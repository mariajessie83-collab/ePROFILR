@page "/student-dashboard"
@layout Gsystem.Layout.StudentLayout
@using SharedProject
@using System.Text.Json
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<PageTitle>Student Dashboard</PageTitle>

<div class="student-dash">
    <h2>Welcome to your Student Dashboard</h2>


    @* Tab Navigation *@
    <div class="tab-navigation">
        <button class="tab-btn @(activeTab == "reports" ? "active" : "")" @onclick='() => SwitchTab("reports")'>
            <span class="tab-icon">üìã</span>
            <span class="tab-label">My Incident Reports</span>
            @if (myReports.Count > 0)
            {
                <span class="tab-badge">@myReports.Count</span>
            }
        </button>
        <button class="tab-btn @(activeTab == "cases" ? "active" : "")" @onclick='() => SwitchTab("cases")'>
            <span class="tab-icon">‚ö†Ô∏è</span>
            <span class="tab-label">My Cases</span>
            @if (myCases.Count > 0)
            {
                <span class="tab-badge">@myCases.Count</span>
            }
        </button>
    </div>

    @* Tab Content *@
    @if (activeTab == "reports")
    {
        <!-- My Incident Reports Section -->
        <div class="reports-section tab-panel">
            <h3>My Incident Reports</h3>
            @if (isLoading)
            {
                <p>Loading your reports...</p>
            }
            else if (myReports.Any())
            {
                <div class="reports-table-container">
                    <table class="reports-table">
                        <thead>
                            <tr>
                                <th>Reference Number</th>
                                <th>Incident Type</th>
                                <th>Date Reported</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var report in myReports)
                            {
                                <tr>
                                    <td>
                                        <strong>@(report.ReferenceNumber ?? $"IR-{report.IncidentID}")</strong>
                                    </td>
                                    <td>@(string.IsNullOrEmpty(report.OtherIncidentType) ? (string.IsNullOrEmpty(report.IncidentType) ? "N/A" : report.IncidentType) : report.OtherIncidentType)</td>
                                    <td>@(report.DateReported == DateTime.MinValue ? "N/A" : report.DateReported.ToString("MMM dd, yyyy hh:mm tt"))</td>
                                    <td>
                                        @{
                                            var statusClass = $"status-{report.Status.ToLower().Replace(" ", "-")}";
                                        }
                                        @if (string.IsNullOrEmpty(report.Status))
                                        {
                                            <span class="status-badge status-pending">Pending</span>
                                        }
                                        else
                                        {
                                            <span class="status-badge @statusClass">
                                                @report.Status
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-primary" @onclick="() => ViewReportDetails(report.IncidentID)" style="background-color: #007bff; border-color: #007bff; color: white; font-weight: 600;">
                                            View Details
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="no-reports">
                    <p>You haven't submitted any incident reports yet.</p>
                    <a href="/incident-report" class="btn btn-primary">Submit Your First Report</a>
                </div>
            }
        </div>
    }
    else if (activeTab == "cases")
    {
        <!-- My Cases Section -->
        <div class="reports-section tab-panel">
            <h3>My Case Records</h3>
            @if (isLoadingCases)
            {
                <p>Loading your cases...</p>
            }
            else if (myCases.Any())
            {
                <div class="reports-table-container">
                    <table class="reports-table">
                        <thead>
                            <tr>
                                <th>Case ID</th>
                                <th>Violation</th>
                                <th>Level</th>
                                <th>Date of Offense</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var caseRecord in myCases)
                            {
                                <tr>
                                    <td><strong>#@caseRecord.RecordID</strong></td>
                                    <td>@caseRecord.ViolationCommitted</td>
                                    <td>
                                        <span class="level-badge level-@(caseRecord.LevelOfOffense?.ToLower())">
                                            @caseRecord.LevelOfOffense
                                        </span>
                                    </td>
                                    <td>@caseRecord.DateOfOffense.ToString("MMM dd, yyyy")</td>
                                    <td>
                                        <span class="status-badge status-@(caseRecord.Status?.ToLower())">
                                            @caseRecord.Status
                                        </span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                            <button class="btn btn-sm btn-primary" @onclick="() => ViewCaseDetails(caseRecord)" style="background-color: #007bff; border-color: #007bff; color: white; font-weight: 600;">
                                                View Details
                                            </button>
                                            @if (HasYakapFormForCase(caseRecord.RecordID))
                                            {
                                                <button class="btn btn-sm btn-secondary" @onclick="() => OpenYakapFormForCase(caseRecord)" style="background-color: #007bff; border-color: #007bff; color: white; font-weight: 600;">
                                                    YAKAP Form
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="no-reports">
                    <p>You don't have any case records.</p>
                </div>
            }
        </div>
    }
</div>

@* Case Details Modal *@
@if (showCaseDetails && selectedCase != null)
{
    <div class="modal-overlay" @onclick="CloseCaseDetails">
        <div class="modal-container report-details-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h4 class="modal-title">Case Record Details</h4>
                <button type="button" class="btn-close" @onclick="CloseCaseDetails" aria-label="Close">√ó</button>
            </div>
            <div class="modal-body">
                <div class="report-detail-section">
                    <h5>Case ID</h5>
                    <p><strong>#@selectedCase.RecordID</strong></p>
                </div>
                <div class="report-detail-section">
                    <h5>Status</h5>
                    <span class="status-badge status-@(selectedCase.Status?.ToLower())">
                        @selectedCase.Status
                    </span>
                </div>
                <div class="report-detail-section">
                    <h5>Date of Offense</h5>
                    <p>@selectedCase.DateOfOffense.ToString("MMMM dd, yyyy")</p>
                </div>
                <div class="report-detail-section">
                    <h5>Violation</h5>
                    <p>@selectedCase.ViolationCommitted</p>
                </div>
                <div class="report-detail-section">
                    <h5>Level of Offense</h5>
                    <span class="level-badge level-@(selectedCase.LevelOfOffense?.ToLower())">
                        @selectedCase.LevelOfOffense
                    </span>
                </div>
                @if (!string.IsNullOrEmpty(selectedCase.DetailsOfAgreement))
                {
                    <div class="report-detail-section">
                        <h5>Agreement/Action Taken</h5>
                        <p>@selectedCase.DetailsOfAgreement</p>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CloseCaseDetails">Close</button>
            </div>
        </div>
    </div>
}

<!-- Report Details Modal -->
@if (showReportDetails && selectedReport != null)
{
    <div class="modal-overlay" @onclick="CloseReportDetails">
        <div class="modal-container report-details-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h4 class="modal-title">Incident Report Details</h4>
                <button type="button" class="btn-close" @onclick="CloseReportDetails" aria-label="Close">√ó</button>
            </div>
            <div class="modal-body">
                <div class="report-detail-section">
                    <h5>Reference Number</h5>
                    <p><strong>@(selectedReport.ReferenceNumber ?? $"IR-{selectedReport.IncidentID}")</strong></p>
                </div>
                <div class="report-detail-section">
                    <h5>Status</h5>
                    @{
                        var detailStatusClass = $"status-{selectedReport.Status.ToLower().Replace(" ", "-")}";
                    }
                    <span class="status-badge @detailStatusClass">
                        @selectedReport.Status
                    </span>
                </div>
                <div class="report-detail-section">
                    <h5>Date Reported</h5>
                    <p>@selectedReport.DateReported.ToString("MMMM dd, yyyy 'at' hh:mm tt")</p>
                </div>
                <div class="report-detail-section">
                    <h5>Incident Type</h5>
                    <p>@(selectedReport.OtherIncidentType ?? selectedReport.IncidentType)</p>
                </div>
                <div class="report-detail-section">
                    <h5>Victim/Complainant</h5>
                    <p>@selectedReport.VictimName</p>
                </div>
                <div class="report-detail-section">
                    <h5>Respondent/Offender@(GetRespondentCount(selectedReport.RespondentName) > 1 ? "s" : "")</h5>
                    @if (string.IsNullOrEmpty(selectedReport.RespondentName))
                    {
                        <p>N/A</p>
                    }
                    else
                    {
                        var respondents = selectedReport.RespondentName.Split(new[] { "; ", ";" }, StringSplitOptions.RemoveEmptyEntries)
                            .Select(r => r.Trim())
                            .Where(r => !string.IsNullOrEmpty(r))
                            .ToArray();
                        if (respondents.Length > 1)
                        {
                            <ul style="list-style-type: disc; padding-left: 20px; margin: 0;">
                                @foreach (var respondent in respondents)
                                {
                                    <li style="margin-bottom: 8px;">@respondent</li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p>@selectedReport.RespondentName</p>
                        }
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="CloseReportDetails">Close</button>
            </div>
        </div>
    </div>
}

@* Y.A.K.A.P. Form Modal for Student *@
@if (showYakapForm && selectedYakapForm != null)
{
    <div class="modal-overlay" @onclick="CloseYakapForm">
        <div class="modal-container yakap-form-modal" @onclick:stopPropagation="true" style="max-width: 900px; width: 95%;">
            <div class="modal-header" style="background: linear-gradient(135deg, #0066cc 0%, #004d99 100%); padding: 24px; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 16px; flex: 1;">
                    <h4 class="modal-title" style="color: white; font-size: 1.5rem; font-weight: 700; margin: 0;">Y.A.K.A.P. Reflection Form</h4>
                    <div class="yakap-counseling-phase" style="display: flex; align-items: center; gap: 12px; margin-left: 20px;">
                        <span class="counseling-number" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #0066cc 0%, #004d99 100%); color: white; font-size: 1.2rem; font-weight: 700; box-shadow: 0 4px 12px rgba(0, 102, 204, 0.4); border: 2px solid rgba(255, 255, 255, 0.3);">6</span>
                        <span class="counseling-text" style="font-size: 1rem; font-weight: 700; color: white; text-transform: uppercase; letter-spacing: 0.05em;">Counseling Phase</span>
                    </div>
                </div>
                <button type="button" class="btn-close" @onclick="CloseYakapForm" aria-label="Close" style="color: white; font-size: 28px; font-weight: bold;">√ó</button>
            </div>
            <div class="modal-body" style="max-height: 80vh; overflow-y: auto; padding: 32px;">
                <div style="text-align: center; margin-bottom: 32px; padding-bottom: 20px; border-bottom: 3px solid #0066cc;">
                    <h4 style="color: #0066cc; font-size: 1.3rem; margin: 0 0 12px 0; font-weight: 700;">YUNIT NA AAKAY SA KABATAAN PARA SA ASAL AT PAGPAPAKATAO</h4>
                    <p style="color: #495057; font-size: 1rem; margin: 0 0 8px 0; font-weight: 600;">@GetDisplaySchoolName()</p>
                    <p style="color: #6c757d; font-size: 0.9rem; font-style: italic; margin: 0;">Confidential Document</p>
                </div>

                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 32px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px solid #e9ecef;">
                    <div>
                        <label style="font-size: 0.95rem; font-weight: 700; color: #0066cc; display: block; margin-bottom: 8px;">Student Name</label>
                        <p style="margin: 0; font-weight: 600; font-size: 1rem; color: #212529; word-wrap: break-word; overflow-wrap: break-word; white-space: normal;">@GetDisplayStudentName()</p>
                    </div>
                    <div>
                        <label style="font-size: 0.95rem; font-weight: 700; color: #0066cc; display: block; margin-bottom: 8px;">Grade & Section</label>
                        <p style="margin: 0; font-size: 1rem; color: #212529;">@currentYakapForm.GradeAndSection</p>
                    </div>
                    <div>
                        <label style="font-size: 0.95rem; font-weight: 700; color: #0066cc; display: block; margin-bottom: 8px;">Date of Session</label>
                        <p style="margin: 0; font-size: 1rem; color: #212529;">@currentYakapForm.DateOfSession.ToString("MMM dd, yyyy")</p>
                    </div>
                    <div>
                        <label style="font-size: 0.95rem; font-weight: 700; color: #0066cc; display: block; margin-bottom: 8px;">Facilitator/Counselor</label>
                        <p style="margin: 0; font-size: 1rem; color: #212529;">@currentYakapForm.FacilitatorCounselor</p>
                    </div>
                </div>

                <div style="margin-bottom: 32px; padding: 24px; background: white; border-left: 5px solid #0066cc; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,102,204,0.1);">
                    <h5 style="color: #0066cc; margin: 0 0 20px 0; font-size: 1.2rem; font-weight: 700;">Bahagi I ‚Äì Pag-unawa sa Aking Karanasan</h5>
                    
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 10px; color: #212529; font-size: 1.05rem;">1. Ano ang nangyari?</label>
                        <small style="display: block; color: #6c757d; margin-bottom: 12px; font-style: italic; font-size: 0.95rem;">(Ilarawan ang asal o sitwasyon na naging dahilan ng iyong paglahok sa Y.A.K.A.P. session)</small>
                        <textarea class="form-control" rows="5" @bind="currentYakapForm.Question1_AnoAngNangyari" 
                                  style="width: 100%; padding: 16px; border: 2px solid #007bff; border-radius: 8px; font-family: inherit; font-size: 1rem; transition: all 0.3s;" 
                                  placeholder="Ilagay ang inyong sagot dito..." readonly="@(selectedYakapForm.Status == "Completed")"
                                  onfocus="this.style.borderColor='#0056b3'; this.style.boxShadow='0 0 0 0.2rem rgba(0,123,255,0.25)'"
                                  onblur="this.style.borderColor='#007bff'; this.style.boxShadow='none'"></textarea>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 10px; color: #212529; font-size: 1.05rem;">2. Ano ang iniisip o nararamdaman mo noong panahong iyon?</label>
                        <textarea class="form-control" rows="5" @bind="currentYakapForm.Question2_AnoAngIniisipOFeelings" 
                                  style="width: 100%; padding: 16px; border: 2px solid #007bff; border-radius: 8px; font-family: inherit; font-size: 1rem; transition: all 0.3s;" 
                                  placeholder="Ilagay ang inyong sagot dito..." readonly="@(selectedYakapForm.Status == "Completed")"
                                  onfocus="this.style.borderColor='#0056b3'; this.style.boxShadow='0 0 0 0.2rem rgba(0,123,255,0.25)'"
                                  onblur="this.style.borderColor='#007bff'; this.style.boxShadow='none'"></textarea>
                    </div>
                </div>

                <div style="margin-bottom: 32px; padding: 24px; background: white; border-left: 5px solid #007bff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,123,255,0.1);">
                    <h5 style="color: #007bff; margin: 0 0 20px 0; font-size: 1.2rem; font-weight: 700;">Bahagi II ‚Äì Pananagutan sa Ginawang Pagkilos</h5>
                    
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 10px; color: #212529; font-size: 1.05rem;">3. Ano ang naging epekto ng iyong ginawa sa iba (kaklase, guro, pamilya)?</label>
                        <textarea class="form-control" rows="5" @bind="currentYakapForm.Question3_AnoAngEpektoSaIba" 
                                  style="width: 100%; padding: 16px; border: 2px solid #007bff; border-radius: 8px; font-family: inherit; font-size: 1rem; transition: all 0.3s;" 
                                  placeholder="Ilagay ang inyong sagot dito..." readonly="@(selectedYakapForm.Status == "Completed")"
                                  onfocus="this.style.borderColor='#0056b3'; this.style.boxShadow='0 0 0 0.2rem rgba(0,123,255,0.25)'"
                                  onblur="this.style.borderColor='#007bff'; this.style.boxShadow='none'"></textarea>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 10px; color: #212529; font-size: 1.05rem;">4. Ano ang iniisip mo ngayon tungkol sa iyong mga naging desisyon?</label>
                        <textarea class="form-control" rows="5" @bind="currentYakapForm.Question4_AnoAngIniisipTungkolSaDesisyon" 
                                  style="width: 100%; padding: 16px; border: 2px solid #007bff; border-radius: 8px; font-family: inherit; font-size: 1rem; transition: all 0.3s;" 
                                  placeholder="Ilagay ang inyong sagot dito..." readonly="@(selectedYakapForm.Status == "Completed")"
                                  onfocus="this.style.borderColor='#0056b3'; this.style.boxShadow='0 0 0 0.2rem rgba(0,123,255,0.25)'"
                                  onblur="this.style.borderColor='#007bff'; this.style.boxShadow='none'"></textarea>
                    </div>
                </div>

                <div style="margin-bottom: 32px; padding: 24px; background: white; border-left: 5px solid #007bff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,123,255,0.1);">
                    <h5 style="color: #007bff; margin: 0 0 20px 0; font-size: 1.2rem; font-weight: 700;">Bahagi III ‚Äì Pagharap sa Hinaharap Gamit ang Positibong Disiplina</h5>
                    
                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 10px; color: #212529; font-size: 1.05rem;">5. Ano ang gagawin mong iba sa susunod?</label>
                        <textarea class="form-control" rows="5" @bind="currentYakapForm.Question5_AnoAngGagawinMongIba" 
                                  style="width: 100%; padding: 16px; border: 2px solid #007bff; border-radius: 8px; font-family: inherit; font-size: 1rem; transition: all 0.3s;" 
                                  placeholder="Ilagay ang inyong sagot dito..." readonly="@(selectedYakapForm.Status == "Completed")"
                                  onfocus="this.style.borderColor='#0056b3'; this.style.boxShadow='0 0 0 0.2rem rgba(0,123,255,0.25)'"
                                  onblur="this.style.borderColor='#007bff'; this.style.boxShadow='none'"></textarea>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 10px; color: #212529; font-size: 1.05rem;">6. Anong positibong pagpapahalaga o prinsipyo ang gagabay sa iyong susunod na hakbang?</label>
                        <small style="display: block; color: #6c757d; margin-bottom: 12px; font-style: italic; font-size: 0.95rem;">(hal. Paggagalang, Pananagutan, Katapatan, Pagtitimpi, Empatiya)</small>
                        <textarea class="form-control" rows="5" @bind="currentYakapForm.Question6_AnongPositibongPagpapahalaga" 
                                  style="width: 100%; padding: 16px; border: 2px solid #007bff; border-radius: 8px; font-family: inherit; font-size: 1rem; transition: all 0.3s;" 
                                  placeholder="Ilagay ang inyong sagot dito..." readonly="@(selectedYakapForm.Status == "Completed")"
                                  onfocus="this.style.borderColor='#0056b3'; this.style.boxShadow='0 0 0 0.2rem rgba(0,123,255,0.25)'"
                                  onblur="this.style.borderColor='#007bff'; this.style.boxShadow='none'"></textarea>
                    </div>

                    <div style="margin-bottom: 24px;">
                        <label style="display: block; font-weight: 700; margin-bottom: 10px; color: #212529; font-size: 1.05rem;">7. Sumulat ng maikling mensahe para sa iyong hinaharap na sarili</label>
                        <small style="display: block; color: #6c757d; margin-bottom: 12px; font-style: italic; font-size: 0.95rem;">(paalala ng mga aral na natutunan mo)</small>
                        <textarea class="form-control" rows="5" @bind="currentYakapForm.Question7_MensaheParaSaHinaharap" 
                                  style="width: 100%; padding: 16px; border: 2px solid #007bff; border-radius: 8px; font-family: inherit; font-size: 1rem; transition: all 0.3s;" 
                                  placeholder="Ilagay ang inyong mensahe dito..." readonly="@(selectedYakapForm.Status == "Completed")"
                                  onfocus="this.style.borderColor='#0056b3'; this.style.boxShadow='0 0 0 0.2rem rgba(0,123,255,0.25)'"
                                  onblur="this.style.borderColor='#007bff'; this.style.boxShadow='none'"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 24px; border-top: 2px solid #e9ecef; background: #f8f9fa;">
                <button type="button" class="btn btn-secondary" @onclick="CloseYakapForm" style="padding: 12px 24px; font-size: 1rem; font-weight: 600; border-radius: 8px;">@(selectedYakapForm.Status == "Completed" ? "Close" : "Cancel")</button>
                @if (selectedYakapForm.Status != "Completed")
                {
                    <button type="button" class="btn btn-primary" @onclick="SaveYakapForm" disabled="@isSavingYakapForm" style="background-color: #007bff; border-color: #007bff; padding: 12px 32px; font-size: 1rem; font-weight: 700; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,123,255,0.3);">
                        @if (isSavingYakapForm) { <span>Saving...</span> } else { <span>Submit Form</span> }
                    </button>
                }
            </div>
        </div>
    </div>
}

<style>
    .student-dash{display:block}


    .reports-section {
        margin-top: 40px;
        padding: 24px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .reports-section h3 {
        margin-bottom: 20px;
        color: #007bff;
        font-size: 28px;
        font-weight: 700;
    }

    .yakap-form-modal {
        max-width: 900px !important;
        width: 95% !important;
    }

    .reports-table-container {
        overflow-x: auto;
    }

    .reports-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
    }

    .reports-table thead {
        background-color: #f8f9fa;
    }

    .reports-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }

    .reports-table td {
        padding: 12px;
        border-bottom: 1px solid #e9ecef;
    }

    .reports-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-pending {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-reviewing {
        background-color: #cfe2ff;
        color: #084298;
    }

    .status-resolved {
        background-color: #d1e7dd;
        color: #0f5132;
    }

    .status-closed {
        background-color: #d3d3d3;
        color: #495057;
    }

    .no-reports {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }

    .report-details-modal {
        max-width: 600px;
    }

    .report-detail-section {
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid #e9ecef;
    }

    .report-detail-section:last-child {
        border-bottom: none;
    }

    .report-detail-section h5 {
        margin-bottom: 8px;
        color: #007bff;
        font-size: 14px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .report-detail-section p {
        margin: 0;
        color: #333;
        font-size: 15px;
    }

    .modal-header .btn-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6c757d;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .modal-header .btn-close:hover {
        color: #000;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 10000;
        animation: fadeIn 0.2s ease;
    }

    .modal-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow: auto;
        animation: slideDown 0.3s ease;
    }

    .modal-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-title {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        color: #007bff;
    }

    .modal-body {
        padding: 24px;
        font-size: 16px;
        line-height: 1.6;
        color: #333;
    }

    .modal-footer {
        padding: 16px 24px;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }

    .modal-footer .btn {
        min-width: 100px;
        padding: 10px 24px;
        font-weight: 500;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @@keyframes slideDown {
        from {
            transform: translateY(-20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    /* Tab Navigation */
    .tab-navigation {
        display: flex;
        gap: 16px;
        margin: 24px 0;
        background: white;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .tab-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 12px 20px;
        border: none;
        background: transparent;
        border-radius: 6px;
        font-size: 15px;
        font-weight: 600;
        color: #6c757d;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .tab-btn:hover {
        background: rgba(0, 123, 255, 0.1);
        color: #007bff;
    }

    .tab-btn.active {
        background: #007bff;
        color: white;
        box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }

    .tab-icon {
        font-size: 1.2rem;
    }

    .tab-badge {
        background: rgba(255, 255, 255, 0.3);
        padding: 2px 10px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: 700;
    }

    .tab-btn.active .tab-badge {
        background: rgba(255, 255, 255, 0.25);
    }

    .tab-panel {
        animation: fadeIn 0.3s ease;
    }

    /* Level Badges */
    .level-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .level-badge.level-minor {
        background-color: #fff3cd;
        color: #856404;
    }

    .level-badge.level-major {
        background-color: #ffe5cc;
        color: #cc5500;
    }

    .level-badge.level-severe {
        background-color: #f8d7da;
        color: #721c24;
    }

    .status-active {
        background-color: #cfe2ff;
        color: #084298;
    }

    .status-calling {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-called {
        background-color: #cfe2ff;
        color: #084298;
    }

    .status-arrived {
        background-color: #cfe2ff;
        color: #084298;
    }

    .status-under-review {
        background-color: #cfe2ff;
        color: #084298;
    }

    .status-sent {
        background-color: #fff3cd;
        color: #856404;
    }

    .status-inprogress {
        background-color: #cfe2ff;
        color: #084298;
    }

    .status-completed {
        background-color: #d1e7dd;
        color: #0f5132;
    }

</style>

@code {
    private List<IncidentReportSummary> myReports = new();
    private List<StudentProfileCaseRecordSummary> myCases = new();
    private List<YakapFormModel> pendingYakapForms = new();
    private Dictionary<int, YakapFormModel> yakapFormsByRecordID = new Dictionary<int, YakapFormModel>();
    private bool isLoading = true;
    private bool isLoadingCases = true;
    private bool isLoadingYakapForms = true;
    private bool showReportDetails = false;
    private bool showCaseDetails = false;
    private bool showYakapForm = false;
    private IncidentReportSummary? selectedReport = null;
    private StudentProfileCaseRecordSummary? selectedCase = null;
    private YakapFormModel? selectedYakapForm = null;
    private YakapFormRequest currentYakapForm = new YakapFormRequest();
    private bool isSavingYakapForm = false;
    private string currentUsername = string.Empty;
    private string activeTab = "reports";
    private string actualSchoolName = string.Empty;
    private string actualStudentName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadMyReports();
        await LoadMyCases();
        await LoadYakapForms();
    }

    private void SwitchTab(string tab)
    {
        activeTab = tab;
    }

    private async Task LoadMyReports()
    {
        try
        {
            isLoading = true;
            currentUsername = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "username") ?? "";
            var userFullName = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userFullName") ?? "";
            
            Console.WriteLine($"Loading reports for username: {currentUsername}, userFullName: {userFullName}");
            
            // Try username first, then userFullName if username doesn't work
            var namesToTry = new List<string>();
            if (!string.IsNullOrEmpty(currentUsername))
                namesToTry.Add(currentUsername);
            if (!string.IsNullOrEmpty(userFullName) && userFullName != currentUsername)
                namesToTry.Add(userFullName);
            
            if (namesToTry.Count == 0)
            {
                Console.WriteLine("No username or userFullName found, cannot load reports");
                isLoading = false;
                StateHasChanged();
                return;
            }
            
            myReports = new List<IncidentReportSummary>();
            
            foreach (var name in namesToTry)
            {
                try
                {
                    var url = $"api/IncidentReport/by-complainant/{Uri.EscapeDataString(name)}";
                    Console.WriteLine($"Calling API: {url}");
                    
                    var response = await Http.GetAsync(url);
                    Console.WriteLine($"Response status: {response.StatusCode}");
                    
                    if (response.IsSuccessStatusCode)
                    {
                        var content = await response.Content.ReadAsStringAsync();
                        Console.WriteLine($"Response content: {content}");
                        
                        var result = JsonSerializer.Deserialize<JsonElement>(content);
                        
                        if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                            result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                        {
                            var options = new JsonSerializerOptions
                            {
                                PropertyNameCaseInsensitive = true
                            };
                            
                            foreach (var item in data.EnumerateArray())
                            {
                                try
                                {
                                    var reportJson = item.GetRawText();
                                    Console.WriteLine($"Deserializing report: {reportJson}");
                                    
                                    var report = JsonSerializer.Deserialize<IncidentReportSummary>(reportJson, options);
                                    if (report != null)
                                    {
                                        Console.WriteLine($"Added report - ID: {report.IncidentID}, Type: {report.IncidentType}, Status: {report.Status}, Date: {report.DateReported}");
                                        // Avoid duplicates
                                        if (!myReports.Any(r => r.IncidentID == report.IncidentID))
                                        {
                                            myReports.Add(report);
                                        }
                                    }
                                }
                                catch (Exception ex)
                                {
                                    Console.WriteLine($"Error deserializing report: {ex.Message}");
                                }
                            }
                        }
                    }
                    else
                    {
                        var errorContent = await response.Content.ReadAsStringAsync();
                        Console.WriteLine($"API Error for {name}: {response.StatusCode} - {errorContent}");
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error loading reports for {name}: {ex.Message}");
                }
            }
            
            Console.WriteLine($"Total reports loaded: {myReports.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading reports: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadMyCases()
    {
        try
        {
            isLoadingCases = true;
            currentUsername = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "username") ?? "";
            var userFullName = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userFullName") ?? "";
            
            Console.WriteLine($"Loading cases for username: {currentUsername}, userFullName: {userFullName}");
            
            // If userFullName is the same as username (meaning StudentName wasn't saved properly),
            // try to get the actual student name from the API by joining Users and Students tables
            if (!string.IsNullOrEmpty(currentUsername) && 
                (string.IsNullOrEmpty(userFullName) || userFullName == currentUsername))
            {
                Console.WriteLine("userFullName is same as username, fetching actual student name from API...");
                try
                {
                    var studentInfoResponse = await Http.GetAsync($"api/IncidentReport/student-info/{Uri.EscapeDataString(currentUsername)}");
                    Console.WriteLine($"Student info API response status: {studentInfoResponse.StatusCode}");
                    
                    if (studentInfoResponse.IsSuccessStatusCode)
                    {
                        var studentInfoContent = await studentInfoResponse.Content.ReadAsStringAsync();
                        Console.WriteLine($"Student info API response content: {studentInfoContent}");
                        
                        var studentInfoResult = JsonSerializer.Deserialize<JsonElement>(studentInfoContent);
                        
                        // Try to extract StudentName from the response (check all possible property names)
                        JsonElement? dataElement = null;
                        
                        // Try Success/success and Data/data
                        if (studentInfoResult.TryGetProperty("Success", out var successProp) && successProp.GetBoolean())
                        {
                            if (studentInfoResult.TryGetProperty("Data", out var dataUpper))
                                dataElement = dataUpper;
                        }
                        else if (studentInfoResult.TryGetProperty("success", out var successLower) && successLower.GetBoolean())
                        {
                            if (studentInfoResult.TryGetProperty("data", out var dataLower))
                                dataElement = dataLower;
                        }
                        
                        if (dataElement.HasValue)
                        {
                            var data = dataElement.Value;
                            
                            // Try different property name formats
                            if (data.ValueKind == JsonValueKind.Object)
                            {
                                // Try StudentName (capital S, capital N)
                                if (data.TryGetProperty("StudentName", out var studentNameProp))
                                {
                                    var extractedName = studentNameProp.GetString();
                                    if (!string.IsNullOrWhiteSpace(extractedName))
                                    {
                                        userFullName = extractedName;
                                        Console.WriteLine($"‚úì Retrieved StudentName from API: {userFullName}");
                                    }
                                }
                                // Try studentName (lowercase s)
                                else if (data.TryGetProperty("studentName", out var studentNameLower))
                                {
                                    var extractedName = studentNameLower.GetString();
                                    if (!string.IsNullOrWhiteSpace(extractedName))
                                    {
                                        userFullName = extractedName;
                                        Console.WriteLine($"‚úì Retrieved studentName from API: {userFullName}");
                                    }
                                }
                                else
                                {
                                    // Enumerate all properties to find StudentName (case-insensitive)
                                    foreach (var prop in data.EnumerateObject())
                                    {
                                        Console.WriteLine($"Property in data: {prop.Name} = {prop.Value}");
                                        if (string.Equals(prop.Name, "StudentName", StringComparison.OrdinalIgnoreCase) ||
                                            string.Equals(prop.Name, "studentName", StringComparison.OrdinalIgnoreCase))
                                        {
                                            var extractedName = prop.Value.GetString();
                                            if (!string.IsNullOrWhiteSpace(extractedName))
                                            {
                                                userFullName = extractedName;
                                                Console.WriteLine($"‚úì Retrieved StudentName via enumeration: {userFullName}");
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        }
                        
                        if (userFullName == currentUsername)
                        {
                            Console.WriteLine($"‚ö† Warning: Failed to extract StudentName, still using username: {currentUsername}");
                        }
                    }
                    else
                    {
                        var errorContent = await studentInfoResponse.Content.ReadAsStringAsync();
                        Console.WriteLine($"‚ö† Student info API error: {errorContent}");
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"‚úó Error fetching student name from API: {ex.Message}");
                    Console.WriteLine($"Stack trace: {ex.StackTrace}");
                }
            }
            
            // Try username first, then userFullName if username doesn't work
            var namesToTry = new List<string>();
            if (!string.IsNullOrEmpty(userFullName) && userFullName != currentUsername)
                namesToTry.Add(userFullName); // Try full name first (more likely to match)
            if (!string.IsNullOrEmpty(currentUsername))
                namesToTry.Add(currentUsername); // Then try username as fallback
            
            if (namesToTry.Count == 0)
            {
                Console.WriteLine("No username or userFullName found, cannot load cases");
                isLoadingCases = false;
                StateHasChanged();
                return;
            }
            
            Console.WriteLine($"Names to try for case search: {string.Join(", ", namesToTry)}");
            myCases = new List<StudentProfileCaseRecordSummary>();
            
            // If we still only have username (not the actual student name), use the username endpoint that does the join
            if (namesToTry.Count == 1 && namesToTry[0] == currentUsername && !string.IsNullOrEmpty(currentUsername))
            {
                Console.WriteLine($"Using username endpoint (joins Users and Students tables) for: {currentUsername}");
                try
                {
                    var url = $"api/StudentProfileCaseRecord/username/{Uri.EscapeDataString(currentUsername)}";
                    Console.WriteLine($"Calling API: {url}");
                    
                    var response = await Http.GetAsync(url);
                    Console.WriteLine($"Response status: {response.StatusCode}");
                    
                    if (response.IsSuccessStatusCode)
                    {
                        var content = await response.Content.ReadAsStringAsync();
                        Console.WriteLine($"Response content: {content}");
                        
                        var result = JsonSerializer.Deserialize<JsonElement>(content);
                        
                        if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                            result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                        {
                            var options = new JsonSerializerOptions
                            {
                                PropertyNameCaseInsensitive = true
                            };
                            
                            foreach (var item in data.EnumerateArray())
                            {
                                try
                                {
                                    var caseJson = item.GetRawText();
                                    Console.WriteLine($"Deserializing case: {caseJson}");
                                    
                                    var caseRecord = JsonSerializer.Deserialize<StudentProfileCaseRecordSummary>(caseJson, options);
                                    if (caseRecord != null)
                                    {
                                        Console.WriteLine($"‚úì Added case - ID: {caseRecord.RecordID}, Violation: {caseRecord.ViolationCommitted}, Status: {caseRecord.Status}");
                                        // Avoid duplicates
                                        if (!myCases.Any(c => c.RecordID == caseRecord.RecordID))
                                        {
                                            myCases.Add(caseRecord);
                                        }
                                    }
                                }
                                catch (Exception ex)
                                {
                                    Console.WriteLine($"Error deserializing case: {ex.Message}");
                                }
                            }
                        }
                    }
                    else
                    {
                        var errorContent = await response.Content.ReadAsStringAsync();
                        Console.WriteLine($"API Error: {response.StatusCode} - {errorContent}");
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error loading cases by username: {ex.Message}");
                }
            }
            else
            {
                // Try searching by student name(s)
                foreach (var name in namesToTry)
                {
                    try
                    {
                        var url = $"api/StudentProfileCaseRecord/respondent/{Uri.EscapeDataString(name)}";
                        Console.WriteLine($"Calling API: {url}");
                        
                        var response = await Http.GetAsync(url);
                        Console.WriteLine($"Response status: {response.StatusCode}");
                        
                        if (response.IsSuccessStatusCode)
                        {
                            var content = await response.Content.ReadAsStringAsync();
                            Console.WriteLine($"Response content: {content}");
                            
                            var result = JsonSerializer.Deserialize<JsonElement>(content);
                            
                            if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                                result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                            {
                                var options = new JsonSerializerOptions
                                {
                                    PropertyNameCaseInsensitive = true
                                };
                                
                                foreach (var item in data.EnumerateArray())
                                {
                                    try
                                    {
                                        var caseJson = item.GetRawText();
                                        Console.WriteLine($"Deserializing case: {caseJson}");
                                        
                                        var caseRecord = JsonSerializer.Deserialize<StudentProfileCaseRecordSummary>(caseJson, options);
                                        if (caseRecord != null)
                                        {
                                            Console.WriteLine($"‚úì Added case - ID: {caseRecord.RecordID}, Violation: {caseRecord.ViolationCommitted}, Status: {caseRecord.Status}");
                                            // Avoid duplicates
                                            if (!myCases.Any(c => c.RecordID == caseRecord.RecordID))
                                            {
                                                myCases.Add(caseRecord);
                                            }
                                        }
                                    }
                                    catch (Exception ex)
                                    {
                                        Console.WriteLine($"Error deserializing case: {ex.Message}");
                                    }
                                }
                            }
                        }
                        else
                        {
                            var errorContent = await response.Content.ReadAsStringAsync();
                            Console.WriteLine($"API Error for {name}: {response.StatusCode} - {errorContent}");
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Error loading cases for {name}: {ex.Message}");
                    }
                }
            }
            
            Console.WriteLine($"Total cases loaded: {myCases.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading cases: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
        finally
        {
            isLoadingCases = false;
            StateHasChanged();
        }
    }

    private void ViewReportDetails(int incidentId)
    {
        selectedReport = myReports.FirstOrDefault(r => r.IncidentID == incidentId);
        showReportDetails = true;
    }

    private void CloseReportDetails()
    {
        showReportDetails = false;
        selectedReport = null;
    }

    private void ViewCaseDetails(StudentProfileCaseRecordSummary caseRecord)
    {
        selectedCase = caseRecord;
        showCaseDetails = true;
    }

    private void CloseCaseDetails()
    {
        showCaseDetails = false;
        selectedCase = null;
    }

    private int GetRespondentCount(string? respondentName)
    {
        if (string.IsNullOrEmpty(respondentName))
            return 0;
        
        var respondents = respondentName.Split(new[] { "; ", ";" }, StringSplitOptions.RemoveEmptyEntries)
            .Select(r => r.Trim())
            .Where(r => !string.IsNullOrEmpty(r))
            .ToArray();
        return respondents.Length;
    }

    private async Task LoadYakapForms()
    {
        try
        {
            isLoadingYakapForms = true;
            currentUsername = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "username") ?? "";
            var userFullName = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userFullName") ?? "";
            
            Console.WriteLine($"Loading Y.A.K.A.P. forms for username: {currentUsername}, userFullName: {userFullName}");
            
            pendingYakapForms = new List<YakapFormModel>();
            yakapFormsByRecordID.Clear(); // Clear dictionary when reloading
            
            // Get Y.A.K.A.P. forms by username (more efficient - server-side filtering)
            if (!string.IsNullOrEmpty(currentUsername))
            {
                var response = await Http.GetAsync($"api/YakapForm?studentUsername={Uri.EscapeDataString(currentUsername)}");
                
                if (response.IsSuccessStatusCode)
                {
                    var content = await response.Content.ReadAsStringAsync();
                    var result = JsonSerializer.Deserialize<JsonElement>(content);
                    
                    if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                        result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                    {
                        var options = new JsonSerializerOptions
                        {
                            PropertyNameCaseInsensitive = true
                        };
                        
                        foreach (var item in data.EnumerateArray())
                        {
                            try
                            {
                                var formJson = item.GetRawText();
                                var form = JsonSerializer.Deserialize<YakapFormModel>(formJson, options);
                                
                                if (form != null)
                                {
                                    Console.WriteLine($"‚úì Added Y.A.K.A.P. form - RecordID: {form.RecordID}, Status: {form.Status}");
                                    pendingYakapForms.Add(form);
                                    
                                    // Add to dictionary for faster lookup by RecordID
                                    // Include ALL forms regardless of status (so button shows for all forms)
                                    yakapFormsByRecordID[form.RecordID] = form;
                                    Console.WriteLine($"‚úì Added to dictionary - RecordID: {form.RecordID}, Status: {form.Status}");
                                }
                            }
                            catch (Exception ex)
                            {
                                Console.WriteLine($"Error deserializing Y.A.K.A.P. form: {ex.Message}");
                            }
                        }
                    }
                }
            }
            
            Console.WriteLine($"Total Y.A.K.A.P. forms loaded: {pendingYakapForms.Count}");
            Console.WriteLine($"Total YAKAP forms in dictionary: {yakapFormsByRecordID.Count}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading Y.A.K.A.P. forms: {ex.Message}");
        }
        finally
        {
            isLoadingYakapForms = false;
            StateHasChanged(); // Refresh UI to update button visibility
        }
    }

    private async Task OpenYakapForm(YakapFormModel form)
    {
        selectedYakapForm = form;
        currentYakapForm = new YakapFormRequest
        {
            RecordID = form.RecordID,
            StudentName = form.StudentName,
            GradeAndSection = form.GradeAndSection,
            DateOfSession = form.DateOfSession,
            FacilitatorCounselor = form.FacilitatorCounselor,
            SchoolName = form.SchoolName,
            SchoolID = form.SchoolID,
            Question1_AnoAngNangyari = form.Question1_AnoAngNangyari,
            Question2_AnoAngIniisipOFeelings = form.Question2_AnoAngIniisipOFeelings,
            Question3_AnoAngEpektoSaIba = form.Question3_AnoAngEpektoSaIba,
            Question4_AnoAngIniisipTungkolSaDesisyon = form.Question4_AnoAngIniisipTungkolSaDesisyon,
            Question5_AnoAngGagawinMongIba = form.Question5_AnoAngGagawinMongIba,
            Question6_AnongPositibongPagpapahalaga = form.Question6_AnongPositibongPagpapahalaga,
            Question7_MensaheParaSaHinaharap = form.Question7_MensaheParaSaHinaharap,
            CreatedBy = form.CreatedBy
        };
        
        // Load actual school name and student name from student's account
        await LoadActualStudentInfo();
        
        // Load actual school name if saved one is placeholder
        if (!string.IsNullOrWhiteSpace(form.SchoolName) && form.SchoolName != "School Name")
        {
            actualSchoolName = form.SchoolName;
        }
        
        showYakapForm = true;
    }

    private async Task ViewYakapForm(YakapFormModel form)
    {
        selectedYakapForm = form;
        currentYakapForm = new YakapFormRequest
        {
            RecordID = form.RecordID,
            StudentName = form.StudentName,
            GradeAndSection = form.GradeAndSection,
            DateOfSession = form.DateOfSession,
            FacilitatorCounselor = form.FacilitatorCounselor,
            SchoolName = form.SchoolName,
            SchoolID = form.SchoolID,
            Question1_AnoAngNangyari = form.Question1_AnoAngNangyari,
            Question2_AnoAngIniisipOFeelings = form.Question2_AnoAngIniisipOFeelings,
            Question3_AnoAngEpektoSaIba = form.Question3_AnoAngEpektoSaIba,
            Question4_AnoAngIniisipTungkolSaDesisyon = form.Question4_AnoAngIniisipTungkolSaDesisyon,
            Question5_AnoAngGagawinMongIba = form.Question5_AnoAngGagawinMongIba,
            Question6_AnongPositibongPagpapahalaga = form.Question6_AnongPositibongPagpapahalaga,
            Question7_MensaheParaSaHinaharap = form.Question7_MensaheParaSaHinaharap,
            CreatedBy = form.CreatedBy
        };
        
        // Load actual school name and student name from student's account
        await LoadActualStudentInfo();
        
        // Load actual school name if saved one is placeholder
        if (!string.IsNullOrWhiteSpace(form.SchoolName) && form.SchoolName != "School Name")
        {
            actualSchoolName = form.SchoolName;
        }
        
        showYakapForm = true;
    }

    private void CloseYakapForm()
    {
        showYakapForm = false;
        selectedYakapForm = null;
        currentYakapForm = new YakapFormRequest();
        actualSchoolName = string.Empty;
        actualStudentName = string.Empty;
    }
    
    private async Task LoadActualStudentInfo()
    {
        actualSchoolName = string.Empty;
        actualStudentName = string.Empty;
        
        try
        {
            // Get student information from current logged-in student's account using username
            if (!string.IsNullOrWhiteSpace(currentUsername))
            {
                var studentResponse = await Http.GetAsync($"api/IncidentReport/student-info/{Uri.EscapeDataString(currentUsername)}");
                if (studentResponse.IsSuccessStatusCode)
                {
                    var studentContent = await studentResponse.Content.ReadAsStringAsync();
                    var studentResult = JsonSerializer.Deserialize<JsonElement>(studentContent);
                    
                    // Try both Success/success and Data/data formats
                    JsonElement? studentData = null;
                    if (studentResult.TryGetProperty("Success", out var successUpper) && successUpper.GetBoolean())
                    {
                        if (studentResult.TryGetProperty("Data", out var dataUpper))
                            studentData = dataUpper;
                    }
                    else if (studentResult.TryGetProperty("success", out var successLower) && successLower.GetBoolean())
                    {
                        if (studentResult.TryGetProperty("data", out var dataLower))
                            studentData = dataLower;
                    }
                    
                    if (studentData.HasValue)
                    {
                        // Get full StudentName
                        if (studentData.Value.TryGetProperty("StudentName", out var studentNameProp))
                        {
                            var studentName = studentNameProp.GetString();
                            if (!string.IsNullOrWhiteSpace(studentName))
                            {
                                actualStudentName = studentName;
                            }
                        }
                        
                        // Get SchoolName
                        if (studentData.Value.TryGetProperty("SchoolName", out var schoolNameProp))
                        {
                            var schoolName = schoolNameProp.GetString();
                            if (!string.IsNullOrWhiteSpace(schoolName))
                            {
                                actualSchoolName = schoolName;
                            }
                        }
                    }
                }
            }
        }
        catch
        {
            // Info will remain empty if all methods fail
        }
    }
    
    private string GetDisplayStudentName()
    {
        if (currentYakapForm == null) return "Not provided";
        
        // If we have actual student name from account, use it (it's the full name)
        if (!string.IsNullOrWhiteSpace(actualStudentName))
        {
            return actualStudentName;
        }
        
        // Otherwise use the saved student name
        return string.IsNullOrWhiteSpace(currentYakapForm.StudentName) ? "Not provided" : currentYakapForm.StudentName;
    }
    
    private string GetDisplaySchoolName()
    {
        if (currentYakapForm == null) return "Not provided";
        
        // If saved school name is placeholder or empty, use actual school name
        if (string.IsNullOrWhiteSpace(currentYakapForm.SchoolName) || currentYakapForm.SchoolName == "School Name")
        {
            return string.IsNullOrWhiteSpace(actualSchoolName) ? "Not provided" : actualSchoolName;
        }
        
        // Otherwise use the saved school name
        return currentYakapForm.SchoolName;
    }

    private async Task SaveYakapForm()
    {
        if (selectedYakapForm == null) return;
        
        // Validate all questions are answered
        if (string.IsNullOrWhiteSpace(currentYakapForm.Question1_AnoAngNangyari) ||
            string.IsNullOrWhiteSpace(currentYakapForm.Question2_AnoAngIniisipOFeelings) ||
            string.IsNullOrWhiteSpace(currentYakapForm.Question3_AnoAngEpektoSaIba) ||
            string.IsNullOrWhiteSpace(currentYakapForm.Question4_AnoAngIniisipTungkolSaDesisyon) ||
            string.IsNullOrWhiteSpace(currentYakapForm.Question5_AnoAngGagawinMongIba) ||
            string.IsNullOrWhiteSpace(currentYakapForm.Question6_AnongPositibongPagpapahalaga) ||
            string.IsNullOrWhiteSpace(currentYakapForm.Question7_MensaheParaSaHinaharap))
        {
            // Show validation message - we'll need to add this
            return;
        }

        isSavingYakapForm = true;
        try
        {
            // Ensure CreatedBy is set (for ModifiedBy)
            if (string.IsNullOrWhiteSpace(currentYakapForm.CreatedBy))
            {
                currentYakapForm.CreatedBy = currentUsername;
            }
            
            var json = JsonSerializer.Serialize(currentYakapForm);
            var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");
            var response = await Http.PutAsync($"api/YakapForm/{selectedYakapForm.YakapFormID}", content);
            
            if (response.IsSuccessStatusCode)
            {
                // Update the form in our local lists
                if (selectedYakapForm != null)
                {
                    var updatedForm = pendingYakapForms.FirstOrDefault(f => f.YakapFormID == selectedYakapForm.YakapFormID);
                    if (updatedForm != null)
                    {
                        updatedForm.Status = "Completed";
                        updatedForm.Question1_AnoAngNangyari = currentYakapForm.Question1_AnoAngNangyari;
                        updatedForm.Question2_AnoAngIniisipOFeelings = currentYakapForm.Question2_AnoAngIniisipOFeelings;
                        updatedForm.Question3_AnoAngEpektoSaIba = currentYakapForm.Question3_AnoAngEpektoSaIba;
                        updatedForm.Question4_AnoAngIniisipTungkolSaDesisyon = currentYakapForm.Question4_AnoAngIniisipTungkolSaDesisyon;
                        updatedForm.Question5_AnoAngGagawinMongIba = currentYakapForm.Question5_AnoAngGagawinMongIba;
                        updatedForm.Question6_AnongPositibongPagpapahalaga = currentYakapForm.Question6_AnongPositibongPagpapahalaga;
                        updatedForm.Question7_MensaheParaSaHinaharap = currentYakapForm.Question7_MensaheParaSaHinaharap;
                        
                        // Update dictionary
                        yakapFormsByRecordID[updatedForm.RecordID] = updatedForm;
                    }
                }
                
                CloseYakapForm();
                await LoadYakapForms(); // Reload forms to see updated status
                StateHasChanged(); // Refresh UI to update button visibility
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error saving Y.A.K.A.P. form: {errorContent}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving Y.A.K.A.P. form: {ex.Message}");
        }
        finally
        {
            isSavingYakapForm = false;
        }
    }

    private bool HasYakapFormForCase(int recordID)
    {
        // Check if there's a YAKAP form for this RecordID (any status)
        // Show button for ALL forms regardless of status
        if (yakapFormsByRecordID.ContainsKey(recordID))
        {
            var form = yakapFormsByRecordID[recordID];
            Console.WriteLine($"‚úì Found YAKAP form for RecordID {recordID}: Status = {form.Status}");
            return true;
        }
        
        // Fallback: check the list directly (check ALL forms, not just specific statuses)
        var hasForm = pendingYakapForms.Any(f => f.RecordID == recordID);
        
        if (hasForm)
        {
            var form = pendingYakapForms.First(f => f.RecordID == recordID);
            yakapFormsByRecordID[recordID] = form; // Add to dictionary for next time
            Console.WriteLine($"‚úì Found YAKAP form for RecordID {recordID} (from list): Status = {form.Status}");
        }
        else
        {
            Console.WriteLine($"‚úó No YAKAP form found for RecordID {recordID}. Total forms loaded: {pendingYakapForms.Count}");
            // Debug: list all RecordIDs in pendingYakapForms
            if (pendingYakapForms.Any())
            {
                var allRecordIDs = string.Join(", ", pendingYakapForms.Select(f => $"#{f.RecordID} (Status: {f.Status})"));
                Console.WriteLine($"Available RecordIDs in forms: {allRecordIDs}");
            }
        }
        
        return hasForm;
    }
    
    private async Task<bool> CheckYakapFormInDatabaseAsync(int recordID)
    {
        try
        {
            var response = await Http.GetAsync($"api/YakapForm/record/{recordID}");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Object)
                {
                    var options = new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    };
                    
                    var form = JsonSerializer.Deserialize<YakapFormModel>(data.GetRawText(), options);
                    if (form != null)
                    {
                        // Add to lists if not already there
                        if (!pendingYakapForms.Any(f => f.YakapFormID == form.YakapFormID))
                        {
                            pendingYakapForms.Add(form);
                        }
                        yakapFormsByRecordID[recordID] = form;
                        Console.WriteLine($"‚úì Found YAKAP form in database for RecordID {recordID}: Status = {form.Status}");
                        StateHasChanged();
                        return true;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking YAKAP form in database: {ex.Message}");
        }
        
        return false;
    }

    private async Task OpenYakapFormForCase(StudentProfileCaseRecordSummary caseRecord)
    {
        try
        {
            // Check if YAKAP form already exists for this RecordID
            var existingForm = pendingYakapForms.FirstOrDefault(f => f.RecordID == caseRecord.RecordID);
            
            if (existingForm != null)
            {
                // Open existing form
                Console.WriteLine($"Opening YAKAP form for RecordID {caseRecord.RecordID} - Status: {existingForm.Status}");
                await OpenYakapForm(existingForm);
                return;
            }

            // Check if form exists in database (might not be in pendingYakapForms)
            Console.WriteLine($"Form not in list, checking database for RecordID {caseRecord.RecordID}...");
            var response = await Http.GetAsync($"api/YakapForm/record/{caseRecord.RecordID}");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Object)
                {
                    var options = new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    };
                    
                    var form = JsonSerializer.Deserialize<YakapFormModel>(data.GetRawText(), options);
                    if (form != null)
                    {
                        // Add to lists if not already there
                        if (!pendingYakapForms.Any(f => f.YakapFormID == form.YakapFormID))
                        {
                            pendingYakapForms.Add(form);
                        }
                        yakapFormsByRecordID[caseRecord.RecordID] = form;
                        Console.WriteLine($"‚úì Found YAKAP form in database for RecordID {caseRecord.RecordID} - Status: {form.Status}");
                        await OpenYakapForm(form);
                        StateHasChanged(); // Refresh UI
                        return;
                    }
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"API returned {response.StatusCode}: {errorContent}");
            }

            // If no form exists, we can't create one from student side
            Console.WriteLine($"‚úó No YAKAP form found for RecordID: {caseRecord.RecordID}. Pod Ide needs to send it first.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error opening YAKAP form for case: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }
}


