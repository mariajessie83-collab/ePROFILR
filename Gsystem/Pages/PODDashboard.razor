@page "/pod-dashboard"
@layout Gsystem.Layout.PODLayout
@using System.Text.Json
@using System.Linq
@using SharedProject
@using Gsystem.Services
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@inject NavigationManager NavigationManager
@inject OfflineStorageService OfflineStorage
@using Gsystem.Pages.Components

<PageTitle>POD Dashboard - Incident Reports</PageTitle>

@if (isCheckingAuth)
{
    <div class="loading-overlay">
        <div class="spinner"></div>
        <p>Verifying access...</p>
    </div>
}
else if (isAuthenticated && isPODUser)
{
    <div class="pod-dashboard-container">
        <div class="pod-dashboard-header">      
            <h2>POD Dashboard</h2>
            <p>Manage and review incident reports and student case records</p>
        </div>

       

        @if (isLoading)
        {
            <div class="loading-overlay">
                <div class="spinner"></div>
                <p>Loading incident reports...</p>
            </div>
        }

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="snackbar @(isSuccess ? "snackbar-success" : "snackbar-error") @(showSnackbar ? "show" : "")">
                <span class="snackbar-icon">@(isSuccess ? "âœ“" : "âœ•")</span>
                <span class="snackbar-message">@message</span>
            </div>
        }



        <!-- Incident Reports Section with Folder Tabs -->
        <div class="folder-section">
            <div class="folder-header-row">
                <div class="folder-title-area">
                    <h3>Incident Reports</h3>
                    <p class="italic-guide">Review status categories to track student behavior progress.</p>
                </div>
                <div class="folder-tabs">
                    <button class="folder-tab @(activeTab == "Pending" ? "active" : "")" 
                            @onclick='() => SetActiveTab("Pending")'>
                        Pending
                        @if(pendingTabCount > 0)
                        {
                            <span class="tab-badge">@pendingTabCount</span>
                        }
                    </button>
                    <button class="folder-tab @(activeTab == "Approved" ? "active" : "")" 
                            @onclick='() => SetActiveTab("Approved")'>
                        Approved
                        @if(approvedTabCount > 0)
                        {
                            <span class="tab-badge">@approvedTabCount</span>
                        }
                    </button>
                    <button class="folder-tab @(activeTab == "Resolved" ? "active" : "")" 
                            @onclick='() => SetActiveTab("Resolved")'>
                        Resolved
                        @if(resolvedTabCount > 0)
                        {
                            <span class="tab-badge">@resolvedTabCount</span>
                        }
                    </button>

                </div>
            </div>

            <div class="folder-content">
                <div class="folder-toolbar">
                    <div class="search-sort-area">
                        <!-- Placeholder for future search/sort if needed -->
                    </div>
                    <div class="action-buttons toolbar-buttons d-flex gap-2">
                        <button class="btn btn-info btn-sm flex-shrink-0" @onclick="OpenGuideModal">
                            <i class="fa-solid fa-circle-info"></i> Guide
                        </button>
                        <button class="btn btn-outline-primary btn-sm flex-shrink-0" @onclick="RefreshReports">
                            <i class="fa-solid fa-arrows-rotate"></i> Refresh
                        </button>
                        <button class="btn btn-success btn-sm flex-shrink-0" @onclick="OpenAnnexADateModal">
                            <i class="fa-solid fa-download"></i> Annex A
                        </button>
                    </div>
                </div>

                @if (filteredIncidentReports != null && filteredIncidentReports.Count > 0)
                {
                    <div class="scroll-hint d-md-none text-muted mb-2 small text-center">
                        <i class="fa-solid fa-arrows-left-right"></i> Scroll table horizontally
                    </div>
                    <div class="reports-table-wrapper">
                        <table class="table table-hover aesthetic-table">
                            <thead>
                                <tr>
                                    <th>Incident Type</th>
                                    <th>Complainant</th>
                                    <th>Respondent</th>
                                    <th>Date Reported</th>
                                    <th>Status</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var report in filteredIncidentReports)
                                {
                                    <tr class="table-row-@report.Status?.ToLower().Replace(" ", "-")">
                                        <td data-label="Incident Type">
                                            <div class="d-flex flex-column">
                                                <span class="incident-type">
                                                    @(report.IncidentType == "Others" ? report.OtherIncidentType : report.IncidentType)
                                                </span>
                                                @if (!string.IsNullOrEmpty(report.LevelOfOffense))
                                                {
                                                    <span class="offense-badge @(report.LevelOfOffense == "Minor" ? "badge-minor" : report.LevelOfOffense == "Major" ? "badge-major" : "badge-neutral")">
                                                        @report.LevelOfOffense
                                                    </span>
                                                }
                                            </div>
                                        </td>
                                        <td data-label="Complainant">
                                            <div class="user-cell" @onclick='() => ShowDetailModal("Complainant", report.ComplainantName)'>
                                                <div class="user-avatar" style="background-color: @GetAvatarColor(report.ComplainantName)">
                                                    @GetInitials(report.ComplainantName)
                                                </div>
                                                <span class="user-name">@report.ComplainantName</span>
                                            </div>
                                        </td>
                                        <td data-label="Respondent">
                                            @if (string.IsNullOrEmpty(report.RespondentName))
                                            {
                                                <span class="text-muted">N/A</span>
                                            }
                                            else
                                            {
                                                var respondents = report.RespondentName.Split(new[] { "; ", ";" }, StringSplitOptions.RemoveEmptyEntries)
                                                    .Select(r => r.Trim())
                                                    .Where(r => !string.IsNullOrEmpty(r))
                                                    .ToArray();
                                                    
                                                if (respondents.Length > 0)
                                                {
                                                     <div class="user-cell" @onclick='() => HandleRespondentClick(report.RespondentName, respondents.Length)'>
                                                        <div class="user-avatar" style="background-color: @GetAvatarColor(respondents[0])">
                                                            @GetInitials(respondents[0])
                                                        </div>
                                                        <span class="user-name">
                                                            @respondents[0]
                                                            @if (respondents.Length > 1)
                                                            {
                                                                <span class="more-count">+@(respondents.Length - 1)</span>
                                                            }
                                                        </span>
                                                    </div>
                                                }
                                            }
                                        </td>
                                        <td class="text-muted" data-label="Date Reported">@report.DateReported.ToString("MMM dd, yyyy")</td>
                                        <td data-label="Status">
                                            <span class="status-pill @GetStatusCssClass(report.Status)">
                                                @FormatStatus(report.Status)
                                            </span>
                                        </td>
                                        <td data-label="Actions">
                                            <div class="action-cell">
                                                <button class="btn-icon" @onclick="() => OpenProgressModal(report)" title="View Details">
                                                    View
                                                </button>
                                                @if (incidentIdsWithCaseRecords.Contains(report.IncidentID))
                                                {
                                                    <button class="btn-icon-secondary" @onclick="() => OpenFormsModal(report.IncidentID, false)" title="Forms">
                                                        Forms
                                                    </button>
                                                }
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }

                else
                {
                    <div class="empty-state">
                        <div class="empty-icon">ðŸ“‚</div>
                        <p>No incident reports found in @activeTab tab.</p>
                    </div>
                }

            </div>
        </div>

        <!-- Escalated Minor Cases Section -->
        <div class="folder-section" style="margin-top: 40px;">
            <div class="folder-header-row">
                <div class="folder-title-area">
                    <h3>ðŸ“¤ Escalated Minor Cases</h3>
                    <p class="italic-guide">These students require POD intervention due to 3 or more minor violations recorded by teachers.</p>
                    <p class="text-muted small">Students sent by advisers (3+ minor offenses)</p>
                </div>
            </div>

            <div class="folder-content">
                @if (escalatedCases != null && escalatedCases.Count > 0)
                {
                    <div class="reports-table-wrapper">
                        <table class="table table-hover aesthetic-table">
                            <thead>
                                <tr>
                                    <th>Respondent</th>
                                    <th>School / Grade</th>
                                    <th>Case Details</th>
                                    <th class="text-center">Minor Cases</th>
                                    <th>Sent By</th>
                                    <th>Date Sent</th>
                                    <th class="text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var escalation in escalatedCases)
                                {
                                    <tr>
                                        <td data-label="Respondent">
                                            <div class="user-cell" @onclick='() => ShowDetailModal("Respondent", escalation.StudentName)'>
                                                <div class="user-avatar" style="background-color: @GetAvatarColor(escalation.StudentName)">
                                                    @GetInitials(escalation.StudentName)
                                                </div>
                                                <span class="user-name">@escalation.StudentName</span>
                                            </div>
                                        </td>
                                        <td data-label="School / Grade">
                                            <div class="d-flex flex-column">
                                                <span class="text-truncate" style="max-width: 150px;" title="@escalation.SchoolName">@(escalation.SchoolName ?? "N/A")</span>
                                                <span class="text-muted small">@escalation.GradeLevel - @escalation.Section</span>
                                            </div>
                                        </td>
                                        <td data-label="Case Details">
                                            <div class="truncate-cell text-muted small" style="max-width: 200px;" title="Click to view details" @onclick='() => ShowDetailModal("Case Details", escalation.CaseDetails ?? "No details provided")'>
                                                @(escalation.CaseDetails ?? "No details provided")
                                            </div>
                                        </td>
                                        <td class="text-center" data-label="Minor Cases">
                                            <span class="badge bg-light text-dark border">
                                                @escalation.MinorCaseCount cases
                                            </span>
                                        </td>
                                        <td class="small" data-label="Sent By">@escalation.EscalatedBy</td>
                                        <td class="text-muted small" data-label="Date Sent">@escalation.EscalatedDate.ToString("MMM dd, yyyy")</td>
                                        <td data-label="Actions">
                                            <div class="action-cell">
                                                <button class="btn-icon" @onclick="() => OpenEscalationModal(escalation)">
                                                    View
                                                </button>
                                                <button class="btn-icon-secondary" @onclick="() => OpenFormsModal(escalation.EscalationID, true)">
                                                    Forms
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <p>No escalated cases at this time.</p>
                    </div>
                }
            </div>
        </div>



        <!-- Forms Modal -->
        <Gsystem.Pages.Components.FormsModal 
            IsVisible="@showFormsModal" 
            IsVisibleChanged="@(val => showFormsModal = val)"
            IncidentId="@selectedIncidentIdForForms"
            IsEscalation="@isEscalationForForms"
            SimplifiedRecordId="@selectedSimplifiedRecordId"
            CurrentMeetingDate="@selectedMeetingDate"
            OnMeetingDateChanged="@(date => selectedMeetingDate = date)"
            OnRescheduleSuccess="@HandleRescheduleSuccess" />

        <!-- Annex A Date Selection Modal -->
        @if (showAnnexADateModal)
        {
            <div class="modal-backdrop">
                <div class="modal-content date-selection-modal">
                    <div class="modal-header">
                        <h3>Download Annex A</h3>
                        <p>Select the period you want to cover in the report</p>
                    </div>
                    <div class="modal-body">
                        <div class="form-group mb-3">
                            <label>Start Date</label>
                            <input type="date" class="form-control" @bind="annexAStartDate" />
                        </div>
                        <div class="form-group mb-3">
                            <label>End Date</label>
                            <input type="date" class="form-control" @bind="annexAEndDate" />
                        </div>
                    </div>
                    <div class="modal-footer d-flex gap-2 justify-content-end mt-4">
                        <button class="btn btn-secondary" @onclick="CloseAnnexADateModal">Cancel</button>
                        <button class="btn btn-success" @onclick="DownloadAnnexA">Confirm & Download</button>
                    </div>
                </div>
            </div>
        }

        <!-- Dashboard User Guide Modal -->
        @if (showGuideModal)
        {
            <div class="modal-backdrop" @onclick="CloseGuideModal">
                <div class="modal-content guide-modal" @onclick:stopPropagation="true">
                    <div class="modal-header">
                        <div class="header-content">
                            <i class="fa-solid fa-circle-question guide-header-icon"></i>
                            <div>
                                <h3>POD Dashboard Guide</h3>
                                <p>Learn how to manage incident reports and case records</p>
                            </div>
                        </div>
                        <button class="btn-close" @onclick="CloseGuideModal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="guide-grid">
                            <div class="guide-item">
                                <div class="guide-icon-wrapper blue">
                                    <i class="fa-solid fa-folder-open"></i>
                                </div>
                                <div class="guide-text">
                                    <h4>Managing Reports</h4>
                                    <ul>
                                        <li><strong>Pending:</strong> Newly submitted reports waiting for your initial review.</li>
                                        <li><strong>Approved:</strong> Cases currently being handled or under investigation.</li>
                                        <li><strong>Resolved:</strong> Successfully closed cases and official documentations.</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="guide-item">
                                <div class="guide-icon-wrapper orange">
                                    <i class="fa-solid fa-bolt"></i>
                                </div>
                                <div class="guide-text">
                                    <h4>Quick Actions</h4>
                                    <ul>
                                        <li><strong>View:</strong> Opens the case progress timeline and full incident details.</li>
                                        <li><strong>Forms:</strong> Quick access to parent call slips and official report papers.</li>
                                        <li><strong>Refresh:</strong> Click anytime to sync your dashboard with new submissions.</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="guide-item">
                                <div class="guide-icon-wrapper red">
                                    <i class="fa-solid fa-triangle-exclamation"></i>
                                </div>
                                <div class="guide-text">
                                    <h4>Escalated Minor Cases</h4>
                                    <ul>
                                        <li>The system automatically alerts you when a student reaches <strong>3 or more minor offenses</strong>.</li>
                                        <li>These cases require POD intervention even if they weren't individually "Major".</li>
                                    </ul>
                                </div>
                            </div>

                            <div class="guide-item">
                                <div class="guide-icon-wrapper green">
                                    <i class="fa-solid fa-file-export"></i>
                                </div>
                                <div class="guide-text">
                                    <h4>Reporting & Downloads</h4>
                                    <ul>
                                        <li><strong>Annex A:</strong> Generates the official summary report for your school.</li>
                                        <li>Select a <strong>Date Range</strong> before downloading to filter specific reporting periods.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <p class="italic-guide mt-3 text-center">*Tip: You can find this guide anytime by clicking the Guide button in the toolbar.*</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary w-100" @onclick="CloseGuideModal">Got it, Let's go!</button>
                    </div>
                </div>
            </div>
        }


    </div>
}
else if (isAuthenticated && !isPODUser)
{
    <div class="access-denied">
        <h2>Access Denied</h2>
        <p>You don't have permission to access the POD Dashboard.</p>
        <a href="/" class="btn btn-primary">Back to Home</a>
    </div>
}
else
{
    <div class="login-required">
        <h2>Login Required</h2>
        <p>Please log in to access the POD Dashboard.</p>
        <a href="/login/teacher" class="btn btn-primary">Teacher Login</a>
        
        <!-- Debug Info -->
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; font-size: 12px; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
            <h4 style="margin-top: 0;">Debug Information:</h4>
            <p><strong>AuthToken:</strong> <span id="debug-authToken">Loading...</span></p>
            <p><strong>Username:</strong> <span id="debug-username">Loading...</span></p>
            <p><strong>UserRole:</strong> <span id="debug-userRole">Loading...</span></p>
            <p><strong>UserPosition:</strong> <span id="debug-userPosition">Loading...</span></p>
            <p><strong>All localStorage keys:</strong> <span id="debug-allKeys">Loading...</span></p>
            <button class="btn btn-secondary" style="margin-top: 10px;" @onclick="RefreshDebugInfo">Refresh Debug Info</button>
        </div>
    </div>
}

@code {
    private List<IncidentReportSummary> incidentReports = new();
    private bool isLoading = false;
    private bool isSuccess = false;
    private string message = string.Empty;
    private bool showSnackbar = false;
    private System.Threading.Timer? snackbarTimer;
    private bool isAuthenticated = false;
    private bool isPODUser = false;
    private bool isCheckingAuth = true;  // Add loading state
    private string currentUser = string.Empty;
    private string userRole = string.Empty;
    private string activeTab = "Pending"; // Default tab
    private string? teacherSchoolName;
    private string respondentsListToShow = string.Empty;
    private bool showRespondentsModal = false;
    private bool showGuideModal = false;

    private void OpenGuideModal()
    {
        showGuideModal = true;
        StateHasChanged();
    }

    private void CloseGuideModal()
    {
        showGuideModal = false;
    }

    // Tab counts
    private int pendingTabCount => incidentReports.Count(r => 
                    (string.Equals(r.Status, "Pending", StringComparison.OrdinalIgnoreCase) || 
                     string.Equals(r.Status, "Reported", StringComparison.OrdinalIgnoreCase)) && 
                    !string.Equals(r.LevelOfOffense, "Minor", StringComparison.OrdinalIgnoreCase));
    private int approvedTabCount => incidentReports.Count(r => 
                    !string.Equals(r.Status, "Pending", StringComparison.OrdinalIgnoreCase) && 
                    !string.Equals(r.Status, "Resolved", StringComparison.OrdinalIgnoreCase) && 
                    !string.Equals(r.Status, "Closed", StringComparison.OrdinalIgnoreCase) &&
                    !string.Equals(r.Status, "Reported", StringComparison.OrdinalIgnoreCase) &&
                    !string.Equals(r.LevelOfOffense, "Minor", StringComparison.OrdinalIgnoreCase));
    private int resolvedTabCount => incidentReports.Count(r => 
                    (string.Equals(r.Status, "Resolved", StringComparison.OrdinalIgnoreCase) || 
                    string.Equals(r.Status, "Closed", StringComparison.OrdinalIgnoreCase)) &&
                    !string.Equals(r.LevelOfOffense, "Minor", StringComparison.OrdinalIgnoreCase));
    
    // Annex A Date Filter Modal
    private bool showAnnexADateModal = false;
    private DateTime annexAStartDate = new DateTime(DateTime.Now.Year, DateTime.Now.Month, 1);
    private DateTime annexAEndDate = DateTime.Now;
    
    private void OpenAnnexADateModal()
    {
        showAnnexADateModal = true;
        StateHasChanged();
    }

    private void CloseAnnexADateModal()
    {
        showAnnexADateModal = false;
    }
    
    // Forms Modal State
    private bool showFormsModal = false;
    private int selectedIncidentIdForForms = 0;
    private bool isEscalationForForms = false;
    private int? selectedSimplifiedRecordId = null;
    private DateTime? selectedMeetingDate = null;
    private HashSet<int> incidentIdsWithCaseRecords = new();





    // Escalated cases
    private List<SharedProject.CaseEscalation> escalatedCases = new();  
    
    // Escalation Modal state
    private bool showEscalationModal = false;
    private SharedProject.CaseEscalation? selectedEscalation;
    private List<SharedProject.StudentProfileCaseRecordSummary> escalationMinorCases = new();
    private bool isLoadingMinorCases = false;

    // Detail Modal state
    private bool showDetailModal = false;
    private string detailModalTitle = string.Empty;
    private string detailModalContent = string.Empty;

    // Part B Form state
    private bool showPartBModal = false;
    private string partBActionTaken = string.Empty;
    private string partBFindings = string.Empty;
    private string partBAgreement = string.Empty;
    private string partBPenaltyAction = string.Empty;
    private bool isSavingPartB = false;
    private int? currentPartBRecordId = null;

    // Part B Pre-defined Options
    private readonly List<string> actionTakenOptions = new()
    {
        "Conducted a conference with the student regarding the incident.",
        "Called the parents/guardians for a conference.",
        "Issued a verbal warning to the student.",
        "Issued a written warning to the student.",
        "Referred the student to the Guidance Office for counseling.",
        "Coordinated with the class adviser regarding the student's behavior.",
        "Conducted mediation between the parties involved.",
        "Documented the incident and filed a report.",
        "Requested a written explanation from the student.",
        "Scheduled a follow-up meeting with parents/guardians."
    };

    private readonly List<string> findingsOptions = new()
    {
        "The student admitted to the offense and expressed remorse.",
        "The student denied the allegations but evidence supports the claim.",
        "The incident was confirmed through witness testimonies.",
        "The student acknowledged the violation and agreed to cooperate.",
        "After investigation, the student was found liable for the offense.",
        "The student showed signs of behavioral issues that need attention.",
        "The offense was committed due to peer pressure.",
        "First-time offense with no prior record of similar behavior.",
        "Repeated offense despite previous warnings.",
        "The student's actions violated the school's code of conduct."
    };

    private readonly List<string> agreementOptions = new()
    {
        "The student agreed to follow all school rules and regulations.",
        "Parents/guardians committed to monitor the student's behavior at home.",
        "The student will undergo counseling sessions as recommended.",
        "The student agreed not to repeat the same offense.",
        "Parents/guardians will attend regular follow-up meetings with the school.",
        "The student will perform community service within the school.",
        "The student agreed to write a formal apology letter.",
        "Both parties agreed to reconcile and maintain peace.",
        "The student will be placed under probationary status.",
        "The student and parents agreed to the imposed sanctions."
    };

    private readonly List<string> penaltyActionOptions = new()
    {
        "Verbal warning - First offense.",
        "Written warning with parental notification.",
        "One (1) day suspension.",
        "Three (3) days suspension.",
        "Five (5) days suspension.",
        "One (1) week suspension.",
        "Community service for ___ hours.",
        "Probationary status for the remainder of the semester.",
        "Referral to Guidance Office for counseling.",
        "Conference with parents/guardians required before returning to class.",
        "Exclusion from extracurricular activities for ___ days/weeks.",
        "Recommendation for transfer/expulsion (for grave offenses)."
    };

    // Dropdown visibility state
    private string? activeDropdown = null;

    private void ToggleDropdown(string name)
    {
        if (activeDropdown == name)
            activeDropdown = null;
        else
            activeDropdown = name;
    }

    private void OpenPartBModal(int? incidentId = null)
    {
        showPartBModal = true;
    }

    private void ClosePartBModal()
    {
        showPartBModal = false;
        activeDropdown = null;
    }

    private void OnActionTakenSelected(ChangeEventArgs e)
    {
        var selected = e.Value?.ToString();
        if (!string.IsNullOrEmpty(selected))
        {
            if (string.IsNullOrEmpty(partBActionTaken))
            {
                partBActionTaken = selected;
            }
            else
            {
                partBActionTaken += " " + selected;
            }
            // Auto-hide dropdown after selection
            activeDropdown = null;
        }
    }

    private void OnFindingsSelected(ChangeEventArgs e)
    {
        var selected = e.Value?.ToString();
        if (!string.IsNullOrEmpty(selected))
        {
            if (string.IsNullOrEmpty(partBFindings))
            {
                partBFindings = selected;
            }
            else
            {
                partBFindings += " " + selected;
            }
            activeDropdown = null;
        }
    }

    private void OnAgreementSelected(ChangeEventArgs e)
    {
        var selected = e.Value?.ToString();
        if (!string.IsNullOrEmpty(selected))
        {
            if (string.IsNullOrEmpty(partBAgreement))
            {
                partBAgreement = selected;
            }
            else
            {
                partBAgreement += " " + selected;
            }
            activeDropdown = null;
        }
    }

    private void OnPenaltyActionSelected(ChangeEventArgs e)
    {
        var selected = e.Value?.ToString();
        if (!string.IsNullOrEmpty(selected))
        {
            if (string.IsNullOrEmpty(partBPenaltyAction))
            {
                partBPenaltyAction = selected;
            }
            else
            {
                partBPenaltyAction += " " + selected;
            }
            activeDropdown = null;
        }
    }

    private void ShowDetailModal(string title, string content)
    {
        detailModalTitle = title;
        detailModalContent = content;
        showDetailModal = true;
        StateHasChanged();
    }

    private void CloseDetailModal()
    {
        showDetailModal = false;
    }

    private void OpenFormsModal(int incidentId, bool isEscalation)
    {
        selectedIncidentIdForForms = incidentId;
        isEscalationForForms = isEscalation;
        selectedSimplifiedRecordId = null;
        selectedMeetingDate = null;
        showFormsModal = true;
        StateHasChanged();
    }

    private void OpenSimplifiedFormsModal(SimplifiedStudentProfileCaseRecordModel record)
    {
        selectedSimplifiedRecordId = record.RecordID;
        selectedMeetingDate = record.ParentMeetingDate;
        selectedIncidentIdForForms = 0;
        isEscalationForForms = false;
        showFormsModal = true;
        StateHasChanged();
    }

    private async Task HandleRescheduleSuccess()
    {
        // Refresh all relevant data lists to ensure background updates match
        await LoadIncidentReports();
        await LoadEscalatedCases();
        
        // Final state refresh
        StateHasChanged();
    }

    private async Task OpenSimplifiedFormsModalFromProgress(IncidentReportSummary report)
    {
        // Find the simplified record by incident ID
        try
        {
            var response = await Http.GetAsync($"api/StudentProfileCaseRecord/simplified-incident-id/{report.IncidentID}");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data))
                {
                    var record = System.Text.Json.JsonSerializer.Deserialize<SimplifiedStudentProfileCaseRecordModel>(
                        data.GetRawText(), 
                        new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    
                    if (record != null && record.RecordID > 0)
                    {
                        selectedSimplifiedRecordId = record.RecordID;
                        selectedMeetingDate = record.ParentMeetingDate;
                        currentPartBRecordId = record.RecordID;
                        // Pre-fill Part B fields if they exist
                        partBActionTaken = record.ActionTaken ?? string.Empty;
                        partBFindings = record.Findings ?? string.Empty;
                        partBAgreement = record.Agreement ?? string.Empty;
                        partBPenaltyAction = record.PenaltyAction ?? string.Empty;
                        selectedIncidentIdForForms = 0;
                        isEscalationForForms = false;
                        showFormsModal = true;
                        StateHasChanged();
                        return;
                    }
                }
            }
            await JSRuntime.InvokeVoidAsync("alert", "No case record found for this incident.");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error opening simplified forms modal: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", "Error loading case record.");
        }
    }

    private async Task MarkParentsArrived(int incidentId)
    {
        try
        {
            // Find the simplified record by incident ID and update status to UnderReview
            var response = await Http.GetAsync($"api/StudentProfileCaseRecord/simplified-incident-id/{incidentId}");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data))
                {
                    var record = System.Text.Json.JsonSerializer.Deserialize<SimplifiedStudentProfileCaseRecordModel>(
                        data.GetRawText(), 
                        new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    
                    if (record != null && record.RecordID > 0)
                    {
                        // Update to ParentOnHold status
                        var payload = new ParentMeetingUpdateRequest { Status = "ParentOnHold" };
                        var updateResponse = await Http.PutAsJsonAsync($"api/StudentProfileCaseRecord/simplified/{record.RecordID}/parent-meeting", payload);
                        
                        if (updateResponse.IsSuccessStatusCode)
                        {
                            // Also update the incident report status
                            await UpdateReportStatus(incidentId, "ParentOnHold");
                            await LoadIncidentReports();
                             
                            // Re-check the case record to update the modal
                            if (progressReport != null)
                            {
                                await CheckCaseRecordExists(progressReport);
                            }
                            
                            ShowSnackbar("Parents arrived - status updated to Parent On Hold", true);
                            return;
                        }
                    }
                }
            }
            ShowSnackbar("Failed to update status", false);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error marking parents arrived: {ex.Message}");
            ShowSnackbar("Error updating status", false);
        }
    }

    private async Task MarkEscalationParentsArrived(int escalationId)
    {
        try
        {
            // Find the simplified record by escalation ID and update status to UnderReview
            var response = await Http.GetAsync($"api/StudentProfileCaseRecord/simplified-escalation-id/{escalationId}");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data))
                {
                    var record = System.Text.Json.JsonSerializer.Deserialize<SimplifiedStudentProfileCaseRecordModel>(
                        data.GetRawText(), 
                        new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    
                    if (record != null && record.RecordID > 0)
                    {
                        // Update to ParentOnHold status
                        var payload = new ParentMeetingUpdateRequest { Status = "ParentOnHold" };
                        var updateResponse = await Http.PutAsJsonAsync($"api/StudentProfileCaseRecord/simplified/{record.RecordID}/parent-meeting", payload);
                        
                        if (updateResponse.IsSuccessStatusCode)
                        {
                            // Also update the escalation status
                            await UpdateEscalationStatus(escalationId, "ParentOnHold");
                            
                            ShowSnackbar("Parents arrived - status updated to Parent On Hold", true);
                            return;
                        }
                    }
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.NotFound)
            {
                // FALLBACK: If Part B record doesn't exist, we can still update the Escalation status directly.
                // Our backend EscalationService will now also sync to all related minor incidents!
                await UpdateEscalationStatus(escalationId, "ParentOnHold");
                ShowSnackbar("Parents arrived - status updated to Parent On Hold", true);
                return;
            }
            ShowSnackbar("Failed to update status", false);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error marking escalation parents arrived: {ex.Message}");
            ShowSnackbar("Error updating status", false);
        }
    }

    private async Task OpenSimplifiedFormsModalFromEscalation(int escalationId)
    {
        try
        {
            var response = await Http.GetAsync($"api/StudentProfileCaseRecord/simplified-escalation-id/{escalationId}");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data))
                {
                    var record = System.Text.Json.JsonSerializer.Deserialize<SimplifiedStudentProfileCaseRecordModel>(
                        data.GetRawText(), 
                        new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    
                    if (record != null && record.RecordID > 0)
                    {
                        selectedSimplifiedRecordId = record.RecordID;
                        selectedMeetingDate = record.ParentMeetingDate;
                        currentPartBRecordId = record.RecordID;
                        
                        // Pre-fill Part B fields
                        partBActionTaken = record.ActionTaken ?? string.Empty;
                        partBFindings = record.Findings ?? string.Empty;
                        partBAgreement = record.Agreement ?? string.Empty;
                        partBPenaltyAction = record.PenaltyAction ?? string.Empty;
                        
                        selectedIncidentIdForForms = 0;
                        isEscalationForForms = true;
                        showFormsModal = true;
                        StateHasChanged();
                        return;
                    }
                }
            }
            ShowSnackbar("No case record found for this escalation.", false);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error opening escalation forms modal: {ex.Message}");
            ShowSnackbar("Error loading case record.", false);
        }
    }

    private async Task SavePartBAndResolve()
    {
        if (!currentPartBRecordId.HasValue) 
        {
            ShowSnackbar("Error: No case record selected.", false);
            return;
        }

        isSavingPartB = true;
        StateHasChanged();
        
        try
        {
            // Update Part B fields and status to Resolved
            var payload = new
            {
                ActionTaken = partBActionTaken,
                Findings = partBFindings,
                Agreement = partBAgreement,
                PenaltyAction = partBPenaltyAction,
                Status = "Resolved"
            };
            
            var updateResponse = await Http.PutAsJsonAsync($"api/StudentProfileCaseRecord/simplified/{currentPartBRecordId.Value}/part-b", payload);
            
            if (updateResponse.IsSuccessStatusCode)
            {
                // Refresh both lists to ensure everything stays in sync
                await LoadIncidentReports();
                await LoadEscalatedCases();
                 
                // Clear Part B form
                partBActionTaken = string.Empty;
                partBFindings = string.Empty;
                partBAgreement = string.Empty;
                partBPenaltyAction = string.Empty;
                currentPartBRecordId = null;
                
                ClosePartBModal();
                ShowSnackbar("Case resolved successfully!", true);

                // If escalation modal is open, close it since it's resolved
                if (showEscalationModal)
                {
                    CloseEscalationModal();
                }
                // If progress modal is open, we might want to refresh it or close it
                if (showProgressModal)
                {
                    CloseProgressModal();
                }
            }
            else
            {
                ShowSnackbar("Failed to save resolution details.", false);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving Part B: {ex.Message}");
            ShowSnackbar("Error saving resolution details", false);
        }
        finally
        {
            isSavingPartB = false;
            StateHasChanged();
        }
    }
    
    private string GetAvatarColor(string name)
    {
        if (string.IsNullOrEmpty(name)) return "#ccc";
        var colors = new[] { "#FF6B6B", "#4ECDC4", "#45B7D1", "#96CEB4", "#FFEEAD", "#D4A5A5", "#9B59B6", "#3498DB" };
        int hash = name.Length;
        foreach(char c in name) hash += c;
        return colors[hash % colors.Length];
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) return "?";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length == 1) return parts[0][0].ToString().ToUpper();
        return $"{parts[0][0]}{parts[parts.Length - 1][0]}".ToUpper();
    }

    private void HandleRespondentClick(string names, int count)
    {
        if (count > 1) ShowRespondentsList(names);
        else ShowDetailModal("Respondent", names);
    }



    protected override async Task OnInitializedAsync()
    {
        // Add a small delay to ensure localStorage is available after navigation
        await Task.Delay(100);
        
        // Try checking authentication multiple times in case of timing issues
        int retryCount = 0;
        const int maxRetries = 3;
        
        while (retryCount < maxRetries && !isAuthenticated)
        {
            await CheckAuthentication();
            
            if (isAuthenticated && isPODUser)
            {
                break;
            }
            
            if (!isAuthenticated && retryCount < maxRetries - 1)
            {
                await Task.Delay(200); // Wait a bit before retrying
            }
            
            retryCount++;
        }
        
        if (isAuthenticated && isPODUser)
        {
            // Initialize IndexedDB first to create all stores including 'teachers'
            Console.WriteLine("ðŸ”„ [Dashboard] Initializing Offline Storage (IndexedDB)...");
            await OfflineStorage.InitializeAsync();
            Console.WriteLine("âœ… [Dashboard] Offline Storage Initialized.");
            
            await LoadIncidentReports();
            await LoadEscalatedCases();
             
            // Start background caching for offline use
            _ = CacheStudentsForOfflineUse();
            _ = CacheTeachersForOfflineUse();
        }
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Double-check authentication after first render
            await Task.Delay(100);
            await CheckAuthentication();
            await RefreshDebugInfo();
            StateHasChanged();
        }
    }
    
    private async Task RefreshDebugInfo()
    {
        try
        {
            var authToken = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");
            var username = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "username");
            var userRole = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userRole");
            var userPosition = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userPosition");
            var allKeys = await JSRuntime.InvokeAsync<string>("eval", "JSON.stringify(Object.keys(localStorage))");
            
            // Escape single quotes for JavaScript
            var authTokenJs = (authToken ?? "null").Replace("'", "\\'");
            var usernameJs = (username ?? "null").Replace("'", "\\'");
            var userRoleJs = (userRole ?? "null").Replace("'", "\\'");
            var userPositionJs = (userPosition ?? "null").Replace("'", "\\'");
            var allKeysJs = allKeys ?? "[]";
            
            await JSRuntime.InvokeVoidAsync("eval", $@"
                var authTokenEl = document.getElementById('debug-authToken');
                var usernameEl = document.getElementById('debug-username');
                var userRoleEl = document.getElementById('debug-userRole');
                var userPositionEl = document.getElementById('debug-userPosition');
                var allKeysEl = document.getElementById('debug-allKeys');
                
                if (authTokenEl) authTokenEl.textContent = '{authTokenJs}';
                if (usernameEl) usernameEl.textContent = '{usernameJs}';
                if (userRoleEl) userRoleEl.textContent = '{userRoleJs}';
                if (userPositionEl) userPositionEl.textContent = '{userPositionJs}';
                if (allKeysEl) allKeysEl.textContent = {allKeysJs};
            ");
        }
        catch
        {
            // Silently handle error
        }
    }

    private async Task CheckAuthentication()
    {
        try
        {
            // Check all localStorage items
            var authToken = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");
            currentUser = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "username");
            var teacherNameFromStorage = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "teacherName");
            userRole = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userRole");
            var userPosition = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userPosition");
            
            // Normalize position: trim whitespace and handle case-insensitive comparison
            var normalizedPosition = userPosition?.Trim() ?? string.Empty;
            var normalizedRole = userRole?.Trim() ?? string.Empty;
            
            if (!string.IsNullOrEmpty(authToken) && !string.IsNullOrEmpty(currentUser))
            {
                isAuthenticated = true;
                
                // Case-insensitive comparison for both role and position
                bool isTeacherRole = normalizedRole.Equals("teacher", StringComparison.OrdinalIgnoreCase);
                bool isPODPosition = normalizedPosition.Equals("POD", StringComparison.OrdinalIgnoreCase);
                
                isPODUser = isTeacherRole && isPODPosition;
            }
            else
            {
                isAuthenticated = false;
                isPODUser = false;
            }
        }
        catch
        {
            isAuthenticated = false;
            isPODUser = false;
        }
        finally
        {
            isCheckingAuth = false;  // Set to false after check completes
        }
    }

    private async Task LoadIncidentReports()
    {
        isLoading = true;
        try
        {
            // First, get the POD user's location information
            string? schoolName = null, division = null, region = null, district = null;
            
            if (!string.IsNullOrEmpty(currentUser))
            {
                try
                {
                    var locationResponse = await Http.GetAsync($"api/IncidentReport/pod-location/{currentUser}");
                    if (locationResponse.IsSuccessStatusCode)
                    {
                        var locationContent = await locationResponse.Content.ReadAsStringAsync();
                        var locationResult = JsonSerializer.Deserialize<JsonElement>(locationContent);
                        
                        if (locationResult.TryGetProperty("success", out var locSuccess) && locSuccess.GetBoolean() &&
                            locationResult.TryGetProperty("data", out var locData))
                        {
                            schoolName = locData.TryGetProperty("schoolName", out var sn) ? sn.GetString() : null;
                            teacherSchoolName = schoolName;
                            division = locData.TryGetProperty("division", out var div) ? div.GetString() : null;
                            region = locData.TryGetProperty("region", out var reg) ? reg.GetString() : null;
                            district = locData.TryGetProperty("district", out var dist) ? dist.GetString() : null;
                        }
                    }
                }
                catch
                {
                    // Silently handle location fetch error
                }
            }
            
            // Build the API URL with location filters
            var apiUrl = "api/IncidentReport";
            var queryParams = new List<string>();
            
            // Filter by school to ensure POD only sees their school's incident reports
            if (!string.IsNullOrEmpty(schoolName))
            {
                queryParams.Add($"schoolName={Uri.EscapeDataString(schoolName)}");
            }
                
            if (queryParams.Count > 0)
            {
                apiUrl += "?" + string.Join("&", queryParams);
            }
            
            var response = await Http.GetAsync(apiUrl);
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data))
                {
                    // Parse the JSON array manually to handle property name differences
                    incidentReports = new List<IncidentReportSummary>();
                    
                    if (data.ValueKind == JsonValueKind.Array)
                    {
                        foreach (var reportElement in data.EnumerateArray())
                        {
                            var report = new IncidentReportSummary();
                            
                            if (reportElement.TryGetProperty("incidentID", out var incidentId))
                                report.IncidentID = incidentId.GetInt32();
                            if (reportElement.TryGetProperty("complainantName", out var complainantName))
                                report.ComplainantName = complainantName.GetString() ?? "";
                            if (reportElement.TryGetProperty("victimName", out var victimName))
                                report.VictimName = victimName.GetString() ?? "";
                            if (reportElement.TryGetProperty("respondentName", out var respondentName))
                                report.RespondentName = respondentName.GetString() ?? "";
                            if (reportElement.TryGetProperty("dateReported", out var dateReported))
                                report.DateReported = DateTime.Parse(dateReported.GetString() ?? "");
                            if (reportElement.TryGetProperty("status", out var status))
                                report.Status = status.GetString() ?? "";
                            if (reportElement.TryGetProperty("incidentType", out var incType))
                                report.IncidentType = incType.GetString() ?? "";
                            if (reportElement.TryGetProperty("otherIncidentType", out var otherType))
                                report.OtherIncidentType = otherType.GetString() ?? "";
                            if (reportElement.TryGetProperty("levelOfOffense", out var level))
                                report.LevelOfOffense = level.GetString() ?? "";
                            if (reportElement.TryGetProperty("schoolName", out var school))
                                report.SchoolName = school.GetString() ?? "";
                            if (reportElement.TryGetProperty("division", out var div))
                                report.Division = div.GetString() ?? "";
                            if (reportElement.TryGetProperty("region", out var reg))
                                report.Region = reg.GetString() ?? "";
                            if (reportElement.TryGetProperty("district", out var dist))
                                report.District = dist.GetString() ?? "";
                            if (reportElement.TryGetProperty("incidentDescription", out var incidentDesc))
                                report.IncidentDescription = incidentDesc.GetString() ?? "";
                            if (reportElement.TryGetProperty("evidencePhotoBase64", out var evidencePhoto))
                                report.EvidencePhotoBase64 = evidencePhoto.GetString();
                            
                            incidentReports.Add(report);
                        }
                    }
                    
                    // Sort: Pending first, then by date (newest first)
                    incidentReports = incidentReports
                        .OrderBy(r => GetStatusSortOrder(r.Status))
                        .ThenByDescending(r => r.DateReported)
                        .ToList();
                    

                    await LoadIncidentIdsWithCaseRecords();
                }
            }
            else
            {
                message = $"Error loading incident reports: {response.StatusCode}";
                isSuccess = false;
            }
            
        }
        catch (Exception ex)
        {
            message = $"Error loading incident reports: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isLoading = false;
        }
    }







    private async Task LoadIncidentIdsWithCaseRecords()
    {
        try
        {
            var response = await Http.GetAsync("api/StudentProfileCaseRecord/incident-ids");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                {
                    incidentIdsWithCaseRecords = data.EnumerateArray()
                        .Select(x => x.GetInt32())
                        .ToHashSet();
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading incident IDs with case records: {ex.Message}");
        }
    }



    private int GetStatusSortOrder(string? status)
    {
        // Lower number = higher priority (shown first)
        return status?.ToLower().Trim() switch
        {
            "pending" => 1,
            "reported" => 1,
            "approved" => 2,
            "calling" => 3,
            "arrived" => 4,
            "parentonhold" => 5,
            "underreview" => 6,
            "under review" => 6,
            "resolved" => 98,
            "closed" => 99,
            _ => 50 // Default for any unspecified status
        };
    }

    private string FormatStatus(string? status)
    {
        if (string.IsNullOrEmpty(status)) return "Unknown";
        
        return status.ToLower() switch
        {
            "underreview" => "Under Review",
            "parentonhold" => "Parent On Hold",
            "under review" => "Under Review",
            "parent on hold" => "Parent On Hold",
            _ => status
        };
    }

    private string GetStatusCssClass(string? status)
    {
        if (string.IsNullOrEmpty(status)) return "status-unknown";
        
        return status.ToLower() switch
        {
            "underreview" => "status-under-review",
            "parentonhold" => "status-parent-on-hold",
            _ => $"status-{status.ToLower().Replace(" ", "-")}"
        };
    }
    private List<IncidentReportSummary> filteredIncidentReports
    {
        get
        {
            if (incidentReports == null) return new List<IncidentReportSummary>();

            return activeTab switch
            {
                "Pending" => incidentReports.Where(r => 
                    (string.Equals(r.Status, "Pending", StringComparison.OrdinalIgnoreCase) ||
                     string.Equals(r.Status, "Reported", StringComparison.OrdinalIgnoreCase)) &&
                    !string.Equals(r.LevelOfOffense, "Minor", StringComparison.OrdinalIgnoreCase)).ToList(),
                
                "Approved" => incidentReports.Where(r => 
                    !string.Equals(r.Status, "Pending", StringComparison.OrdinalIgnoreCase) && 
                    !string.Equals(r.Status, "Resolved", StringComparison.OrdinalIgnoreCase) && 
                    !string.Equals(r.Status, "Closed", StringComparison.OrdinalIgnoreCase) &&
                    !string.Equals(r.Status, "Reported", StringComparison.OrdinalIgnoreCase) &&
                    !string.Equals(r.LevelOfOffense, "Minor", StringComparison.OrdinalIgnoreCase)).ToList(),
                
                "Resolved" => incidentReports.Where(r => 
                    (string.Equals(r.Status, "Resolved", StringComparison.OrdinalIgnoreCase) || 
                    string.Equals(r.Status, "Closed", StringComparison.OrdinalIgnoreCase)) &&
                    !string.Equals(r.LevelOfOffense, "Minor", StringComparison.OrdinalIgnoreCase)).ToList(),
                
                _ => incidentReports // Should not happen
            };
        }
    }

    private void SetActiveTab(string tabName)
    {
        activeTab = tabName;
        StateHasChanged();
    }

    private async Task RefreshReports()
    {
        await LoadIncidentReports();
        await LoadEscalatedCases();
         
        message = "Reports refreshed successfully";
        isSuccess = true;
    }

    private async Task DownloadAnnexA()
    {
        try
        {
            showAnnexADateModal = false;
            StateHasChanged();

            var startStr = annexAStartDate.ToString("yyyy-MM-dd");
            var endStr = annexAEndDate.ToString("yyyy-MM-dd");
            var schoolParam = !string.IsNullOrEmpty(teacherSchoolName) ? $"&schoolName={Uri.EscapeDataString(teacherSchoolName)}" : "";

            // Use activeTab to filter Annex A download if needed, or pass empty status to get all for the date range
            // Currently keeping original behavior or passing activeTab as status? 
            // The requirement was just for the UI tabs. Let's pass empty status to get all within date range, 
            // OR if the user wants to download Annex A only for the current tab, we map "activeTab" to status.
            // But "Approved" maps to multiple statuses. Let's send empty status to get EVERYTHING for dhe date range, 
            // which is usually what Annex A is (a summary).
            var url = $"api/StudentProfileCaseRecord/annex-a-pdf?status={schoolParam}&startDate={startStr}&endDate={endStr}";
            var fileName = $"AnnexA_Report_{DateTime.Now:yyyyMMdd}.pdf";
            
            var response = await Http.GetAsync(url);
            if (response.IsSuccessStatusCode)
            {
                var bytes = await response.Content.ReadAsByteArrayAsync();
                var base64 = Convert.ToBase64String(bytes);
                await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
                
                message = "Annex A Downloaded successfully";
                isSuccess = true;
                showSnackbar = true;
                StateHasChanged();
            }
            else
            {
                message = $"Failed to download Annex A: {response.StatusCode}";
                isSuccess = false;
                showSnackbar = true;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            message = $"Error downloading Annex A: {ex.Message}";
            isSuccess = false;
            showSnackbar = true;
            StateHasChanged();
        }
    }

    private async Task LoadEscalatedCases()
    {
        try
        {
            // Get POD user's school information
            string? schoolName = null;
            
            if (!string.IsNullOrEmpty(currentUser))
            {
                try
                {
                    var locationResponse = await Http.GetAsync($"api/IncidentReport/pod-location/{currentUser}");
                    if (locationResponse.IsSuccessStatusCode)
                    {
                        var locationContent = await locationResponse.Content.ReadAsStringAsync();
                        var locationResult = JsonSerializer.Deserialize<JsonElement>(locationContent);
                        
                        if (locationResult.TryGetProperty("success", out var locSuccess) && locSuccess.GetBoolean() &&
                            locationResult.TryGetProperty("data", out var locData))
                        {
                            schoolName = locData.TryGetProperty("schoolName", out var sn) ? sn.GetString() : null;
                        }
                    }
                }
                catch
                {
                    // Silently handle location fetch error
                }
            }

            var apiUrl = "api/Escalation/pod";
            
            // Filter escalated cases by school
            if (!string.IsNullOrEmpty(schoolName))
            {
                apiUrl += $"?schoolName={Uri.EscapeDataString(schoolName)}";
            }
            
            var response = await Http.GetAsync(apiUrl);
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                {
                    escalatedCases = new List<SharedProject.CaseEscalation>();
                    
                    foreach (var escalationElement in data.EnumerateArray())
                    {
                        var escalation = new SharedProject.CaseEscalation();
                        
                        if (escalationElement.TryGetProperty("escalationID", out var escalationId))
                            escalation.EscalationID = escalationId.GetInt32();
                        if (escalationElement.TryGetProperty("studentName", out var studentName))
                            escalation.StudentName = studentName.GetString() ?? "";
                        if (escalationElement.TryGetProperty("gradeLevel", out var gradeLevel))
                            escalation.GradeLevel = gradeLevel.GetString() ?? "";
                        if (escalationElement.TryGetProperty("section", out var section))
                            escalation.Section = section.GetString() ?? "";
                        if (escalationElement.TryGetProperty("minorCaseCount", out var minorCaseCount))
                            escalation.MinorCaseCount = minorCaseCount.GetInt32();
                        if (escalationElement.TryGetProperty("escalatedBy", out var escalatedBy))
                            escalation.EscalatedBy = escalatedBy.GetString() ?? "";
                        if (escalationElement.TryGetProperty("escalatedDate", out var escalatedDate))
                            escalation.EscalatedDate = DateTime.Parse(escalatedDate.GetString() ?? "");
                        if (escalationElement.TryGetProperty("status", out var status))
                        {
                            // Handle both string and number (enum value) from JSON
                            if (status.ValueKind == JsonValueKind.String)
                            {
                                escalation.Status = Enum.Parse<EscalationStatus>(status.GetString() ?? "Active");
                            }
                            else if (status.ValueKind == JsonValueKind.Number)
                            {
                                escalation.Status = (EscalationStatus)status.GetInt32();
                            }
                            else
                            {
                                escalation.Status = EscalationStatus.Active; // Default fallback
                            }
                        }
                        if (escalationElement.TryGetProperty("caseDetails", out var caseDetails))
                            escalation.CaseDetails = caseDetails.GetString() ?? "";
                        if (escalationElement.TryGetProperty("schoolName", out var sName))
                            escalation.SchoolName = sName.GetString() ?? "";
                            escalatedCases.Add(escalation);
                    }
                }
            }
            
            Console.WriteLine($"[DEBUG] Loaded {escalatedCases.Count} escalated cases");
            if (escalatedCases.Count == 0)
            {
                Console.WriteLine("[DEBUG] No escalated cases found. Check:");
                Console.WriteLine("[DEBUG] 1. Is there data in CaseEscalations table?");
                Console.WriteLine("[DEBUG] 2. Are the statuses correct? (Active, Calling, Arrived)");
                Console.WriteLine("[DEBUG] 3. Is the server running the latest code?");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading escalated cases: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    private void ViewEscalatedCases(SharedProject.CaseEscalation escalation)
    {
        // Navigate to case records page filtered by this student
        NavigationManager.NavigateTo("/case-records-dashboard");
    }

    private void CreateProfileFromEscalation(SharedProject.CaseEscalation escalation)
    {
        var queryParams = new List<string>();
        if (!string.IsNullOrEmpty(escalation.StudentName)) queryParams.Add($"respondentName={Uri.EscapeDataString(escalation.StudentName)}");
        if (!string.IsNullOrEmpty(escalation.GradeLevel)) queryParams.Add($"gradeLevel={Uri.EscapeDataString(escalation.GradeLevel)}");
        if (!string.IsNullOrEmpty(escalation.Section)) queryParams.Add($"section={Uri.EscapeDataString(escalation.Section)}");
        if (!string.IsNullOrEmpty(escalation.TrackStrand)) queryParams.Add($"trackStrand={Uri.EscapeDataString(escalation.TrackStrand)}");
        if (!string.IsNullOrEmpty(escalation.SchoolName)) queryParams.Add($"schoolName={Uri.EscapeDataString(escalation.SchoolName)}");
        
        // Auto-fill Violation Committed with the specific list of offenses (as requested)
        // Previous value "Accumulated 3 Minor Offenses" was rejected by user in favor of the list
        if (!string.IsNullOrEmpty(escalation.CaseDetails))
        {
             queryParams.Add($"violationType={Uri.EscapeDataString(escalation.CaseDetails)}");
        }
        else
        {
             queryParams.Add($"violationType={Uri.EscapeDataString("Accumulated 3 Minor Offenses")}");
        }
        
        // Format Incident Description (Restoring prefix as per original request)
        if (!string.IsNullOrEmpty(escalation.CaseDetails)) 
        {
            var formattedDescription = $"Accumulated the following minor offenses: {escalation.CaseDetails}";
            queryParams.Add($"caseDetails={Uri.EscapeDataString(formattedDescription)}");
        }
        
        queryParams.Add($"escalationId={escalation.EscalationID}");
        
        var url = $"/simplified-case-record?{string.Join("&", queryParams)}";
        NavigationManager.NavigateTo(url);
    }

    private async Task OpenEscalationModal(SharedProject.CaseEscalation escalation)
    {
        selectedEscalation = escalation;
        showEscalationModal = true;
        
        // Reset Part B fields
        partBActionTaken = string.Empty;
        partBFindings = string.Empty;
        partBAgreement = string.Empty;
        partBPenaltyAction = string.Empty;
        currentPartBRecordId = null;

        // Try to fetch simplified case record to populate Part B
        try 
        {
            var response = await Http.GetAsync($"api/StudentProfileCaseRecord/simplified-escalation-id/{escalation.EscalationID}");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(content);
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data))
                {
                    var record = System.Text.Json.JsonSerializer.Deserialize<SimplifiedStudentProfileCaseRecordModel>(
                        data.GetRawText(), 
                        new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    
                    if (record != null)
                    {
                        currentPartBRecordId = record.RecordID;
                        partBActionTaken = record.ActionTaken ?? string.Empty;
                        partBFindings = record.Findings ?? string.Empty;
                        partBAgreement = record.Agreement ?? string.Empty;
                        partBPenaltyAction = record.PenaltyAction ?? string.Empty;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching case record for escalation: {ex.Message}");
        }

        await LoadStudentMinorCases(escalation.StudentName);
        await FetchEscalationCallSlipData(escalation.EscalationID);
    }
    
    private void CloseEscalationModal()
    {
        showEscalationModal = false;
        selectedEscalation = null;
        escalationMinorCases.Clear();
    }
    
    private async Task LoadStudentMinorCases(string studentName)
    {
        if (string.IsNullOrWhiteSpace(studentName)) return;
        
        isLoadingMinorCases = true;
        escalationMinorCases.Clear();
        
        try
        {
            var response = await Http.GetAsync($"api/StudentProfileCaseRecord/respondent/{Uri.EscapeDataString(studentName)}");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                {
                    foreach (var item in data.EnumerateArray())
                    {
                        // Filter for Minor cases only
                        var levelOfOffense = item.TryGetProperty("levelOfOffense", out var level) ? level.GetString() : "";
                        
                        if (string.Equals(levelOfOffense, "Minor", StringComparison.OrdinalIgnoreCase))
                        {
                            var record = new SharedProject.StudentProfileCaseRecordSummary();
                            if (item.TryGetProperty("recordID", out var id)) record.RecordID = id.GetInt32();
                            if (item.TryGetProperty("studentOffenderName", out var name)) record.StudentOffenderName = name.GetString() ?? "";
                            if (item.TryGetProperty("violationCommitted", out var violation)) record.ViolationCommitted = violation.GetString() ?? "";
                            if (item.TryGetProperty("dateOfOffense", out var date)) record.DateOfOffense = DateTime.Parse(date.GetString() ?? "");
                            if (item.TryGetProperty("detailsOfAgreement", out var details)) record.DetailsOfAgreement = details.GetString() ?? "";
                            if (item.TryGetProperty("status", out var status)) record.Status = status.GetString() ?? "";
                            
                            escalationMinorCases.Add(record);
                        }
                    }
                    
                }
            }

            // Also fetch Incident Reports for this student - they also contribute to escalation count
            var incidentResponse = await Http.GetAsync($"api/IncidentReport/by-respondent/{Uri.EscapeDataString(studentName)}");
            if (incidentResponse.IsSuccessStatusCode)
            {
                var content = await incidentResponse.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                {
                    foreach (var item in data.EnumerateArray())
                    {
                        // Check if it's a Minor case
                        var levelOfOffense = item.TryGetProperty("levelOfOffense", out var level) ? level.GetString() : "";
                        
                        if (string.Equals(levelOfOffense, "Minor", StringComparison.OrdinalIgnoreCase))
                        {
                            var incidentId = item.GetProperty("incidentID").GetInt32();
                            
                            // Check if we already added a CaseRecord linked to this IncidentID
                            if (escalationMinorCases.Any(c => c.IncidentID == incidentId))
                                continue;

                            var record = new SharedProject.StudentProfileCaseRecordSummary();
                            record.RecordID = -incidentId; // Use negative ID to distinguish from CaseRecords
                            record.IncidentID = incidentId;
                            if (item.TryGetProperty("respondentName", out var name)) record.StudentOffenderName = name.GetString() ?? "";
                            if (item.TryGetProperty("incidentType", out var type)) record.ViolationCommitted = type.GetString() ?? "";
                            if (item.TryGetProperty("dateReported", out var date)) record.DateOfOffense = DateTime.Parse(date.GetString() ?? "");
                            if (item.TryGetProperty("incidentDescription", out var desc)) record.DetailsOfAgreement = desc.GetString() ?? ""; // Use description as details
                            if (item.TryGetProperty("status", out var status)) record.Status = status.GetString() ?? "";
                            
                            escalationMinorCases.Add(record);
                        }
                    }
                }
            }
            
            // Sort by date descending
            escalationMinorCases = escalationMinorCases.OrderByDescending(c => c.DateOfOffense).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading minor cases: {ex.Message}");
        }
        finally
        {
            isLoadingMinorCases = false;
            StateHasChanged();
        }
    }

    private int GetRespondentCount(string? respondentName)
    {
        if (string.IsNullOrEmpty(respondentName))
            return 0;
        
        var respondents = respondentName.Split(new[] { ", ", "," }, StringSplitOptions.RemoveEmptyEntries)
            .Select(r => r.Trim())
            .Where(r => !string.IsNullOrEmpty(r))
            .ToArray();
        return respondents.Length;
    }

    private void ShowRespondentsList(string respondentNames)
    {
        respondentsListToShow = respondentNames;
        showRespondentsModal = true;
        StateHasChanged();
    }

    private void CloseRespondentsModal()
    {
        showRespondentsModal = false;
        respondentsListToShow = null;
        StateHasChanged();
    }

    private void ShowSnackbar(string msg, bool success)
    {
        message = msg;
        isSuccess = success;
        showSnackbar = true;
        StateHasChanged();
        
        // Dispose existing timer if any
        snackbarTimer?.Dispose();
        
        // Auto-hide after 3 seconds
        snackbarTimer = new System.Threading.Timer(_ =>
        {
            showSnackbar = false;
            message = string.Empty;
            InvokeAsync(StateHasChanged);
        }, null, 3000, Timeout.Infinite);
    }

    private void ViewReport(int incidentId)
    {
        NavigationManager.NavigateTo($"/incident-report/{incidentId}");
    }

    // Progress Modal state & helpers
    private bool showProgressModal = false;
    private IncidentReportSummary? progressReport;
    private bool hasCaseRecord = false;
    private int? caseRecordId = null;
    private List<CaseRecordInfo> caseRecordsList = new();
    private CallSlipModel? currentCallSlip = null;
    private bool showResolutionDetails = false;
    
    // Respondents List Modal
    
    // Evidence Modal
    private bool showEvidenceModal = false;
    private bool isPhotoBlurred = true;
    
    // Helper class to store case record info
    private class CaseRecordInfo
    {
        public int RecordId { get; set; }
        public string StudentName { get; set; } = string.Empty;
    }

    private async Task OpenProgressModal(IncidentReportSummary report)
    {
        progressReport = report;
        showProgressModal = true;
        showResolutionDetails = false; // Always reset when opening
        
        // Clear Part B fields to prevent leakage from previous modals
        partBActionTaken = string.Empty;
        partBFindings = string.Empty;
        partBAgreement = string.Empty;
        partBPenaltyAction = string.Empty;
        
        await CheckCaseRecordExists(report);
        await FetchCallSlipData(report.IncidentID);
        
        // Load Part B fields if status is UnderReview or ParentOnHold
        var status = report.Status?.Trim() ?? "";
        if (string.Equals(status, "UnderReview", StringComparison.OrdinalIgnoreCase) ||
            string.Equals(status, "Under Review", StringComparison.OrdinalIgnoreCase) ||
            string.Equals(status, "ParentOnHold", StringComparison.OrdinalIgnoreCase) ||
            string.Equals(status, "Resolved", StringComparison.OrdinalIgnoreCase))
        {
            await LoadPartBFields(report.IncidentID);
        }
    }

    private async Task LoadPartBFields(int incidentId)
    {
        try
        {
            var response = await Http.GetAsync($"api/StudentProfileCaseRecord/simplified-incident-id/{incidentId}");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data))
                {
                    var record = System.Text.Json.JsonSerializer.Deserialize<SimplifiedStudentProfileCaseRecordModel>(
                        data.GetRawText(), 
                        new System.Text.Json.JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    
                    if (record != null)
                    {
                        currentPartBRecordId = record.RecordID;
                        partBActionTaken = record.ActionTaken ?? string.Empty;
                        partBFindings = record.Findings ?? string.Empty;
                        partBAgreement = record.Agreement ?? string.Empty;
                        partBPenaltyAction = record.PenaltyAction ?? string.Empty;
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading Part B fields: {ex.Message}");
        }
    }

    private async Task FetchCallSlipData(int incidentId)
    {
        currentCallSlip = null;
        try
        {
            var response = await Http.GetAsync($"api/CallSlip/incident/{incidentId}");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                {
                    var callSlips = data.EnumerateArray();
                    if (callSlips.Any())
                    {
                        // Get the most recent call slip (first one, as they're sorted by GeneratedDate DESC)
                        var callSlipElement = callSlips.First();
                        currentCallSlip = new CallSlipModel
                        {
                            CallSlipID = callSlipElement.TryGetProperty("callSlipID", out var id) ? id.GetInt32() : 0,
                            IncidentID = callSlipElement.TryGetProperty("incidentID", out var incId) ? incId.GetInt32() : 0,
                            MeetingDate = callSlipElement.TryGetProperty("meetingDate", out var meetDate) && meetDate.ValueKind != JsonValueKind.Null 
                                ? meetDate.GetDateTime() : DateTime.MinValue
                        };
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching call slip: {ex.Message}");
        }
    }

    private async Task CacheTeachersForOfflineUse()
    {
        try
        {
            // 1. Get School Name from API location (more reliable than local storage)
            string? schoolName = null;
            if (!string.IsNullOrEmpty(currentUser))
            {
                var locationResponse = await Http.GetAsync($"api/IncidentReport/pod-location/{currentUser}");
                if (locationResponse.IsSuccessStatusCode)
                {
                    var content = await locationResponse.Content.ReadAsStringAsync();
                    var result = JsonSerializer.Deserialize<JsonElement>(content);
                    
                    if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                        result.TryGetProperty("data", out var data))
                    {
                        schoolName = data.TryGetProperty("schoolName", out var sn) ? sn.GetString() : null;
                    }
                }
            }
            
            // Fallback to localStorage
            if (string.IsNullOrEmpty(schoolName))
            {
                schoolName = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "schoolName");
            }

            if (string.IsNullOrEmpty(schoolName)) return;

            // 2. Fetch Teachers
            var response = await Http.GetAsync($"api/IncidentReport/teachers-by-location?schoolName={Uri.EscapeDataString(schoolName)}");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                {
                    var teachersToCache = new List<TeacherSearchResult>();
                    foreach (var item in data.EnumerateArray())
                    {
                        var position = "";
                        if (item.TryGetProperty("position", out var pos)) position = pos.GetString() ?? "";
                        
                        // FILTER: Only cache Teachers/Advisers. 
                        // Exclude POD, GUIDANCE, OFFICER, etc.
                        var posUpper = position.ToUpper();
                        if (posUpper.Contains("POD") || posUpper.Contains("GUIDANCE") || posUpper.Contains("OFFICER"))
                        {
                            continue;
                        }

                        var teacher = new TeacherSearchResult();
                        if (item.TryGetProperty("teacherID", out var tid)) teacher.TeacherID = tid.GetInt32();
                        else if (item.TryGetProperty("id", out var id)) teacher.TeacherID = id.GetInt32();
                        
                        if (item.TryGetProperty("teacherName", out var name)) teacher.TeacherName = name.GetString() ?? "";
                        teacher.Position = position;
                        
                        if (item.TryGetProperty("schoolName", out var sn)) teacher.SchoolName = sn.GetString() ?? "";
                        if (item.TryGetProperty("gradeHandle", out var gh)) teacher.GradeHandle = gh.GetString() ?? "";
                        if (item.TryGetProperty("sectionHandle", out var sh)) teacher.SectionHandle = sh.GetString() ?? "";
                        
                        teachersToCache.Add(teacher);
                    }
                    
                    if (teachersToCache.Any())
                    {
                        await OfflineStorage.SaveTeachersAsync(teachersToCache);
                        Console.WriteLine($"âœ… [Dashboard] Cached {teachersToCache.Count} teachers (Advisers) for offline use.");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âš ï¸ [Dashboard] Failed to cache teachers: {ex.Message}");
        }
    }

    private async Task CacheStudentsForOfflineUse()
    {
        try
        {
            // 1. Get School Name from API location (more reliable than local storage)
            string? schoolName = null;
            string? division = null;
            string? region = null;
            string? district = null;

            if (!string.IsNullOrEmpty(currentUser))
            {
                var locationResponse = await Http.GetAsync($"api/IncidentReport/pod-location/{currentUser}");
                if (locationResponse.IsSuccessStatusCode)
                {
                    var content = await locationResponse.Content.ReadAsStringAsync();
                    var result = JsonSerializer.Deserialize<JsonElement>(content);
                    
                    if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                        result.TryGetProperty("data", out var data))
                    {
                        schoolName = data.TryGetProperty("schoolName", out var sn) ? sn.GetString() : null;
                        division = data.TryGetProperty("division", out var div) ? div.GetString() : null;
                        region = data.TryGetProperty("region", out var reg) ? reg.GetString() : null;
                        district = data.TryGetProperty("district", out var dist) ? dist.GetString() : null;
                    }
                }
            }
            
            // Fallback to localStorage if API failed
            if (string.IsNullOrEmpty(schoolName))
            {
                schoolName = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "schoolName");
                if (string.IsNullOrEmpty(division)) division = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "division");
                if (string.IsNullOrEmpty(region)) region = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "region");
                if (string.IsNullOrEmpty(district)) district = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "district");
            }

            if (string.IsNullOrEmpty(schoolName)) return;

            // 2. Fetch Students
            var queryParams = new List<string>();
            queryParams.Add($"schoolName={Uri.EscapeDataString(schoolName)}");
            if (!string.IsNullOrEmpty(division)) queryParams.Add($"division={Uri.EscapeDataString(division)}");
            if (!string.IsNullOrEmpty(region)) queryParams.Add($"region={Uri.EscapeDataString(region)}");
            if (!string.IsNullOrEmpty(district)) queryParams.Add($"district={Uri.EscapeDataString(district)}");

            var response = await Http.GetAsync($"api/IncidentReport/students-by-location?{string.Join("&", queryParams)}");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                {
                    var studentsToCache = new List<StudentCacheDto>();
                    foreach (var item in data.EnumerateArray())
                    {
                        var student = new StudentCacheDto();
                        if (item.TryGetProperty("studentName", out var name)) student.StudentName = name.GetString() ?? "";
                        if (item.TryGetProperty("gradeLevel", out var grade)) student.GradeLevel = grade.GetString() ?? "";
                        if (item.TryGetProperty("section", out var section)) student.Section = section.GetString() ?? "";
                        studentsToCache.Add(student);
                    }
                    
                    // 3. Save to Offline Cache
                    if (studentsToCache.Any())
                    {
                        await OfflineStorage.SaveStudentsAsync(studentsToCache);
                        Console.WriteLine($"âœ… [Dashboard] Cached {studentsToCache.Count} students for offline use.");
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"âš ï¸ [Dashboard] Failed to cache students: {ex.Message}");
        }
    }

    // DTO for caching (must match the one in Podofflineonlinerounding.razor)
    public class StudentCacheDto
    {
        public string StudentName { get; set; } = string.Empty;
        public string GradeLevel { get; set; } = string.Empty;
        public string Section { get; set; } = string.Empty;
    }

    // DTO for caching (standardized with SharedProject)
    // Removed TeacherCacheDto in favor of SharedProject.TeacherSearchResult

    // API Response wrapper
    public class ApiResponse<T>
    {
        public bool Success { get; set; }
        public string Message { get; set; } = "";
        public T? Data { get; set; }
    }

    private async Task CheckCaseRecordExists(IncidentReportSummary? report)
    {
        hasCaseRecord = false;
        caseRecordId = null;
        caseRecordsList.Clear();

        if (report is null)
        {
            return;
        }

        try
        {
            // Check using SimplifiedStudentProfileCaseRecords table via API
            // First, quick check using the cached incidentIdsWithCaseRecords
            if (incidentIdsWithCaseRecords.Contains(report.IncidentID))
            {
                hasCaseRecord = true;
                
                // Fetch the actual record details from SimplifiedStudentProfileCaseRecords
                var response = await Http.GetAsync($"api/StudentProfileCaseRecord/simplified?incidentId={report.IncidentID}");
                if (response.IsSuccessStatusCode)
                {
                    var content = await response.Content.ReadAsStringAsync();
                    var result = JsonSerializer.Deserialize<JsonElement>(content);

                    if (result.TryGetProperty("success", out var successProp) && successProp.GetBoolean() &&
                        result.TryGetProperty("data", out var dataProp) && dataProp.ValueKind == JsonValueKind.Array)
                    {
                        foreach (var recordElement in dataProp.EnumerateArray())
                        {
                            // Check if this record matches the incident ID
                            if (recordElement.TryGetProperty("incidentID", out var incidentIdProp))
                            {
                                var caseRecordIncidentId = incidentIdProp.ValueKind == JsonValueKind.Null ? (int?)null : incidentIdProp.GetInt32();
                                
                                if (caseRecordIncidentId != report.IncidentID)
                                {
                                    continue;
                                }
                            }
                            else
                            {
                                continue;
                            }

                            // Get respondent name (SimplifiedStudentProfileCaseRecords uses RespondentName)
                            var studentName = "";
                            if (recordElement.TryGetProperty("respondentName", out var studentNameProp))
                            {
                                studentName = studentNameProp.GetString() ?? "";
                            }

                            // Get record ID
                            if (recordElement.TryGetProperty("recordID", out var recordIdProp) && recordIdProp.TryGetInt32(out var parsedId))
                            {
                                caseRecordsList.Add(new CaseRecordInfo 
                                { 
                                    RecordId = parsedId, 
                                    StudentName = studentName.Trim() 
                                });
                                
                                if (caseRecordId == null)
                                {
                                    caseRecordId = parsedId;
                                }
                            }
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking case record exists: {ex.Message}");
            // If check fails, use the cached HashSet as fallback
            hasCaseRecord = incidentIdsWithCaseRecords.Contains(report.IncidentID);
        }
    }

    private static IEnumerable<string> ExtractRespondentNames(string? respondentField)
    {
        if (string.IsNullOrWhiteSpace(respondentField))
        {
            yield break;
        }

        var separators = new[] { ";", "\n" };
        foreach (var name in respondentField.Split(separators, StringSplitOptions.RemoveEmptyEntries))
        {
            var trimmed = name.Trim();
            if (!string.IsNullOrEmpty(trimmed))
            {
                yield return trimmed;
            }
        }
    }

    private void CloseProgressModal()
    {
        showProgressModal = false;
        progressReport = null;
        hasCaseRecord = false;
        caseRecordId = null;
    }

    private void OpenEvidenceModal()
    {
        showEvidenceModal = true;
        isPhotoBlurred = true; // Reset blur state when opening modal
    }

    private void CloseEvidenceModal()
    {
        showEvidenceModal = false;
        isPhotoBlurred = true; // Reset blur state when closing
    }

    private void TogglePhotoBlur()
    {
        isPhotoBlurred = !isPhotoBlurred;
    }

    private void ViewMultipleRecords()
    {
        // Store the record IDs in session storage and navigate
        var recordIds = string.Join(",", caseRecordsList.Select(r => r.RecordId));
        NavigationManager.NavigateTo($"/multiple-case-records?ids={recordIds}");
    }

    private bool IsCreateCaseDisabled(IncidentReportSummary report)
    {
        // Allow creating a case record ONLY when status is "Arrived"
        // Student must be present before creating case record
        var status = report.Status?.Trim() ?? string.Empty;
        return !status.Equals("Arrived", StringComparison.OrdinalIgnoreCase);
    }

    private string GetCreateCaseTooltip(IncidentReportSummary report)
    {
        return IsCreateCaseDisabled(report) ? "Student must be marked as 'Arrived' before creating a Case Record." : string.Empty;
    }

    private int GetProgressStep(string? status)
    {
        // Map status to step number: 1=Approval, 2=Reported, 3=Notification, 4=Investigation, 5=Resolution
        var s = status?.Trim() ?? string.Empty;
        if (s.Equals("Pending", StringComparison.OrdinalIgnoreCase) || s.Equals("Reported", StringComparison.OrdinalIgnoreCase)) return 1;
        if (s.Equals("Approved", StringComparison.OrdinalIgnoreCase)) return 2;
        if (s.Equals("Calling", StringComparison.OrdinalIgnoreCase) || s.Equals("Called", StringComparison.OrdinalIgnoreCase)) return 3;
        if (s.Equals("Arrived", StringComparison.OrdinalIgnoreCase) || 
            s.Equals("Under Review", StringComparison.OrdinalIgnoreCase) || 
            s.Equals("UnderReview", StringComparison.OrdinalIgnoreCase) ||
            s.Equals("ParentOnHold", StringComparison.OrdinalIgnoreCase)) return 4;
        if (s.Equals("Resolved", StringComparison.OrdinalIgnoreCase) || s.Equals("Closed", StringComparison.OrdinalIgnoreCase)) return 5;
        return 1;
    }

    private bool IsStepDone(int stepIndex, string? status)
    {
        // stepIndex is 0-based, so for 5 steps:
        // Index 0: Approval
        // Index 1: Reported
        // Index 2: Notification
        // Index 3: Investigation
        // Index 4: Resolution
        var current = GetProgressStep(status);
        
        // If status is "Rejected", no steps are "done" in terms of progress forward
        if (string.Equals(status?.Trim(), "Rejected", StringComparison.OrdinalIgnoreCase)) return false;
        
        return current > (stepIndex + 1);
    }

    private async Task ApproveIncident(int incidentId)
    {
        try
        {
            var updateRequest = new { Status = "Approved" };
            var response = await Http.PutAsJsonAsync($"api/IncidentReport/{incidentId}/status", updateRequest);
            if (response.IsSuccessStatusCode)
            {
                if (progressReport != null && progressReport.IncidentID == incidentId)
                {
                    progressReport.Status = "Approved";
                }
                await LoadIncidentReports();
                ShowSnackbar("Incident approved successfully", true);
                StateHasChanged();
            }
            else
            {
                ShowSnackbar("Error approving incident", false);
            }
        }
        catch (Exception ex)
        {
            ShowSnackbar($"Error: {ex.Message}", false);
        }
    }

    private async Task RejectIncident(int incidentId)
    {
        try
        {
            var updateRequest = new { Status = "Rejected" };
            var response = await Http.PutAsJsonAsync($"api/IncidentReport/{incidentId}/status", updateRequest);
            if (response.IsSuccessStatusCode)
            {
                if (progressReport != null && progressReport.IncidentID == incidentId)
                {
                    progressReport.Status = "Rejected";
                }
                await LoadIncidentReports();
                ShowSnackbar("Incident rejected", true);
                CloseProgressModal();
                StateHasChanged();
            }
            else
            {
                ShowSnackbar("Error rejecting incident", false);
            }
        }
        catch (Exception ex)
        {
            ShowSnackbar($"Error: {ex.Message}", false);
        }
    }

    private void UpdateStatus(int incidentId)
    {
        NavigationManager.NavigateTo($"/update-incident-status/{incidentId}");
    }

    private async Task CreateCaseRecord(IncidentReportSummary report)
    {
        try
        {
            // Fetch full incident report data
            var response = await Http.GetAsync($"api/IncidentReport/details/{report.IncidentID}");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data))
                {
                    // Extract data from the full incident report
                    var offenderName = data.TryGetProperty("respondentName", out var respondent) ? respondent.GetString() : "";
                    var complainantName = data.TryGetProperty("complainantName", out var complainant) ? complainant.GetString() : "";
                    var violationType = data.TryGetProperty("incidentType", out var violation) ? violation.GetString() : "";
                    var otherViolation = data.TryGetProperty("otherIncidentType", out var other) ? other.GetString() : "";
                    var dateReported = data.TryGetProperty("dateReported", out var date) ? date.GetString() : "";
                    
                    // Build query parameters with relevant data only
                    var queryParams = $"?offenderName={Uri.EscapeDataString(offenderName)}" +
                                   $"&complainantName={Uri.EscapeDataString(complainantName)}" +
                                   $"&violationType={Uri.EscapeDataString(violationType)}" +
                                   $"&otherViolation={Uri.EscapeDataString(otherViolation ?? "")}" +
                                   $"&incidentId={report.IncidentID}" +
                                   $"&dateReported={dateReported}";
                    
                    NavigationManager.NavigateTo($"/simplified-case-record{queryParams}");
                }
                else
                {
                    // Fallback to basic data if API call fails
                    var queryParams = $"?offenderName={Uri.EscapeDataString(report.RespondentName)}" +
                                   $"&complainantName={Uri.EscapeDataString(report.ComplainantName)}" +
                                   $"&incidentId={report.IncidentID}" +
                                   $"&dateReported={report.DateReported:yyyy-MM-dd}";
                    
                    NavigationManager.NavigateTo($"/simplified-case-record{queryParams}");
                }
            }
            else
            {
                // Fallback to basic data if API call fails
                var queryParams = $"?offenderName={Uri.EscapeDataString(report.RespondentName)}" +
                               $"&complainantName={Uri.EscapeDataString(report.ComplainantName)}" +
                               $"&incidentId={report.IncidentID}" +
                               $"&dateReported={report.DateReported:yyyy-MM-dd}";
                
                NavigationManager.NavigateTo($"/simplified-case-record{queryParams}");
            }
        }
        catch
        {
            // Fallback to basic data if any error occurs
            var queryParams = $"?offenderName={Uri.EscapeDataString(report.RespondentName)}" +
                           $"&complainantName={Uri.EscapeDataString(report.ComplainantName)}" +
                           $"&incidentId={report.IncidentID}" +
                           $"&dateReported={report.DateReported:yyyy-MM-dd}";
            
            NavigationManager.NavigateTo($"/simplified-case-record{queryParams}");
        }
    }

    // Call Slip Modal state
    private bool showCallSlipModal = false;
    private IncidentReportSummary? selectedReport;
    private string selectedDate = DateTime.Today.ToString("yyyy-MM-dd");
    private string selectedTime = DateTime.Now.ToString("HH:mm");

    private void OpenCallSlipModal(IncidentReportSummary report)
    {
        selectedReport = report;
        selectedDate = DateTime.Today.ToString("yyyy-MM-dd");
        selectedTime = DateTime.Now.ToString("HH:mm");
        showCallSlipModal = true;
    }

    private void CloseCallSlipModal()
    {
        showCallSlipModal = false;
        selectedReport = null;
    }

    private void OnSelectedDateChanged(ChangeEventArgs e)
    {
        selectedDate = e.Value?.ToString() ?? selectedDate;
    }

    private void OnSelectedTimeChanged(ChangeEventArgs e)
    {
        selectedTime = e.Value?.ToString() ?? selectedTime;
    }

    private bool isGeneratingCallSlip = false;
    
    private async Task GenerateCallSlip()
    {
        if (isGeneratingCallSlip) return; // Prevent double-click
        
        try
        {
            if (selectedReport is null)
            {
                return;
            }

            isGeneratingCallSlip = true;
            StateHasChanged(); // Update UI to show loading state

            // Store the incident ID before closing modal to avoid null reference
            var incidentId = selectedReport.IncidentID;
            
            var dateParam = string.IsNullOrWhiteSpace(selectedDate) ? DateTime.Today.ToString("yyyy-MM-dd") : selectedDate;
            var timeParam = string.IsNullOrWhiteSpace(selectedTime) ? DateTime.Now.ToString("HH:mm") : selectedTime;
            var teacherName = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "teacherName");
            var generatedByParam = string.IsNullOrEmpty(teacherName) ? (string.IsNullOrEmpty(currentUser) ? "System" : currentUser) : teacherName;

            var response = await Http.GetAsync($"api/CallSlip/generate/{incidentId}?date={Uri.EscapeDataString(dateParam)}&time={Uri.EscapeDataString(timeParam)}&generatedBy={Uri.EscapeDataString(generatedByParam)}");
            
            if (response.IsSuccessStatusCode)
            {
                var contentType = response.Content.Headers.ContentType?.MediaType ?? "application/pdf";
                var bytes = await response.Content.ReadAsByteArrayAsync();
                var base64 = Convert.ToBase64String(bytes);
                
                // Determine file extension based on content type
                var fileExtension = contentType.Contains("html") ? "html" : "pdf";
                var fileName = $"CallSlip_{incidentId}_{DateTime.Now:yyyyMMdd}.{fileExtension}";
                
                // Trigger download using JavaScript helper defined in index.html
                await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
                
                ShowSnackbar($"Call slip generated successfully ({fileExtension.ToUpper()})", true);
                
                CloseCallSlipModal();
                
                // Update status first (most important)
                try
                {
                    await UpdateReportStatusToCalling(incidentId);
                }
                catch (Exception statusEx)
                {
                    ShowSnackbar($"Call slip generated but status update failed: {statusEx.Message}", false);
                }
                
                // Fetch call slip data (less critical)
                try
                {
                    await FetchCallSlipData(incidentId);
                }
                catch
                {
                    // Silently handle error
                }
                
                // Refresh reports to show updated status (do this last)
                try
                {
                    await LoadIncidentReports();
                }
                catch
                {
                    // Silently handle error
                }
            }
            else
            {
                // Get the actual error message from the API response
                var errorContent = await response.Content.ReadAsStringAsync();
                
                try
                {
                    var errorResult = JsonSerializer.Deserialize<JsonElement>(errorContent);
                    if (errorResult.TryGetProperty("message", out var errorMessage))
                    {
                        ShowSnackbar($"Error generating call slip: {errorMessage.GetString()}", false);
                    }
                    else
                    {
                        ShowSnackbar($"Error generating call slip: {response.StatusCode}", false);
                    }
                }
                catch
                {
                    ShowSnackbar($"Error generating call slip: {response.StatusCode} - {errorContent}", false);
                }
                
                CloseCallSlipModal();
            }
        }
        catch (Exception ex)
        {
            ShowSnackbar($"Error generating call slip: {ex.Message}", false);
            CloseCallSlipModal();
        }
        finally
        {
            isGeneratingCallSlip = false;
            StateHasChanged();
        }
    }

    private async Task UpdateReportStatusToCalling(int incidentId)
    {
        try
        {
            if (Http == null)
            {
                throw new InvalidOperationException("Http client is not available");
            }
            
            var updateRequest = new { Status = "Calling" };
            var response = await Http.PutAsJsonAsync($"api/IncidentReport/{incidentId}/status", updateRequest);

            if (response.IsSuccessStatusCode)
            {
                // Update the local report status
                var report = incidentReports.FirstOrDefault(r => r.IncidentID == incidentId);
                if (report != null)
                {
                    report.Status = "Calling";
                }
                
                // Update progressReport if it's the one we're looking at
                if (progressReport != null && progressReport.IncidentID == incidentId)
                {
                    progressReport.Status = "Calling";
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                var errorMessage = $"Failed to update status to Calling: {response.StatusCode}";
                
                try
                {
                    var errorResult = JsonSerializer.Deserialize<JsonElement>(errorContent);
                    if (errorResult.TryGetProperty("message", out var errorMsg))
                    {
                        errorMessage = $"Failed to update status: {errorMsg.GetString()}";
                    }
                    else if (errorResult.TryGetProperty("Message", out var errorMsg2))
                    {
                        errorMessage = $"Failed to update status: {errorMsg2.GetString()}";
                    }
                }
                catch
                {
                    errorMessage = $"Failed to update status: {response.StatusCode} - {errorContent}";
                }
                
                message = errorMessage;
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            message = $"Error updating report status: {ex.Message}";
            isSuccess = false;
        }
    }

    private async Task UpdateReportStatus(int incidentId, string newStatus)
    {
        try
        {
            var updateRequest = new { Status = newStatus };
            var response = await Http.PutAsJsonAsync($"api/IncidentReport/{incidentId}/status", updateRequest);
            if (response.IsSuccessStatusCode)
            {
                var report = incidentReports.FirstOrDefault(r => r.IncidentID == incidentId);
                if (report != null)
                {
                    report.Status = newStatus;
                }
                if (progressReport?.IncidentID == incidentId)
                {
                    progressReport.Status = newStatus;
                }
                isSuccess = true;
                message = $"Status updated to {newStatus}";
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                var errorMessage = $"Failed to update status: {response.StatusCode}";
                
                // Try to extract error message from JSON response
                try
                {
                    var errorResult = JsonSerializer.Deserialize<JsonElement>(errorContent);
                    if (errorResult.TryGetProperty("message", out var errorMsg))
                    {
                        errorMessage = $"Failed to update status: {errorMsg.GetString()}";
                    }
                    else if (errorResult.TryGetProperty("error", out var error))
                    {
                        errorMessage = $"Failed to update status: {error.GetString()}";
                    }
                    else if (!string.IsNullOrWhiteSpace(errorContent) && errorContent.Length < 500)
                    {
                        errorMessage = $"Failed to update status: {errorContent}";
                    }
                }
                catch
                {
                    // If JSON parsing fails, use the raw content if it's reasonable
                    if (!string.IsNullOrWhiteSpace(errorContent) && errorContent.Length < 500)
                    {
                        errorMessage = $"Failed to update status: {errorContent}";
                    }
                }
                
                message = errorMessage;
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            var errorMessage = $"Error updating status: {ex.Message}";
            
            // Include inner exception if available
            if (ex.InnerException != null)
            {
                errorMessage += $" ({ex.InnerException.Message})";
            }
            
            message = errorMessage;
            isSuccess = false;
        }
    }

    private async Task MarkAsCalled(int incidentId)
    {
        await UpdateReportStatus(incidentId, "Called");
    }

    private async Task MarkAsArrived(int incidentId)
    {
        // Update status to "Arrived"
        await UpdateReportStatus(incidentId, "Arrived");
        
        // Refresh the reports list to show updated status
        await LoadIncidentReports();
        
        // Refresh the modal if it's still open
        if (progressReport?.IncidentID == incidentId)
        {
            var report = incidentReports.FirstOrDefault(r => r.IncidentID == incidentId);
            if (report != null)
            {
                progressReport.Status = report.Status;
                // Reset case record check to show Create button
                await CheckCaseRecordExists(progressReport);
            }
        }
    }

}

@* Respondents List Modal *@
@if (showRespondentsModal && !string.IsNullOrEmpty(respondentsListToShow))
{
    <div class="cs-modal-backdrop" @onclick="CloseRespondentsModal"></div>
    <div class="cs-modal respondents-list-modal" @onclick:stopPropagation="true">
        <div class="cs-modal-header">
            <h3>Respondents/Offenders</h3>
            <button type="button" class="btn-close-modal" @onclick="CloseRespondentsModal" aria-label="Close">Ã—</button>
        </div>
        <div class="cs-modal-body">
            <div class="respondents-modal-list">
                @{
                    var respondents = respondentsListToShow.Split(new[] { ", ", "," }, StringSplitOptions.RemoveEmptyEntries)
                        .Select(r => r.Trim())
                        .Where(r => !string.IsNullOrEmpty(r))
                        .ToArray();
                }
                @foreach (var respondent in respondents)
                {
                    <div class="respondent-modal-item">
                        <span class="respondent-number">@(Array.IndexOf(respondents, respondent) + 1)</span>
                        <span class="respondent-name">@respondent</span>
                    </div>
                }
            </div>
        </div>
        <div class="cs-modal-footer">
            <button type="button" class="btn btn-primary" @onclick="CloseRespondentsModal">Close</button>
        </div>
    </div>
}

@code {
    private async Task GenerateEscalationCallSlip()
    {
        if (isGeneratingCallSlip) return;
        
        try
        {
            if (selectedEscalationForCallSlip == null) return;

            isGeneratingCallSlip = true;
            StateHasChanged();

            var escalationId = selectedEscalationForCallSlip.EscalationID;
            var dateParam = string.IsNullOrWhiteSpace(selectedDate) ? DateTime.Today.ToString("yyyy-MM-dd") : selectedDate;
            var timeParam = string.IsNullOrWhiteSpace(selectedTime) ? DateTime.Now.ToString("HH:mm") : selectedTime;
            var teacherName = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "teacherName");
            var generatedByParam = string.IsNullOrEmpty(teacherName) ? (string.IsNullOrEmpty(currentUser) ? "System" : currentUser) : teacherName;

            var url = $"api/CallSlip/generate-escalation/{escalationId}?date={Uri.EscapeDataString(dateParam)}&time={Uri.EscapeDataString(timeParam)}&generatedBy={Uri.EscapeDataString(generatedByParam)}";
            
            var response = await Http.GetAsync(url);
            
            if (response.IsSuccessStatusCode)
            {
                var bytes = await response.Content.ReadAsByteArrayAsync();
                var base64 = Convert.ToBase64String(bytes);
                var fileName = $"CallSlip_Escalation_{escalationId}_{DateTime.Now:yyyyMMdd}.pdf";
                
                await JSRuntime.InvokeVoidAsync("downloadFile", fileName, base64);
                
                ShowSnackbar("Escalation call slip generated successfully", true);
                
                CloseCallSlipModal();

                // Update status to "Calling" if it's currently "Active" or "Pending"
                if (selectedEscalationForCallSlip.Status == EscalationStatus.Active || selectedEscalationForCallSlip.Status == EscalationStatus.Pending)
                {
                    await UpdateEscalationStatus(escalationId, "Calling");
                }
                
                // Refresh call slip data
                await FetchEscalationCallSlipData(escalationId);
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                try
                {
                    var errorResult = JsonSerializer.Deserialize<JsonElement>(errorContent);
                    if (errorResult.TryGetProperty("message", out var errorMessage))
                    {
                        ShowSnackbar($"Error generating escalation call slip: {errorMessage.GetString()}", false);
                    }
                    else
                    {
                        ShowSnackbar($"Error generating escalation call slip: {response.StatusCode}", false);
                    }
                }
                catch
                {
                    ShowSnackbar($"Error generating escalation call slip: {response.StatusCode}", false);
                }
                CloseCallSlipModal();
            }
        }
        catch (Exception ex)
        {
            ShowSnackbar($"Error generating escalation call slip: {ex.Message}", false);
            CloseCallSlipModal();
        }
        finally
        {
            isGeneratingCallSlip = false;
            StateHasChanged();
        }
    }

    private async Task FetchEscalationCallSlipData(int escalationId)
    {
        currentCallSlip = null;
        try
        {
            var response = await Http.GetAsync($"api/CallSlip/escalation/{escalationId}");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);

                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                {
                    var callSlips = data.EnumerateArray();
                    if (callSlips.Any())
                    {
                        var callSlipElement = callSlips.First();
                        currentCallSlip = new CallSlipModel
                        {
                            CallSlipID = callSlipElement.TryGetProperty("callSlipID", out var id) ? id.GetInt32() : 0,
                            EscalationID = callSlipElement.TryGetProperty("escalationID", out var escId) ? (escId.ValueKind != JsonValueKind.Null ? escId.GetInt32() : 0) : 0,
                            MeetingDate = callSlipElement.TryGetProperty("meetingDate", out var meetDate) && meetDate.ValueKind != JsonValueKind.Null
                                ? meetDate.GetDateTime() : DateTime.MinValue,
                            MeetingTime = callSlipElement.TryGetProperty("meetingTime", out var meetTime) && meetTime.ValueKind != JsonValueKind.Null
                                ? TimeSpan.Parse(meetTime.ToString()) : null
                        };
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching escalation call slip: {ex.Message}");
        }
    }

    private async Task UpdateEscalationStatus(int escalationId, string status)
    {
        try
        {
            var response = await Http.PutAsync($"api/Escalation/{escalationId}/status?status={status}", null);
            if (response.IsSuccessStatusCode)
            {
                if (selectedEscalation != null && selectedEscalation.EscalationID == escalationId)
                {
                    selectedEscalation.Status = Enum.Parse<EscalationStatus>(status);
                }
                
                // Refresh main list
                await LoadEscalatedCases();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating escalation status: {ex.Message}");
        }
    }
    
    private void OpenEscalationCallSlipModal(CaseEscalation escalation)
    {
        selectedEscalationForCallSlip = escalation;
        selectedDate = DateTime.Now.ToString("yyyy-MM-dd");
        selectedTime = DateTime.Now.ToString("HH:mm");
        showCallSlipModal = true;
    }
    
    // Track which escalation is being processed for call slip
    private CaseEscalation? selectedEscalationForCallSlip;

    private int GetEscalationProgressStep(EscalationStatus status)
    {
        return status switch
        {
            EscalationStatus.Active => 1,
            EscalationStatus.Pending => 1,
            EscalationStatus.Calling => 2,
            EscalationStatus.Arrived => 3,
            EscalationStatus.UnderReview => 3,
            EscalationStatus.ParentOnHold => 3,
            EscalationStatus.Resolved => 4,
            EscalationStatus.Closed => 4,
            EscalationStatus.Withdrawn => 0,
            _ => 1
        };
    }

    private bool IsEscalationStepDone(int stepIndex, EscalationStatus status)
    {
        var currentStep = GetEscalationProgressStep(status);
        
        // Withdrawn cases don't show progress
        if (status == EscalationStatus.Withdrawn) return false;
        
        // StepIndex is 0-based: 0=Reported, 1=Notification, 2=Investigation, 3=Resolution
        // CurrentStep is 1-based: 1=Reported, 2=Notification, 3=Investigation, 4=Resolution
        
        return currentStep > (stepIndex + 1);
    }
    }

@* Call Slip Modal *@
@if (showCallSlipModal)
{
    <div class="cs-modal-backdrop" @onclick="CloseCallSlipModal"></div>
    <div class="cs-modal">
        <div class="cs-modal-header">
            <h3>Generate Call Slip</h3>
        </div>
        <div class="cs-modal-body">
            <div class="cs-form-row">
                <label>Date</label>
                <input type="date" class="form-control" value="@selectedDate" @onchange="OnSelectedDateChanged" />
            </div>
            <div class="cs-form-row">
                <label>Time</label>
                <input type="time" class="form-control" value="@selectedTime" @onchange="OnSelectedTimeChanged" />
            </div>
        </div>
        <div class="cs-modal-footer">
            <button class="btn btn-secondary" @onclick="CloseCallSlipModal">Cancel</button>
            <button class="btn btn-primary" @onclick="() => selectedEscalationForCallSlip != null ? GenerateEscalationCallSlip() : GenerateCallSlip()" disabled="@isGeneratingCallSlip">
                @if (isGeneratingCallSlip)
                {
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span> Generating...</span>
                }
                else
                {
                    <span>Generate</span>
                }
            </button>
        </div>
    </div>
}

@* Progress Modal *@
@if (showProgressModal && progressReport is not null)
{
    <div class="cs-modal-backdrop" @onclick="CloseProgressModal"></div>
    <div class="cs-modal progress-modal" @onclick:stopPropagation>
        <div class="cs-modal-header progress-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="header-content">
                <h3 class="modal-title">Incident Progress</h3>
                <span class="incident-id" style="background: rgba(255, 255, 255, 0.2);">Incident #@progressReport.IncidentID</span>
            </div>
        </div>
        <div class="cs-modal-body progress-body">
            @{
                var status = progressReport.Status?.Trim() ?? "";
                var isParentOnHold = string.Equals(status, "ParentOnHold", StringComparison.OrdinalIgnoreCase);
                var isUnderReview = string.Equals(status, "UnderReview", StringComparison.OrdinalIgnoreCase) || 
                                   string.Equals(status, "Under Review", StringComparison.OrdinalIgnoreCase);
            }
            
            <div class="progress-steps-container">
                <div class="progress-steps">
                    <div class="progress-step @(IsStepDone(0, status) ? "done" : GetProgressStep(status) == 1 ? "active" : string.Empty)">
                        <div class="step-content">
                            <div class="circle">1</div>
                            <div class="step-info">
                                <div class="label">Approval</div>
                                <div class="step-description">Pending approval</div>
                            </div>
                        </div>
                    </div>
                    <div class="connector @(GetProgressStep(status) > 1 ? "done" : string.Empty)"></div>
                    <div class="progress-step @(IsStepDone(1, status) ? "done" : GetProgressStep(status) == 2 ? "active" : string.Empty)">
                        <div class="step-content">
                            <div class="circle">2</div>
                            <div class="step-info">
                                <div class="label">Reported</div>
                                <div class="step-description">Case registered</div>
                            </div>
                        </div>
                    </div>
                    <div class="connector @(GetProgressStep(status) > 2 ? "done" : string.Empty)"></div>
                    <div class="progress-step @(IsStepDone(2, status) ? "done" : GetProgressStep(status) == 3 ? "active" : string.Empty)">
                        <div class="step-content">
                            <div class="circle">3</div>
                            <div class="step-info">
                                <div class="label">Notification</div>
                                <div class="step-description">Call slip sent</div>
                            </div>
                        </div>
                    </div>
                    <div class="connector @(GetProgressStep(status) > 3 ? "done" : string.Empty)"></div>
                    <div class="progress-step @(IsStepDone(3, status) ? "done" : GetProgressStep(status) == 4 ? "active" : string.Empty)">
                        <div class="step-content">
                            <div class="circle">4</div>
                            <div class="step-info">
                                <div class="label">Investigation</div>
                                <div class="step-description">Inquiry & Part B</div>
                            </div>
                        </div>
                    </div>
                    <div class="connector @(GetProgressStep(status) > 4 ? "done" : string.Empty)"></div>
                    <div class="progress-step @(GetProgressStep(status) == 5 ? "done" : string.Empty)">
                        <div class="step-content">
                            <div class="circle">5</div>
                            <div class="step-info">
                                <div class="label">Resolution</div>
                                <div class="step-description">Case resolved</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="progress-details-card">
                <div class="details-header">
                    <h4>Incident Details</h4>
                </div>
                <div class="progress-details">
                    <div class="detail-item">
                        <span class="detail-icon">ðŸ“‹</span>
                        <div class="detail-content">
                            <span class="detail-key">Status</span>
                            <span class="detail-val status-badge-modal @GetStatusCssClass(progressReport.Status)">@FormatStatus(progressReport.Status)</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">ðŸ‘¤</span>
                        <div class="detail-content">
                            <span class="detail-key">Complainant</span>
                            <span class="detail-val">@progressReport.ComplainantName</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">âš ï¸</span>
                        <div class="detail-content">
                            <span class="detail-key">Victim</span>
                            <span class="detail-val">@(string.IsNullOrWhiteSpace(progressReport.VictimName) ? "N/A" : progressReport.VictimName)</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">ðŸ‘¤</span>
                        <div class="detail-content">
                            <span class="detail-key">Respondent@(GetRespondentCount(progressReport.RespondentName) > 1 ? "s" : "")</span>
                            <span class="detail-val">
                                @if (string.IsNullOrEmpty(progressReport.RespondentName))
                                {
                                    <text>N/A</text>
                                }
                                else
                                {
                                    var respondents = progressReport.RespondentName.Split(new[] { "; ", ";" }, StringSplitOptions.RemoveEmptyEntries)
                                        .Select(r => r.Trim())
                                        .Where(r => !string.IsNullOrEmpty(r))
                                        .ToArray();
                                    if (respondents.Length > 1)
                                    {
                                        <div style="text-align: left;">
                                            @foreach (var respondent in respondents)
                                            {
                                                <div style="margin-bottom: 6px; padding: 4px 0; border-bottom: 1px solid #e0e0e0;">
                                                    <strong>@respondent</strong>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        @progressReport.RespondentName
                                    }
                                }
                            </span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">ðŸ“…</span>
                        <div class="detail-content">
                            <span class="detail-key">Reported</span>
                            <span class="detail-val">@progressReport.DateReported.ToString("MMM dd, yyyy")</span>
                        </div>
                    </div>
                    @if (!string.IsNullOrWhiteSpace(progressReport.IncidentDescription))
                    {
                        <div style="margin: 0 16px 16px 16px;">
                            <button class="btn-toggle-resolution evidence-toggle" @onclick="OpenEvidenceModal" title="Click to view full details">
                                <div class="toggle-content">
                                    <span class="toggle-icon">ðŸ“</span>
                                    <span class="toggle-label">View Evidence & Details</span>
                                </div>
                                <span class="chevron">â–¶</span>
                            </button>
                        </div>
                    }
                </div>
                @{
                    bool hasPartBData = !string.IsNullOrWhiteSpace(partBActionTaken) || 
                                       !string.IsNullOrWhiteSpace(partBFindings) || 
                                       !string.IsNullOrWhiteSpace(partBAgreement) || 
                                       !string.IsNullOrWhiteSpace(partBPenaltyAction);
                }

                @if (hasPartBData)
                {
                    <div style="margin: 0 16px 12px 16px;">
                        <button class="btn-toggle-resolution @(showResolutionDetails ? "active" : "")" @onclick="() => showResolutionDetails = !showResolutionDetails">
                            <div class="toggle-content">
                                <span class="toggle-icon">@(showResolutionDetails ? "ðŸ“‚" : "ðŸ“")</span>
                                <span class="toggle-label">@(showResolutionDetails ? "Hide Resolution Details" : "View Resolution Details")</span>
                            </div>
                            <span class="chevron">@(showResolutionDetails ? "â–¼" : "â–¶")</span>
                        </button>
                    </div>
                }

                @if (hasPartBData && showResolutionDetails)
                {
                    var isResolvedStatus = string.Equals(progressReport.Status?.Trim(), "Resolved", StringComparison.OrdinalIgnoreCase);
                    <div class="resolution-card @(isResolvedStatus ? "resolved" : "in-progress")">
                        <div class="resolution-header">
                            <h5>
                                <span class="res-icon">@(isResolvedStatus ? "âœ…" : "ðŸ“")</span> 
                                @(isResolvedStatus ? "Resolution Details" : "Resolution in Progress")
                            </h5>
                        </div>
                        <div class="resolution-grid">
                            @if (!string.IsNullOrWhiteSpace(partBActionTaken))
                            {
                                <div class="resolution-item">
                                    <div class="resolution-icon-box">ðŸ›¡ï¸</div>
                                    <div class="res-item-content">
                                        <span class="res-item-label">Action Taken</span>
                                        <p class="res-item-value">@partBActionTaken</p>
                                    </div>
                                </div>
                            }
                            @if (!string.IsNullOrWhiteSpace(partBFindings))
                            {
                                <div class="resolution-item">
                                    <div class="resolution-icon-box">ðŸ”</div>
                                    <div class="res-item-content">
                                        <span class="res-item-label">Findings</span>
                                        <p class="res-item-value">@partBFindings</p>
                                    </div>
                                </div>
                            }
                            @if (!string.IsNullOrWhiteSpace(partBAgreement))
                            {
                                <div class="resolution-item">
                                    <div class="resolution-icon-box">ðŸ¤</div>
                                    <div class="res-item-content">
                                        <span class="res-item-label">Agreement</span>
                                        <p class="res-item-value">@partBAgreement</p>
                                    </div>
                                </div>
                            }
                            @if (!string.IsNullOrWhiteSpace(partBPenaltyAction))
                            {
                                <div class="resolution-item">
                                    <div class="resolution-icon-box">âš–ï¸</div>
                                    <div class="res-item-content">
                                        <span class="res-item-label">Penalty/Action</span>
                                        <p class="res-item-value">@partBPenaltyAction</p>
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="resolution-footer">
                            <button class="btn-res-edit" @onclick="() => OpenPartBModal(progressReport.IncidentID)">
                                <span class="btn-icon">âœï¸</span> Edit Resolution
                            </button>
                        </div>
                    </div>
                }
            </div>

            <div class="progress-actions">
                @if (string.Equals(progressReport.Status?.Trim(), "Pending", StringComparison.OrdinalIgnoreCase) || 
                     string.Equals(progressReport.Status?.Trim(), "Reported", StringComparison.OrdinalIgnoreCase))
                {
                    <div class="action-buttons-row" style="width: 100%; display: flex; gap: 12px;">
                        <button class="btn btn-success btn-action" @onclick="() => ApproveIncident(progressReport.IncidentID)" style="flex: 1;">
                            <span class="btn-icon">âœ…</span>
                            <span>Approve</span>
                        </button>
                        <button class="btn btn-danger btn-action" @onclick="() => RejectIncident(progressReport.IncidentID)" style="flex: 1; background-color: #ef4444;">
                            <span class="btn-icon">âœ–</span>
                            <span>Reject</span>
                        </button>
                    </div>
                }
                else if (string.Equals(progressReport.Status?.Trim(), "Approved", StringComparison.OrdinalIgnoreCase))
                {
                    <button class="btn btn-info btn-action" @onclick="() => OpenCallSlipModal(progressReport)" style="width: 100%;">
                        <span class="btn-icon">ðŸ“„</span>
                        <span>Generate Call Slip</span>
                    </button>
                }
                else if (string.Equals(progressReport.Status?.Trim(), "Calling", StringComparison.OrdinalIgnoreCase))
                {
                    <button class="btn btn-info btn-action" @onclick="() => OpenCallSlipModal(progressReport)">
                        <span class="btn-icon">ðŸ“„</span>
                        <span>Call Slip</span>
                    </button>
                    <button class="btn btn-outline btn-action" @onclick="() => MarkAsArrived(progressReport.IncidentID)">
                        <span class="btn-icon">âœ…</span>
                        <span>Student Arrived</span>
                    </button>
                }
                else if (isParentOnHold)
                {
                    @* ParentOnHold status - show Parents Arrived button *@
                    <button class="btn btn-info btn-action" style="background: #0ea5e9; border: none; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);" @onclick="() => OpenSimplifiedFormsModalFromProgress(progressReport)">
                        <i class="fas fa-file-alt btn-icon"></i>
                        <span>Review Case Record</span>
                    </button>
                    <button class="btn btn-success btn-action" style="background: #10b981; border: none; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);" @onclick="() => MarkParentsArrived(progressReport.IncidentID)">
                        <i class="fas fa-user-check btn-icon"></i>
                        <span>Parents Arrived</span>
                    </button>
                }
                else if (isUnderReview)
                {
                    @* UnderReview status - show button to open Part B modal *@
                    <div style="width: 100%; margin-top: 10px;">
                        <button class="btn btn-primary btn-action" style="width: 100%; height: 48px; font-weight: 600; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; background: @(hasPartBData ? "#0284c7" : "#3b82f6"); border: none; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);" @onclick="() => OpenPartBModal()">
                            <span style="font-size: 1.2rem;">ðŸ“</span>
                            <span>@(hasPartBData ? "Continue Part B - Case Resolution" : "Make Part B - Case Resolution")</span>
                        </button>
                    </div>
                }
                else if (string.Equals(progressReport.Status?.Trim(), "Resolved", StringComparison.OrdinalIgnoreCase) || 
                         string.Equals(progressReport.Status?.Trim(), "Closed", StringComparison.OrdinalIgnoreCase) || 
                         hasCaseRecord)
                {
                    @* If status is Resolved/Closed OR case record exists, show Review button *@
                    <div class="case-record-exists">
                        @if (caseRecordsList.Count > 1)
                        {
                            <div class="action-buttons-row" style="margin-top: 16px;">
                                <button class="btn btn-info btn-action" @onclick="() => ViewMultipleRecords()">
                                    <span class="btn-icon">ðŸ‘ï¸</span>
                                    <span>View All Case Records</span>
                                </button>
                            </div>
                        }
                        else if (caseRecordId.HasValue && caseRecordId.Value > 0)
                        {
                            <div class="action-buttons-row">
                                <button class="btn btn-info btn-action" style="background: #0ea5e9; border: none; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);" @onclick='() => NavigationManager.NavigateTo($"/case-record-review/{caseRecordId.Value}")'>
                                    <i class="fas fa-file-alt btn-icon"></i>
                                    <span>Review Case Record</span>
                                </button>
                            </div>
                        }
                        
                        @if (!string.Equals(progressReport.Status?.Trim(), "Resolved", StringComparison.OrdinalIgnoreCase) &&
                             !string.Equals(progressReport.Status?.Trim(), "Closed", StringComparison.OrdinalIgnoreCase))
                        {
                            <div class="action-buttons-row" style="margin-top: 12px;">
                                <button class="btn btn-success btn-action" style="background: #10b981; border: none; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);" @onclick='async () => { await UpdateReportStatus(progressReport.IncidentID, "Resolved"); await LoadIncidentReports(); await CheckCaseRecordExists(progressReport); }'>
                                    <i class="fas fa-check-circle btn-icon"></i>
                                    <span>Mark as Resolved</span>
                                </button>
                            </div>
                        }
                    </div>
                }
                else
                {
                    @* Status is Arrived or Called, no case record yet - show Create button *@
                    <button class="btn btn-success btn-action" @onclick="() => CreateCaseRecord(progressReport)" disabled="@IsCreateCaseDisabled(progressReport)">
                        <span class="btn-icon">ðŸ“</span>
                        <span>Create Student Profile Case</span>
                    </button>
                }
            </div>
        </div>
        <div class="cs-modal-footer progress-footer">
            <button class="btn btn-secondary progress-close-btn" @onclick="CloseProgressModal">Close</button>
        </div>
    </div>
}

@* Part B - Case Resolution Modal *@
@if (showPartBModal && (progressReport is not null || selectedEscalation is not null))
{
    <div class="cs-modal-backdrop" @onclick="ClosePartBModal"></div>
    <div class="cs-modal part-b-modal" @onclick:stopPropagation style="max-width: 650px; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
        <div class="cs-modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 20px 24px;">
            <div class="header-content">
                <h3 class="modal-title" style="margin: 0; font-weight: 700; font-size: 1.5rem;">Part B - Case Resolution</h3>
                <span style="font-size: 0.9rem; opacity: 0.9;">
                    @(progressReport != null ? $"Incident ID: #{progressReport.IncidentID}" : $"Escalation: #{selectedEscalation?.EscalationID}")
                </span>
            </div>
            <button @onclick="ClosePartBModal" style="background: none; border: none; color: white; font-size: 1.8rem; line-height: 1; cursor: pointer; padding: 0; margin: 0;">&times;</button>
        </div>
        <div class="cs-modal-body" style="padding: 24px; max-height: 70vh; overflow-y: auto;">
             @* Action Taken *@
            <div class="form-group" style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label style="font-weight: 600; color: #1e293b; font-size: 1rem; margin-bottom: 0;">Action Taken</label>
                    <button type="button" class="btn btn-sm btn-link" style="padding: 0; font-size: 0.85rem; text-decoration: none; color: #2563eb; font-weight: 500;" @onclick='() => ToggleDropdown("ActionTaken")'>
                        @(activeDropdown == "ActionTaken" ? "âŒ Cancel Selection" : "â¬‡ï¸ Quick Select Options")
                    </button>
                </div>
                
                @if (activeDropdown == "ActionTaken")
                {
                    <div class="animate-fade-in" style="margin-bottom: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <select class="form-control" style="border-color: #3b82f6; background-color: white; height: 42px; font-size: 0.95rem;" @onchange="OnActionTakenSelected">
                            <option value="">-- Select an action template --</option>
                            @foreach (var option in actionTakenOptions)
                            {
                                <option value="@option">@option</option>
                            }
                        </select>
                        <small style="display: block; margin-top: 6px; color: #64748b;">Selecting an option will append it to the text area.</small>
                    </div>
                }
                <textarea class="form-control" rows="3" @bind="partBActionTaken" placeholder="Describe actions taken by the office..." style="border-radius: 10px; border: 1px solid #cbd5e1; padding: 12px; font-size: 1rem;"></textarea>
            </div>
            
            @* Findings *@
            <div class="form-group" style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label style="font-weight: 600; color: #1e293b; font-size: 1rem; margin-bottom: 0;">Findings</label>
                    <button type="button" class="btn btn-sm btn-link" style="padding: 0; font-size: 0.85rem; text-decoration: none; color: #2563eb; font-weight: 500;" @onclick='() => ToggleDropdown("Findings")'>
                        @(activeDropdown == "Findings" ? "âŒ Cancel Selection" : "â¬‡ï¸ Quick Select Options")
                    </button>
                </div>

                @if (activeDropdown == "Findings")
                {
                    <div class="animate-fade-in" style="margin-bottom: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <select class="form-control" style="border-color: #3b82f6; background-color: white; height: 42px; font-size: 0.95rem;" @onchange="OnFindingsSelected">
                            <option value="">-- Select a finding template --</option>
                            @foreach (var option in findingsOptions)
                            {
                                <option value="@option">@option</option>
                            }
                        </select>
                    </div>
                }
                <textarea class="form-control" rows="3" @bind="partBFindings" placeholder="Summarize your findings after investigation..." style="border-radius: 10px; border: 1px solid #cbd5e1; padding: 12px; font-size: 1rem;"></textarea>
            </div>
            
            @* Agreement *@
            <div class="form-group" style="margin-bottom: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label style="font-weight: 600; color: #1e293b; font-size: 1rem; margin-bottom: 0;">Agreement</label>
                    <button type="button" class="btn btn-sm btn-link" style="padding: 0; font-size: 0.85rem; text-decoration: none; color: #2563eb; font-weight: 500;" @onclick='() => ToggleDropdown("Agreement")'>
                        @(activeDropdown == "Agreement" ? "âŒ Cancel Selection" : "â¬‡ï¸ Quick Select Options")
                    </button>
                </div>

                @if (activeDropdown == "Agreement")
                {
                    <div class="animate-fade-in" style="margin-bottom: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <select class="form-control" style="border-color: #3b82f6; background-color: white; height: 42px; font-size: 0.95rem;" @onchange="OnAgreementSelected">
                            <option value="">-- Select an agreement template --</option>
                            @foreach (var option in agreementOptions)
                            {
                                <option value="@option">@option</option>
                            }
                        </select>
                    </div>
                }
                <textarea class="form-control" rows="3" @bind="partBAgreement" placeholder="State the agreed upon resolution with all parties..." style="border-radius: 10px; border: 1px solid #cbd5e1; padding: 12px; font-size: 1rem;"></textarea>
            </div>
            
            @* Penalty/Action *@
            <div class="form-group" style="margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label style="font-weight: 600; color: #1e293b; font-size: 1rem; margin-bottom: 0;">Penalty/Action</label>
                    <button type="button" class="btn btn-sm btn-link" style="padding: 0; font-size: 0.85rem; text-decoration: none; color: #2563eb; font-weight: 500;" @onclick='() => ToggleDropdown("PenaltyAction")'>
                        @(activeDropdown == "PenaltyAction" ? "âŒ Cancel Selection" : "â¬‡ï¸ Quick Select Options")
                    </button>
                </div>

                @if (activeDropdown == "PenaltyAction")
                {
                    <div class="animate-fade-in" style="margin-bottom: 12px; padding: 12px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <select class="form-control" style="border-color: #3b82f6; background-color: white; height: 42px; font-size: 0.95rem;" @onchange="OnPenaltyActionSelected">
                            <option value="">-- Select a penalty template --</option>
                            @foreach (var option in penaltyActionOptions)
                            {
                                <option value="@option">@option</option>
                            }
                        </select>
                    </div>
                }
                <textarea class="form-control" rows="3" @bind="partBPenaltyAction" placeholder="Specify final penalty or disciplinary action..." style="border-radius: 10px; border: 1px solid #cbd5e1; padding: 12px; font-size: 1rem;"></textarea>
            </div>
        </div>
        <div class="cs-modal-footer" style="padding: 20px 24px; background: #f8fafc; border-top: 1px solid #e2e8f0; display: flex; justify-content: flex-end; gap: 12px;">
            <button class="btn btn-secondary" @onclick="ClosePartBModal" style="padding: 10px 24px; border-radius: 10px; font-weight: 500;">Cancel</button>
            <button class="btn btn-success" @onclick="SavePartBAndResolve" disabled="@isSavingPartB" style="padding: 10px 24px; border-radius: 10px; font-weight: 600; min-width: 140px; display: flex; align-items: center; justify-content: center; gap: 8px; background: #10b981; border: none; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                @if (isSavingPartB)
                {
                    <span class="spinner-border spinner-border-sm"></span>
                    <span>Saving...</span>
                }
                else
                {
                    <span>âœ“</span>
                    <span>Save</span>
                }
            </button>
        </div>
    </div>
}

@* Evidence Modal *@
@if (showEvidenceModal && progressReport is not null)
{
    <div class="cs-modal-backdrop" @onclick="CloseEvidenceModal"></div>
    <div class="cs-modal evidence-modal" @onclick:stopPropagation>
        <div class="cs-modal-header evidence-header">
            <h3 class="modal-title">
                <span class="evidence-icon">ðŸ“·</span>
                Incident Evidence #@progressReport.IncidentID
            </h3>
            <button class="cs-close" @onclick="CloseEvidenceModal">&times;</button>
        </div>
        <div class="cs-modal-body evidence-body">
            @if (!string.IsNullOrWhiteSpace(progressReport.IncidentDescription))
            {
                <div class="evidence-section">
                    <h4 class="evidence-section-title">
                        <span class="section-icon">ðŸ“</span>
                        Incident Description
                    </h4>
                    <div class="evidence-content">
                        <p class="evidence-description">@progressReport.IncidentDescription</p>
                    </div>
                </div>
            }
            
            @if (!string.IsNullOrWhiteSpace(progressReport.EvidencePhotoBase64))
            {
                <div class="evidence-section">
                    <h4 class="evidence-section-title">
                        <span class="section-icon">ðŸ“·</span>
                        Evidence Photo
                    </h4>
                    <div class="evidence-content">
                        <div class="evidence-photo-wrapper" @onclick="TogglePhotoBlur" style="cursor: pointer;">
                            <img src="@progressReport.EvidencePhotoBase64" 
                                 alt="Evidence Photo" 
                                 class="evidence-photo-large @(isPhotoBlurred ? "blurred" : "")" />
                            @if (isPhotoBlurred)
                            {
                                <div class="blur-overlay">
                                    <span class="blur-icon">ðŸ‘ï¸</span>
                                    <p>Click to view</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
            
            @if (string.IsNullOrWhiteSpace(progressReport.IncidentDescription) && string.IsNullOrWhiteSpace(progressReport.EvidencePhotoBase64))
            {
                <div class="no-evidence">
                    <span class="no-evidence-icon">ðŸ“­</span>
                    <p>No evidence available for this incident.</p>
                </div>
            }
        </div>
        <div class="cs-modal-footer">
            <button class="btn btn-secondary" @onclick="CloseEvidenceModal">Close</button>
        </div>
    </div>
}


@* Escalation Progress Modal *@
@if (showEscalationModal && selectedEscalation is not null)
{
    <div class="cs-modal-backdrop" @onclick="CloseEscalationModal"></div>
    <div class="cs-modal progress-modal" @onclick:stopPropagation>
        <div class="cs-modal-header progress-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <div class="header-content">
                <h3 class="modal-title">Escalation Review</h3>
                <span class="incident-id" style="background: rgba(255, 255, 255, 0.2);">Active</span>
            </div>
        </div>
        <div class="cs-modal-body progress-body">
            
            <div class="progress-steps-container">
                @{
                    var status = selectedEscalation.Status;
                }
                
                <div class="progress-steps">
                    <div class="progress-step @(IsEscalationStepDone(0, status) ? "done" : GetEscalationProgressStep(status) == 1 ? "active" : string.Empty)">
                        <div class="step-content">
                            <div class="circle">1</div>
                            <div class="step-info">
                                <div class="label">Reported</div>
                                <div class="step-description">Case registered</div>
                            </div>
                        </div>
                    </div>
                    <div class="connector @(GetEscalationProgressStep(status) > 1 ? "done" : string.Empty)"></div>
                    <div class="progress-step @(IsEscalationStepDone(1, status) ? "done" : GetEscalationProgressStep(status) == 2 ? "active" : string.Empty)">
                        <div class="step-content">
                            <div class="circle">2</div>
                            <div class="step-info">
                                <div class="label">Notification</div>
                                <div class="step-description">Call slip sent</div>
                            </div>
                        </div>
                    </div>
                    <div class="connector @(GetEscalationProgressStep(status) > 2 ? "done" : string.Empty)"></div>
                    <div class="progress-step @(IsEscalationStepDone(2, status) ? "done" : GetEscalationProgressStep(status) == 3 ? "active" : string.Empty)">
                        <div class="step-content">
                            <div class="circle">3</div>
                            <div class="step-info">
                                <div class="label">Investigation</div>
                                <div class="step-description">Inquiry & Part B</div>
                            </div>
                        </div>
                    </div>
                    <div class="connector @(GetEscalationProgressStep(status) > 3 ? "done" : string.Empty)"></div>
                    <div class="progress-step @(GetEscalationProgressStep(status) == 4 ? "done" : string.Empty)">
                        <div class="step-content">
                            <div class="circle">4</div>
                            <div class="step-info">
                                <div class="label">Resolution</div>
                                <div class="step-description">Case resolved</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="progress-details-card" style="margin-top: 20px;">
                <div class="details-header">
                    <h4>Student Information</h4>
                </div>
                <div class="progress-details">
                    <div class="detail-item">
                        <span class="detail-icon">ðŸ‘¤</span>
                        <div class="detail-content">
                            <span class="detail-key">Student Name</span>
                            <span class="detail-val">@selectedEscalation.StudentName</span>
                        </div>
                    </div>
                    @if (currentCallSlip != null)
                    {
                         <div class="detail-item">
                            <span class="detail-icon">ðŸ“„</span>
                            <div class="detail-content">
                                <span class="detail-key">Call Slip Status</span>
                                <span class="detail-val">Generated (@currentCallSlip.GeneratedDate.ToString("MMM dd"))</span>
                            </div>
                        </div>
                    }
                    <div class="detail-item">
                        <span class="detail-icon">ðŸ«</span>
                        <div class="detail-content">
                            <span class="detail-key">School</span>
                            <span class="detail-val">@selectedEscalation.SchoolName</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">ðŸ“š</span>
                        <div class="detail-content">
                            <span class="detail-key">Grade & Section</span>
                            <span class="detail-val">@selectedEscalation.GradeLevel - @selectedEscalation.Section</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="progress-details-card">
                <div class="details-header">
                    <h4>Escalation Details</h4>
                </div>
                <div class="progress-details">
                    <div class="detail-item">
                        <span class="detail-icon">ðŸ“…</span>
                        <div class="detail-content">
                            <span class="detail-key">Date Escalated</span>
                            <span class="detail-val">@selectedEscalation.EscalatedDate.ToString("MMM dd, yyyy")</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-icon">ðŸ§‘â€ðŸ«</span>
                        <div class="detail-content">
                            <span class="detail-key">Escalated By</span>
                            <span class="detail-val">@selectedEscalation.EscalatedBy</span>
                        </div>
                    </div>
                     <div class="detail-item">
                        <span class="detail-icon">â„¹ï¸</span>
                        <div class="detail-content">
                            <span class="detail-key">Reason</span>
                            <span class="detail-val">Accumulated 3 Minor Offenses</span>
                        </div>
                    </div>
                </div>
            </div>

            @* Minor Offense History removed per user request *@

            @{
                bool hasPartBData = !string.IsNullOrWhiteSpace(partBActionTaken) || 
                                   !string.IsNullOrWhiteSpace(partBFindings) || 
                                   !string.IsNullOrWhiteSpace(partBAgreement) || 
                                   !string.IsNullOrWhiteSpace(partBPenaltyAction);
            }

            @if (hasPartBData)
            {
                <div style="margin: 0 16px 12px 16px;">
                    <button class="btn-toggle-resolution @(showResolutionDetails ? "active" : "")" @onclick="() => showResolutionDetails = !showResolutionDetails">
                        <div class="toggle-content">
                            <span class="toggle-icon">@(showResolutionDetails ? "ðŸ“‚" : "ðŸ“")</span>
                            <span class="toggle-label">@(showResolutionDetails ? "Hide Resolution Details" : "View Resolution Details")</span>
                        </div>
                        <span class="chevron">@(showResolutionDetails ? "â–¼" : "â–¶")</span>
                    </button>
                </div>
            }

            @if (hasPartBData && showResolutionDetails)
            {
                var isResolvedStatus = selectedEscalation.Status == EscalationStatus.Resolved;
                <div class="resolution-card @(isResolvedStatus ? "resolved" : "in-progress")" style="margin: 0 16px 20px 16px;">
                    <div class="resolution-header">
                        <h5>
                            <span class="res-icon">@(isResolvedStatus ? "âœ…" : "ðŸ“")</span> 
                            @(isResolvedStatus ? "Resolution Details" : "Resolution in Progress")
                        </h5>
                    </div>
                    <div class="resolution-grid">
                        @if (!string.IsNullOrWhiteSpace(partBActionTaken))
                        {
                            <div class="resolution-item">
                                <div class="resolution-icon-box">ðŸ›¡ï¸</div>
                                <div class="res-item-content">
                                    <span class="res-item-label">Action Taken</span>
                                    <p class="res-item-value">@partBActionTaken</p>
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrWhiteSpace(partBFindings))
                        {
                            <div class="resolution-item">
                                <div class="resolution-icon-box">ðŸ”</div>
                                <div class="res-item-content">
                                    <span class="res-item-label">Findings</span>
                                    <p class="res-item-value">@partBFindings</p>
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrWhiteSpace(partBAgreement))
                        {
                            <div class="resolution-item">
                                <div class="resolution-icon-box">ðŸ¤</div>
                                <div class="res-item-content">
                                    <span class="res-item-label">Agreement</span>
                                    <p class="res-item-value">@partBAgreement</p>
                                </div>
                            </div>
                        }
                        @if (!string.IsNullOrWhiteSpace(partBPenaltyAction))
                        {
                            <div class="resolution-item">
                                <div class="resolution-icon-box">âš–ï¸</div>
                                <div class="res-item-content">
                                    <span class="res-item-label">Penalty/Action</span>
                                    <p class="res-item-value">@partBPenaltyAction</p>
                                </div>
                            </div>
                        }
                    </div>
                    @if (!isResolvedStatus)
                    {
                        <div class="resolution-footer">
                            <button class="btn-res-edit" @onclick="() => OpenPartBModal()">
                                <span class="btn-icon">âœï¸</span> Edit Resolution
                            </button>
                        </div>
                    }
                </div>
            }

            <div class="progress-actions">
                @if (selectedEscalation.Status == EscalationStatus.Active || selectedEscalation.Status == EscalationStatus.Pending)
                {
                    <button class="btn btn-info btn-action" @onclick="() => OpenEscalationCallSlipModal(selectedEscalation)">
                        <span class="btn-icon">ðŸ“„</span>
                        <span>Generate Call Slip</span>
                    </button>
                }
                else if (selectedEscalation.Status == EscalationStatus.Calling)
                {
                    <button class="btn btn-info btn-action" @onclick="() => OpenEscalationCallSlipModal(selectedEscalation)">
                        <span class="btn-icon">ðŸ“„</span>
                        <span>Re-Generate Call Slip</span>
                    </button>
                    <button class="btn btn-outline btn-action" @onclick='() => UpdateEscalationStatus(selectedEscalation.EscalationID, "Arrived")'>
                        <span class="btn-icon">âœ…</span>
                        <span>Student Arrived</span>
                    </button>
                }
                else if (selectedEscalation.Status == EscalationStatus.Arrived)
                {
                    <button class="btn btn-success btn-action" @onclick="() => CreateProfileFromEscalation(selectedEscalation)">
                        <span class="btn-icon">ðŸ“</span>
                        <span>Create Case Record</span>
                    </button>
                }
                else if (selectedEscalation.Status == EscalationStatus.UnderReview)
                {
                    @* Case Under Review alert removed per user request *@
                    
                    <button class="btn btn-primary btn-action" style="width: 100%; height: 42px; font-size: 0.95rem; font-weight: 600; border-radius: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; background: @(hasPartBData ? "#0284c7" : "#3b82f6"); border: none; box-shadow: 0 4px 10px rgba(59, 130, 246, 0.25); margin-top: 16px; margin-bottom: 32px;" @onclick="() => OpenPartBModal()">
                        <span style="font-size: 1.1rem;">ðŸ“</span>
                        <span>@(hasPartBData ? "Continue Part B - Case Resolution" : "Make Part B - Case Resolution")</span>
                    </button>

                    <div class="action-buttons-row" style="display: flex; gap: 10px; width: 100%; margin-top: 20px;">
                        <button class="btn btn-info btn-action" style="flex: 1; padding: 10px 16px; font-size: 0.9rem; background: #0ea5e9; border: none; box-shadow: 0 3px 8px rgba(14, 165, 233, 0.25);" @onclick="() => OpenSimplifiedFormsModalFromEscalation(selectedEscalation.EscalationID)">
                            <i class="fas fa-file-alt btn-icon" style="font-size: 16px;"></i>
                            <span>Review Case Record</span>
                        </button>
                        <button class="btn btn-success btn-action" style="flex: 1; padding: 10px 16px; font-size: 0.9rem; background: #10b981; border: none; box-shadow: 0 3px 8px rgba(16, 185, 129, 0.25);" @onclick='() => UpdateEscalationStatus(selectedEscalation.EscalationID, "Resolved")'>
                            <i class="fas fa-check-circle btn-icon" style="font-size: 16px;"></i>
                            <span>Mark as Resolved</span>
                        </button>
                    </div>
                }
                else if (selectedEscalation.Status == EscalationStatus.ParentOnHold)
                {
                    <div class="alert alert-warning" style="width: 100%; text-align: center; margin-bottom: 10px; background-color: #fff3cd; color: #856404; border-color: #ffeeba;">
                        <span class="btn-icon">ðŸ‘ª</span> Parent Conference Scheduled
                    </div>
                    
                    <div class="action-buttons-row" style="display: flex; gap: 10px; width: 100%; margin-top: 20px;">
                        <button class="btn btn-info btn-action" style="flex: 1; padding: 10px 16px; font-size: 0.9rem; background: #0ea5e9; border: none; box-shadow: 0 3px 8px rgba(14, 165, 233, 0.25);" @onclick="() => OpenSimplifiedFormsModalFromEscalation(selectedEscalation.EscalationID)">
                            <i class="fas fa-file-alt btn-icon" style="font-size: 16px;"></i>
                            <span>Review Case Record</span>
                        </button>
                        <button class="btn btn-success btn-action" style="flex: 1; padding: 10px 16px; font-size: 0.9rem; background: #10b981; border: none; box-shadow: 0 3px 8px rgba(16, 185, 129, 0.25);" @onclick="() => MarkEscalationParentsArrived(selectedEscalation.EscalationID)">
                            <i class="fas fa-user-check btn-icon" style="font-size: 16px;"></i>
                            <span>Parents Arrived</span>
                        </button>
                    </div>
                }
                else if (selectedEscalation.Status == EscalationStatus.Resolved)
                {
                    <div class="alert alert-success" style="width: 100%; text-align: center;">
                        Case Resolved
                    </div>
                }
                else
                {
                    <button class="btn btn-success btn-action" @onclick="() => CreateProfileFromEscalation(selectedEscalation)">
                        <span class="btn-icon">ðŸ“</span>
                        <span>Create Case Record</span>
                    </button>
                }
            </div>
        </div>
        <div class="cs-modal-footer progress-footer">
            <button class="btn btn-secondary progress-close-btn" @onclick="CloseEscalationModal">Close</button>
        </div>
    </div>
}

@* Generic Detail Viewer Modal *@
@if (showDetailModal)
{
    <div class="cs-modal-backdrop" @onclick="CloseDetailModal"></div>
    <div class="cs-modal detail-view-modal" @onclick:stopPropagation>
        <div class="cs-modal-header detail-header">
            <h3 class="modal-title">@detailModalTitle</h3>
            <button class="cs-close" @onclick="CloseDetailModal">&times;</button>
        </div>
        <div class="cs-modal-body detail-body">
            <div class="detail-text-content">
                @detailModalContent
            </div>
        </div>
        <div class="cs-modal-footer">
            <button class="btn btn-primary" @onclick="CloseDetailModal">Close</button>
        </div>
    </div>
}

<style>
    /* Progress Modal Enhanced Styles */
    .progress-modal {
        max-width: 90vw;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        border-radius: 20px;
        box-shadow: 0 25px 50px rgba(102, 126, 234, 0.3);
        animation: modalFadeIn 0.4s ease-out;
    }

    /* Truncation styles */
    .truncate-cell {
        max-width: 120px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.2s ease;
    }

    .nowrap-column {
        white-space: nowrap !important;
    }

    .reports-table {
        overflow-x: hidden !important; 
        width: 100%;
    }

    .table {
        width: 100%;
        table-layout: auto;
    }

    .truncate-cell:hover {
        background-color: rgba(0, 123, 255, 0.1);
        color: #0056b3;
    }

    /* Detail Modal Styles */
    .detail-view-modal {
        max-width: 600px;
        border-radius: 12px;
    }

    .detail-header {
        background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
        color: white;
        padding: 16px 24px;
    }

    .detail-header .modal-title {
        color: white;
        margin: 0;
        font-size: 1.25rem;
    }

    .detail-body {
        padding: 24px;
        max-height: 60vh;
        overflow-y: auto;
    }

    .detail-text-content {
        font-size: 1.1rem;
        line-height: 1.6;
        color: #374151;
        white-space: pre-wrap;
    }

    @@keyframes modalFadeIn {
        from {
            opacity: 0;
            transform: scale(0.95) translateY(-20px);
        }
        to {
            opacity: 1;
            transform: scale(1) translateY(0);
        }
    }

    .progress-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 28px 32px;
        border-bottom: none;
        font-family: 'Poppins', sans-serif !important;
        position: relative;
        overflow: hidden;
    }

    .progress-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        animation: shimmer 3s infinite;
    }

    @@keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    .progress-header .header-content {
        display: flex;
        align-items: baseline;
        gap: 16px;
        position: relative;
        z-index: 1;
    }

    .progress-header .modal-title {
        margin: 0;
        font-size: 2rem;
        font-weight: 700;
        color: white;
        font-family: 'Poppins', sans-serif !important;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .progress-header .incident-id {
        font-size: 1.3rem;
        opacity: 0.95;
        font-weight: 600;
        font-family: 'Poppins', sans-serif !important;
        background: rgba(255, 255, 255, 0.2);
        padding: 6px 16px;
        border-radius: 20px;
        backdrop-filter: blur(10px);
    }

    .progress-header .cs-close {
        display: none !important;
    }

    .progress-header .cs-close:hover {
        display: none !important;
    }

    .progress-body {
        padding: 0;
        max-height: calc(90vh - 200px);
        overflow-y: auto;
        flex: 1;
        position: relative;
    }
    
    .progress-body > * {
        position: relative;
    }
    
    .progress-body > :not(.progress-steps-container) {
        padding: 0 24px;
    }
    
    .progress-body > .progress-steps-container {
        margin: 0 0 28px 0;
    }

    .progress-body::-webkit-scrollbar {
        width: 8px;
    }

    .progress-body::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .progress-body::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .progress-body::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .progress-steps-container {
        margin-bottom: 28px;
        background: #f8f9fa;
        border-radius: 12px;
        position: sticky;
        top: -1px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .progress-steps-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #f8f9fa;
        border-radius: 12px;
        z-index: -1;
    }

    .validation-phase-header {
        text-align: center;
        padding: 16px 24px 12px 24px;
        border-bottom: 2px solid #003d82;
    }

    .validation-phase-header h4 {
        margin: 0;
        color: #003d82;
        font-size: 1.3rem;
        font-weight: 700;
        font-family: 'Poppins', sans-serif;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .phase-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #003d82 0%, #00a8e8 100%);
        color: white;
        border-radius: 50%;
        font-size: 1.1rem;
        font-weight: 700;
        margin-right: 10px;
        box-shadow: 0 2px 8px rgba(0, 61, 130, 0.3);
    }

    .call-time-label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 12px 20px;
        margin: 0 24px 16px 24px;
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1.1rem;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        animation: pulse-glow 2s ease-in-out infinite;
    }

    .call-time-label .time-icon {
        font-size: 1.4rem;
    }

    .call-time-label .time-text {
        font-family: 'Poppins', sans-serif;
    }

    @@keyframes pulse-glow {
        0%, 100% {
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        50% {
            box-shadow: 0 2px 16px rgba(76, 175, 80, 0.5);
        }
    }

    .progress-steps {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 10px;
        position: relative;
        padding: 24px;
    }

    .progress-step {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
    }

    .progress-step .step-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
    }

    .progress-step .circle {
        width: 52px;
        height: 52px;
        border-radius: 50%;
        background: #e5e7eb;
        color: #6b7280;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 18px;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        border: 3px solid #e5e7eb;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .progress-step.active .circle {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
        transform: scale(1.15);
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        animation: pulse 2s ease-in-out infinite;
    }

    @@keyframes pulse {
        0%, 100% {
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        50% {
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
        }
    }

    .progress-step.done .circle {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
        box-shadow: 0 6px 15px rgba(102, 126, 234, 0.3);
    }

    .progress-step .step-info {
        text-align: center;
    }

    .progress-step .label {
        font-weight: 600;
        font-size: 13px;
        color: #374151;
        margin-bottom: 4px;
    }

    .progress-step.active .label {
        color: #003d82;
        font-weight: 700;
    }

    .progress-step.done .label {
        color: #003d82;
    }

    .progress-step .step-description {
        font-size: 11px;
        color: #9ca3af;
        margin-top: 2px;
    }

    .progress-step.active .step-description {
        color: #6b7280;
    }

    .connector {
        flex: 1;
        height: 5px;
        background: #e5e7eb;
        border-radius: 999px;
        margin-top: 26px;
        position: relative;
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .connector.done {
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
    }

    .progress-details-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        margin-top: 32px;
        margin-bottom: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .details-header {
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid #f3f4f6;
    }

    .details-header h4 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
        color: #111827;
    }

    .progress-details {
        display: flex;
        flex-direction: column;
        gap: 14px;
    }

    .detail-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .detail-item-full {
        flex-direction: column;
        align-items: flex-start;
    }

        .detail-item-full .detail-content {
            width: 100%;
            flex-direction: column;
            align-items: flex-start;
        }

        .detail-item-full .detail-val {
            text-align: left;
            width: 100%;
        }

    .detail-icon {
        font-size: 20px;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border-radius: 8px;
        flex-shrink: 0;
    }

    .detail-key {
        color: #6b7280;
        font-size: 14px;
        font-weight: 500;
    }

    .detail-val {
        color: #111827;
        font-weight: 600;
        font-size: 14px;
        text-align: right;
    }

    .view-evidence-link {
        transition: all 0.3s ease;
        border-radius: 8px;
        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
        border: 2px solid #f59e0b;
    }

    .view-evidence-link:hover {
        background: linear-gradient(135deg, #fde68a 0%, #fcd34d 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(245, 158, 11, 0.3);
        border-color: #d97706;
    }

    .view-evidence-link:active {
        transform: translateY(0);
    }

    .evidence-link-text {
        color: #92400e;
        font-weight: 600;
        font-size: 1.05rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .evidence-link-text::after {
        content: 'â†’';
        font-size: 1.2rem;
        transition: transform 0.3s ease;
    }

    .view-evidence-link:hover .evidence-link-text::after {
        transform: translateX(4px);
    }

    /* Incident Description Item - Modern Design */
    .incident-desc-item {
        transition: all 0.3s ease;
        border-radius: 10px;
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        border: 2px solid #818cf8;
        padding: 16px !important;
    }

    .incident-desc-item:hover {
        background: linear-gradient(135deg, #c7d2fe 0%, #a5b4fc 100%);
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(129, 140, 248, 0.3);
        border-color: #6366f1;
    }

    .incident-desc-item:active {
        transform: translateY(0);
    }

    .incident-desc-item .detail-icon {
        background: white;
        box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
    }

    .incident-desc-item .detail-key {
        color: #4338ca;
        font-weight: 700;
        font-size: 15px;
    }

    .incident-desc-link {
        color: #4338ca;
        font-weight: 500;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .incident-desc-link::after {
        content: 'â†’';
        font-size: 1.2rem;
        transition: transform 0.3s ease;
    }

    .incident-desc-item:hover .incident-desc-link::after {
        transform: translateX(4px);
    }

    .evidence-photo-container {
        margin-top: 8px;
        width: 100%;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .evidence-photo {
        width: 100%;
        max-width: 600px;
        height: auto;
        display: block;
        border-radius: 8px;
    }

    .status-badge-modal {

    .details-header h4 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
        color: #111827;
    }

    .progress-details {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .detail-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #f9fafb;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .detail-item:hover {
        background: #f3f4f6;
        transform: translateX(4px);
    }

    .detail-icon {
        font-size: 20px;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border-radius: 8px;
        flex-shrink: 0;
    }

    .detail-content {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
    }

    .detail-key {
        color: #6b7280;
        font-size: 14px;
        font-weight: 500;
    }

    .detail-val {
        color: #111827;
        font-weight: 600;
        font-size: 14px;
        text-align: right;
    }

    .status-badge-modal {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge-modal.status-under-review {
        background: #e6f4ff;
        color: #003d82;
    }

    .status-badge-modal.status-calling {
        background: #f5f3ff;
        color: #5b21b6;
    }

    .status-badge-modal.status-pending {
        background: #fff8e6;
        color: #cc9400;
    }

    .status-badge-modal.status-resolved {
        background: #d1fae5;
        color: #065f46;
    }

    .status-badge-modal.status-approved {
        background: #e0f2fe;
        color: #0369a1;
    }

    .progress-actions {
        display: flex;
        flex-direction: column;
        gap: 12px;
        flex-wrap: wrap;
        margin-top: 8px;
    }

    .case-record-exists {
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
    }

    .action-buttons-row {
        display: flex;
        gap: 12px !important;
        flex-wrap: wrap;
        width: 100%;
        margin-top: 20px;
    }

    .action-buttons-row .btn-action {
        flex: 1;
        min-width: 150px;
        margin: 0 !important;
    }

    .multiple-records-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
        margin-top: 8px;
    }

    .records-count {
        margin: 0 0 12px 0;
        font-weight: 600;
        color: #003d82;
        font-size: 0.95rem;
    }

    .case-records-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .case-record-item-simple {
        display: flex;
        align-items: center;
        gap: 12px;
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 12px 16px;
        margin-bottom: 10px;
    }

    .student-icon {
        font-size: 1.3rem;
    }

    .student-name-text {
        font-weight: 600;
        color: #212529;
        font-size: 1rem;
    }

    .record-id-text {
        color: #6c757d;
        font-size: 0.9rem;
        margin-left: auto;
        margin-right: 16px;
    }

    .btn-compact {
        padding: 8px 16px;
        font-size: 0.9rem;
        border-radius: 6px;
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        white-space: nowrap;
    }

    .success-badge {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: linear-gradient(135deg, #e6f4ff 0%, #b3e0ff 100%);
        border: 2px solid #00a8e8;
        border-radius: 8px;
        color: #003d82;
        font-weight: 600;
        font-size: 14px;
    }

    .success-icon {
        font-size: 20px;
    }

    .btn-action {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        font-weight: 600;
        font-size: 0.95rem;
        border-radius: 8px;
        transition: all 0.2s ease;
        min-height: 40px;
    }

    .btn-action .btn-icon {
        font-size: 18px;
    }

    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .progress-footer {
        padding: 16px 24px;
        background: #f9fafb;
        border-top: 1px solid #e5e7eb;
        display: flex;
        justify-content: flex-end;
        position: sticky;
        bottom: 0;
        z-index: 10;
    }

    .progress-close-btn {
        padding: 12px 24px;
        font-weight: 600;
        font-size: 1rem;
        background: #6c757d;
        color: white;
        border: 1px solid #5a6268;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .progress-close-btn:hover {
        background: #5a6268;
        color: white;
    }

    .cs-close {
        display: none !important;
    }

    @@media (max-width: 640px) {
        .progress-modal {
            width: 95vw;
        }

        .progress-steps {
            flex-direction: column;
            align-items: center;
        }

        .connector {
            width: 4px;
            height: 40px;
            margin: 4px 0;
        }

        .progress-step {
            width: 100%;
        }

        .progress-actions {
            flex-direction: column;
        }

        .btn-action {
            width: 100%;
            justify-content: center;
        }
    }
</style>

@* CSS Styles *@
<style>
    .cs-modal-backdrop {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;
        backdrop-filter: blur(8px);
        animation: backdropFadeIn 0.3s ease-out;
    }

    @@keyframes backdropFadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @@keyframes modalSlideIn {
        from {
            opacity: 0;
            transform: translate(-50%, -50%) translateY(50px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translate(-50%, -50%) translateY(0) scale(1);
        }
    }

    .cs-modal {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 420px; background: #fff; border-radius: 10px; z-index: 1001;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: visible;
        animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .cs-modal.progress-modal {
        width: 650px !important;
        overflow: hidden;
    }
    
    /* Call Slip Modal - higher z-index to show above Progress Modal */
    .cs-modal-backdrop + .cs-modal:not(.progress-modal):not(.respondents-list-modal) {
        z-index: 1100 !important;
    }
    
    .cs-modal-backdrop:has(+ .cs-modal:not(.progress-modal):not(.respondents-list-modal)) {
        z-index: 1099 !important;
    }
    .cs-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid #eee; }
    .cs-modal-body { padding: 16px; }
    .cs-modal-footer { padding: 12px 16px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #eee; }
    .cs-modal .cs-form-row { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
    .cs-modal .cs-close { 
        display: none !important;
    }
    
    .cs-modal.respondents-list-modal {
        width: 500px !important;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .cs-modal-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
        color: #003d82;
    }

    /* Respondents Clickable and Modal Styles */
    .respondent-clickable {
        cursor: pointer;
        color: #333;
        text-decoration: none;
        transition: all 0.2s ease;
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
    }

    .respondent-clickable:hover {
        background-color: #f0f8ff;
        color: #007bff;
        text-decoration: underline;
    }

    .respondents-modal-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 10px 0;
    }

    .respondent-modal-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border-left: 4px solid #007bff;
        transition: all 0.2s ease;
    }

    .respondent-modal-item:hover {
        background-color: #e9ecef;
        transform: translateX(4px);
    }

    .respondent-number {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background-color: #007bff;
        color: white;
        border-radius: 50%;
        font-weight: 700;
        font-size: 14px;
        flex-shrink: 0;
    }

    .respondent-name {
        flex: 1;
        font-size: 16px;
        font-weight: 500;
        color: #333;
    }

    .btn-close-modal {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6c757d;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s ease;
    }

    .btn-close-modal:hover {
        color: #000;
    }
    .pod-dashboard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .pod-dashboard-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 30px;
        background: linear-gradient(135deg, #003d82 0%, #00a8e8 100%);
        color: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        font-family: 'Poppins', sans-serif !important;
    }

    .pod-dashboard-header h2 {
        margin: 0 0 10px 0;
        font-size: 3rem;
        font-weight: 600;
        font-family: 'Poppins', sans-serif !important;
    }

    .pod-dashboard-header p {
        margin: 0;
        font-size: 1.4rem;
        opacity: 0.9;
        font-family: 'Poppins', sans-serif !important;
    }

    .dashboard-actions {
        margin-bottom: 40px;
    }

    .action-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .action-card {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e0e0e0;
        transition: all 0.3s ease;
        text-align: center;
    }

    .action-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        border-color: #00a8e8;
    }

    .action-icon {
        font-size: 3rem;
        margin-bottom: 20px;
        display: block;
    }

    .action-card h3 {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .action-card p {
        color: #666;
        margin-bottom: 25px;
        line-height: 1.6;
    }

    .italic-guide {
        font-style: italic;
        font-size: 0.85rem;
        color: #64748b;
        margin-bottom: 8px;
        display: block;
    }

    .action-buttons {
        display: flex;
        gap: 12px;
        justify-content: center;
        flex-wrap: wrap;
    }

    .btn {
        padding: 16px 32px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.2s ease;
        min-width: 160px;
        min-height: 48px;
        font-family: 'Poppins', sans-serif !important;
    }

    .btn-primary {
        background-color: #00a8e8;
        color: white;
    }

    .btn-primary:hover {
        background-color: #003d82;
        color: white;
        text-decoration: none;
    }

    .btn-outline {
        background-color: transparent;
        color: #00a8e8;
        border: 2px solid #00a8e8;
    }

    .btn-outline:hover {
        background-color: #00a8e8;
        color: white;
        text-decoration: none;
    }

    .btn-success {
        background-color: #00a8e8 !important;
        color: white;
    }

    .btn-success:hover {
        background-color: #003d82 !important;
        color: white;
    }

    .btn-info {
        background-color: #00a8e8 !important;
        color: white;
    }

    .btn-info:hover {
        background-color: #003d82 !important;
        color: white;
    }

    .btn-secondary {
        background-color: #00a8e8 !important;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #003d82 !important;
        color: white;
    }

    .btn-sm {
        padding: 8px 16px;
        font-size: 12px;
        min-width: auto;
    }

    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
        border-left: 4px solid #00a8e8;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        animation: fadeInUp 0.6s ease-out both;
    }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .stat-card:nth-child(1) { animation-delay: 0.1s; }
    .stat-card:nth-child(2) { animation-delay: 0.2s; }
    .stat-card:nth-child(3) { animation-delay: 0.3s; }
    .stat-card:nth-child(4) { animation-delay: 0.4s; }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    .stat-card.pending {
        border-left-color: #ffb800;
    }

    .stat-card.reviewing {
        border-left-color: #00a8e8;
    }

    .stat-card.resolved {
        border-left-color: #28a745;
    }

    .stat-card h3 {
        font-size: 3rem;
        font-weight: 700;
        margin: 0 0 10px 0;
        color: #333;
        font-family: 'Poppins', sans-serif !important;
    }

    .stat-card.pending h3 {
        color: #ffb800;
    }

    .stat-card.reviewing h3 {
        color: #00a8e8;
    }

    .stat-card.resolved h3 {
        color: #28a745;
    }

    .stat-card p {
        margin: 0;
        color: #666;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-size: 1.2rem;
        font-family: 'Poppins', sans-serif !important;
    }

    .incident-reports-section {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid #e0e0e0;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
    }

    .section-header h3 {
        margin: 0;
        color: #333;
        font-size: 1.8rem;
        font-weight: 600;
        font-family: 'Poppins', sans-serif !important;
    }

    .filter-controls {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .form-control {
        padding: 14px 18px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        background: white;
        transition: border-color 0.2s ease;
        min-height: 48px;
        font-family: 'Poppins', sans-serif !important;
    }

    .form-control:focus {
        outline: none;
        border-color: #00a8e8;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
    }

    .table th {
        background-color: #003d82;
        color: white;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #002855;
        border-right: 1px solid rgba(255, 255, 255, 0.2);
        font-family: 'Poppins', sans-serif !important;
        font-size: 1rem;
    }

    .table td {
        padding: 15px 12px;
        border-bottom: 1px solid #dee2e6;
        vertical-align: middle;
        font-family: 'Poppins', sans-serif !important;
        font-size: 1rem;
    }

    .table tr:hover {
        background-color: #f8f9fa;
    }

    .status-badge {
        display: inline-block;
        padding: 10px 18px;
        font-size: 0.95rem;
        font-weight: 600;
        text-transform: uppercase;
        border-radius: 20px;
        letter-spacing: 0.5px;
        font-family: 'Poppins', sans-serif !important;
    }
    .status-pending {
        background-color: #fff8e6;
        color: #cc9400;
        border: 1px solid #ffb800;
    }
    .status-under-review {
        background-color: #e6f4ff;
        color: #003d82;
        border: 1px solid #00a8e8;
    }
    .status-called {
        background-color: #e6f4ff;
        color: #065f46;
        border: 1px solid #bfe0ff;
    }

    .status-arrived {
        background-color: #eefce8;
        color: #1b5e20;
        border: 1px solid #c8f7b9;
    }

    .status-resolved {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .status-closed {
        background-color: #e2e3e5;
        color: #383d41;
        border: 1px solid #d6d8db;
    }

    .status-calling {
        background-color: #f5f3ff;
        color: #5b21b6;
        border: 1px solid #ddd6fe;
    }

    .status-approved {
        background-color: #f0f9ff;
        color: #0369a1;
        border: 1px solid #bae6fd;
    }

    .no-reports {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #00a8e8;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .alert {
        padding: 15px 20px;
        margin-bottom: 25px;
        border-radius: 8px;
        border: 1px solid transparent;
        font-weight: 500;
    }

    /* Snackbar Styles */
    .snackbar {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-100px);
        min-width: 300px;
        max-width: 500px;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 10000;
        opacity: 0;
        transition: all 0.3s ease-in-out;
        font-family: 'Poppins', sans-serif;
        font-size: 14px;
        font-weight: 500;
    }

    .snackbar.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }

    .snackbar-success {
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
    }

    .snackbar-error {
        background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        color: white;
    }

    .snackbar-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        font-size: 16px;
        font-weight: bold;
        flex-shrink: 0;
    }

    .snackbar-message {
        flex: 1;
    }

    .access-denied,
    .login-required {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        max-width: 500px;
        margin: 50px auto;
    }

    .access-denied h2,
    .login-required h2 {
        color: #dc3545;
        margin-bottom: 20px;
    }

    .access-denied p,
    .login-required p {
        color: #666;
        margin-bottom: 30px;
        font-size: 1.1rem;
    }

    @@media (max-width: 768px) {
        .pod-dashboard-container {
            padding: 15px;
        }

        .pod-dashboard-header {
            padding: 20px;
        }

        .pod-dashboard-header h2 {
            font-size: 2rem;
        }

        .action-cards {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .action-card {
            padding: 20px;
        }

        .action-buttons:not(.toolbar-buttons) {
            flex-direction: column;
            gap: 10px;
        }

        .toolbar-buttons.action-buttons {
            flex-direction: row !important;
            flex-wrap: nowrap !important;
            justify-content: center;
            width: 100%;
            margin-top: 10px;
            gap: 8px !important;
        }

        .toolbar-buttons .btn {
            width: auto !important;
            flex: 0 0 auto;
            min-width: 0;
            padding: 8px 12px;
            font-size: 0.8rem;
            min-height: 36px;
            white-space: nowrap;
        }

        .btn:not(.toolbar-buttons .btn) {
            width: 100%;
        }

        .dashboard-stats {
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .section-header {
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }

        .filter-controls {
            justify-content: center;
        }

        .table {
            font-size: 14px;
        }

        .table th,
        .table td {
            padding: 10px 8px;
        }
    }

    /* Evidence Modal Styles */
    .evidence-modal {
        max-width: 1100px;
        width: 95%;
        max-height: 92vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .evidence-header {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        padding: 20px 24px;
        border-bottom: none;
    }

    .evidence-header .modal-title {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .evidence-icon {
        font-size: 1.8rem;
    }

    .evidence-body {
        padding: 32px;
        max-height: calc(92vh - 150px);
        overflow-y: auto;
        flex: 1;
    }

    .evidence-body::-webkit-scrollbar {
        width: 8px;
    }

    .evidence-body::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .evidence-body::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .evidence-body::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    .evidence-section {
        margin-bottom: 28px;
        background: #f9fafb;
        border-radius: 12px;
        padding: 24px;
        border: 1px solid #e5e7eb;
    }

    .evidence-section:last-child {
        margin-bottom: 0;
    }

    .evidence-section-title {
        margin: 0 0 18px 0;
        font-size: 1.35rem;
        font-weight: 700;
        color: #111827;
        display: flex;
        align-items: center;
        gap: 10px;
        border-bottom: 2px solid #f59e0b;
        padding-bottom: 10px;
    }

    .section-icon {
        font-size: 1.6rem;
    }

    .evidence-content {
        margin-top: 12px;
    }

    .evidence-description {
        white-space: pre-wrap;
        word-break: break-word;
        overflow-wrap: break-word;
        line-height: 2;
        color: #374151;
        font-size: 1.15rem;
        margin: 0;
        padding: 20px;
        background: white;
        border-radius: 8px;
        border-left: 4px solid #f59e0b;
        max-height: 400px;
        overflow-y: auto;
    }

    .evidence-description::-webkit-scrollbar {
        width: 6px;
    }

    .evidence-description::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    .evidence-description::-webkit-scrollbar-thumb {
        background: #f59e0b;
        border-radius: 3px;
    }

    .evidence-description::-webkit-scrollbar-thumb:hover {
        background: #d97706;
    }

    .evidence-photo-wrapper {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 12px;
        background: white;
        border-radius: 8px;
        position: relative;
        min-height: 200px;
    }

    .evidence-photo-large {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
    }

    .evidence-photo-large.blurred {
        filter: blur(20px);
    }

    .evidence-photo-large:hover {
        transform: scale(1.02);
    }

    .blur-overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #374151;
        pointer-events: none;
        z-index: 10;
    }

    .blur-icon {
        font-size: 3rem;
        display: block;
        margin-bottom: 8px;
        animation: pulse-eye 2s ease-in-out infinite;
    }

    .blur-overlay p {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0;
        color: #111827;
    }

    @@keyframes pulse-eye {
        0%, 100% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.1);
            opacity: 0.8;
        }
    }

    .no-evidence {
        text-align: center;
        padding: 40px 20px;
        color: #6b7280;
    }

    .no-evidence-icon {
        font-size: 3rem;
        display: block;
        margin-bottom: 16px;
    }

    .no-evidence p {
        font-size: 1.1rem;
        margin: 0;
    }

    /* Mobile Responsive Optimizations */
    @@media (max-width: 768px) {
        .progress-modal {
            max-width: 95vw;
            max-height: 95vh;
            border-radius: 16px;
        }

        .progress-header {
            padding: 16px;
        }

        .progress-header .modal-title {
            font-size: 1.25rem;
        }

        .progress-header .incident-id {
            font-size: 0.9rem;
            padding: 4px 10px;
        }

        .progress-body > :not(.progress-steps-container) {
            padding: 0 16px;
        }

        .progress-steps {
            padding: 16px 10px;
            gap: 5px;
        }

        .progress-step .circle {
            width: 32px;
            height: 32px;
            font-size: 12px;
            border-width: 2px;
        }

        .progress-step .label {
            font-size: 9px;
        }
        
        .progress-step .step-description {
            display: none; /* Hide detailed description on mobile to save space */
        }

        .connector {
            margin-top: 16px; /* Adjust for smaller circle */
        }

        .progress-details-card {
            padding: 16px;
            margin-top: 16px;
        }

        .details-header h4 {
            font-size: 1rem;
        }

        .detail-item {
            padding: 10px;
            gap: 10px;
        }

        .detail-icon {
            width: 28px;
            height: 28px;
            font-size: 14px;
        }

        .detail-key {
            font-size: 11px;
        }

        .detail-val {
            font-size: 12px;
        }
        
        .progress-actions {
            flex-direction: column;
            gap: 12px;
        }
        
        /* Force side-by-side layout for button rows */
        .action-buttons-row {
            flex-direction: row !important;
            flex-wrap: nowrap !important;
            gap: 8px !important;
            margin-top: 12px !important;
        }
        
        /* General mobile buttons */
        .btn-action {
            width: 100%;
            height: auto;
            padding: 8px 10px;
            font-size: 0.75rem;
            min-height: 36px;
        }
        
        /* Buttons inside row should not be full width */
        .action-buttons-row .btn-action {
            width: auto !important;
            min-width: 0 !important;
            padding: 8px 4px !important;
            white-space: nowrap;
        }
        
        .btn-action .btn-icon {
            font-size: 12px;
        }
        
        .progress-footer {
            padding: 12px 16px;
        }
        
        .progress-close-btn {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        /* Compact View Evidence Button */
        .btn-toggle-resolution {
            padding: 8px 12px !important;
            min-height: 36px;
        }
        
        .btn-toggle-resolution .toggle-content {
            gap: 6px;
        }
        
        .btn-toggle-resolution .toggle-icon {
            font-size: 14px;
        }
        
        .btn-toggle-resolution .toggle-label {
            font-size: 0.85rem;
            white-space: nowrap;
        }
        
        .btn-toggle-resolution .chevron {
            font-size: 0.8rem;
        }
    }

    /* Guide Modal Styles */
    .guide-modal {
        max-width: 850px;
        border-radius: 20px;
        overflow: hidden;
    }

    .guide-header-icon {
        font-size: 2.5rem;
        color: #00a8e8;
        margin-right: 20px;
    }

    .header-content {
        display: flex;
        align-items: center;
    }

    .guide-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 24px;
        padding: 10px;
    }

    .guide-item {
        display: flex;
        gap: 16px;
        padding: 20px;
        background: #f8fbff;
        border-radius: 12px;
        border: 1px solid #e1e9f5;
        transition: transform 0.2s ease;
    }

    .guide-item:hover {
        transform: translateY(-3px);
        background: #fff;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }

    .guide-icon-wrapper {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .guide-icon-wrapper.blue { background: #e0f2fe; color: #0369a1; }
    .guide-icon-wrapper.orange { background: #ffedd5; color: #c2410c; }
    .guide-icon-wrapper.red { background: #fee2e2; color: #b91c1c; }
    .guide-icon-wrapper.green { background: #dcfce7; color: #15803d; }

    .guide-text h4 {
        margin: 0 0 8px 0;
        font-size: 1.1rem;
        color: #1e293b;
    }

    .guide-text ul {
        margin: 0;
        padding-left: 18px;
        font-size: 0.9rem;
        color: #64748b;
    }

    .guide-text li {
        margin-bottom: 6px;
    }

    @@media (max-width: 768px) {
        .guide-grid {
            grid-template-columns: 1fr;
        }
        
        .guide-header-icon {
            font-size: 2rem;
            margin-right: 12px;
        }                                                             

        .guide-item {
            padding: 16px;
        }
    }
</style>
