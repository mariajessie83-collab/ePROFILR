@page "/incident-report"
@layout Gsystem.Layout.Walkinlayout
@using System.Text.Json
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Headers
@using SharedProject
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@inject NavigationManager NavigationManager

<style>
    .suggestions-dropdown {
        position: absolute;
        top: 100%;
        left: 0; 
        right: 0;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
    }
    
    .suggestion-item {
        padding: 10px 12px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    
    .suggestion-item div {
        line-height: 1.4;
    }
    
    .suggestion-item:hover {
        background-color: #f8f9fa;
    }
    
    .suggestion-item:last-child {
        border-bottom: none;
    }
    
    .position-relative {
        position: relative;
    }

    .checkbox-container {
        margin-bottom: 12px;
        padding: 10px;
        background-color: #f0f8ff;
        border: 1px solid #b3d9ff;
        border-radius: 6px;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        font-weight: 500;
        color: #003d82;
        user-select: none;
    }

    .checkbox-label input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
        accent-color: #007bff;
        flex-shrink: 0;
    }

    .checkbox-label span {
        font-size: 14px;
        line-height: 1.4;
    }

    .checkbox-label:hover {
        color: #0056b3;
    }

    .form-control:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
        opacity: 0.7;
    }

    /* Form Separator Line */
    .form-separator {
        height: 1px;
        background-color: #e0e0e0;
        margin: 25px 0;
        width: 100%;
    }

    /* Guide Text Styling */
    .form-text-guide {
        display: block;
        margin-top: 6px;
        font-size: 0.875rem;
        color: #6c757d;
        font-style: italic;
        line-height: 1.4;
    }

    /* Description Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    
    .modal-container {
        background: white;
        border-radius: 12px;
        padding: 30px;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    
    .modal-title {
        margin-top: 0;
        margin-bottom: 20px;
        color: #007bff;
        font-size: 24px;
        font-weight: 700;
    }

    .modal-footer {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }

    /* Clickable description field */
    .description-input-wrapper {
        cursor: pointer;
        position: relative;
    }
    
    .clickable-description {
        cursor: pointer !important;
        background-color: #f8f9fa !important;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: 2px solid #e9ecef !important;
    }
    
    .clickable-description:hover {
        background-color: #ffffff !important;
        border-color: #007bff !important;
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.15);
        transform: translateY(-1px);
    }

    .description-input-wrapper:hover small {
        color: #007bff !important;
        font-weight: 600;
    }

    .report-title {
        text-align: center;
        color: #007bff;
        font-weight: 800;
        font-size: 3rem;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 2px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    .report-subtitle {
        text-align: center;
        color: #6c757d;
        font-size: 1.1rem;
        max-width: 700px;
        margin: 0 auto 30px auto;
        line-height: 1.6;
        font-style: italic;
    }
    /* Autocomplete Styles */
    .autocomplete-wrapper {
        position: relative;
    }

    .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        background-color: white;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 0;
        margin: 0;
        list-style: none;
    }

    .autocomplete-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .autocomplete-item:hover {
        background-color: #f8f9fa;
        color: #007bff;
    }

    /* Force uppercase text for inputs (except tel for phone numbers) */
    input[type="text"], textarea, .form-control:not([type="tel"]) {
        text-transform: uppercase;
    }
</style>

<PageTitle>Incident Report</PageTitle>

<h2 class="report-title">Incident Report</h2>
<p class="report-subtitle">Help us maintain a safe and supportive learning environment by providing detailed and accurate incident information.</p>

<div class="wizard-stepper-container">
    <div class="wizard-stepper">
        <div class="step-item @(step >= 1 ? "active" : "") @(step > 1 ? "done" : "")">
            <div class="step-circle">1</div>
            <span class="step-label">Location</span>
        </div>
        <div class="step-line @(step > 1 ? "done" : "")"></div>
        <div class="step-item @(step >= 2 ? "active" : "") @(step > 2 ? "done" : "")">
            <div class="step-circle">2</div>
            <span class="step-label">Person Info</span>
        </div>
        <div class="step-line @(step > 2 ? "done" : "")"></div>
        <div class="step-item @(step >= 3 ? "active" : "") @(step > 3 ? "done" : "")">
            <div class="step-circle">3</div>
            <span class="step-label">Incident</span>
        </div>
        <div class="step-line @(step > 3 ? "done" : "")"></div>
        <div class="step-item @(step >= 4 ? "active" : "") @(step > 4 ? "done" : "")">
            <div class="step-circle">4</div>
            <span class="step-label">Evidence</span>
        </div>
        <div class="step-line @(step > 4 ? "done" : "")"></div>
        <div class="step-item @(step >= 5 ? "active" : "") @(step > 5 ? "done" : "")">
            <div class="step-circle">5</div>
            <span class="step-label">Review</span>
        </div>
    </div>
</div>

@if (!isSuccess && !string.IsNullOrEmpty(message))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert" style="margin: 20px auto; max-width: 800px;">
        <strong>@message</strong>
        <button type="button" class="btn-close" @onclick="@(() => { message = string.Empty; })" aria-label="Close"></button>
    </div>
}

<div class="incident-report-container">
    <div class="incident-report-card">
        <EditForm Model="incidentReport" @key="formKey">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <!-- Step 1: Division and School Selection -->
            @if (step == 1)
            {
                <div class="form-section">
                    <h3>Location Selection</h3>
                    
                    <div class="form-group">
                        <label for="selectedDivision">Division <span class="required-asterisk">*</span></label>
                        <select id="selectedDivision" class="form-control" value="@selectedDivision" @onchange="OnDivisionChanged">
                            <option value="">-- Select Division --</option>
                            @foreach (var division in divisions)
                            {
                                <option value="@division.Division">@division.Division</option>
                            }
                        </select>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(selectedDivision))
                    {
                        <div class="form-group">
                            <label for="schoolSearch">School <span class="required-asterisk">*</span></label>
                            <div class="autocomplete-wrapper">
                                <input type="text" 
                                       id="schoolSearch" 
                                       class="form-control" 
                                       placeholder="Type to search school..." 
                                       @bind="schoolSearchTerm" 
                                       @oninput="OnSchoolSearchInput" 
                                       autocomplete="off" />
                                
                                @if (showSchoolSuggestions && filteredSchools.Any())
                                {
                                    <ul class="autocomplete-results">
                                        @foreach (var school in filteredSchools)
                                        {
                                            <li class="autocomplete-item" @onclick="() => SelectSchool(school)">
                                                @school.SchoolName
                                            </li>
                                        }
                                    </ul>
                                }
                            </div>
                            <p style="font-style: italic; color: #6c757d; font-size: 0.85rem; margin-top: 10px; opacity: 0.8;">
                                Tip: Type the school name and select from the list.
                            </p>
                        </div>
                    }
                    
                    @if (!string.IsNullOrEmpty(selectedSchool))
                    {
                        <div class="wizard-nav">
                            <button type="button" class="btn btn-primary" @onclick="NextStep">Continue ‚ûî</button>
                        </div>
                    }
                </div>
            }

            <!-- Step 2: Complainant and Respondent Full Names -->
            @if (step == 2)
            {
                <div class="form-section">
                    <h3>Person Information</h3>
                    <div class="form-group">
                        <div class="checkbox-container">
                            <label class="checkbox-label">
                                <input type="checkbox" @bind="isAnonymous" @oninput="OnAnonymousToggled" />
                                <span>Report Anonymously</span>
                            </label>
                        </div>
                        <label for="fullName">Complainant Full Name <span class="required-asterisk">*</span></label>
                        <InputText id="fullName" class="form-control" @bind-Value="incidentReport.FullName" placeholder="Enter complainant full name" disabled="@isAnonymous" />
                        <small class="form-text-guide"><em>Format: Last Name, First Name, Middle Initial (e.g., Dela Cruz, Juan P.)</em></small>
                    </div>

                    <div class="form-group">
                        <label for="complainantContact">Complainant Contact Number <span class="required-asterisk">*</span></label>
                        <InputText id="complainantContact" 
                                   type="tel" 
                                   class="form-control" 
                                   @bind-Value="incidentReport.ComplainantContactNumber" 
                                   placeholder="09XXXXXXXXX" 
                                   maxlength="11"
                                   pattern="[0-9]*"
                                   @oninput="@FormatContactNumber" />
                        <small class="form-text-guide"><em>Format: 09XXXXXXXXX (11 digits, must start with 09)</em></small>
                        <ValidationMessage For="@(() => incidentReport.ComplainantContactNumber)" />
                    </div>
                    
                    <!-- Visual Separator Line -->
                    <div class="form-separator"></div>
                    
                    <div class="form-group">
                        <label>Respondent Full Name(s) <span class="required-asterisk">*</span></label>
                        @for (int i = 0; i < respondentNames.Count; i++)
                        {
                            var index = i;
                            <div class="d-flex gap-2 mb-2">
                                <div class="flex-grow-1">
                                    <InputText class="form-control" @bind-Value="respondentNames[index]" placeholder="Enter respondent full name" />
                                </div>
                                @if (respondentNames.Count > 1)
                                {
                                    <button type="button" class="btn btn-danger" @onclick="() => RemoveRespondent(index)">‚úï</button>
                                }
                            </div>
                        }
                        <button type="button" class="btn btn-outline-primary btn-sm mt-1" @onclick="AddRespondent">+ Add Another Respondent</button>
                        <small class="form-text-guide"><em>Format: Last Name, First Name, Middle Initial (e.g., Santos, Maria C.)</em></small>
                    </div>
                    <div class="wizard-nav">
                        <button type="button" class="btn btn-secondary" @onclick="PrevStep">Back</button>
                        <button type="button" class="btn btn-primary" @onclick="NextStep">Next ‚ûî</button>
                    </div>
                </div>
            }
            <!-- Step 3: Incident Classification and Details -->
            @if (step == 3)
            {
                <div class="form-section">
                    <h3>Incident Details</h3>
                    <div class="form-group">
                        <label for="hasVictim">Does this incident involve a victim? <span class="required-asterisk">*</span></label>
                        <select id="hasVictim" class="form-control" value="@hasVictim" @onchange="OnHasVictimChanged">
                            <option value="">-- Select Option --</option>
                            <option value="Yes">Yes - Has Victim</option>
                            <option value="No">No - No Victim</option>
                        </select>
                        <small class="form-text-guide"><em>This question helps classify the incident. Please select Yes or No to enable the incident type selection.</em></small>
                    </div>
                    
                    @if (hasVictim == "Yes")
                    {
                        <div class="form-group">
                            <label>Victim Name(s) <span class="required-asterisk">*</span></label>
                            @for (int i = 0; i < victimNames.Count; i++)
                            {
                                var index = i;
                                <div class="d-flex gap-2 mb-2">
                                    <div class="flex-grow-1">
                                        <InputText class="form-control" @bind-Value="victimNames[index]" placeholder="Enter victim full name" />
                                    </div>
                                    @if (victimNames.Count > 1)
                                    {
                                        <button type="button" class="btn btn-danger" @onclick="() => RemoveVictim(index)">‚úï</button>
                                    }
                                </div>
                            }
                            <button type="button" class="btn btn-outline-primary btn-sm mt-1" @onclick="AddVictim">+ Add Another Victim</button>
                            <small class="form-text-guide"><em>Format: Last Name, First Name, Middle Initial (e.g., Dela Cruz, Juan P.)</em></small>
                        </div>
                    }
                    
                    <div class="form-group">
                        <label for="incidentType">Type of Incident <span class="required-asterisk">*</span></label>
                        <select id="incidentType" class="form-control" value="@incidentReport.IncidentType" @onchange="OnIncidentTypeChanged" disabled="@(string.IsNullOrEmpty(hasVictim))">
                            <option value="">-- Select Incident Type --</option>
                            @if (!string.IsNullOrEmpty(hasVictim))
                            {
                                @if (hasVictim == "Yes")
                                {
                                    @foreach (var category in new[] { "Major", "Prohibited Acts" })
                                    {
                                        @if (violationTypesByCategory.ContainsKey(category))
                                        {
                                            var violations = violationTypesByCategory[category].Where(v => violationTypesWithVictim.Contains(v)).ToList();
                                            @if (violations.Any())
                                            {
                                                <optgroup label="‚îÅ‚îÅ‚îÅ @category.ToUpper() ‚îÅ‚îÅ‚îÅ">
                                                    @foreach (var violationType in violations)
                                                    {
                                                        <option value="@violationType">@violationType</option>
                                                    }
                                                </optgroup>
                                            }
                                        }
                                    }
                                }
                                else if (hasVictim == "No")
                                {
                                    @foreach (var category in new[] { "Major", "Prohibited Acts" })
                                    {
                                        @if (violationTypesByCategory.ContainsKey(category))
                                        {
                                            var violations = violationTypesByCategory[category].Where(v => !violationTypesWithVictim.Contains(v)).ToList();
                                            @if (violations.Any())
                                            {
                                                <optgroup label="‚îÅ‚îÅ‚îÅ @category.ToUpper() ‚îÅ‚îÅ‚îÅ">
                                                    @foreach (var violationType in violations)
                                                    {
                                                        <option value="@violationType">@violationType</option>
                                                    }
                                                </optgroup>
                                            }
                                        }
                                    }
                                }
                            }
                        </select>
                        <small class="form-text-guide"><em>This dropdown is for selecting the type of incident. It will be enabled after you select whether the incident has a victim or not.</em></small>
                        <ValidationMessage For="@(() => incidentReport.IncidentType)" />
                    </div>
                    <div class="form-group">
                        <label for="description">Description <span class="required-asterisk">*</span></label>
                        <div class="description-input-wrapper" @onclick="@OpenDescriptionModal">
                            <textarea id="description" class="form-control clickable-description" rows="6" 
                                value="@incidentReport.Description" 
                                @onclick="@((MouseEventArgs e) => OpenDescriptionModal())"
                                @onfocus="@OpenDescriptionModal"
                                placeholder="Click here to enter detailed description of the incident..." readonly></textarea>
                            <small class="form-text-guide"><em>Click this field to open the description form. Include date, time, location, and what happened.</em></small>
                        </div>
                        <ValidationMessage For="@(() => incidentReport.Description)" />
                    </div>
                    <div class="wizard-nav">
                        <button type="button" class="btn btn-secondary" @onclick="PrevStep">Back</button>
                        <button type="button" class="btn btn-primary" @onclick="NextStep">Next ‚ûî</button>
                    </div>
                </div>
            }
            <!-- Step 4: Evidence -->
            @if (step == 4)
            {
                <div class="form-section">
                    <h3>Evidence</h3>
                    <div class="form-group">
                        <label for="evidencePhoto">Evidence Photo (Optional)</label>
                        <InputFile id="evidencePhoto" class="form-control" accept="image/*" OnChange="HandlePhotoUpload" />
                        <small class="form-text-guide"><em>This upload box is for submitting photo evidence if available. Supported formats: JPG, PNG, GIF (Maximum 5MB).</em></small>
                        @if (!string.IsNullOrEmpty(incidentReport.EvidencePhotoBase64))
                        {
                            <div class="photo-preview-container mt-3">
                                <div class="photo-preview-wrapper">
                                    <img src="@incidentReport.EvidencePhotoBase64" alt="Evidence Photo" class="evidence-photo" />
                                </div>
                                <div class="photo-actions mt-2">
                                    <button type="button" class="btn btn-sm btn-danger" @onclick="RemovePhoto">
                                        <span>üóëÔ∏è</span> Remove Photo
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                    <!-- Navigation -->
                    <div class="wizard-nav">
                        <button type="button" class="btn btn-secondary" @onclick="PrevStep">Back</button>
                        <button type="button" class="btn btn-primary" @onclick="NextStep">Review ‚ûî</button>
                        <NavLink href="/" class="btn btn-outline">Cancel</NavLink>
                    </div>
                </div>
            }
            <!-- Step 5: Review & Submit -->
            @if (step == 5)
            {
                <div class="form-section">
                    <h3>Review Your Report</h3>
                    <p class="text-muted mb-4">Please review all the information below. You can go back to any step to make changes before submitting.</p>
                    
                    <div class="review-section">
                        <!-- Location Information -->
                        <div class="review-card">
                            <div class="review-header">
                                <h4>1. Location</h4>
                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="@(() => GoToStep(1))">Edit</button>
                            </div>
                            <div class="review-content">
                                <div class="review-item">
                                    <strong>Division:</strong> @selectedDivision
                                </div>
                                <div class="review-item">
                                    <strong>School:</strong> @selectedSchool
                                </div>
                            </div>
                        </div>

                        <!-- Person Information -->
                        <div class="review-card">
                            <div class="review-header">
                                <h4>2. Person Information</h4>
                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="@(() => GoToStep(2))">Edit</button>
                            </div>
                            <div class="review-content">
                                <div class="review-item">
                                    <strong>Full Name:</strong> @(isAnonymous ? "Anonymous" : incidentReport.FullName)
                                </div>
                                <div class="review-item">
                                    <strong>Respondent Name(s):</strong> @string.Join(" / ", respondentNames.Where(n => !string.IsNullOrWhiteSpace(n)))
                                </div>
                            </div>
                        </div>

                        <!-- Incident Details -->
                        <div class="review-card">
                            <div class="review-header">
                                <h4>3. Incident Details</h4>
                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="@(() => GoToStep(3))">Edit</button>
                            </div>
                            <div class="review-content">
                                <div class="review-item">
                                    <strong>Has Victim:</strong> @(string.IsNullOrEmpty(hasVictim) ? "Not specified" : hasVictim)
                                </div>
                                @if (hasVictim == "Yes")
                                {
                                    <div class="review-item">
                                        <strong>Victim Name(s):</strong> @string.Join(", ", victimNames.Where(n => !string.IsNullOrWhiteSpace(n)))
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- Incident Information -->
                        <div class="review-card">
                            <div class="review-header">
                                <h4>4. Incident Information</h4>
                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="@(() => GoToStep(3))">Edit</button>
                            </div>
                            <div class="review-content">
                                <div class="review-item">
                                    <strong>Type of Incident:</strong> @incidentReport.IncidentType
                                </div>
                                <div class="review-item">
                                    <strong>Description:</strong>
                                    <div class="review-description">@incidentReport.Description</div>
                                </div>
                            </div>
                        </div>

                        <!-- Evidence -->
                        <div class="review-card">
                            <div class="review-header">
                                <h4>5. Evidence</h4>
                                <button type="button" class="btn btn-sm btn-outline-primary" @onclick="@(() => GoToStep(4))">Edit</button>
                            </div>
                            <div class="review-content">
                                @if (!string.IsNullOrEmpty(incidentReport.EvidencePhotoBase64))
                                {
                                    <div class="review-item">
                                        <strong>Evidence Photo:</strong>
                                        <div class="review-photo-preview">
                                            <img src="@incidentReport.EvidencePhotoBase64" alt="Evidence Photo" />
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <div class="review-item">
                                        <strong>Evidence Photo:</strong> No photo uploaded
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Submit/Back Navigation -->
                    <div class="wizard-nav">
                        <button type="button" class="btn btn-secondary" @onclick="PrevStep">Back</button>
                        <button type="button" class="btn btn-success btn-lg" @onclick="@HandleSubmit" disabled="@isLoading">
                            @(isLoading ? "Submitting Report..." : "‚úì Submit Incident Report")
                        </button>
                        <NavLink href="/" class="btn btn-outline">Cancel</NavLink>
                    </div>
                </div>
            }
        </EditForm>
    </div>
</div>

<!-- Description Modal -->
@if (showDescriptionModal)
{
    <div class="modal-overlay" @onclick="@CloseDescriptionModal">
        <div class="modal-container" @onclick:stopPropagation="true">
            <h3 class="modal-title">Incident Description</h3>
            <div class="modal-body">
                <div class="form-group">
                    <label for="descriptionDate">Date <span class="required-asterisk">*</span></label>
                    <input type="date" id="descriptionDate" class="form-control" @bind="descriptionDate" />
                    <small class="form-text-guide"><em>Select the date when the incident occurred.</em></small>
                </div>
                <div class="form-group">
                    <label for="descriptionTime">Time <span class="required-asterisk">*</span></label>
                    <input type="time" id="descriptionTime" class="form-control" @bind="descriptionTime" />
                    <small class="form-text-guide"><em>Select the time when the incident occurred.</em></small>
                </div>
                <div class="form-group">
                    <label for="descriptionLocation">Location <span class="required-asterisk">*</span></label>
                    <InputText id="descriptionLocation" class="form-control" @bind-Value="descriptionLocation" placeholder="Enter the location where the incident occurred" />
                    <small class="form-text-guide"><em>Enter the specific location where the incident happened (e.g., Classroom 101, School Gym, etc.).</em></small>
                </div>
                <div class="form-group">
                    <label for="descriptionDetails">Description <span class="required-asterisk">*</span></label>
                    <textarea id="descriptionDetails" class="form-control" rows="5" 
                        @bind="descriptionDetails" 
                        placeholder="Enter detailed description of what happened..."></textarea>
                    <small class="form-text-guide"><em>Provide a detailed description of what happened during the incident.</em></small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" @onclick="@CloseDescriptionModal">Cancel</button>
                <button type="button" class="btn btn-primary" @onclick="@ApplyDescription">Apply</button>
            </div>
        </div>
    </div>
}

<!-- Success Modal with Reference Number - Moved outside if-blocks to ensure visibility -->
@if (showSuccessModal)
{
    <div class="modal-overlay" @onclick="@CloseSuccessModal">
        <div class="modal-container" @onclick:stopPropagation="true" style="text-align: center;">
            <div style="font-size: 60px; margin-bottom: 20px;">‚úÖ</div>
            <h3 class="modal-title" style="color: #22bb33;">Report Submitted Successfully!</h3>
            <p style="color: #64748b; margin-bottom: 25px;">Your incident report has been submitted successfully.</p>
            
            @if (!string.IsNullOrEmpty(referenceNumber))
            {
                <div style="background: #f1f5f9; padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                    <small style="color: #64748b; font-weight: 600; text-transform: uppercase;">Reference Number</small>
                    <div style="font-size: 1.8rem; font-weight: 800; color: #0f172a; margin-top: 10px;">@referenceNumber</div>
                </div>
            }
            
            <div class="modal-footer" style="justify-content: center;">
                <button type="button" class="btn btn-primary" @onclick="@CloseSuccessModal">OK</button>
            </div>
        </div>
    </div>
}

<!-- Loading Overlay -->
@if (isLoading)
{
    <div class="loading-overlay">
        <div class="spinner"></div>
        <h3>Submitting Report...</h3>
        <p>Please wait while we process your request.</p>
    </div>
}

@code {
    // Simplified Incident Report Model
    private SimplifiedIncidentReport incidentReport = new();
    private bool isLoading = false;
    private bool isSuccess = false;
    private string message = string.Empty;
    private string formKey = Guid.NewGuid().ToString();
    private bool showSuccessModal = false;
    private string? referenceNumber = null;
    
    // Division and School Selection
    private List<School> allSchools = new();
    private List<School> divisions = new();
    private List<School> schools = new();
    private string selectedDivision = string.Empty;
    private string selectedSchool = string.Empty;
    
    // Autocomplete fields
    private string schoolSearchTerm = string.Empty;
    private List<School> filteredSchools = new();
    private bool showSchoolSuggestions = false;

    // Violation types from database - grouped by category
    private Dictionary<string, List<string>> violationTypesByCategory = new();
    // Track which violation types have victims (from database HasVictim column)
    private HashSet<string> violationTypesWithVictim = new();

    private int step = 1; // Start with 1 (Location Selection)
    private readonly int maxStep = 5; // 5 steps: 1=Location, 2=Person, 3=Incident, 4=Evidence, 5=Review
    
    // Has Victim field
    private string hasVictim = string.Empty;
    private List<string> respondentNames = new() { "" };
    private List<string> victimNames = new() { "" };
    
    // Description Modal fields
    private bool showDescriptionModal = false;
    private DateTime descriptionDate = DateTime.Now;
    private TimeOnly descriptionTime = TimeOnly.FromDateTime(DateTime.Now);
    private string descriptionLocation = string.Empty;
    private string descriptionDetails = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadDivisions();
        await LoadViolationTypes();
    }

    private async Task LoadDivisions()
    {
        try
        {
            var response = await Http.GetAsync("/api/Auth/schools");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var apiResponse = JsonSerializer.Deserialize<ApiResponse<List<School>>>(content, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (apiResponse?.Success == true && apiResponse.Data != null)
                {
                    allSchools = apiResponse.Data;
                    // Get unique divisions
                    divisions = allSchools
                        .Where(s => !string.IsNullOrEmpty(s.Division))
                        .GroupBy(s => s.Division?.Trim())
                        .Select(g => new School { Division = g.Key, DivisionName = g.Key })
                        .ToList();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading divisions: {ex.Message}");
        }
    }

    private async Task OnDivisionChanged(ChangeEventArgs e)
    {
        selectedDivision = e.Value?.ToString() ?? string.Empty;
        selectedSchool = string.Empty;
        schools.Clear();
        
        if (!string.IsNullOrEmpty(selectedDivision))
        {
            schools = allSchools
                .Where(s => s.Division?.Trim() == selectedDivision.Trim())
                .ToList();
        }
        
        // Reset school selection
        schoolSearchTerm = string.Empty;
        filteredSchools.Clear();
        showSchoolSuggestions = false;
        
        StateHasChanged();
    }

    private void OnSchoolSearchInput(ChangeEventArgs e)
    {
        schoolSearchTerm = e.Value?.ToString() ?? string.Empty;
        selectedSchool = string.Empty; // Reset selection so user must pick valid one
        
        if (!string.IsNullOrEmpty(schoolSearchTerm) && schools.Any())
        {
            filteredSchools = schools
                .Where(s => s.SchoolName != null && 
                            s.SchoolName.Contains(schoolSearchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
            showSchoolSuggestions = true;
        }
        else
        {
            filteredSchools.Clear();
            showSchoolSuggestions = false;
        }
    }

    private void SelectSchool(School school)
    {
        selectedSchool = school.SchoolName ?? string.Empty;
        schoolSearchTerm = selectedSchool;
        showSchoolSuggestions = false;
        StateHasChanged();
    }


    private async Task HandlePhotoUpload(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file != null)
            {
                // Validate file size (max 5MB)
                if (file.Size > 5 * 1024 * 1024)
                {
                    message = "Photo size must be less than 5MB";
                    isSuccess = false;
                    return;
                }

                // Validate file type
                var allowedTypes = new[] { "image/jpeg", "image/jpg", "image/png", "image/gif" };
                if (!allowedTypes.Contains(file.ContentType))
                {
                    message = "Only JPG, PNG, and GIF images are allowed";
                    isSuccess = false;
                    return;
                }

                // Compress/Resize image to max 1024x768 before converting to base64
                // This reduces file size significantly (from MBs to KBs)
                var resizedFile = await file.RequestImageFileAsync("image/jpeg", 1024, 768);
                
                // Convert resized image to bytes, then to base64
                var buffer = new byte[resizedFile.Size];
                await resizedFile.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024).ReadAsync(buffer);
                
                var base64String = Convert.ToBase64String(buffer);
                incidentReport.EvidencePhotoBase64 = $"data:image/jpeg;base64,{base64String}";
                
                // Log size for debugging
                var originalSizeKB = file.Size / 1024.0;
                var compressedSizeKB = buffer.Length / 1024.0;
                Console.WriteLine($"Photo compressed: {originalSizeKB:F2} KB -> {compressedSizeKB:F2} KB");
                
                message = $"Photo uploaded and compressed successfully ({compressedSizeKB:F1} KB)";
                isSuccess = true;
            }
        }
        catch (Exception ex)
        {
            message = $"Error uploading photo: {ex.Message}";
            isSuccess = false;
            Console.WriteLine($"Photo upload error: {ex}");
        }
    }

    private void RemovePhoto()
    {
        incidentReport.EvidencePhotoBase64 = null;
        message = string.Empty;
    }

    private void FormatContactNumber(ChangeEventArgs e)
    {
        var input = e.Value?.ToString() ?? string.Empty;
        // Remove any non-numeric characters
        var numericOnly = new string(input.Where(char.IsDigit).ToArray());
        // Limit to 11 digits
        if (numericOnly.Length > 11)
        {
            numericOnly = numericOnly.Substring(0, 11);
        }
        incidentReport.ComplainantContactNumber = numericOnly;
    }


    

    private async Task LoadViolationTypes()
    {
        try
        {
            violationTypesByCategory = new Dictionary<string, List<string>>();
            violationTypesWithVictim = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
            
            // Load violations by category - order: Minor, Major, Prohibited Acts
            string[] categories = { "Minor", "Major", "Prohibited Acts" };
            
            foreach (var category in categories)
            {
                var response = await Http.GetAsync($"api/StudentProfileCaseRecord/violation-types?category={Uri.EscapeDataString(category)}");
                
                if (response.IsSuccessStatusCode)
                {
                    var content = await response.Content.ReadAsStringAsync();
                    var result = JsonSerializer.Deserialize<JsonElement>(content);
                    
                    if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                        result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                    {
                        var violations = new List<string>();
                        foreach (var item in data.EnumerateArray())
                        {
                            var violationName = item.GetString();
                            if (!string.IsNullOrEmpty(violationName))
                            {
                                violations.Add(violationName);
                                // Check if this violation has a victim based on common patterns
                                if (IsVictimRelatedIncident(violationName))
                                {
                                    violationTypesWithVictim.Add(violationName);
                                }
                            }
                        }
                        violationTypesByCategory[category] = violations;
                    }
                }
            }
            
            // If no violations loaded, use fallback
            if (!violationTypesByCategory.Any() || violationTypesByCategory.Values.All(v => !v.Any()))
            {
                // Fallback to default violations (categorized) - order: Minor, Major, Prohibited Acts
                var fallbackViolations = new Dictionary<string, List<string>>
                {
                    ["Minor"] = new List<string>
                    {
                        "Late/Unauthorized Absence",
                        "Dress Code Violation",
                        "Disruptive Behavior",
                        "Use of Profane Language",
                        "Charging Gadgets in Class",
                        "Earrings (Boys)",
                        "Glaring Hair/Nail Colors"
                    },
                    ["Major"] = new List<string>
                    {
                        "Cheating/Plagiarism",
                        "Bullying/Harassment",
                        "Cybercrime/Cyberbullying",
                        "Forgery/Tampering Records",
                        "Fraud/Identity Theft",
                        "Disrespect to Authorities",
                        "Acts Tarnishing School"
                    },
                    ["Prohibited Acts"] = new List<string>
                    {
                        "Deadly/Bladed Weapons",
                        "Fights/Rumbles (100m Radius)",
                        "Entering Under Influence",
                        "Gambling/Betting",
                        "Extortion (Pangingikil)"
                    }
                };
                
                violationTypesByCategory = fallbackViolations;
                // Populate victim types from fallback
                foreach (var violations in fallbackViolations.Values)
                {
                    foreach (var violation in violations)
                    {
                        if (IsVictimRelatedIncident(violation))
                        {
                            violationTypesWithVictim.Add(violation);
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading violation types: {ex.Message}");
            // Fallback to default violations (categorized) - order: Minor, Major, Prohibited Acts
            var fallbackViolations = new Dictionary<string, List<string>>
            {
                ["Minor"] = new List<string>
                {
                    "Late/Unauthorized Absence",
                    "Dress Code Violation",
                    "Disruptive Behavior",
                    "Use of Profane Language",
                    "Charging Gadgets in Class",
                    "Earrings (Boys)",
                    "Glaring Hair/Nail Colors"
                },
                ["Major"] = new List<string>
                {
                    "Cheating/Plagiarism",
                    "Bullying/Harassment",
                    "Cybercrime/Cyberbullying",
                    "Forgery/Tampering Records",
                    "Fraud/Identity Theft",
                    "Disrespect to Authorities",
                    "Acts Tarnishing School"
                },
                ["Prohibited Acts"] = new List<string>
                {
                    "Deadly/Bladed Weapons",
                    "Fights/Rumbles (100m Radius)",
                    "Entering Under Influence",
                    "Gambling/Betting",
                    "Extortion (Pangingikil)"
                }
            };
            
            violationTypesByCategory = fallbackViolations;
            // Populate victim types from fallback
            foreach (var violations in fallbackViolations.Values)
            {
                foreach (var violation in violations)
                {
                    if (IsVictimRelatedIncident(violation))
                    {
                        violationTypesWithVictim.Add(violation);
                    }
                }
            }
        }
    }



    private void NextStep()
    {
        if (ValidateCurrentStep())
        {
            if (step < maxStep)
                step++;
        }
    }
    
    private void OpenDescriptionModal()
    {
        // If description already exists, try to parse it to populate fields
        if (!string.IsNullOrEmpty(incidentReport.Description))
        {
            // Try to extract date, time, location from existing description
            // This is optional - if description exists, we can pre-fill or leave empty
        }
        showDescriptionModal = true;
        StateHasChanged();
    }
    
    private void CloseDescriptionModal()
    {
        showDescriptionModal = false;
        StateHasChanged();
    }
    
    private void ApplyDescription()
    {
        // Validate required fields
        if (string.IsNullOrWhiteSpace(descriptionLocation))
        {
            message = "‚ö†Ô∏è Location is required.";
            isSuccess = false;
            return;
        }
        
        if (string.IsNullOrWhiteSpace(descriptionDetails))
        {
            message = "‚ö†Ô∏è Description is required.";
            isSuccess = false;
            return;
        }
        
        // Format date
        string formattedDate = descriptionDate.ToString("MMMM dd, yyyy");
        
        // Format time - convert from 24-hour to 12-hour format
        // Format time - convert from 24-hour to 12-hour format
        int hour = descriptionTime.Hour;
        int minute = descriptionTime.Minute;
        string amPm = hour >= 12 ? "PM" : "AM";
        
        int displayHour = hour;
        if (displayHour > 12) displayHour -= 12;
        if (displayHour == 0) displayHour = 12;
        
        string formattedTime12 = $"{displayHour:00}:{minute:00} {amPm}";
        
        // Generate sentence automatically
        incidentReport.Description = $"On {formattedDate}, at approximately {formattedTime12}, an incident occurred at {descriptionLocation}. {descriptionDetails}";
        
        showDescriptionModal = false;
        message = "Description applied successfully!";
        isSuccess = true;
        StateHasChanged();
    }
    
    private void OnHasVictimChanged(ChangeEventArgs e)
    {
        var newValue = e.Value?.ToString() ?? string.Empty;
        if (hasVictim != newValue)
        {
            // Clear incident type when victim status changes
            incidentReport.IncidentType = string.Empty;
        }
        hasVictim = newValue;
        if (hasVictim == "Yes" && !victimNames.Any())
        {
            victimNames = new List<string> { "" };
        }
        else if (hasVictim != "Yes")
        {
            victimNames = new List<string> { "" };
        }
        StateHasChanged();
    }

    private void AddRespondent()
    {
        respondentNames.Add("");
        StateHasChanged();
    }

    private void RemoveRespondent(int index)
    {
        if (respondentNames.Count > 1)
        {
            respondentNames.RemoveAt(index);
        }
        else
        {
            respondentNames[0] = "";
        }
        StateHasChanged();
    }

    private void AddVictim()
    {
        victimNames.Add("");
        StateHasChanged();
    }

    private void RemoveVictim(int index)
    {
        if (victimNames.Count > 1)
        {
            victimNames.RemoveAt(index);
        }
        else
        {
            victimNames[0] = "";
        }
        StateHasChanged();
    }
    
    private bool isAnonymous = false;

    private void OnAnonymousToggled(ChangeEventArgs e)
    {
        bool selected = (bool)(e.Value ?? false);
        if (selected)
        {
            incidentReport.FullName = "Anonymous";
        }
        else
        {
            incidentReport.FullName = string.Empty;
        }
    }

    private void PrevStep()
    {
        if (step > 1)
            step--;
    }
    
    private void GoToStep(int targetStep)
    {
        if (targetStep >= 1 && targetStep <= maxStep)
        {
            step = targetStep;
            StateHasChanged();
        }
    }

    private bool IsVictimRelatedIncident(string incidentType)
    {
        // List of incident types that typically involve victims (accidents with victims)
        // Based on the SQL file, violations with HasVictim = 'Yes'
        var victimRelatedTypes = new[]
        {
            "Bullying",
            "Harassment",
            "Cybercrime",
            "Cyberbullying",
            "Fights",
            "Rumbles",
            "Theft",
            "Stealing",
            "Assault",
            "Extortion",
            "Pangingikil",
            "Deadly",
            "Bladed",
            "Weapons",
            "Cheating",
            "Plagiarism",
            "Fraud",
            "Identity Theft",
            "Disrespect",
            "Authorities",
            "Tarnishing",
            "Physical Injury",
            "Sex Trade",
            "Human Trafficking",
            "Terrorism",
            "Subversion",
            "Insurgency",
            "Malicious Touching",
            "Hazing",
            "Initiation",
            "Illegal Group",
            "Gang",
            "Instigating",
            "Troubles",
            "Outsiders",
            "Pornographic",
            "Sexual Misconduct",
            "Indecency"
        };
        
        return victimRelatedTypes.Any(v => incidentType.Contains(v, StringComparison.OrdinalIgnoreCase));
    }

    private void OnIncidentTypeChanged(ChangeEventArgs e)
    {
        incidentReport.IncidentType = e.Value?.ToString() ?? string.Empty;
        StateHasChanged();
    }

    private bool ValidateCurrentStep()
    {
        message = string.Empty;
        
        switch (step)
        {
            case 1:
                if (string.IsNullOrWhiteSpace(selectedDivision))
                {
                    message = "‚ö†Ô∏è Please select a Division.";
                    return false;
                }
                if (string.IsNullOrWhiteSpace(selectedSchool))
                {
                    message = "‚ö†Ô∏è Please select a School.";
                    return false;
                }
                return true;
                
            case 2:
                if (string.IsNullOrWhiteSpace(incidentReport.FullName))
                {
                    message = "‚ö†Ô∏è Full Name is required.";
                    return false;
                }
                if (respondentNames.All(n => string.IsNullOrWhiteSpace(n)))
                {
                    message = "‚ö†Ô∏è At least one Respondent Name is required.";
                    return false;
                }
                return true;
                
            case 3:
                if (string.IsNullOrWhiteSpace(hasVictim))
                {
                    message = "‚ö†Ô∏è Please specify if this incident has a victim or not.";
                    return false;
                }
                if (hasVictim == "Yes" && victimNames.All(n => string.IsNullOrWhiteSpace(n)))
                {
                    message = "‚ö†Ô∏è At least one Victim name is required when incident has a victim.";
                    return false;
                }
                if (string.IsNullOrWhiteSpace(incidentReport.IncidentType))
                {
                    message = "‚ö†Ô∏è Incident Type is required.";
                    return false;
                }
                if (string.IsNullOrWhiteSpace(incidentReport.Description))
                {
                    message = "‚ö†Ô∏è Description is required.";
                    return false;
                }
                return true;
                
            case 4:
                return true; // Evidence is optional
                
            default:
                return true;
        }
    }

    private async Task HandleSubmit()
    {
        isLoading = true;
        message = string.Empty;
        StateHasChanged(); // Force UI update to show loading overlay immediately
        
        try
        {
            // Validate all steps before submitting
            if (!ValidateCurrentStep())
            {
                isLoading = false;
                return;
            }

            // Prepare names for submission
            incidentReport.RespondentName = string.Join(" / ", respondentNames.Where(n => !string.IsNullOrWhiteSpace(n)));
            var finalizedVictimNames = hasVictim == "Yes" 
                ? string.Join(" / ", victimNames.Where(n => !string.IsNullOrWhiteSpace(n))) 
                : null;
            
            if (isAnonymous)
            {
                incidentReport.FullName = "Anonymous";
            }

            // Create simplified request
            var request = new SimplifiedIncidentReportRequest
            {
                FullName = incidentReport.FullName,
                RespondentName = incidentReport.RespondentName,
                VictimName = finalizedVictimNames,
                IncidentType = incidentReport.IncidentType,
                Description = incidentReport.Description,
                EvidencePhotoBase64 = incidentReport.EvidencePhotoBase64,
                Status = "Pending",
                SchoolName = selectedSchool,
                Division = selectedDivision
            };

            // Debugging: Log the size of the payload
            if (!string.IsNullOrEmpty(request.EvidencePhotoBase64))
            {
                var base64Length = request.EvidencePhotoBase64.Length;
                Console.WriteLine($"[DEBUG] Submitting report with photo. Base64 Length: {base64Length} chars (~{base64Length * 0.75 / 1024 / 1024:F2} MB)");
            }
            else 
            {
                 Console.WriteLine("[DEBUG] Submitting report without photo.");
            }

            var json = JsonSerializer.Serialize(request);
            var jsonSize = System.Text.Encoding.UTF8.GetByteCount(json);
            Console.WriteLine($"[DEBUG] Total Payload Size: {jsonSize} bytes (~{jsonSize / 1024.0 / 1024.0:F2} MB)");

            var content = new StringContent(json, System.Text.Encoding.UTF8);
            content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/json");

            var response = await Http.PostAsync("api/IncidentReport/simplified", content);
            
            if (response.IsSuccessStatusCode)
            {
                var responseContent = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(responseContent);
                
                var isSuccessKey = (result.TryGetProperty("success", out var success) && success.GetBoolean())
                                   || (result.TryGetProperty("Success", out var successCaps) && successCaps.GetBoolean());
                if (isSuccessKey)
                {
                    // Extract Reference Number
                    string refNum = "N/A";
                    if (result.TryGetProperty("referenceNumber", out var refProp))
                    {
                        refNum = refProp.GetString() ?? "N/A";
                    }
                    else if (result.TryGetProperty("ReferenceNumber", out var refUpper))
                    {
                        refNum = refUpper.GetString() ?? "N/A";
                    }

                    referenceNumber = refNum;
                    showSuccessModal = true;
                    isSuccess = true;
                    message = "Report submitted successfully!";
                    
                    // Reset form
                    incidentReport = new SimplifiedIncidentReport();
                    hasVictim = string.Empty;
                    isAnonymous = false;
                    respondentNames = new List<string> { "" };
                    victimNames = new List<string> { "" };
                    formKey = Guid.NewGuid().ToString();
                    step = 1;
                    selectedDivision = string.Empty;
                    selectedSchool = string.Empty;
                    schools.Clear();
                }
                else
                {
                    message = "Failed to submit incident report. Please try again.";
                    isSuccess = false;
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                try
                {
                    var errorResult = JsonSerializer.Deserialize<JsonElement>(errorContent);
                    string errorMsg = "Unknown error";
                    
                    if (errorResult.TryGetProperty("Message", out var msgProp))
                        errorMsg = msgProp.GetString() ?? errorMsg;
                    else if (errorResult.TryGetProperty("message", out var msgLower))
                        errorMsg = msgLower.GetString() ?? errorMsg;
                    
                    message = $"Server error ({response.StatusCode}): {errorMsg}";
                }
                catch (Exception ex)
                {
                    message = $"Server error ({response.StatusCode}): {errorContent}";
                }
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            message = $"Error submitting report: {ex.Message}";
            if (ex.InnerException != null)
            {
                message += $" ({ex.InnerException.Message})";
            }
            isSuccess = false;
            Console.WriteLine($"Submit error: {ex}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void CloseSuccessModal()
    {
        showSuccessModal = false;
        referenceNumber = null;
        StateHasChanged();
        
        // Redirect to home page (or landing page) as requested
        NavigationManager.NavigateTo("/", forceLoad: true);
    }
}

<style>
    .incident-type-options {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background-color: #f9f9f9;
        margin-top: 8px;
    }

    .checkbox-group {
        margin-bottom: 12px;
    }

    .checkbox-group:last-child {
        margin-bottom: 0;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-weight: 500;
        color: #333;
        padding: 8px 0;
        transition: color 0.2s ease;
    }

    .checkbox-label:hover {
        color: #007bff;
    }

    .checkbox-label input[type="radio"] {
        margin-right: 10px;
        transform: scale(1.2);
        accent-color: #007bff;
    }

    .checkmark {
        display: none; /* We're using the browser's default radio button styling */
    }

    .form-group.mt-3 {
        margin-top: 15px;
        padding: 15px;
        border: 1px solid #007bff;
        border-radius: 8px;
        background-color: #f0f8ff;
    }

    .form-group.mt-3 label {
        color: #007bff;
        font-weight: 600;
    }

    .label-with-badge {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
    }

    .label-with-badge label {
        margin-bottom: 0;
        flex: 1;
    }

    .violation-type-badge {
        display: inline-block;
        padding: 4px 12px;
        background-color: #007bff;
        color: white;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
        white-space: nowrap;
    }

    /* Style for optgroup labels in violation type dropdown */
    select#incidentType optgroup {
        font-weight: 700;
        font-size: 13px;
        color: #007bff;
        background-color: #f8f9fa;
        padding: 5px 0;
    }

    select#incidentType optgroup[label*="PROHIBITED"] {
        color: #dc3545;
        background-color: #fff5f5;
    }

    select#incidentType optgroup[label*="MINOR"] {
        color: #6c757d;
        background-color: #f8f9fa;
    }

    select#incidentType optgroup[label*="MAJOR"] {
        color: #fd7e14;
        background-color: #fff8f0;
    }

    select#incidentType option {
        padding: 8px 12px;
        font-size: 14px;
    }

.wizard-stepper-container {
    margin-top: 2rem;
    margin-bottom: 2rem;
    padding-top: 1rem;
    width: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
}
.wizard-stepper {
    display: flex;
    align-items: center;
    width: 80%;
    max-width: 700px;
    justify-content: space-between;
    margin: 0 auto 20px auto;
}
.step-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    min-width: 70px;
}
.step-circle {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #eee;
    color: #aaa;
    font-weight: 600;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.3s, color 0.3s, border 0.3s;
    border: 2px solid #ccc;
    z-index: 2;
}
.step-label {
    margin-top: 8px;
    font-size: 14px;
    color: #777;
    font-weight: 500;
    text-align: center;
}
.step-item.active .step-circle {
    background: #007bff;
    color: #fff;
    border-color: #007bff;
}
.step-item.done .step-circle {
    background: #22bb33;
    color: #fff;
    border-color: #22bb33;
}
.step-item.active .step-label {
    color: #007bff;
    font-weight: 700;
}
.step-item.done .step-label {
    color: #22bb33;
}
.step-line {
    height: 4px;
    flex: 1 1 50px;
    background: #ccc;
    border-radius: 2px;
    margin: 0 2px;
    min-width: 30px;
    max-width: 60px;
    transition: background 0.3s;
}
.step-line.done {
    background: #22bb33;
}
@@media (max-width: 600px) {
    .wizard-stepper {
        width: 98%;
        max-width: none;
    }
    .step-label { font-size: 11px; }
    .step-circle { width: 28px; height: 28px; font-size: 14px; }
}

/* Review Section Styles */
.review-section {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin-bottom: 30px;
}

.review-card {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
    background-color: #fafafa;
    transition: box-shadow 0.2s ease;
}

.review-card:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #007bff;
}

.review-header h4 {
    margin: 0;
    color: #007bff;
    font-weight: 600;
}

.review-content {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.review-item {
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
}

.review-item:last-child {
    border-bottom: none;
}

.review-item strong {
    color: #555;
    display: inline-block;
    min-width: 180px;
    margin-right: 10px;
}

.review-description {
    margin-top: 8px;
    padding: 12px;
    background-color: white;
    border-radius: 4px;
    border-left: 3px solid #007bff;
    white-space: pre-wrap;
    word-wrap: break-word;
}

.review-photo-preview {
    margin-top: 10px;
}

.review-photo-preview img {
    max-width: 300px;
    max-height: 200px;
    border-radius: 4px;
    border: 1px solid #ddd;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Photo Preview Container Styles */
.photo-preview-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}

.photo-preview-wrapper {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    margin-bottom: 15px;
}

.evidence-photo {
    max-width: 100%;
    max-height: 400px;
    border-radius: 8px;
    border: 2px solid #ddd;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    object-fit: contain;
}

.photo-actions {
    display: flex;
    justify-content: center;
    width: 100%;
}

.photo-actions .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.photo-actions .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.photo-actions .btn span {
    font-size: 16px;
}

/* Required Field Asterisk Styles */
.required-asterisk {
    color: #dc3545;
    font-weight: bold;
    font-size: 1.1em;
    margin-left: 2px;
}

/* Modal Styles */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 10000;
    animation: fadeIn 0.2s ease;
}

.modal-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow: auto;
    animation: slideDown 0.3s ease;
}

.modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-title {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
    color: #dc3545;
}

.modal-body {
    padding: 24px;
    font-size: 16px;
    line-height: 1.6;
    color: #333;
}

.modal-footer {
    padding: 16px 24px;
    border-top: 1px solid #e0e0e0;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
}

.modal-footer .btn {
    min-width: 100px;
    padding: 10px 24px;
    font-weight: 500;
}

@@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

@@keyframes slideDown {
    from {
        transform: translateY(-20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

/* Multiple Respondents Styles */
.respondents-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 10px;
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
}

.respondent-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background-color: white;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    transition: all 0.2s ease;
}

.respondent-item:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-color: #007bff;
}

.respondent-info {
    flex: 1;
}

.respondent-info strong {
    color: #333;
    font-size: 1rem;
}

.respondent-info small {
    color: #6c757d;
    font-size: 0.875rem;
}

.d-flex {
    display: flex;
}

.gap-2 {
    gap: 0.5rem;
}

.flex-grow-1 {
    flex-grow: 1;
}

.alert-warning {
    background-color: #fff3cd;
    border-color: #ffc107;
    color: #856404;
    padding: 12px 16px;
    border-radius: 6px;
    margin-top: 10px;
}

.alert-warning i {
    margin-right: 8px;
}
</style>
