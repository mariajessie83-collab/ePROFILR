@page "/schoolhead-dashboard"
@layout Gsystem.Layout.SchoolHeadLayout
@using SharedProject
@using System.Text.Json
@using System.Linq
@using System.Globalization
@using System.Text.RegularExpressions

<PageTitle>School Head Dashboard</PageTitle>

<style>
    @@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    :root {
        --font-main: 'Poppins', sans-serif;
        --color-bg: #f4f7fe;
        --color-text-dark: #2b3674;
        --color-text-gray: #a3aed0;
        --color-primary: #4318ff;
        --color-secondary: #6ad2ff;
        --color-success: #05cd99;
        --color-warning: #ffb547;
        --color-danger: #ee5d50;
        --card-radius: 20px;
        --card-shadow: 0px 18px 40px rgba(112, 144, 176, 0.12);
    }

    .schoolhead-dashboard {
        font-family: var(--font-main);
        background-color: var(--color-bg);
        min-height: 100vh;
        padding: 20px;
        color: var(--color-text-dark);
    }

    /* Header */
    .dashboard-header {
        margin-bottom: 30px;
    }

    .dashboard-header h2 {
        font-size: 34px;
        font-weight: 700;
        margin: 0;
        color: var(--color-text-dark);
    }

    .dashboard-header p {
        font-size: 16px;
        color: var(--color-text-gray);
        margin: 5px 0 0;
        font-weight: 500;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: var(--card-radius);
        padding: 20px;
        box-shadow: var(--card-shadow);
        display: flex;
        align-items: center;
        gap: 18px;
        transition: transform 0.2s;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }

    .stat-info h4 {
        margin: 0;
        font-size: 14px;
        color: var(--color-text-gray);
        font-weight: 500;
    }

    .stat-info h3 {
        margin: 0;
        font-size: 24px;
        font-weight: 700;
        color: var(--color-text-dark);
    }

    /* Charts Grid */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        gap: 20px;
        margin-bottom: 30px;
    }

    .chart-card {
        background: white;
        border-radius: var(--card-radius);
        padding: 24px;
        box-shadow: var(--card-shadow);
        display: flex;
        flex-direction: column;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .chart-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 700;
        color: var(--color-text-dark);
    }

    .chart-header span {
        font-size: 14px;
        color: var(--color-text-gray);
        font-weight: 500;
    }

    /* Specific Grid Layouts */
    .col-span-12 { grid-column: span 12; }
    .col-span-8 { grid-column: span 8; }
    .col-span-6 { grid-column: span 6; }
    .col-span-4 { grid-column: span 4; }

    @@media (max-width: 1200px) {
        .col-span-8, .col-span-4 { grid-column: span 12; }
    }
    
    @@media (max-width: 768px) {
        .col-span-6 { grid-column: span 12; }
    }

    /* Chart Containers */
    .chart-container {
        flex: 1;
        position: relative;
        min-height: 250px;
        display: flex;
        align-items: flex-end;
        justify-content: center;
    }

    /* SVG Charts */
    svg {
        width: 100%;
        height: 100%;
        overflow: visible;
    }

    .line-path {
        fill: none;
        stroke: var(--color-primary);
        stroke-width: 4;
        stroke-linecap: round;
        stroke-linejoin: round;
        filter: drop-shadow(0px 10px 20px rgba(67, 24, 255, 0.4));
    }

    .chart-dot {
        fill: white;
        stroke: var(--color-primary);
        stroke-width: 3;
        r: 6;
        transition: r 0.2s;
        cursor: pointer;
    }
    
    .chart-dot:hover {
        r: 8;
    }

    .chart-label {
        font-size: 12px;
        fill: var(--color-text-gray);
        text-anchor: middle;
    }

    /* Bar Charts */
    .bar-chart-container {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        height: 100%;
        width: 100%;
        padding-top: 20px;
        gap: 8px;
    }

    .bar-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        height: 100%;
        justify-content: flex-end;
        gap: 8px;
        position: relative;
    }

    .bar {
        width: 100%;
        max-width: 40px;
        border-radius: 8px;
        background: linear-gradient(180deg, var(--color-secondary) 0%, var(--color-primary) 100%);
        transition: height 0.5s ease;
        min-height: 4px;
        position: relative;
    }
    
    .bar:hover {
        opacity: 0.8;
    }
    
    .bar-tooltip {
        position: absolute;
        top: -30px;
        background: #333;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.2s;
        pointer-events: none;
        white-space: nowrap;
        z-index: 10;
    }
    
    .bar-group:hover .bar-tooltip {
        opacity: 1;
    }

    .bar-label {
        font-size: 12px;
        color: var(--color-text-gray);
        text-align: center;
    }

    /* Horizontal Bar Chart */
    .h-bar-row {
        margin-bottom: 16px;
    }

    .h-bar-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
        font-size: 14px;
        font-weight: 500;
        color: var(--color-text-dark);
    }

    .h-bar-bg {
        height: 10px;
        background: #eff4fb;
        border-radius: 10px;
        overflow: hidden;
    }

    .h-bar-fill {
        height: 100%;
        background: var(--color-primary);
        border-radius: 10px;
    }

    /* Pie Chart */
    .pie-legend {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        color: var(--color-text-gray);
    }

    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    /* Table Section */
    .table-card {
        background: white;
        border-radius: var(--card-radius);
        padding: 24px;
        box-shadow: var(--card-shadow);
        overflow: hidden;
    }

    .table-header {
        margin-bottom: 20px;
    }

    .table-header h3 {
        font-size: 22px;
        font-weight: 700;
        color: var(--color-text-dark);
        margin: 0;
    }

    .table-responsive {
        overflow-y: auto;
        max-height: 400px;
        position: relative;
    }

    .custom-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .custom-table th {
        text-align: left;
        padding: 16px;
        color: var(--color-text-gray);
        font-size: 14px;
        font-weight: 500;
        border-bottom: 1px solid #e2e8f0;
        white-space: nowrap;
        position: sticky;
        top: 0;
        background: white;
        z-index: 1;
    }

    .custom-table td {
        padding: 16px;
        color: var(--color-text-dark);
        font-size: 14px;
        font-weight: 600;
        border-bottom: 1px solid #f4f7fe;
    }

    .custom-table tr:last-child td {
        border-bottom: none;
    }

    .status-pill {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 700;
        display: inline-block;
    }

    .status-pending { background: #fff7e6; color: #ffb547; }
    .status-review { background: #e6f7ff; color: #6ad2ff; }
    .status-resolved { background: #e6fffa; color: #05cd99; }
    .status-default { background: #f4f7fe; color: var(--color-text-gray); }

    .loading-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 300px;
        flex-direction: column;
        gap: 16px;
        color: var(--color-primary);
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--color-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Category Cards */
    .category-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 24px;
        padding: 10px 0;
    }

    .category-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        position: relative;
        transition: transform 0.3s, box-shadow 0.3s;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .category-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.15);
    }

    .category-card-icon {
        width: 64px;
        height: 64px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        color: white;
        margin-bottom: 16px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }

    .category-card-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--color-text-dark);
        margin: 0 0 12px;
    }

    .category-card-count {
        font-size: 36px;
        font-weight: 700;
        margin: 0;
        line-height: 1;
    }

    .category-card-label {
        font-size: 13px;
        color: var(--color-text-gray);
        margin: 4px 0 8px;
    }

    .category-card-percentage {
        font-size: 12px;
        color: var(--color-text-gray);
        font-weight: 500;
        margin-bottom: 16px;
    }

    .vertical-progress-container {
        width: 100%;
        height: 8px;
        background: #f4f7fe;
        border-radius: 10px;
        overflow: hidden;
        margin-top: auto;
    }

    .vertical-progress-bar {
        width: 100%;
        border-radius: 10px;
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Category Trend Chart */
    .category-trend-container {
        padding: 20px 0;
    }

    .category-legend {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .legend-item-modern {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
        color: var(--color-text-dark);
    }

    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    /* Animations */
    .category-line-animated {
        stroke-dasharray: 2000;
        stroke-dashoffset: 2000;
        animation: drawLine 2s ease-out forwards;
    }

    .category-area-animated {
        opacity: 0;
        animation: fadeInArea 1.5s ease-out 0.5s forwards;
    }

    .category-dot-animated {
        opacity: 0;
        transform: scale(0);
        animation: popIn 0.5s ease-out 1s forwards;
    }

    @@keyframes drawLine {
        to {
            stroke-dashoffset: 0;
        }
    }

    @@keyframes fadeInArea {
        to {
            opacity: 1;
        }
    }

    @@keyframes popIn {
        0% {
            opacity: 0;
            transform: scale(0);
        }
        70% {
            transform: scale(1.2);
        }
        100% {
            opacity: 1;
            transform: scale(1);
        }
    }

    /* Data Labels - Only visible on hover for clean UI */
    .month-group .data-label {
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: none;
    }

    .month-group:hover .data-label {
        opacity: 1;
    }
    
    .month-group:hover .connector-line {
        opacity: 0.6;
    }

    .month-group:hover circle {
        r: 7;
        transition: r 0.2s ease;
    }

    .dot-group .label-bg {
        filter: drop-shadow(0px 1px 3px rgba(0,0,0,0.2));
    }
    
    .connector-line {
        stroke-width: 1;
        stroke-dasharray: 2,2;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .month-group {
        cursor: pointer;
    }

    /* Scroll Animation Styles */
    .scroll-animate {
        opacity: 0;
        transform: translateY(30px);
        transition: opacity 0.6s ease-out, transform 0.6s ease-out;
    }

    .scroll-animate.visible {
        opacity: 1;
        transform: translateY(0);
    }

    /* Stagger animation delays for grid items */
    .stat-card:nth-child(1) { transition-delay: 0s; }
    .stat-card:nth-child(2) { transition-delay: 0.1s; }
    .stat-card:nth-child(3) { transition-delay: 0.2s; }
    .stat-card:nth-child(4) { transition-delay: 0.3s; }

    /* Chart animation */
    .chart-card.scroll-animate {
        transition-delay: 0.2s;
    }

    .table-card.scroll-animate {
        transition-delay: 0.3s;
    }
</style>

@if (isCheckingAuth)
{
    <div class="loading-container" style="height: 100vh;">
        <div class="spinner"></div>
        <p>Verifying access...</p>
    </div>
}
else if (!isAuthenticated)
{
    <div class="center-message">
        <h2>Authentication Required</h2>
        <p>Please log in using your school head account to continue.</p>
        <a class="btn btn-primary" href="/login/admin">Go to Login</a>
    </div>
}
else if (!isSchoolHeadUser)
{
    <div class="access-denied">
        <h2>Access Restricted</h2>
        <p>This dashboard is only available for School Head accounts.</p>
        <a class="btn btn-primary" href="/admin-dashboard">Back to Admin</a>
    </div>
}
else
{
    <div class="schoolhead-dashboard">
        <div class="dashboard-header">
            <h2>@(string.IsNullOrWhiteSpace(schoolName) ? "School Head Dashboard" : schoolName)</h2>
            <p>Division: @(division ?? "N/A") · Region: @(region ?? "N/A")</p>
        </div>

        @if (isLoading)
        {
            <div class="loading-container">
                <div class="spinner"></div>
                <p>Loading analytics...</p>
            </div>
        }
        else
        {
            <!-- Summary Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: #f4f7fe; color: var(--color-primary);">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h4>Total Reports</h4>
                        <h3>@totalReports</h3>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #fff7e6; color: var(--color-warning);">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h4>Pending</h4>
                        <h3>@pendingReports</h3>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e6f7ff; color: var(--color-secondary);">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="stat-info">
                        <h4>Under Review</h4>
                        <h3>@underReviewReports</h3>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: #e6fffa; color: var(--color-success);">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-info">
                        <h4>Resolved</h4>
                        <h3>@resolvedReports</h3>
                    </div>
                </div>
            </div>

            <!-- Incident Categories Trend Chart -->
            <div class="chart-card" style="margin-bottom: 30px;">
                <div class="chart-header">
                    <h3>Incident Categories Trend</h3>
                    <span>Current Year by Severity</span>
                </div>
                <div class="category-trend-container">
                    @if (categoryTrendData.Any())
                    {
                        <svg viewBox="0 0 1200 350" style="width: 100%; height: 350px;">
                            <defs>
                                <!-- Gradients for each category -->
                                <linearGradient id="minorGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#EAB308;stop-opacity:0.3" />
                                    <stop offset="100%" style="stop-color:#EAB308;stop-opacity:0" />
                                </linearGradient>
                                <linearGradient id="majorGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#EF4444;stop-opacity:0.3" />
                                    <stop offset="100%" style="stop-color:#EF4444;stop-opacity:0" />
                                </linearGradient>
                                <linearGradient id="prohibitedGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                    <stop offset="0%" style="stop-color:#3B82F6;stop-opacity:0.3" />
                                    <stop offset="100%" style="stop-color:#3B82F6;stop-opacity:0" />
                                </linearGradient>
                            </defs>
                            
                            <!-- Grid Lines -->
                            @for (int i = 0; i <= 5; i++)
                            {
                                <line x1="50" y1="@(50 + i * 46)" x2="1150" y2="@(50 + i * 46)" 
                                      stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4,4" opacity="0.5"/>
                            }
                            
                            @{
                                var categories = new[] { 
                                    new { Name = "Minor", Color = "#EAB308", Gradient = "minorGradient", Data = categoryTrendData.Select(m => m.MinorCount).ToList() },
                                    new { Name = "Major", Color = "#EF4444", Gradient = "majorGradient", Data = categoryTrendData.Select(m => m.MajorCount).ToList() },
                                    new { Name = "Prohibited", Color = "#3B82F6", Gradient = "prohibitedGradient", Data = categoryTrendData.Select(m => m.ProhibitedCount).ToList() }
                                };
                                
                                var maxValue = categoryTrendData.SelectMany(m => new[] { m.MinorCount, m.MajorCount, m.ProhibitedCount }).Max();
                                if (maxValue == 0) maxValue = 10;
                            }
                            
                            @* First pass: Render all lines and areas *@
                            @foreach (var cat in categories)
                            {
                                var points = new List<string>();
                                var areaPoints = new List<string>();
                                
                                for (int i = 0; i < cat.Data.Count; i++)
                                {
                                    double x = 50 + (i * (1100.0 / (cat.Data.Count - 1)));
                                    double y = 280 - ((double)cat.Data[i] / maxValue * 230);
                                    points.Add($"{x},{y}");
                                    
                                    if (i == 0) areaPoints.Add($"M{x},280");
                                    areaPoints.Add($"L{x},{y}");
                                    if (i == cat.Data.Count - 1) areaPoints.Add($"L{x},280 Z");
                                }
                                
                                var linePath = "M" + string.Join(" L", points);
                                var areaPath = string.Join(" ", areaPoints);
                                
                                <!-- Area Fill -->
                                <path d="@areaPath" fill="url(#@cat.Gradient)" class="category-area-animated"/>
                                
                                <!-- Line -->
                                <path d="@linePath" stroke="@cat.Color" stroke-width="3" fill="none" 
                                      stroke-linecap="round" stroke-linejoin="round" 
                                      class="category-line-animated" style="filter: drop-shadow(0px 4px 8px @(cat.Color)66);"/>
                            }
                            
                            @* Second pass: Render dots and labels with overlap handling *@
                            @for (int monthIndex = 0; monthIndex < categoryTrendData.Count; monthIndex++)
                            {
                                double x = 50 + (monthIndex * (1100.0 / (categoryTrendData.Count - 1)));
                                
                                // Collect all category values for this month
                                var monthData = new List<(string Name, string Color, int Value, double Y)>();
                                foreach (var cat in categories)
                                {
                                    int categoryIndex = cat.Name == "Minor" ? 0 : (cat.Name == "Major" ? 1 : 2);
                                    double y = 280 - ((double)cat.Data[monthIndex] / maxValue * 230);
                                    monthData.Add((cat.Name, cat.Color, cat.Data[monthIndex], y));
                                }
                                
                                // Group by value to detect overlaps
                                var valueGroups = monthData.GroupBy(d => d.Value).ToList();
                                
                                <!-- Wrap entire month in a group for hover effect -->
                                <g class="month-group">
                                    @foreach (var group in valueGroups)
                                    {
                                        var items = group.ToList();
                                        double baseY = items[0].Y;
                                        
                                        if (items.Count == 1)
                                        {
                                            // Single value - show label with category name and value
                                            var item = items[0];
                                            double labelY = baseY - 22; // Position label 22px above dot
                                            
                                            <g class="dot-group">
                                                <circle cx="@x" cy="@baseY" r="5" fill="white" stroke="@item.Color" stroke-width="2.5" 
                                                        class="category-dot-animated" style="animation-delay: @(monthIndex * 0.1)s;"/>
                                                
                                                <!-- Hover label with category name and value -->
                                                <g class="data-label" style="pointer-events: none;">
                                                    <rect x="@(x - 40)" y="@(labelY - 24)" width="80" height="32" rx="4" 
                                                          fill="@item.Color" opacity="0.95" class="label-bg"/>
                                                    <text x="@x" y="@(labelY - 13)" text-anchor="middle" font-size="14" font-weight="600" fill="white">
                                                        @item.Name
                                                    </text>
                                                    <text x="@x" y="@(labelY - 1)" text-anchor="middle" font-size="15" font-weight="700" fill="white">
                                                        @item.Value
                                                    </text>
                                                </g>
                                            </g>
                                        }
                                        else
                                        {
                                            // Multiple categories with same value - stack labels vertically with connector lines
                                            for (int i = 0; i < items.Count; i++)
                                            {
                                                var item = items[i];
                                                // Stack labels vertically: 32px spacing between each label (increased for larger labels)
                                                double labelY = baseY - 24 - (i * 32);
                                                
                                                <g class="dot-group">
                                                    <!-- Dot with distinct color border -->
                                                    <circle cx="@x" cy="@baseY" r="5" fill="white" stroke="@item.Color" stroke-width="2.5" 
                                                            class="category-dot-animated" style="animation-delay: @(monthIndex * 0.1)s;"/>
                                                    
                                                    <!-- Connector line from dot to label -->
                                                    @if (i > 0)
                                                    {
                                                        <line x1="@x" y1="@baseY" x2="@x" y2="@(labelY + 6)" 
                                                              stroke="@item.Color" class="connector-line"/>
                                                    }
                                                    
                                                    <!-- Stacked label with category name and value -->
                                                    <g class="data-label" style="pointer-events: none;">
                                                        <rect x="@(x - 40)" y="@(labelY - 24)" width="80" height="32" rx="4" 
                                                              fill="@item.Color" opacity="0.95" class="label-bg"/>
                                                        <text x="@x" y="@(labelY - 13)" text-anchor="middle" font-size="14" font-weight="600" fill="white">
                                                            @item.Name
                                                        </text>
                                                        <text x="@x" y="@(labelY - 1)" text-anchor="middle" font-size="15" font-weight="700" fill="white">
                                                            @item.Value
                                                        </text>
                                                    </g>
                                                </g>
                                            }
                                        }
                                    }
                                </g>
                            }
                            
                            
                            <!-- X-Axis Labels -->
                            @for (int i = 0; i < categoryTrendData.Count; i++)
                            {
                                double xPos = 50 + (i * (1100.0 / (categoryTrendData.Count - 1)));
                                <g>
                                    <text x="@xPos" y="320" text-anchor="middle" font-size="14" fill="#a3aed0" font-weight="500">
                                        @categoryTrendData[i].Label
                                    </text>
                                </g>
                            }
                        </svg>
                        
                        <!-- Legend -->
                        <div class="category-legend">
                            <div class="legend-item-modern">
                                <div class="legend-dot" style="background: #EAB308;"></div>
                                <span>Minor Acts</span>
                            </div>
                            <div class="legend-item-modern">
                                <div class="legend-dot" style="background: #EF4444;"></div>
                                <span>Major Acts</span>
                            </div>
                            <div class="legend-item-modern">
                                <div class="legend-dot" style="background: #3B82F6;"></div>
                                <span>Prohibited Acts</span>
                            </div>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No data available</p>
                    }
                </div>
            </div>

            <!-- Prescriptive Actions & Descriptive Insights -->
            <div class="insights-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <!-- Prescriptive Actions -->
                <div class="chart-card" style="height: 100%;">
                    <div class="chart-header">
                        <h3>Prescriptive Actions</h3>
                        <span>Recommended Interventions</span>
                    </div>
                    <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                        @if (prescriptiveActions.Any())
                        {
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Grade</th>
                                        <th>Risk</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var action in prescriptiveActions)
                                    {
                                        <tr>
                                            <td>@MaskName(action.StudentName)</td>
                                            <td>@action.GradeLevel</td>
                                            <td>
                                                <span class="badge @(action.RiskLevel == "High" ? "bg-danger" : (action.RiskLevel == "Medium" ? "bg-warning" : "bg-info"))">
                                                    @action.RiskLevel
                                                </span>
                                            </td>
                                            <td><small>@action.RecommendedAction</small></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        else
                        {
                            <div class="empty-state" style="text-align: center; padding: 20px;">
                                <i class="fas fa-check-circle text-success" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <p>No high-risk students identified requiring immediate intervention.</p>
                            </div>
                        }
                    </div>
                </div>

                <!-- Descriptive Insights -->
                <div class="chart-card" style="height: 100%;">
                    <div class="chart-header">
                        <h3>Descriptive Insights</h3>
                        <span>Key Patterns & Trends</span>
                    </div>
                    <div class="insights-list" style="display: flex; flex-direction: column; gap: 15px;">
                        @if (descriptiveInsights.Any())
                        {
                            @foreach (var insight in descriptiveInsights)
                            {
                                <div class="insight-item" style="padding: 15px; border-left: 4px solid @(insight.Severity == "Warning" ? "#ffc107" : (insight.Severity == "Critical" ? "#dc3545" : "#0d6efd")); background: #f8f9fa; border-radius: 4px;">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 style="margin: 0; font-size: 1rem; font-weight: 600;">
                                            <i class="fas @GetInsightIcon(insight.Category) me-2"></i>@insight.Title
                                        </h5>
                                        <span class="badge @(insight.Severity == "Warning" ? "bg-warning text-dark" : (insight.Severity == "Critical" ? "bg-danger" : "bg-info"))">
                                            @insight.Severity
                                        </span>
                                    </div>
                                    <p class="text-muted small mb-2">@insight.Description</p>
                                    <div class="d-flex gap-3">
                                        @foreach (var metric in insight.Metrics)
                                        {
                                            <div>
                                                <small class="text-uppercase text-secondary" style="font-size: 0.7rem;">@metric.Key</small>
                                                <div class="fw-bold">@metric.Value</div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="empty-state" style="text-align: center; padding: 20px;">
                                <p>Not enough data to generate insights.</p>
                            </div>
                        }
                    </div>
                </div>
            </div>



            <!-- Charts Grid -->
            <div class="charts-grid">
                <!-- Monthly Trend (Line Chart) -->
                <div class="chart-card col-span-8">
                    <div class="chart-header">
                        <h3>Monthly Trends</h3>
                        <span>Last 12 Months</span>
                    </div>
                    <div class="chart-container">
                        @if (monthlyStats.Any())
                        {
                            <svg viewBox="0 0 800 250" preserveAspectRatio="none">
                                <!-- Grid Lines -->
                                @for (int i = 0; i <= 4; i++)
                                {
                                    <line x1="0" y1="@(i * 50 + 25)" x2="800" y2="@(i * 50 + 25)" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4" />
                                }
                                
                                <!-- Line Path -->
                                <path d="@GetLineChartPath(monthlyStats, 800, 250)" class="line-path" />
                                
                                <!-- Dots -->
                                @foreach (var (point, index) in monthlyStats.Select((p, i) => (p, i)))
                                {
                                    var x = (index * (800.0 / (monthlyStats.Count - 1)));
                                    var max = monthlyStats.Max(m => m.Count);
                                    var y = 250 - ((double)point.Count / (max == 0 ? 1 : max) * 200) - 25;
                                    
                                    <circle cx="@x" cy="@y" class="chart-dot">
                                        <title>@point.Label: @point.Count reports</title>
                                    </circle>
                                    <g>
                                        <text x="@x" y="245" class="chart-label">@point.Label.Split(' ')[0]</text>
                                    </g>
                                }
                            </svg>
                        }
                        else
                        {
                            <p class="text-muted">No data available</p>
                        }
                    </div>
                </div>

                <!-- Status Breakdown (Pie/Donut) -->
                <div class="chart-card col-span-4">
                    <div class="chart-header">
                        <h3>Status Breakdown</h3>
                        <span>Current</span>
                    </div>
                    <div class="chart-container" style="flex-direction: column; align-items: center;">
                        @if (totalReports > 0)
                        {
                            var segments = GetPieChartSegments();
                            <svg viewBox="0 0 100 100" style="max-width: 180px;">
                                @foreach (var segment in segments)
                                {
                                    <path d="@segment.Path" fill="@segment.Color" 
                                          @onmouseover="() => hoveredSegment = segment" 
                                          @onmouseout="() => hoveredSegment = null"
                                          style="cursor: pointer; transition: opacity 0.2s;">
                                        <title>@segment.Label: @segment.Count (@segment.Percentage%)</title>
                                    </path>
                                }
                                <circle cx="50" cy="50" r="35" fill="white" />
                                
                                @if (hoveredSegment != null)
                                {
                                    <g>
                                        <text x="50" y="45" text-anchor="middle" font-size="8" font-weight="bold" fill="#2b3674">@hoveredSegment.Label</text>
                                    </g>
                                    <g>
                                        <text x="50" y="58" text-anchor="middle" font-size="10" font-weight="bold" fill="@hoveredSegment.Color">@hoveredSegment.Percentage%</text>
                                    </g>
                                }
                                else
                                {
                                    <g>
                                        <text x="50" y="52" text-anchor="middle" font-size="8" font-weight="bold" fill="#a3aed0">Total: @totalReports</text>
                                    </g>
                                }
                            </svg>
                            <div class="pie-legend">
                                @foreach (var segment in segments)
                                {
                                    <div class="legend-item">
                                        <div class="legend-color" style="background: @segment.Color"></div>
                                        <span>@segment.Label (@segment.Percentage%)</span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">No data available</p>
                        }
                    </div>
                </div>

                <!-- Weekly Trends (Bar) -->
                <div class="chart-card col-span-4">
                    <div class="chart-header">
                        <h3>Weekly Trends</h3>
                        <span>This Month</span>
                    </div>
                    <div class="chart-container">
                        <div class="bar-chart-container">
                            @foreach (var week in weeklyStats)
                            {
                                <div class="bar-group">
                                    <div class="bar-tooltip">@week.Count reports</div>
                                    <div class="bar" style="height: @(week.BarPercent)%"></div>
                                    <span class="bar-label">@week.Label</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Yearly Comparison (Bar) -->
                <div class="chart-card col-span-4">
                    <div class="chart-header">
                        <h3>Yearly Comparison</h3>
                        <span>All Time</span>
                    </div>
                    <div class="chart-container">
                        <div class="bar-chart-container">
                            @foreach (var year in yearlyStats)
                            {
                                <div class="bar-group">
                                    <div class="bar-tooltip">@year.Count reports</div>
                                    <div class="bar" style="height: @(year.BarPercent)%; background: linear-gradient(180deg, #868CFF 0%, #4318FF 100%);"></div>
                                    <span class="bar-label">@year.Label</span>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Top Behavior Trends (Horizontal Bar) -->
                <div class="chart-card col-span-4">
                    <div class="chart-header">
                        <h3>Top Behaviors</h3>
                        <span>Top 5</span>
                    </div>
                    <div class="chart-container" style="display: block;">
                        @foreach (var trend in incidentTypeTrends)
                        {
                            <div class="h-bar-row">
                                <div class="h-bar-header">
                                    <span>@trend.Label</span>
                                    <span>@trend.Count</span>
                                </div>
                                <div class="h-bar-bg">
                                    <div class="h-bar-fill" style="width: @trend.BarPercent%"></div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <!-- Recent Reports Table -->
            <div class="table-card">
                <div class="table-header">
                    <h3>Incident Reports This Week</h3>
                </div>
                <div class="table-responsive">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Complainant</th>
                                <th>Incident Type</th>
                                <th>Victim</th>
                                <th>Respondent</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var report in incidentReports.Take(20))
                            {
                                <tr>
                                    <td>@MaskName(report.ComplainantName)</td>
                                    <td>@(string.IsNullOrEmpty(report.IncidentType) ? "–" : report.IncidentType)</td>
                                    <td>@(string.IsNullOrEmpty(report.VictimName) || report.VictimName == "-" ? "N/A" : MaskName(report.VictimName))</td>
                                    <td>@(string.IsNullOrEmpty(report.RespondentName) ? "N/A" : MaskName(report.RespondentName))</td>
                                    <td>@report.DateReported.ToString("MMM dd, yyyy")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </div>
}

@code {
    private bool isAuthenticated;
    private bool isSchoolHeadUser;
    private bool isLoading = true;
    private bool isCheckingAuth = true;

    private string? schoolName;
    private string? division;
    private string? region;
    private string? district;

    private List<IncidentReportSummary> incidentReports = new();
    
    // Stats
    private int totalReports;
    private int pendingReports;
    private int underReviewReports;
    private int resolvedReports;

    // Chart Data
    private List<MonthlyStat> monthlyStats = new();
    private List<WeeklyStat> weeklyStats = new();
    private List<YearlyStat> yearlyStats = new();
    private List<TrendItem> incidentTypeTrends = new();
    private Dictionary<string, int> statusCounts = new();
    private List<CategoryStat> categoryStats = new();
    private List<CategoryTrendMonth> categoryTrendData = new();
    
    // Insights Data
    private List<PrescriptiveAction> prescriptiveActions = new();
    private List<DescriptiveInsight> descriptiveInsights = new();

    private PieSegment? hoveredSegment;

    [Inject] private HttpClient Http { get; set; } = default!;
    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        await CheckAuthentication();
        if (isAuthenticated && isSchoolHeadUser)
        {
            await LoadSchoolHeadContext();
            await LoadIncidentReports();
            await LoadCategoryTrendData(); // Uncommented
            await LoadDashboardStats();    // Added
            await ProcessAnalytics();      // Recalculate derived stats
        }
    }

    private async Task CheckAuthentication()
    {
        try
        {
            var token = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");
            var role = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userRole");
            isAuthenticated = !string.IsNullOrEmpty(token);
            isSchoolHeadUser = !string.IsNullOrEmpty(role) && role.Equals("schoolhead", StringComparison.OrdinalIgnoreCase);
        }
        catch 
        { 
            isAuthenticated = false;
            isSchoolHeadUser = false;
        }
        finally
        {
            isCheckingAuth = false;
        }
    }

    private async Task LoadSchoolHeadContext()
    {
        try
        {
            var adminAccountIdStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "adminAccountID");
            if (int.TryParse(adminAccountIdStr, out var adminAccountId) && adminAccountId > 0)
            {
                var response = await Http.GetAsync($"api/Admin/accounts/{adminAccountId}");
                if (response.IsSuccessStatusCode)
                {
                    var content = await response.Content.ReadAsStringAsync();
                    var accountResponse = JsonSerializer.Deserialize<ApiResponse<AdminAccount>>(content, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    if (accountResponse?.Success == true && accountResponse.Data != null)
                    {
                        var account = accountResponse.Data;
                        schoolName = account.SchoolName ?? account.FullName;
                        division = account.Division ?? account.DivisionName;
                        region = account.Region;
                        district = account.District;
                        

                    }
                }
            }
        }
        catch { /* Ignore */ }
    }

    private async Task LoadIncidentReports()
    {
        isLoading = true;
        try
        {
            var queryParams = new List<string>();
            if (!string.IsNullOrEmpty(schoolName)) queryParams.Add($"schoolName={Uri.EscapeDataString(schoolName)}");
            if (!string.IsNullOrEmpty(division)) queryParams.Add($"division={Uri.EscapeDataString(division)}");
            if (!string.IsNullOrEmpty(region)) queryParams.Add($"region={Uri.EscapeDataString(region)}");
            var startOfWeek = DateTime.Today.AddDays(-(int)DateTime.Today.DayOfWeek);
            queryParams.Add($"startDate={startOfWeek:yyyy-MM-dd}");
            queryParams.Add("pageSize=50");

            var url = "api/IncidentReport" + (queryParams.Any() ? "?" + string.Join("&", queryParams) : "");
            var response = await Http.GetAsync(url);
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<ApiResponse<List<IncidentReportSummary>>>(content, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (result?.Success == true && result.Data != null)
                {
                    incidentReports = result.Data
                        .OrderByDescending(r => r.DateReported)
                        .ToList();
                }
            }
        }
        catch { /* Ignore */ }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadCategoryTrendData()
    {
        try
        {
            // Step 1: Build query parameters (only school and division for School Head)
            var queryParams = new List<string>();
            if (!string.IsNullOrEmpty(schoolName)) 
            {
                queryParams.Add($"schoolName={Uri.EscapeDataString(schoolName)}");
            }
            if (!string.IsNullOrEmpty(division)) 
            {
                queryParams.Add($"division={Uri.EscapeDataString(division)}");
            }
            
            var url = "api/IncidentReport/category-trend" + (queryParams.Any() ? "?" + string.Join("&", queryParams) : "");
            
            // Step 2: Make API call
            var response = await Http.GetAsync(url);
            
            // Step 3: Check response status
            if (response.IsSuccessStatusCode)
            {
                try
                {
                    var content = await response.Content.ReadAsStringAsync();
                    
                    // Step 4: Deserialize response
                    var result = JsonSerializer.Deserialize<ApiResponse<List<CategoryTrendData>>>(
                        content, 
                        new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                    
                    if (result?.Success == true && result.Data != null && result.Data.Any())
                    {
                        categoryTrendData = result.Data.Select(d => new CategoryTrendMonth
                        {
                            Label = d.Label,
                            MinorCount = d.MinorCount,
                            MajorCount = d.MajorCount,
                            ProhibitedCount = d.ProhibitedCount
                        }).ToList();
                    }
                    else
                    {
                        InitializeEmptyCategoryTrendData();
                    }
                }
                catch (JsonException ex)
                {
                    Console.WriteLine($"Error deserializing category trend data: {ex.Message}");
                    InitializeEmptyCategoryTrendData();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error reading category trend response: {ex.Message}");
                    InitializeEmptyCategoryTrendData();
                }
            }
            else
            {
                InitializeEmptyCategoryTrendData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Unexpected error loading category trend data: {ex.Message}");
            InitializeEmptyCategoryTrendData();
        }
    }

    private async Task LoadDashboardStats()
    {
        try
        {
            var queryParams = new List<string>();
            if (!string.IsNullOrEmpty(schoolName)) queryParams.Add($"schoolName={Uri.EscapeDataString(schoolName)}");
            if (!string.IsNullOrEmpty(division)) queryParams.Add($"division={Uri.EscapeDataString(division)}");
            if (!string.IsNullOrEmpty(region)) queryParams.Add($"region={Uri.EscapeDataString(region)}");
            if (!string.IsNullOrEmpty(district)) queryParams.Add($"district={Uri.EscapeDataString(district)}");
            
            var url = "api/IncidentReport/dashboard-stats" + (queryParams.Any() ? "?" + string.Join("&", queryParams) : "");
            var response = await Http.GetAsync(url);
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<ApiResponse<DashboardStatistics>>(content, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                
                if (result?.Success == true && result.Data != null)
                {
                   var stats = result.Data;
                   
                   // Map Status Counts
                   statusCounts = stats.StatusCounts.ToDictionary(s => s.Status, s => s.Count);
                   
                   // Map Weekly Stats
                   weeklyStats = stats.WeeklyStats.Select(w => new WeeklyStat { Label = w.Label, Count = w.Count }).ToList();
                   // Calculate bar percent for weekly
                   var maxWeekly = weeklyStats.Any() ? weeklyStats.Max(w => w.Count) : 0;
                   weeklyStats.ForEach(w => w.BarPercent = maxWeekly == 0 ? 0 : (double)w.Count / maxWeekly * 100);
                   
                   // Map Yearly Stats
                   yearlyStats = stats.YearlyStats.Select(y => new YearlyStat { Label = y.Year, Count = y.Count }).ToList();
                   var maxYearly = yearlyStats.Any() ? yearlyStats.Max(y => y.Count) : 0;
                   yearlyStats.ForEach(y => y.BarPercent = maxYearly == 0 ? 0 : (double)y.Count / maxYearly * 100);

                   // Map Top Behaviors
                   var maxType = stats.TopBehaviors.Any() ? stats.TopBehaviors.Max(b => b.Count) : 0;
                   incidentTypeTrends = stats.TopBehaviors.Select(b => new TrendItem 
                   { 
                       Label = b.Behavior, 
                       Count = b.Count,
                       BarPercent = maxType == 0 ? 0 : (double)b.Count / maxType * 100
                   }).ToList();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading dashboard stats: {ex.Message}");
        }
    }

    private void InitializeEmptyCategoryTrendData()
    {
        // Initialize with 12 months of zero data
        var now = DateTime.Now;
        categoryTrendData = Enumerable.Range(0, 12)
            .Select(i => now.AddMonths(-11 + i))
            .Select(month => new CategoryTrendMonth
            {
                Label = month.ToString("MMMM"),
                MinorCount = 0,
                MajorCount = 0,
                ProhibitedCount = 0
            })
            .ToList();
    }

    private async Task ProcessAnalytics()
    {
        // 1. Summary Stats (Derived from StatusCounts from API)
        if (statusCounts.Any())
        {
            pendingReports = statusCounts.ContainsKey("Pending") ? statusCounts["Pending"] : 0;
            resolvedReports = statusCounts.ContainsKey("Resolved") ? statusCounts["Resolved"] : 0;
            int rejectedReports = statusCounts.ContainsKey("Rejected") ? statusCounts["Rejected"] : 0;
            
            // Total reports is the sum of all status counts
            totalReports = statusCounts.Values.Sum();
            
            // Under Review is everything else (Reported, Approved, Escalated, etc.)
            // We subtract Pending, Resolved, and Rejected from the total
            underReviewReports = totalReports - pendingReports - resolvedReports - rejectedReports;
            

        }

        // 2. Monthly Stats & Category Stats (Derived from CategoryTrendData from API)
        if (categoryTrendData.Any())
        {
             // Monthly Stats
             monthlyStats = categoryTrendData.Select(c => new MonthlyStat 
             { 
                Label = c.Label.Length >= 3 ? c.Label.Substring(0, 3) : c.Label, 
                Count = c.MinorCount + c.MajorCount + c.ProhibitedCount
             }).ToList();

            // Category Stats
            var totalMinor = categoryTrendData.Sum(m => m.MinorCount);
            var totalMajor = categoryTrendData.Sum(m => m.MajorCount);
            var totalProhibited = categoryTrendData.Sum(m => m.ProhibitedCount);
            var totalCategorized = totalMinor + totalMajor + totalProhibited;

            categoryStats = new List<CategoryStat>
            {
                new CategoryStat
                {
                    Label = "Minor Acts", Count = totalMinor, Color = "#EAB308", Icon = "fas fa-exclamation-circle",
                    Percentage = totalCategorized == 0 ? 0 : Math.Round((double)totalMinor / totalCategorized * 100, 1),
                    BarPercent = totalCategorized == 0 ? 0 : (double)totalMinor / totalCategorized * 100
                },
                new CategoryStat
                {
                    Label = "Major Acts", Count = totalMajor, Color = "#EF4444", Icon = "fas fa-exclamation-triangle",
                    Percentage = totalCategorized == 0 ? 0 : Math.Round((double)totalMajor / totalCategorized * 100, 1),
                    BarPercent = totalCategorized == 0 ? 0 : (double)totalMajor / totalCategorized * 100
                },
                new CategoryStat
                {
                    Label = "Prohibited Acts", Count = totalProhibited, Color = "#3B82F6", Icon = "fas fa-ban",
                    Percentage = totalCategorized == 0 ? 0 : Math.Round((double)totalProhibited / totalCategorized * 100, 1),
                    BarPercent = totalCategorized == 0 ? 0 : (double)totalProhibited / totalCategorized * 100
                }
            };
        }
        
        // 9. Generate Insights (Limited to visible incidents for now)
        GeneratePrescriptiveActions();
        GenerateDescriptiveInsights();
    }

    private void GeneratePrescriptiveActions()
    {
        prescriptiveActions.Clear();
        
        // Identify students with multiple incidents (repeat offenders)
        // Use RespondentName as the student offender
        var studentIncidents = incidentReports
            .Where(r => !string.IsNullOrEmpty(r.RespondentName))
            .GroupBy(r => new { 
                Name = r.RespondentName, 
                Grade = Regex.Replace(r.GradeLevel ?? "", @"[^a-zA-Z0-9]", "").ToLower()
            })
            .Select(g => new
            {
                StudentName = g.Key.Name,
                GradeLevel = CultureInfo.CurrentCulture.TextInfo.ToTitleCase(Regex.Replace(g.Key.Grade, @"([a-z])([0-9])", "$1 $2")),
                IncidentCount = g.Count(),
                LastIncident = g.Max(r => r.DateReported),
                HasMajor = g.Any(r => r.LevelOfOffense?.Contains("Major", StringComparison.OrdinalIgnoreCase) ?? false),
                HasProhibited = g.Any(r => r.LevelOfOffense?.Contains("Prohibited", StringComparison.OrdinalIgnoreCase) ?? false)
            })
            .Where(s => s.IncidentCount >= 2) // At least 2 incidents
            .OrderByDescending(s => s.IncidentCount)
            .ThenByDescending(s => s.LastIncident)
            .Take(10)
            .ToList();
        
        foreach (var student in studentIncidents)
        {
            string riskLevel;
            string recommendedAction;
            string responsibleParty;
            
            // Determine risk level and recommended action
            if (student.IncidentCount >= 4 || student.HasProhibited)
            {
                riskLevel = "High";
                recommendedAction = "Mandatory Parent-School Attendance Contract";
                responsibleParty = "School Head & Guidance Counselor";
            }
            else if (student.IncidentCount >= 3 || student.HasMajor)
            {
                riskLevel = "High";
                recommendedAction = "Intensive Counseling & Behavioral Intervention";
                responsibleParty = "Guidance Counselor";
            }
            else
            {
                riskLevel = "Medium";
                recommendedAction = "Parent Conference & Monitoring";
                responsibleParty = "Class Adviser";
            }
            
            prescriptiveActions.Add(new PrescriptiveAction
            {
                StudentName = student.StudentName,
                GradeLevel = string.IsNullOrEmpty(student.GradeLevel) ? "N/A" : student.GradeLevel,
                RiskLevel = riskLevel,
                RecommendedAction = recommendedAction,
                ResponsibleParty = responsibleParty,
                IncidentCount = student.IncidentCount,
                LastIncidentDate = student.LastIncident
            });
        }
    }

    private void GenerateDescriptiveInsights()
    {
        descriptiveInsights.Clear();
        
        // Insight 1: Grade Level with Highest Incident Rate
        var gradeLevelStats = incidentReports
            .Where(r => !string.IsNullOrEmpty(r.GradeLevel))
            .GroupBy(r => Regex.Replace(r.GradeLevel ?? "", @"[^a-zA-Z0-9]", "").ToLower())
            .Select(g => new { 
                // Reconstruct display name: "grade11" -> "Grade 11"
                Grade = CultureInfo.CurrentCulture.TextInfo.ToTitleCase(Regex.Replace(g.Key, @"([a-z])([0-9])", "$1 $2")), 
                Count = g.Count() 
            })
            .OrderByDescending(g => g.Count)
            .FirstOrDefault();
            
        if (gradeLevelStats != null && gradeLevelStats.Count > 0)
        {
            descriptiveInsights.Add(new DescriptiveInsight
            {
                Title = $"{gradeLevelStats.Grade}: Highest Incident Volume",
                Description = $"{gradeLevelStats.Grade} accounts for the highest number of reported incidents in the school.",
                Category = "Grade",
                Severity = gradeLevelStats.Count >= 10 ? "Warning" : "Info",
                Metrics = new Dictionary<string, string>
                {
                    { "Total Incidents", gradeLevelStats.Count.ToString() },
                    { "Share of Total", $"{(totalReports > 0 ? Math.Round((double)gradeLevelStats.Count / totalReports * 100, 1) : 0)}%" }
                }
            });
        }

        // Insight 2: Most Common Incident Type
        if (incidentTypeTrends.Any())
        {
            var topType = incidentTypeTrends.First();
            descriptiveInsights.Add(new DescriptiveInsight
            {
                Title = $"Top Issue: {topType.Label}",
                Description = $"{topType.Label} is the most frequently reported issue.",
                Category = "Incident",
                Severity = "Info",
                Metrics = new Dictionary<string, string>
                {
                    { "Count", topType.Count.ToString() },
                    { "Trend", "Monitoring" }
                }
            });
        }

        // Insight 3: Grade Level with Most Repeat Offenders
        var gradeRepeatOffenders = incidentReports
            .Where(r => !string.IsNullOrEmpty(r.GradeLevel) && !string.IsNullOrEmpty(r.RespondentName))
            .GroupBy(r => Regex.Replace(r.GradeLevel ?? "", @"[^a-zA-Z0-9]", "").ToLower())
            .Select(g => new 
            { 
                Grade = CultureInfo.CurrentCulture.TextInfo.ToTitleCase(Regex.Replace(g.Key, @"([a-z])([0-9])", "$1 $2")), 
                RepeatOffenders = g.GroupBy(r => r.RespondentName).Count(sg => sg.Count() > 1),
                TotalStudents = g.Select(r => r.RespondentName).Distinct().Count()
            })
            .OrderByDescending(g => g.RepeatOffenders)
            .FirstOrDefault();

        if (gradeRepeatOffenders != null && gradeRepeatOffenders.RepeatOffenders > 0)
        {
            descriptiveInsights.Add(new DescriptiveInsight
            {
                Title = $"{gradeRepeatOffenders.Grade}: Repeat Offender Alert",
                Description = $"{gradeRepeatOffenders.Grade} has the highest number of students with recurring behavioral issues.",
                Category = "Grade",
                Severity = "Warning",
                Metrics = new Dictionary<string, string>
                {
                    { "Repeat Offenders", gradeRepeatOffenders.RepeatOffenders.ToString() },
                    { "Affected Students", gradeRepeatOffenders.TotalStudents.ToString() }
                }
            });
        }
    }

    private string GetInsightIcon(string category)
    {
        return category switch
        {
            "Grade" => "fa-layer-group",
            "Incident" => "fa-exclamation-circle",
            "Trend" => "fa-chart-line",
            _ => "fa-info-circle"
        };
    }

    // --- Helper Methods for Charts ---

    private string GetLineChartPath(List<MonthlyStat> stats, double width, double height)
    {
        if (stats.Count < 2) return "";
        
        var max = stats.Max(s => s.Count);
        if (max == 0) max = 10; // Default scale
        
        var points = new List<string>();
        double stepX = width / (stats.Count - 1);
        double paddingY = 25;
        double usableHeight = height - (paddingY * 2);

        for (int i = 0; i < stats.Count; i++)
        {
            double x = i * stepX;
            double y = height - paddingY - ((double)stats[i].Count / max * usableHeight);
            points.Add($"{x},{y}");
        }

        return "M" + string.Join(" L", points);
    }

    private List<PieSegment> GetPieChartSegments()
    {
        var segments = new List<PieSegment>();
        double total = totalReports;
        if (total == 0) return segments;

        // Start from -90 degrees (12 o'clock)
        double startAngle = -Math.PI / 2;
        
        // Define colors for specific statuses (Case-insensitive)
        var colors = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase)
        {
            { "Pending", "#ffb547" },
            { "Under Review", "#6ad2ff" },
            { "Resolved", "#05cd99" },
            { "Arrived", "#4318ff" },
            { "Closed", "#a3aed0" }
        };
        
        // Default colors for unknown statuses
        var defaultColors = new[] { "#e2e8f0", "#cbd5e1", "#94a3b8", "#64748b" };
        int defaultColorIndex = 0;

        // Order by count descending for better presentation
        var sortedStatuses = statusCounts.OrderByDescending(x => x.Value).ToList();

        foreach (var status in sortedStatuses)
        {
            double count = status.Value;
            double sliceAngle = (count / total) * 2 * Math.PI;
            
            // Fix for 100% slice disappearing (SVG arc limitation)
            // If slice is very close to 360 degrees, make it slightly less to ensure it renders as a full circle
            bool isFullCircle = sliceAngle >= 2 * Math.PI * 0.999;
            double drawAngle = isFullCircle ? 2 * Math.PI * 0.9999 : sliceAngle;

            double endAngle = startAngle + drawAngle;

            // Calculate path coordinates
            double x1 = 50 + 50 * Math.Cos(startAngle);
            double y1 = 50 + 50 * Math.Sin(startAngle);
            double x2 = 50 + 50 * Math.Cos(endAngle);
            double y2 = 50 + 50 * Math.Sin(endAngle);

            int largeArc = drawAngle > Math.PI ? 1 : 0;

            string path = $"M50,50 L{x1},{y1} A50,50 0 {largeArc},1 {x2},{y2} Z";
            
            // Determine color
            string color;
            if (colors.TryGetValue(status.Key, out var specificColor))
            {
                color = specificColor;
            }
            else
            {
                color = defaultColors[defaultColorIndex % defaultColors.Length];
                defaultColorIndex++;
            }

            double percentage = Math.Round((count / total) * 100, 1);

            segments.Add(new PieSegment { 
                Path = path, 
                Color = color,
                Label = status.Key,
                Count = (int)count,
                Percentage = percentage
            });

            // Advance start angle by the ACTUAL slice angle (not the drawn one, to keep math correct)
            startAngle += sliceAngle;
        }

        return segments;
    }

    private double GetStatusPercent(string status)
    {
        if (totalReports == 0) return 0;
        var count = incidentReports.Count(r => r.Status.Equals(status, StringComparison.OrdinalIgnoreCase));
        return Math.Round((double)count / totalReports * 100, 1);
    }

    private string GetStatusClass(string status)
    {
        return status?.ToLower() switch
        {
            "pending" => "status-pending",
            "under review" => "status-review",
            "resolved" => "status-resolved",
            _ => "status-default"
        };
    }

    private string MaskName(string? value)
    {
        if (string.IsNullOrWhiteSpace(value)) return "-";
        var words = value.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        return string.Join(' ', words.Select(w => w.Length > 1 ? w[0] + new string('*', w.Length - 1) : "*"));
    }

    // Category Classification Helpers - No longer needed, data comes from StudentProfileCaseRecords.LevelOfOffense

    // Data Classes
    public class MonthlyStat { public string Label { get; set; } = ""; public int Count { get; set; } }
    public class WeeklyStat { public string Label { get; set; } = ""; public int Count { get; set; } public double BarPercent { get; set; } }
    public class YearlyStat { public string Label { get; set; } = ""; public int Count { get; set; } public double BarPercent { get; set; } }
    public class TrendItem { public string Label { get; set; } = ""; public int Count { get; set; } public double BarPercent { get; set; } }
    public class CategoryStat { 
        public string Label { get; set; } = ""; 
        public int Count { get; set; } 
        public string Color { get; set; } = ""; 
        public string Icon { get; set; } = "";
        public double Percentage { get; set; }
        public double BarPercent { get; set; }
    }
    public class CategoryTrendMonth {
        public string Label { get; set; } = "";
        public int MinorCount { get; set; }
        public int MajorCount { get; set; }
        public int ProhibitedCount { get; set; }
    }
    public class PieSegment { 
        public string Path { get; set; } = ""; 
        public string Color { get; set; } = ""; 
        public string Label { get; set; } = "";
        public int Count { get; set; }
        public double Percentage { get; set; }
    }

    public class PrescriptiveAction
    {
        public string StudentName { get; set; } = "";
        public string GradeLevel { get; set; } = "";
        public string RiskLevel { get; set; } = "Medium"; // High, Medium, Low
        public string RecommendedAction { get; set; } = "";
        public string ResponsibleParty { get; set; } = "";
        public int IncidentCount { get; set; }
        public DateTime LastIncidentDate { get; set; }
    }

    public class DescriptiveInsight
    {
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string Category { get; set; } = "Info"; // Grade, Incident, Trend
        public string Severity { get; set; } = "Info"; // Info, Warning, Critical
        public Dictionary<string, string> Metrics { get; set; } = new();
    }
}
