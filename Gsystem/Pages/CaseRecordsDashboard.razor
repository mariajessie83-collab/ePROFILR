@page "/case-records-dashboard"
@layout Gsystem.Layout.PODLayout
@using System.Text.Json
@using System.Net.Http.Headers
@using SharedProject
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>Case Records Dashboard</PageTitle>

@if (isAuthenticated)
{
    <div class="dashboard-container">
        <div class="dashboard-header">
            <h2>Student Profile and Case Records Dashboard</h2>
            <p>View and manage student disciplinary case records</p>
        </div>

        <div class="dashboard-controls">
            <div class="filter-controls">
                <label for="statusFilter">Filter by Status:</label>
                <select id="statusFilter" class="form-control" @onchange="OnStatusFilterChanged">
                    <option value="">All Records</option>
                    <option value="Active">Active</option>
                    <option value="Resolved">Resolved</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
            
            <div class="action-controls">
                <a href="/simplified-case-record" class="btn btn-primary">
                    <i class="icon-plus"></i> Create New Record
                </a>
            </div>
        </div>

        @if (isLoading)
        {
            <div class="loading-container">
                <div class="spinner"></div>
                <p>Loading case records...</p>
            </div>
        }
        else
        {
            @if (!string.IsNullOrEmpty(message))
            {
                <div class="alert @(isSuccess ? "alert-success" : "alert-error")">
                    @message
                </div>
            }

            <div class="records-table-container">
                @if (caseRecords.Any())
                {
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>Record ID</th>
                                <th>Student Name</th>
                                <th>Grade Level</th>
                                <th>Section</th>
                                <th>Violation</th>
                                <th>Level</th>
                                <th>Date of Offense</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var record in caseRecords)
                            {
                                <tr class="@GetRowClass(record.Status)">
                                    <td>@record.RecordID</td>
                                    <td>@record.StudentOffenderName</td>
                                    <td>@record.GradeLevel</td>
                                    <td>@record.Section</td>
                                    <td>@record.ViolationCommitted</td>
                                    <td>
                                        <span class="badge @GetLevelBadgeClass(record.LevelOfOffense)">
                                            @record.LevelOfOffense
                                        </span>
                                    </td>
                                    <td>@record.DateOfOffense.ToString("MMM dd, yyyy")</td>
                                    <td>
                                        <span class="badge @GetStatusBadgeClass(record.Status)">
                                            @record.Status
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons-group">
                                            <button class="btn btn-sm btn-info" @onclick='@(() => NavigationManager.NavigateTo($"/case-record-review/{record.RecordID}"))'>
                                                View Details
                                            </button>
                                            <button class="btn btn-sm btn-sms" @onclick="@(() => OpenSMSModal(record.RecordID))" title="Send SMS Notification">
                                                üì± SMS
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>

                    @if (caseRecords.Count == pageSize)
                    {
                        <div class="pagination">
                            <button class="btn btn-outline" @onclick="LoadMoreRecords" disabled="@isLoading">
                                Load More Records
                            </button>
                        </div>
                    }
                }
                else
                {
                    <div class="no-records">
                        <div class="no-records-icon">üìã</div>
                        <h3>No Case Records Found</h3>
                        <p>There are no case records matching your current filter criteria.</p>
                        <a href="/simplified-case-record" class="btn btn-primary">
                            Create First Record
                        </a>
                    </div>
                }
            </div>
        }
    </div>
}
else
{
    <div class="login-required-container">
        <div class="login-required-card">
            <div class="login-required-header">
                <h2>üîí Login Required</h2>
                <p>You need to be logged in to access the case records dashboard.</p>
                <p class="filipino-text">Kailangan mong mag-login upang ma-access ang case records dashboard.</p>
            </div>
            
            <div class="login-required-actions">
                <a href="/login/teacher" class="btn btn-primary">Teacher Login</a>
                <a href="/login/student" class="btn btn-outline">Student Login</a>
                <a href="/" class="btn btn-secondary">Back to Home</a>
            </div>
        </div>
    </div>
}

@* Details Modal *@
@if (showDetailsModal)
{
    <div class="modal-backdrop" @onclick="CloseDetailsModal"></div>
    <div class="details-modal" @onclick:stopPropagation>
        <div class="modal-header">
            <div class="header-content">
                <h3>Case Record Details</h3>
                @if (selectedRecordId > 0)
                {
                    <span class="record-id-header">#@selectedRecordId</span>
                }
            </div>
            <button class="modal-close" @onclick="CloseDetailsModal">&times;</button>
        </div>
        <div class="modal-body">
            @if (isLoadingDetails)
            {
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Loading record details...</p>
                </div>
            }
            else if (selectedRecord != null)
            {
                <div class="details-sections">
                    <div class="details-section">
                        <h4>üìã Student Information</h4>
                        <div class="details-grid">
                            <div class="detail-field">
                                <label>Student Name</label>
                                <div class="detail-value">@selectedRecord.StudentOffenderName</div>
                            </div>
                            <div class="detail-field">
                                <label>Grade Level</label>
                                <div class="detail-value">@selectedRecord.GradeLevel</div>
                            </div>
                            @if (!string.IsNullOrEmpty(selectedRecord.TrackStrand))
                            {
                                <div class="detail-field">
                                    <label>Track/Strand</label>
                                    <div class="detail-value">@selectedRecord.TrackStrand</div>
                                </div>
                            }
                            <div class="detail-field">
                                <label>Section</label>
                                <div class="detail-value">@selectedRecord.Section</div>
                            </div>
                            <div class="detail-field">
                                <label>Adviser Name</label>
                                <div class="detail-value">@selectedRecord.AdviserName</div>
                            </div>
                        </div>
                    </div>

                    <div class="details-section">
                        <h4>üë®‚Äçüë©‚Äçüëß Parent/Guardian Information</h4>
                        <div class="details-grid">
                            @if (!string.IsNullOrEmpty(selectedRecord.FathersName))
                            {
                                <div class="detail-field">
                                    <label>Father's Name</label>
                                    <div class="detail-value">@selectedRecord.FathersName</div>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(selectedRecord.MothersName))
                            {
                                <div class="detail-field">
                                    <label>Mother's Name</label>
                                    <div class="detail-value">@selectedRecord.MothersName</div>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(selectedRecord.GuardianName))
                            {
                                <div class="detail-field">
                                    <label>Guardian Name</label>
                                    <div class="detail-value">@selectedRecord.GuardianName</div>
                                </div>
                            }
                            <div class="detail-field">
                                <label>Contact Number</label>
                                <div class="detail-value">@selectedRecord.ParentGuardianContact</div>
                            </div>
                        </div>
                    </div>

                    <div class="details-section">
                        <h4>‚ö†Ô∏è Offense Information</h4>
                        <div class="details-grid">
                            <div class="detail-field">
                                <label>Violation Committed</label>
                                <div class="detail-value">@selectedRecord.ViolationCommitted</div>
                            </div>
                            @if (!string.IsNullOrEmpty(selectedRecord.OtherViolationDescription))
                            {
                                <div class="detail-field full-width">
                                    <label>Other Violation Description</label>
                                    <div class="detail-value">@selectedRecord.OtherViolationDescription</div>
                                </div>
                            }
                            <div class="detail-field">
                                <label>Level of Offense</label>
                                <div class="detail-value">
                                    <span class="badge @GetLevelBadgeClass(selectedRecord.LevelOfOffense)">
                                        @selectedRecord.LevelOfOffense
                                    </span>
                                </div>
                            </div>
                            <div class="detail-field">
                                <label>Number of Offense</label>
                                <div class="detail-value">@selectedRecord.NumberOfOffense</div>
                            </div>
                            <div class="detail-field">
                                <label>Date of Offense</label>
                                <div class="detail-value">@selectedRecord.DateOfOffense.ToString("MMM dd, yyyy")</div>
                            </div>
                            <div class="detail-field full-width">
                                <label>Details of Agreement</label>
                                <div class="detail-value text-area">@selectedRecord.DetailsOfAgreement</div>
                            </div>
                        </div>
                    </div>

                    <div class="details-section">
                        <h4>üìù Additional Information</h4>
                        <div class="details-grid">
                            @if (!string.IsNullOrEmpty(selectedRecord.PODInCharge))
                            {
                                <div class="detail-field">
                                    <label>POD In-Charge</label>
                                    <div class="detail-value">@selectedRecord.PODInCharge</div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" @onclick="CloseDetailsModal">Close</button>
        </div>
    </div>
}

@* SMS Modal *@
@if (showSMSModal)
{
    <div class="modal-backdrop" @onclick="CloseSMSModal"></div>
    <div class="sms-modal" @onclick:stopPropagation>
        <div class="modal-header">
            <div class="header-content">
                <h3>üì± Send SMS Notification</h3>
                @if (smsRecordId > 0)
                {
                    <span class="record-id-header">Record #@smsRecordId</span>
                }
            </div>
            <button class="modal-close" @onclick="CloseSMSModal">&times;</button>
        </div>
        <div class="modal-body">
            @if (isLoadingSMS)
            {
                <div class="loading-container">
                    <div class="spinner"></div>
                    <p>Loading record information...</p>
                </div>
            }
            else if (smsRecordDetails != null)
            {
                <div class="sms-info-section">
                    <div class="info-row">
                        <span class="info-label">Student:</span>
                        <span class="info-value">@smsRecordDetails.StudentOffenderName</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Parent/Guardian Contact:</span>
                        <span class="info-value">@smsRecordDetails.ParentGuardianContact</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Violation:</span>
                        <span class="info-value">@smsRecordDetails.ViolationCommitted</span>
                    </div>
                </div>

                <div class="sms-message-section">
                    <label for="smsMessage">Message:</label>
                    <textarea id="smsMessage" class="sms-message-input" rows="5" @bind="smsMessage" placeholder="Enter your message here..."></textarea>
                    <small class="character-count">@smsMessage.Length / 160 characters</small>
                    <button type="button" class="btn btn-sm btn-outline" @onclick="LoadDefaultMessage" style="display: none;">
                        üîÑ Use Default Message
                    </button>
                </div>

                <div class="sms-preview-section">
                    <div class="preview-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0;">Message Preview:</h4>
                        <div>
                            <button type="button" class="btn btn-sm btn-outline" @onclick="LoadDefaultMessage" style="margin-right: 8px;">
                                üîÑ Use Default Message
                            </button>
                            <button type="button" class="btn btn-sm btn-outline" @onclick="TogglePreviewDropdown">
                                @if (showPreviewDropdown)
                                {
                                    <span>‚ñº Hide Preview</span>
                                }
                                else
                                {
                                    <span>‚ñ∂ Show Preview</span>
                                }
                            </button>
                        </div>
                    </div>
                    @if (showPreviewDropdown)
                    {
                        <div class="preview-box">
                            <p class="preview-text">@(string.IsNullOrEmpty(smsMessage) ? GetDefaultSMSMessage() : smsMessage)</p>
                        </div>
                    }
                </div>
            }
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" @onclick="CloseSMSModal">Cancel</button>
            <button class="btn btn-primary" @onclick="SendSMSNotification" disabled="@(isSendingSMS || string.IsNullOrEmpty(smsMessage))">
                @if (isSendingSMS)
                {
                    <span>Sending...</span>
                }
                else
                {
                    <span>üì± Send SMS</span>
                }
            </button>
        </div>
    </div>
}

@code {
    private List<StudentProfileCaseRecordSummary> caseRecords = new();
    private bool isLoading = false;
    private bool isSuccess = false;
    private string message = string.Empty;
    private bool isAuthenticated = false;
    private string statusFilter = "";
    private int currentPage = 1;
    private int pageSize = 20;
    protected override async Task OnInitializedAsync()
    {
        await CheckAuthentication();
        if (isAuthenticated)
        {
            await LoadCaseRecords();
        }
    }

    private async Task CheckAuthentication()
    {
        try
        {
            var authToken = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");
            var username = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "username");
            
            if (!string.IsNullOrEmpty(authToken) && !string.IsNullOrEmpty(username))
            {
                isAuthenticated = true;
            }
            else
            {
                isAuthenticated = false;
            }
        }
        catch
        {
            isAuthenticated = false;
        }
    }

    private async Task LoadCaseRecords()
    {
        isLoading = true;
        message = string.Empty;

        try
        {
            // Use the new POD endpoint with case routing logic
            // This endpoint returns:
            // 1. All Major and Prohibited Acts cases
            // 2. Consolidated records for students with 3+ minor cases
            var url = $"api/StudentProfileCaseRecord/pod?page={currentPage}&pageSize={pageSize}";
            if (!string.IsNullOrEmpty(statusFilter))
            {
                url += $"&status={Uri.EscapeDataString(statusFilter)}";
            }

            var response = await Http.GetAsync(url);
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                {
                    var newRecords = new List<StudentProfileCaseRecordSummary>();
                    foreach (var recordElement in data.EnumerateArray())
                    {
                        var record = new StudentProfileCaseRecordSummary();
                        
                        if (recordElement.TryGetProperty("recordID", out var recordId))
                            record.RecordID = recordId.GetInt32();
                        if (recordElement.TryGetProperty("studentOffenderName", out var studentName))
                            record.StudentOffenderName = studentName.GetString() ?? "";
                        if (recordElement.TryGetProperty("gradeLevel", out var gradeLevel))
                            record.GradeLevel = gradeLevel.GetString() ?? "";
                        if (recordElement.TryGetProperty("section", out var section))
                            record.Section = section.GetString() ?? "";
                        if (recordElement.TryGetProperty("violationCommitted", out var violation))
                            record.ViolationCommitted = violation.GetString() ?? "";
                        if (recordElement.TryGetProperty("levelOfOffense", out var level))
                            record.LevelOfOffense = level.GetString() ?? "";
                        if (recordElement.TryGetProperty("dateOfOffense", out var date))
                            record.DateOfOffense = DateTime.Parse(date.GetString() ?? DateTime.Now.ToString());
                        if (recordElement.TryGetProperty("status", out var status))
                            record.Status = status.GetString() ?? "";
                        if (recordElement.TryGetProperty("detailsOfAgreement", out var details))
                            record.DetailsOfAgreement = details.GetString() ?? "";
                        
                        newRecords.Add(record);
                    }
                    
                    if (currentPage == 1)
                    {
                        caseRecords = newRecords;
                    }
                    else
                    {
                        caseRecords.AddRange(newRecords);
                    }
                    
                    isSuccess = true;
                    
                    // Show info message about routing logic
                    if (currentPage == 1 && newRecords.Any())
                    {
                        var consolidatedCount = newRecords.Count(r => r.LevelOfOffense.Contains("Consolidated"));
                        if (consolidatedCount > 0)
                        {
                            message = $"Showing {newRecords.Count} case records (includes {consolidatedCount} student(s) with 3+ minor cases)";
                            isSuccess = true;
                        }
                    }
                }
                else
                {
                    message = "Failed to load case records.";
                    isSuccess = false;
                }
            }
            else
            {
                message = $"Error loading case records: {response.StatusCode}";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            message = $"Error loading case records: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnStatusFilterChanged(ChangeEventArgs e)
    {
        statusFilter = e.Value?.ToString() ?? "";
        currentPage = 1;
        await LoadCaseRecords();
    }

    private async Task LoadMoreRecords()
    {
        currentPage++;
        await LoadCaseRecords();
    }

    private async Task ViewRecord(int recordId)
    {
        await LoadCaseRecordDetails(recordId);
        showDetailsModal = true;
    }

    // Details Modal state
    private bool showDetailsModal = false;
    private StudentProfileCaseRecordModel? selectedRecord = null;
    private bool isLoadingDetails = false;
    private int selectedRecordId = 0;

    private async Task LoadCaseRecordDetails(int recordId)
    {
        selectedRecordId = recordId;
        isLoadingDetails = true;
        try
        {
            var response = await Http.GetAsync($"api/StudentProfileCaseRecord/{recordId}");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data))
                {
                    selectedRecord = new StudentProfileCaseRecordModel();
                    
                    if (data.TryGetProperty("studentOffenderName", out var studentName))
                        selectedRecord.StudentOffenderName = studentName.GetString() ?? "";
                    if (data.TryGetProperty("gradeLevel", out var gradeLevel))
                        selectedRecord.GradeLevel = gradeLevel.GetString() ?? "";
                    if (data.TryGetProperty("trackStrand", out var trackStrand))
                        selectedRecord.TrackStrand = trackStrand.GetString() ?? "";
                    if (data.TryGetProperty("section", out var section))
                        selectedRecord.Section = section.GetString() ?? "";
                    if (data.TryGetProperty("adviserName", out var adviserName))
                        selectedRecord.AdviserName = adviserName.GetString() ?? "";
                    if (data.TryGetProperty("fathersName", out var fathersName))
                        selectedRecord.FathersName = fathersName.GetString();
                    if (data.TryGetProperty("mothersName", out var mothersName))
                        selectedRecord.MothersName = mothersName.GetString();
                    if (data.TryGetProperty("guardianName", out var guardianName))
                        selectedRecord.GuardianName = guardianName.GetString();
                    if (data.TryGetProperty("parentGuardianContact", out var contact))
                        selectedRecord.ParentGuardianContact = contact.GetString() ?? "";
                    if (data.TryGetProperty("dateOfOffense", out var dateOfOffense))
                        selectedRecord.DateOfOffense = DateTime.Parse(dateOfOffense.GetString() ?? DateTime.Now.ToString());
                    if (data.TryGetProperty("levelOfOffense", out var levelOfOffense))
                        selectedRecord.LevelOfOffense = levelOfOffense.GetString() ?? "";
                    if (data.TryGetProperty("violationCommitted", out var violation))
                        selectedRecord.ViolationCommitted = violation.GetString() ?? "";
                    if (data.TryGetProperty("otherViolationDescription", out var otherViolation))
                        selectedRecord.OtherViolationDescription = otherViolation.GetString();
                    if (data.TryGetProperty("numberOfOffense", out var numberOfOffense))
                        selectedRecord.NumberOfOffense = numberOfOffense.GetString() ?? "";
                    if (data.TryGetProperty("detailsOfAgreement", out var details))
                        selectedRecord.DetailsOfAgreement = details.GetString() ?? "";
                    if (data.TryGetProperty("podInCharge", out var podInCharge))
                        selectedRecord.PODInCharge = podInCharge.GetString();
                    if (data.TryGetProperty("dateCreated", out var dateCreated))
                        selectedRecord.DateCreated = DateTime.Parse(dateCreated.GetString() ?? DateTime.Now.ToString());
                    if (data.TryGetProperty("status", out var status))
                        selectedRecord.Status = status.GetString() ?? "";
                }
            }
        }
        catch (Exception ex)
        {
            message = $"Error loading record details: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isLoadingDetails = false;
        }
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedRecord = null;
        selectedRecordId = 0;
    }

    // SMS Modal state
    private bool showSMSModal = false;
    private int smsRecordId = 0;
    private StudentProfileCaseRecordModel? smsRecordDetails = null;
    private bool isLoadingSMS = false;
    private bool isSendingSMS = false;
    private string smsMessage = "";
    private bool showPreviewDropdown = false;

    private async Task OpenSMSModal(int recordId)
    {
        smsRecordId = recordId;
        smsMessage = "";
        showSMSModal = true;
        await LoadSMSRecordDetails(recordId);
    }

    private async Task LoadSMSRecordDetails(int recordId)
    {
        isLoadingSMS = true;
        try
        {
            var response = await Http.GetAsync($"api/StudentProfileCaseRecord/{recordId}");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data))
                {
                    smsRecordDetails = new StudentProfileCaseRecordModel();
                    
                    if (data.TryGetProperty("studentOffenderName", out var studentName))
                        smsRecordDetails.StudentOffenderName = studentName.GetString() ?? "";
                    if (data.TryGetProperty("parentGuardianContact", out var contact))
                        smsRecordDetails.ParentGuardianContact = contact.GetString() ?? "";
                    if (data.TryGetProperty("violationCommitted", out var violation))
                        smsRecordDetails.ViolationCommitted = violation.GetString() ?? "";
                    
                    // Set default message automatically
                    smsMessage = GetDefaultSMSMessage();
                }
            }
        }
        catch (Exception ex)
        {
            message = $"Error loading record details: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isLoadingSMS = false;
        }
    }

    private string GetDefaultSMSMessage()
    {
        if (smsRecordDetails == null) return "";
        
        return $"Dear Parent/Guardian,\n\n" +
               $"This is to inform you that your child {smsRecordDetails.StudentOffenderName} " +
               $"has been involved in a disciplinary case regarding: {smsRecordDetails.ViolationCommitted}.\n\n" +
               $"Please contact the school office for more details.\n\n" +
               $"ePROFILR System";
    }

    private void LoadDefaultMessage()
    {
        smsMessage = GetDefaultSMSMessage();
    }

    private void TogglePreviewDropdown()
    {
        showPreviewDropdown = !showPreviewDropdown;
    }

    private async Task SendSMSNotification()
    {
        if (smsRecordDetails == null || string.IsNullOrEmpty(smsMessage))
        {
            message = "Please enter a message to send.";
            isSuccess = false;
            return;
        }

        isSendingSMS = true;
        try
        {
            var smsRequest = new
            {
                recordId = smsRecordId,
                phoneNumber = smsRecordDetails.ParentGuardianContact,
                message = smsMessage,
                studentName = smsRecordDetails.StudentOffenderName
            };

            var json = JsonSerializer.Serialize(smsRequest);
            var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");

            Console.WriteLine($"Sending SMS to: {smsRecordDetails.ParentGuardianContact}");
            var response = await Http.PostAsync("api/SMS/SendSMS", content);
            
            Console.WriteLine($"Response status: {response.StatusCode}");
            
            if (response.IsSuccessStatusCode)
            {
                var responseContent = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(responseContent);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean())
                {
                    message = "SMS notification sent successfully!";
                    isSuccess = true;
                    CloseSMSModal();
                }
                else
                {
                    if (result.TryGetProperty("message", out var errorMsg))
                        message = $"Failed to send SMS: {errorMsg.GetString()}";
                    else
                        message = "Failed to send SMS notification.";
                    isSuccess = false;
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Error response: {errorContent}");
                try
                {
                    var errorResult = JsonSerializer.Deserialize<JsonElement>(errorContent);
                    if (errorResult.TryGetProperty("message", out var errorMsg))
                    {
                        message = errorMsg.GetString() ?? "Failed to send SMS";
                        Console.WriteLine($"Error message: {message}");
                    }
                    else if (errorResult.TryGetProperty("details", out var details))
                    {
                        message = $"Error sending SMS: {errorContent}";
                    }
                    else
                    {
                        message = $"Error sending SMS: {errorContent}";
                    }
                }
                catch (Exception parseEx)
                {
                    Console.WriteLine($"Error parsing response: {parseEx.Message}");
                    message = $"Error sending SMS: {response.StatusCode} - {errorContent}";
                }
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            message = $"Error sending SMS notification: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isSendingSMS = false;
        }
    }

    private void CloseSMSModal()
    {
        showSMSModal = false;
        smsRecordId = 0;
        smsRecordDetails = null;
        smsMessage = "";
        showPreviewDropdown = false;
    }

    private string GetRowClass(string status)
    {
        return status.ToLower() switch
        {
            "active" => "row-active",
            "resolved" => "row-resolved",
            "closed" => "row-closed",
            _ => ""
        };
    }

    private string GetStatusBadgeClass(string status)
    {
        return status.ToLower() switch
        {
            "active" => "badge-warning",
            "resolved" => "badge-success",
            "closed" => "badge-secondary",
            _ => "badge-default"
        };
    }

    private string GetLevelBadgeClass(string level)
    {
        var lowerLevel = level.ToLower();
        
        // Check for consolidated minor cases
        if (lowerLevel.Contains("consolidated"))
            return "badge-consolidated";
            
        return lowerLevel switch
        {
            "prohibited acts" => "badge-info",
            "minor" => "badge-warning",
            "major" => "badge-danger",
            _ => "badge-default"
        };
    }
}

@* CSS Styles *@
<style>
    .dashboard-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .dashboard-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 30px;
        background: linear-gradient(135deg, #003d82 0%, #00a8e8 100%);
        color: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        font-family: 'Poppins', sans-serif !important;
    }

    .dashboard-header h2 {
        margin: 0 0 10px 0;
        font-size: 2.5rem;
        font-weight: 600;
        font-family: 'Poppins', sans-serif !important;
    }

    .dashboard-header p {
        margin: 0;
        opacity: 0.9;
        font-size: 1.2rem;
        font-family: 'Poppins', sans-serif !important;
    }

    .dashboard-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
    }

    .filter-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .filter-controls label {
        font-weight: 500;
        margin: 0;
    }

    .form-control {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .action-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background-color: #00a8e8;
        color: white;
        font-family: 'Poppins', sans-serif !important;
    }

    .btn-primary:hover {
        background-color: #003d82;
        color: white;
    }

    .btn-outline {
        background-color: transparent;
        color: #00a8e8;
        border: 2px solid #00a8e8;
    }

    .btn-outline:hover {
        background-color: #00a8e8;
        color: white;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #545b62;
    }

    .btn-info {
        background-color: #00a8e8;
        color: white;
        padding: 6px 12px;
        font-size: 12px;
    }

    .btn-info:hover {
        background-color: #003d82;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }

    .action-buttons-group {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }

    .btn-sms {
        background-color: #28a745;
        color: white;
        padding: 6px 12px;
        font-size: 12px;
    }

    .btn-sms:hover {
        background-color: #218838;
        color: white;
    }

    .loading-container {
        text-align: center;
        padding: 40px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .records-table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .records-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }

    .records-table th {
        background-color: #003d82;
        color: white;
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        border-bottom: 2px solid #002855;
        font-family: 'Poppins', sans-serif !important;
        font-size: 1rem;
    }

    .records-table td {
        padding: 15px 12px;
        border-bottom: 1px solid #dee2e6;
        vertical-align: middle;
        font-family: 'Poppins', sans-serif !important;
        font-size: 1rem;
    }

    .records-table tr:hover {
        background-color: #f8f9fa;
    }

    .row-active {
        border-left: 4px solid #ffc107;
    }

    .row-resolved {
        border-left: 4px solid #28a745;
    }

    .row-closed {
        border-left: 4px solid #6c757d;
    }

    .badge {
        display: inline-block;
        padding: 4px 8px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        border-radius: 4px;
    }

    .badge-warning {
        background-color: #ffc107;
        color: #212529;
    }

    .badge-success {
        background-color: #28a745;
        color: white;
    }

    .badge-secondary {
        background-color: #6c757d;
        color: white;
    }

    .badge-info {
        background-color: #17a2b8;
        color: white;
    }

    .badge-danger {
        background-color: #dc3545;
        color: white;
    }

    .badge-default {
        background-color: #e9ecef;
        color: #495057;
    }

    .pagination {
        text-align: center;
        padding: 20px;
        border-top: 1px solid #dee2e6;
    }

    .no-records {
        text-align: center;
        padding: 60px 20px;
        color: #6c757d;
    }

    .no-records-icon {
        font-size: 4rem;
        margin-bottom: 20px;
    }

    .no-records h3 {
        margin-bottom: 10px;
        color: #495057;
    }

    .no-records p {
        margin-bottom: 20px;
    }

    .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 6px;
        border: 1px solid transparent;
    }

    .alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }

    .alert-error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }

    .filipino-text {
        font-style: italic;
        opacity: 0.8;
    }

    .login-required-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 60vh;
    }

    .login-required-card {
        text-align: center;
        padding: 40px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        max-width: 400px;
    }

    .login-required-header h2 {
        color: #dc3545;
        margin-bottom: 15px;
    }

    .login-required-actions {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* Modal Styles */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    .details-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 900px;
        max-height: 90vh;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        z-index: 1001;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        background: linear-gradient(135deg, #003d82 0%, #00a8e8 100%);
        color: white;
        border-bottom: none;
    }

    .modal-header .header-content {
        display: flex;
        align-items: baseline;
        gap: 12px;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .record-id-header {
        font-size: 1.1rem;
        opacity: 0.9;
        font-weight: 500;
    }

    .modal-close {
        background: none;
        border: none;
        color: white;
        font-size: 2rem;
        cursor: pointer;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
        padding: 0;
        line-height: 1;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .modal-body {
        padding: 24px;
        overflow-y: auto;
        flex: 1;
    }

    .details-sections {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .details-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
    }

    .details-section h4 {
        margin: 0 0 16px 0;
        font-size: 1.2rem;
        font-weight: 600;
        color: #003d82;
        padding-bottom: 12px;
        border-bottom: 2px solid #00a8e8;
    }

    .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
    }

    .detail-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .detail-field.full-width {
        grid-column: 1 / -1;
    }

    .detail-field label {
        font-size: 12px;
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .detail-value {
        font-size: 14px;
        color: #212529;
        font-weight: 500;
        padding: 8px 12px;
        background: white;
        border-radius: 6px;
        border: 1px solid #e0e0e0;
    }

    .detail-value.text-area {
        min-height: 80px;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    .modal-footer {
        padding: 16px 24px;
        background: #f8f9fa;
        border-top: 1px solid #dee2e6;
        display: flex;
        justify-content: flex-end;
    }

    @@media (max-width: 768px) {
        .records-table-container {
            overflow-x: auto;
        }

        .records-table {
            font-size: 14px;
        }

        .records-table th,
        .records-table td {
            padding: 10px 8px;
        }

        .details-modal {
            width: 95%;
            max-height: 95vh;
        }

        .details-grid {
            grid-template-columns: 1fr;
        }

        .modal-header h3 {
            font-size: 1.2rem;
        }

        .sms-modal {
            width: 95%;
            max-height: 95vh;
        }
    }

    /* SMS Modal Styles */
    .sms-modal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90%;
        max-width: 600px;
        max-height: 90vh;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        z-index: 1001;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .sms-info-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-row .info-label {
        font-weight: 600;
        color: #6c757d;
        font-size: 14px;
    }

    .info-row .info-value {
        font-weight: 500;
        color: #212529;
        font-size: 14px;
        text-align: right;
    }

    .sms-message-section {
        margin-bottom: 20px;
    }

    .sms-message-section label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #212529;
    }

    .sms-message-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        font-family: 'Poppins', sans-serif;
        resize: vertical;
        min-height: 120px;
    }

    .sms-message-input:focus {
        outline: none;
        border-color: #00a8e8;
    }

    .character-count {
        display: block;
        margin-top: 4px;
        font-size: 12px;
        color: #6c757d;
        text-align: right;
    }

    .sms-preview-section {
        margin-bottom: 20px;
    }

    .sms-preview-section h4 {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
        color: #212529;
    }

    .preview-box {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 16px;
        min-height: 100px;
    }

    .preview-text {
        margin: 0;
        font-size: 14px;
        color: #212529;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    /* Consolidated Minor Case Badge */
    .badge-consolidated {
        background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        color: white;
        font-weight: 600;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        display: inline-block;
    }
</style>
