@page "/student-profile-case-record"
@layout Gsystem.Layout.PlainLayout 
@using System.Text.Json
@using System.Linq
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Headers
@using System.Web
@using SharedProject
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@inject NavigationManager NavigationManager

<PageTitle>Student Profile and Case Records</PageTitle>
<link rel="stylesheet" href="css/modal-styles.css" />

@if (isAuthenticated)   
{
    <div class="case-record-container">
        <div class="case-record-card">
            @if (isLoading)
            {
                <div class="loading-overlay">
                    <div class="spinner"></div>
                    <p>Loading information...</p>
                </div>
            }

            @if (!string.IsNullOrEmpty(message))
            {
                <div class="alert @(isSuccess ? "alert-success" : "alert-error")">
                    @message
                </div>
            }

            <EditForm EditContext="editContext" OnValidSubmit="HandleValidSubmit" @key="@formKey">
                <DataAnnotationsValidator />
                <ValidationSummary />

                @if (currentStep == 1)
                {
                    <div class="case-record-header" style="text-align: center;">
                        <h2>Student Profile and Case Records</h2>
                        <p>Please provide details about the student offense. All fields marked with * are required.</p>
                    </div>
                    <div class="wizard-stepper-container">
                        <div class="wizard-stepper">
                            @for (var i = 1; i <= TotalSteps; i++)
                            {
                                var stepClass = i < currentStep ? "done" : i == currentStep ? "active" : string.Empty;
                                <div class="step-item @stepClass">
                                    <div class="step-circle">
                                        @if (i < currentStep)
                                        {
                                            <span>‚úì</span>
                                        }
                                        else
                                        {
                                            <span>@i</span>
                                        }
                                    </div>
                                    <span class="step-label">@stepLabels[i - 1]</span>
                                </div>
                                @if (i < TotalSteps)
                                {
                                    <div class="step-line @(i < currentStep ? "done" : string.Empty)"></div>
                                }
                            }
                        </div>
                    </div>

                    <div class="form-section unified-student-section">
                        <h3>üìù Student Information</h3>
                        <p class="section-description">Select the student(s) involved in this case</p>
                        
                        <!-- Auto-filled Info Display - Multiple Records as Individual Cards -->
                        @if (studentInfoSuggestions.Any())
                        {
                            <div class="auto-filled-section">
                                <div class="info-cards-container">
                                    @foreach (var suggestion in studentInfoSuggestions)
                                    {
                                        var isSelected = selectedStudentSuggestion != null && AreSuggestionsEquivalent(selectedStudentSuggestion, suggestion);
                                        <div class="simple-card @(isSelected ? "card-selected" : "")" @onclick="@(() => ApplyStudentSuggestion(suggestion, clearSuggestions: false))" style="cursor: pointer;">
                                            <div class="card-content">
                                                <h3 class="student-name">
                                                    @suggestion.StudentName
                                                </h3>
                                                <p class="student-details">
                                                    @suggestion.GradeLevel
                                                    @if (!string.IsNullOrWhiteSpace(suggestion.TrackStrand))
                                                    {
                                                        <text> - @suggestion.TrackStrand</text>
                                                    }
                                                    @if (!string.IsNullOrWhiteSpace(suggestion.Section))
                                                    {
                                                        <text> - @suggestion.Section</text>
                                                    }
                                                </p>
                                                <p class="teacher-name">Adviser: @suggestion.AdviserName</p>
                                                @if (suggestion.StudentId.HasValue && !string.IsNullOrWhiteSpace(suggestion.Source) && suggestion.Source.Contains("Records"))
                                                {
                                                    <p class="student-id-small" style="font-size: 0.75rem; color: #6c757d; margin-top: 4px;">ID: @suggestion.StudentId</p>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }

                        @if (!studentInfoSuggestions.Any())
                        {
                            <div class="no-records-message">
                                <p>‚ö†Ô∏è No student records found. Student information will be loaded automatically from the incident report.</p>
                            </div>
                        }
                        

                        <!-- Student Records Cards - HIDDEN - Now shown in auto-filled section above -->
                        @if (false && studentInfoSuggestions.Count > 1)
                        {
                            <div class="student-records-container">
                                <div class="records-header">
                                    <div class="records-header-left">
                                        <span class="records-icon">üë•</span>
                                        <div>
                                            <h4>Multiple Student Records Found</h4>
                                            <p>Found @studentInfoSuggestions.Count record(s) for "@caseRecord.StudentOffenderName". The first one is auto-selected. Click on another to change:</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="student-cards-grid">
                                    @foreach (var suggestion in studentInfoSuggestions)
                                    {
                                        var isSelected = selectedStudentSuggestion != null && AreSuggestionsEquivalent(selectedStudentSuggestion, suggestion);
                                        <div class="student-info-card @(isSelected ? "card-selected" : string.Empty)">
                                            <div class="card-header">
                                                <div class="card-badge">
                                                    <span class="badge-icon">üìö</span>
                                                    <span class="badge-text">@(!string.IsNullOrWhiteSpace(suggestion.Source) ? suggestion.Source : "Student Record")</span>
                                                </div>
                                                @if (isSelected)
                                                {
                                                    <span class="selected-badge">‚úì Currently Selected</span>
                                                }
                                            </div>
                                            
                                            <div class="card-body">
                                                <div class="info-row primary">
                                                    <span class="info-label">üë§ Student Name:</span>
                                                    <span class="info-value">@(string.IsNullOrWhiteSpace(suggestion.StudentName) ? caseRecord.StudentOffenderName : suggestion.StudentName)</span>
                                                </div>
                                                
                                                <div class="info-row highlight">
                                                    <span class="info-label">üìä Grade Level:</span>
                                                    <span class="info-value highlight-value">@(string.IsNullOrWhiteSpace(suggestion.GradeLevel) ? "Not set" : suggestion.GradeLevel)</span>
                                                </div>
                                                
                                                <div class="info-row highlight">
                                                    <span class="info-label">üìù Section:</span>
                                                    <span class="info-value highlight-value">@(string.IsNullOrWhiteSpace(suggestion.Section) ? "Not set" : suggestion.Section)</span>
                                                </div>
                                                
                                                @if (!string.IsNullOrWhiteSpace(suggestion.TrackStrand))
                                                {
                                                    <div class="info-row">
                                                        <span class="info-label">üéØ Track/Strand:</span>
                                                        <span class="info-value">@suggestion.TrackStrand</span>
                                                    </div>
                                                }
                                                
                                                @if (!string.IsNullOrWhiteSpace(suggestion.AdviserName))
                                                {
                                                    <div class="info-row adviser-row">
                                                        <span class="info-label">üë®‚Äçüè´ Adviser:</span>
                                                        <span class="info-value adviser-value">@suggestion.AdviserName</span>
                                                    </div>
                                                }
                                                
                                                @if (!string.IsNullOrWhiteSpace(suggestion.SchoolName))
                                                {
                                                    <div class="info-row">
                                                        <span class="info-label">üè´ School:</span>
                                                        <span class="info-value">@suggestion.SchoolName</span>
                                                    </div>
                                                }
                                                
                                                @if (suggestion.Timestamp.HasValue)
                                                {
                                                    <div class="info-row timestamp-row">
                                                        <span class="info-label">üìÖ Last Updated:</span>
                                                        <span class="info-value timestamp-value">@suggestion.Timestamp.Value.ToString("MMM dd, yyyy")</span>
                                                    </div>
                                                }
                                            </div>
                                            
                                            <div class="card-footer">
                                                <button type="button" class="btn-select-record @(isSelected ? "btn-selected" : "btn-primary")" @onclick="@(() => ApplyStudentSuggestion(suggestion, clearSuggestions: false))">
                                                    @if (isSelected)
                                                    {
                                                        <span>‚úì Using This Record</span>
                                                    }
                                                    else
                                                    {
                                                        <span>Select This Record</span>
                                                    }
                                                </button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>

                    <div class="wizard-nav">
                        <NavLink href="/" class="btn btn-outline-modern">
                            <span class="btn-icon">‚úï</span> Cancel
                        </NavLink>
                        <button type="button" class="btn btn-primary-modern" @onclick="NextStep">
                            Next <span class="btn-icon">‚Üí</span>
                        </button>
                    </div>
                }
                else if (currentStep == 2)
                {
                    <div class="wizard-stepper-container">
                        <div class="wizard-stepper">
                            @for (var i = 1; i <= TotalSteps; i++)
                            {
                                var stepClass = i < currentStep ? "done" : i == currentStep ? "active" : string.Empty;
                                <div class="step-item @stepClass">
                                    <div class="step-circle">
                                        @if (i < currentStep)
                                        {
                                            <span>‚úì</span>
                                        }
                                        else
                                        {
                                            <span>@i</span>
                                        }
                                    </div>
                                    <span class="step-label">@stepLabels[i - 1]</span>
                                </div>
                                @if (i < TotalSteps)
                                {
                                    <div class="step-line @(i < currentStep ? "done" : string.Empty)"></div>
                                }
                            }
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="section-header-with-student">
                            <h3>‚ö†Ô∏è Offense Details</h3>
                        </div>
                        <p class="section-description offense-description">Provide comprehensive information about the violation</p>
                        
                        <div class="section-header-modern">
                            <div class="section-icon-wrapper">
                                <span class="section-icon-large">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                            </div>
                            <div>
                                <h3 class="section-title-modern">Parent/Guardian Information</h3>
                                <p class="section-subtitle">Please provide contact details of the student's parent or guardian</p>
                            </div>
                        </div>

                        <div class="contact-type-selector">
                            <label class="selector-label">
                                <span class="label-icon">üë§</span>
                                <span>Who will be the primary contact person?</span>
                                <span class="label-badge required">Required</span>
                            </label>
                            
                            @if (selectedStudents.Any())
                            {
                                <div class="current-student-indicator-inline">
                                    <h4 class="current-student-name">@selectedStudents[currentStudentIndex].StudentName</h4>
                                    <p class="current-student-info">
                                        @{
                                            var student = selectedStudents[currentStudentIndex];
                                            var gradeLevel = student.GradeLevel;
                                            var isGrade11or12 = gradeLevel == "Grade 11" || gradeLevel == "Grade 12";
                                            var trackStrand = student.TrackStrand;
                                            
                                            if (isGrade11or12 && !string.IsNullOrWhiteSpace(trackStrand))
                                            {
                                                <text>@gradeLevel @trackStrand - @student.Section</text>
                                            }
                                            else
                                            {
                                                <text>@gradeLevel - @student.Section</text>
                                            }
                                        }
                                    </p>
                                    <span class="student-counter">Student @(currentStudentIndex + 1) of @selectedStudents.Count</span>
                                </div>
                            }

                            @if (string.IsNullOrEmpty(contactPersonType))
                            {
                                <div class="contact-type-options">
                                    <div class="contact-option" @onclick='() => contactPersonType = "both"'>
                                        <div class="option-icon">üë®‚Äçüë©</div>
                                        <div class="option-content">
                                            <div class="option-title">Both Parents</div>
                                            <div class="option-desc">Father and Mother</div>
                                        </div>
                                    </div>

                                    <div class="contact-option" @onclick='() => contactPersonType = "father"'>
                                        <div class="option-icon">üë®</div>
                                        <div class="option-content">
                                            <div class="option-title">Father Only</div>
                                            <div class="option-desc">Father as contact</div>
                                        </div>
                                    </div>

                                    <div class="contact-option" @onclick='() => contactPersonType = "mother"'>
                                        <div class="option-icon">üë©</div>
                                        <div class="option-content">
                                            <div class="option-title">Mother Only</div>
                                            <div class="option-desc">Mother as contact</div>
                                        </div>
                                    </div>

                                    <div class="contact-option" @onclick='() => contactPersonType = "guardian"'>
                                        <div class="option-icon">üßë</div>
                                        <div class="option-content">
                                            <div class="option-title">Legal Guardian</div>
                                            <div class="option-desc">Guardian instead of parents</div>
                                        </div>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="selected-contact-type-display">
                                    <div class="selected-type-badge">
                                        @if (contactPersonType == "both")
                                        {
                                            <span class="badge-icon">üë®‚Äçüë©</span>
                                            <span class="badge-text">Both Parents Selected</span>
                                        }
                                        else if (contactPersonType == "father")
                                        {
                                            <span class="badge-icon">üë®</span>
                                            <span class="badge-text">Father</span>
                                        }
                                        else if (contactPersonType == "mother")
                                        {
                                            <span class="badge-icon">üë©</span>
                                            <span class="badge-text">Mother Only Selected</span>
                                        }
                                        else if (contactPersonType == "guardian")
                                        {
                                            <span class="badge-icon">üßë</span>
                                            <span class="badge-text">Legal Guardian Selected</span>
                                        }
                                    </div>
                                    <button type="button" class="btn-change-selection" @onclick='() => contactPersonType = ""'>
                                        <span class="btn-icon">üîÑ</span> Change Selection
                                    </button>
                                </div>
                            }
                        </div>

                        @if (contactPersonType == "both")
                        {
                            <div class="form-row-modern">
                            <div class="form-group-modern">
                                <label for="fathersName" class="label-modern">
                                    <span class="label-icon">üë®</span>
                                    <span>Father's Name</span>
                                    <span class="label-badge optional">Optional</span>
                                </label>
                                <InputText id="fathersName" class="form-control-modern text-uppercase" 
                                    placeholder="Last Name, First Name, MI." 
                                    @bind-Value="caseRecord.FathersName"
                                    @oninput="@((e) => caseRecord.FathersName = e.Value?.ToString()?.ToUpper())"
                                    readonly="@IsAutoGenerated("FathersName")"
                                    style="@(IsAutoGenerated("FathersName") ? "background-color: #f8f9fa; cursor: default; border-color: #dee2e6; color: #6c757d;" : "")" />
                                <small class="help-text">@(IsAutoGenerated("FathersName") ? "Auto-filled from records" : "Leave blank if not applicable")</small>
                                <ValidationMessage For="@(() => caseRecord.FathersName)" />
                            </div>

                            <div class="form-group-modern">
                                <label for="mothersName" class="label-modern">
                                    <span class="label-icon">üë©</span>
                                    <span>Mother's Name</span>
                                    <span class="label-badge optional">Optional</span>
                                </label>
                                <InputText id="mothersName" class="form-control-modern text-uppercase" 
                                    placeholder="Last Name, First Name, MI." 
                                    @bind-Value="caseRecord.MothersName"
                                    @oninput="@((e) => caseRecord.MothersName = e.Value?.ToString()?.ToUpper())"
                                    readonly="@IsAutoGenerated("MothersName")"
                                    style="@(IsAutoGenerated("MothersName") ? "background-color: #f8f9fa; cursor: default; border-color: #dee2e6; color: #6c757d;" : "")" />
                                <small class="help-text">@(IsAutoGenerated("MothersName") ? "Auto-filled from records" : "Leave blank if not applicable")</small>
                                <ValidationMessage For="@(() => caseRecord.MothersName)" />
                            </div>
                            </div>
                        }
                        else if (contactPersonType == "father")
                        {
                            <div class="form-group-modern">
                                <label for="fathersName" class="label-modern">
                                    <span class="label-icon">üë®</span>
                                    <span>Father's Name</span>
                                    <span class="label-badge required">Required</span>
                                </label>
                                <InputText id="fathersName" class="form-control-modern text-uppercase" 
                                    placeholder="Last Name, First Name, MI." 
                                    @bind-Value="caseRecord.FathersName"
                                    @oninput="@((e) => caseRecord.FathersName = e.Value?.ToString()?.ToUpper())"
                                    readonly="@IsAutoGenerated("FathersName")"
                                    style="@(IsAutoGenerated("FathersName") ? "background-color: #f8f9fa; cursor: default; border-color: #dee2e6; color: #6c757d;" : "")" />
                                <small class="help-text text-muted" style="font-size: 0.8rem; margin-top: 4px; display: block;">@(IsAutoGenerated("FathersName") ? "‚úì Auto-filled from student records" : "")</small>
                                <ValidationMessage For="@(() => caseRecord.FathersName)" />
                            </div>
                        }
                        else if (contactPersonType == "mother")
                        {
                            <div class="form-group-modern">
                                <label for="mothersName" class="label-modern">
                                    <span class="label-icon">üë©</span>
                                    <span>Mother's Name</span>
                                    <span class="label-badge required">Required</span>
                                </label>
                                <InputText id="mothersName" class="form-control-modern text-uppercase" 
                                    placeholder="Last Name, First Name, MI." 
                                    @bind-Value="caseRecord.MothersName"
                                    @oninput="@((e) => caseRecord.MothersName = e.Value?.ToString()?.ToUpper())"
                                    readonly="@IsAutoGenerated("MothersName")"
                                    style="@(IsAutoGenerated("MothersName") ? "background-color: #f8f9fa; cursor: default; border-color: #dee2e6; color: #6c757d;" : "")" />
                                <small class="help-text text-muted" style="font-size: 0.8rem; margin-top: 4px; display: block;">@(IsAutoGenerated("MothersName") ? "‚úì Auto-filled from student records" : "")</small>
                                <ValidationMessage For="@(() => caseRecord.MothersName)" />
                            </div>
                        }
                        else if (contactPersonType == "guardian")
                        {
                            <div class="form-group-modern">
                                <label for="guardianName" class="label-modern">
                                    <span class="label-icon">üßë</span>
                                    <span>Guardian's Name</span>
                                    <span class="label-badge required">Required</span>
                                </label>
                                <InputText id="guardianName" class="form-control-modern text-uppercase" 
                                    placeholder="Last Name, First Name, MI." 
                                    @bind-Value="caseRecord.GuardianName"
                                    @oninput="@((e) => caseRecord.GuardianName = e.Value?.ToString()?.ToUpper())"
                                    readonly="@IsAutoGenerated("GuardianName")"
                                    style="@(IsAutoGenerated("GuardianName") ? "background-color: #f8f9fa; cursor: default; border-color: #dee2e6; color: #6c757d;" : "")" />
                                <small class="help-text text-muted" style="font-size: 0.8rem; margin-top: 4px; display: block;">@(IsAutoGenerated("GuardianName") ? "‚úì Auto-filled from student records" : "")</small>
                                <ValidationMessage For="@(() => caseRecord.GuardianName)" />
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(contactPersonType))
                        {
                            <div class="form-group-modern contact-group">
                            <label for="parentGuardianContact" class="label-modern">
                                <span class="label-icon">üì±</span>
                                <span>Contact Number</span>
                                <span class="label-badge required">Required</span>
                            </label>
                            <div class="input-with-prefix">
                                <span class="input-prefix">üáµüá≠ 09</span>
                                <InputText id="parentGuardianContact" type="tel" class="form-control-modern with-prefix" 
                                    placeholder="XXXXXXXXX (9 digits)" 
                                    @bind-Value="caseRecord.ParentGuardianContact" 
                                    maxlength="11" @oninput="FormatPhoneNumber"
                                    readonly="@IsAutoGenerated("ParentGuardianContact")"
                                    style="@(IsAutoGenerated("ParentGuardianContact") ? "background-color: #f8f9fa; cursor: default; border-color: #dee2e6; color: #6c757d;" : "")" />
                            </div>
                            @if (string.IsNullOrEmpty(caseRecord.ParentGuardianContact))
                            {
                                <small class="help-text">
                                    <span class="format-example">Format: 09XXXXXXXXX</span>
                                </small>
                            }
                            else if (!IsValidPhilippinePhoneNumber(caseRecord.ParentGuardianContact))
                            {
                                <small class="validation-error">
                                    <span class="error-icon">‚ö†Ô∏è</span>
                                    Please enter a valid Philippine mobile number (09XXXXXXXXX)
                                </small>
                            }
                            else
                            {
                                <small class="validation-success">
                                    <span class="success-icon">‚úÖ</span>
                                    Valid Philippine mobile number
                                </small>
                            }
                            <ValidationMessage For="@(() => caseRecord.ParentGuardianContact)" />
                            </div>
                        }
                    </div>

                    <div class="wizard-nav">
                        <button type="button" class="btn btn-outline-modern" @onclick="PreviousStep">
                            <span class="btn-icon">‚Üê</span> Back
                        </button>
                        <button type="button" class="btn btn-primary-modern" @onclick="NextStep">
                            Next <span class="btn-icon">‚Üí</span>
                        </button>
                    </div>
                }
                else if (currentStep == 3)
                {
                    <div class="wizard-stepper-container">
                        <div class="wizard-stepper">
                            @for (var i = 1; i <= TotalSteps; i++)
                            {
                                var stepClass = i < currentStep ? "done" : i == currentStep ? "active" : string.Empty;
                                <div class="step-item @stepClass">
                                    <div class="step-circle">
                                        @if (i < currentStep)
                                        {
                                            <span>‚úì</span>
                                        }
                                        else
                                        {
                                            <span>@i</span>
                                        }
                                    </div>
                                    <span class="step-label">@stepLabels[i - 1]</span>
                                </div>
                                @if (i < TotalSteps)
                                {
                                    <div class="step-line @(i < currentStep ? "done" : string.Empty)"></div>
                                }
                            }
                        </div>
                    </div>
                    
                    <div class="wizard-stepper-container">
                        <div class="step-item active" style="flex-direction: row; gap: 15px; min-width: auto;">
                            <div class="step-circle" style="width: 50px; height: 50px; font-size: 24px;">
                                <span>4</span>
                            </div>
                            <span class="step-label" style="margin-top: 0; text-transform: uppercase; font-size: 20px; font-weight: 700;">CLASSIFICATION PHASE</span>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>üìã Violation Information</h3>
                        @if (selectedStudents.Any())
                        {
                            <div class="current-student-indicator-inline">
                                <h4 class="current-student-name">@selectedStudents[currentStudentIndex].StudentName</h4>
                                <p class="current-student-info">
                                    @{
                                        var student = selectedStudents[currentStudentIndex];
                                        var gradeLevel = student.GradeLevel;
                                        var isGrade11or12 = gradeLevel == "Grade 11" || gradeLevel == "Grade 12";
                                        var trackStrand = student.TrackStrand;
                                        
                                        if (isGrade11or12 && !string.IsNullOrWhiteSpace(trackStrand))
                                        {
                                            <text>@gradeLevel @trackStrand - @student.Section</text>
                                        }
                                        else
                                        {
                                            <text>@gradeLevel - @student.Section</text>
                                        }
                                    }
                                </p>
                                <span class="student-counter">Student @(currentStudentIndex + 1) of @selectedStudents.Count</span>
                            </div>
                        }
                        
                        <div class="form-row-single-line">
                            <div class="form-group">
                                <label for="dateOfOffense" class="form-label-with-icon">
                                    <span class="label-icon-inline">üìÖ</span>
                                    <span>Date of Offense *</span>
                                </label>
                                <InputDate id="dateOfOffense" class="form-control-modern" @bind-Value="caseRecord.DateOfOffense" />
                                <ValidationMessage For="@(() => caseRecord.DateOfOffense)" />
                            </div>

                            <div class="form-group">
                                <label for="violationCommitted" class="form-label-with-icon">
                                    <span class="label-icon-inline">‚ö†Ô∏è</span>
                                    <span>Violation Committed *</span>
                                </label>
                                <InputSelect id="violationCommitted" class="form-control-modern" @bind-Value="caseRecord.ViolationCommitted" @onchange="OnViolationCommittedChanged" disabled>
                                    <option value="">Select Violation</option>
                                    @if (violationTypes.Any())
                                    {
                                        @foreach (var violation in violationTypes)
                                        {
                                            <option value="@violation" selected="@(caseRecord.ViolationCommitted == violation)">@violation</option>
                                        }
                                    }
                                    else
                                    {
                                        <option value="" disabled>Loading violations...</option>
                                    }
                                </InputSelect>
                                <ValidationMessage For="@(() => caseRecord.ViolationCommitted)" />
                            </div>

                            <div class="form-group">
                                <label for="levelOfOffense" class="form-label-with-icon">
                                    <span class="label-icon-inline">üìä</span>
                                    <span>Level of Offense *</span>
                                </label>
                                <input type="text" id="levelOfOffense" class="form-control-modern" 
                                    value="@caseRecord.LevelOfOffense" 
                                    readonly 
                                    style="background-color: #e9ecef; cursor: default;"
                                    placeholder="@(string.IsNullOrEmpty(caseRecord.LevelOfOffense) ? "Auto-filled" : "")" />
                                <small class="form-help-text">Auto-filled</small>
                                <ValidationMessage For="@(() => caseRecord.LevelOfOffense)" />
                            </div>

                            <div class="form-group">
                                <label for="numberOfOffense" class="form-label-with-icon">
                                    <span class="label-icon-inline">üî¢</span>
                                    <span>Offense Count *</span>
                                </label>
                                <input type="text" id="numberOfOffense" class="form-control-modern" 
                                    value="@caseRecord.NumberOfOffense" 
                                    readonly 
                                    style="background-color: #e9ecef; cursor: default;"
                                    placeholder="@(string.IsNullOrEmpty(caseRecord.NumberOfOffense) ? "Auto-filled" : "")" />
                                <small class="form-help-text">Auto-filled based on student's violation history</small>
                                <ValidationMessage For="@(() => caseRecord.NumberOfOffense)" />
                            </div>
                        </div>

                        @if (caseRecord.ViolationCommitted == "Other")
                        {
                            <div class="form-group">
                                <label for="otherViolationDescription">Other Violation/ Description of the Violation, If necessary. (put N/A if not applicable) *</label>
                                <InputTextArea id="otherViolationDescription" class="form-control" rows="3" 
                                    placeholder="Describe the specific violation committed" 
                                    @bind-Value="caseRecord.OtherViolationDescription" />
                                <ValidationMessage For="@(() => caseRecord.OtherViolationDescription)" />
                            </div>
                        }
                    </div>

                    <div class="wizard-nav">
                        <button type="button" class="btn btn-outline-modern" @onclick="PreviousStep">
                            <span class="btn-icon">‚Üê</span> Back
                        </button>
                        <button type="button" class="btn btn-primary-modern" @onclick="NextStep">
                            Next <span class="btn-icon">‚Üí</span>
                        </button>
                    </div>
                }
                else if (currentStep == 4)
                {
                    <div class="wizard-stepper-container">
                        <div class="wizard-stepper">
                            @for (var i = 1; i <= TotalSteps; i++)
                            {
                                var stepClass = i < currentStep ? "done" : i == currentStep ? "active" : string.Empty;
                                <div class="step-item @stepClass">
                                    <div class="step-circle">
                                        @if (i < currentStep)
                                        {
                                            <span>‚úì</span>
                                        }
                                        else
                                        {
                                            <span>@i</span>
                                        }
                                    </div>
                                    <span class="step-label">@stepLabels[i - 1]</span>
                                </div>
                                @if (i < TotalSteps)
                                {
                                    <div class="step-line @(i < currentStep ? "done" : string.Empty)"></div>
                                }
                            }
                        </div>
                    </div>

                    <div class="form-section" style="padding-top: 30px;">
                        
                        <!-- Main Section Header -->
                        <div class="section-header-big">
                            <h2>üìã AGREEMENT</h2>
                        </div>
                        
                        <!-- Student Info Below Header -->
                        @if (selectedStudents.Any())
                        {
                            <div class="student-info-below-header">
                                <div class="student-name-large">@selectedStudents[currentStudentIndex].StudentName</div>
                                <div class="student-details">
                                    @{
                                        var student = selectedStudents[currentStudentIndex];
                                        var gradeLevel = student.GradeLevel;
                                        var isGrade11or12 = gradeLevel == "Grade 11" || gradeLevel == "Grade 12";
                                        var trackStrand = student.TrackStrand;
                                        
                                        if (isGrade11or12 && !string.IsNullOrWhiteSpace(trackStrand))
                                        {
                                            <text>@gradeLevel @trackStrand - @student.Section</text>
                                        }
                                        else
                                        {
                                            <text>@gradeLevel - @student.Section</text>
                                        }
                                    }
                                </div>
                                <div class="student-counter-small">Student @(currentStudentIndex + 1) of @selectedStudents.Count</div>
                            </div>
                        }

                        <!-- N/A Checkbox -->
                        <div class="form-group" style="margin-bottom: 20px;">
                            <div class="checkbox-container" style="display: flex; align-items: center; gap: 10px; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 2px solid #dee2e6;">
                                <input type="checkbox" id="agreementNA" @bind="isAgreementNA" 
                                       style="width: 20px; height: 20px; cursor: pointer;" />
                                <label for="agreementNA" style="margin: 0; cursor: pointer; font-weight: 500; font-size: 16px;">
                                    ‚òëÔ∏è Not Applicable (N/A) - No agreement was reached
                                </label>
                            </div>
                        </div>
                        
                        <!-- Agreement Details Section (Collapsible style) -->
                        @if (!isAgreementNA)
                        {
                            <div class="agreement-section" style="border: 2px solid #007bff; border-radius: 10px; padding: 20px; background: #fff; margin-bottom: 20px;">
                                <div class="form-group">
                                    <label for="detailsOfAgreement" style="font-weight: 600; font-size: 16px; color: #007bff;">
                                        üìù Details of the Agreement *
                                    </label>
                                    <InputTextArea id="detailsOfAgreement" class="form-control" rows="6" 
                                        placeholder="Describe the agreement reached between school, student, and parent/guardian&#10;&#10;Include:&#10;‚Ä¢ Disciplinary measures&#10;‚Ä¢ Counseling requirements&#10;‚Ä¢ Behavioral expectations&#10;‚Ä¢ Other agreements or commitments" 
                                        @bind-Value="caseRecord.DetailsOfAgreement" 
                                        style="border: 2px solid #ced4da; border-radius: 8px; font-size: 15px;" />
                                    <ValidationMessage For="@(() => caseRecord.DetailsOfAgreement)" />
                                    <small class="text-muted" style="display: block; margin-top: 8px;">
                                        üí° Provide clear and detailed information about what was agreed upon
                                    </small>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="na-indicator" style="padding: 20px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; margin-bottom: 20px;">
                                <p style="margin: 0; color: #856404; font-weight: 500;">
                                    ‚ÑπÔ∏è Agreement marked as Not Applicable. The system will automatically record "N/A" for this section.
                                </p>
                            </div>
                        }

                        <div class="form-group">
                            <label for="podInCharge" style="font-weight: 600;">üë§ POD In-Charge</label>
                            <InputText id="podInCharge" class="form-control" 
                                placeholder="Auto-filled from current user" 
                                @bind-Value="caseRecord.PODInCharge" readonly 
                                style="background: #e9ecef; border: 2px solid #ced4da; border-radius: 8px;" />
                            <small class="text-muted">Person of Designation in charge of the case</small>
                        </div>
                    </div>

                    <div class="wizard-nav">
                        <button type="button" class="btn btn-outline-modern" @onclick="PreviousStep">
                            <span class="btn-icon">‚Üê</span> Back
                        </button>
                        <button type="button" class="btn btn-primary-modern" @onclick="NextStep">
                            Next <span class="btn-icon">‚Üí</span>
                        </button>
                    </div>
                }
                else if (currentStep == 5)
                {
                    <div class="wizard-stepper-container">
                        <div class="wizard-stepper">
                            @for (var i = 1; i <= TotalSteps; i++)
                            {
                                var stepClass = i < currentStep ? "done" : i == currentStep ? "active" : string.Empty;
                                <div class="step-item @stepClass">
                                    <div class="step-circle">
                                        @if (i < currentStep)
                                        {
                                            <span>‚úì</span>
                                        }
                                        else
                                        {
                                            <span>@i</span>
                                        }
                                    </div>
                                    <span class="step-label">@stepLabels[i - 1]</span>
                                </div>
                                @if (i < TotalSteps)
                                {
                                    <div class="step-line @(i < currentStep ? "done" : string.Empty)"></div>
                                }
                            }
                        </div>
                    </div>

                    <div class="form-section" style="padding-top: 30px;">
                        
                        <!-- Main Section Header -->
                        <div class="section-header-big">
                            <h2>üì∏ PHOTO & SIGNATURE</h2>
                        </div>
                        
                        <!-- Student Info Below Header -->
                        @if (selectedStudents.Any())
                        {
                            <div class="student-info-below-header">
                                <div class="student-name-large">@selectedStudents[currentStudentIndex].StudentName</div>
                                <div class="student-details">
                                    @{
                                        var student = selectedStudents[currentStudentIndex];
                                        var gradeLevel = student.GradeLevel;
                                        var isGrade11or12 = gradeLevel == "Grade 11" || gradeLevel == "Grade 12";
                                        var trackStrand = student.TrackStrand;
                                        
                                        if (isGrade11or12 && !string.IsNullOrWhiteSpace(trackStrand))
                                        {
                                            <text>@gradeLevel @trackStrand - @student.Section</text>
                                        }
                                        else
                                        {
                                            <text>@gradeLevel - @student.Section</text>
                                        }
                                    }
                                </div>
                                <div class="student-counter-small">Student @(currentStudentIndex + 1) of @selectedStudents.Count</div>
                            </div>
                        }

                        <!-- Progress Indicators -->
                        <div class="progress-indicators" style="display: flex; gap: 20px; margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                            <div class="progress-item" style="flex: 1; text-align: center;">
                                <div class="progress-icon" style="font-size: 48px; margin-bottom: 10px;">
                                    @if (!string.IsNullOrEmpty(capturedPhotoBase64))
                                    {
                                        <span style="color: #28a745;">‚úÖ</span>
                                    }
                                    else
                                    {
                                        <span style="color: #6c757d;">üì∑</span>
                                    }
                                </div>
                                <div class="progress-label" style="font-weight: 600; margin-bottom: 5px;">Photo</div>
                                <div class="progress-status" style="color: @(string.IsNullOrEmpty(capturedPhotoBase64) ? "#6c757d" : "#28a745"); font-size: 14px;">
                                    @(string.IsNullOrEmpty(capturedPhotoBase64) ? "Not Captured" : "Captured")
                                </div>
                            </div>
                            <div class="progress-item" style="flex: 1; text-align: center;">
                                <div class="progress-icon" style="font-size: 48px; margin-bottom: 10px;">
                                    @if (!string.IsNullOrEmpty(signatureBase64))
                                    {
                                        <span style="color: #28a745;">‚úÖ</span>
                                    }
                                    else
                                    {
                                        <span style="color: #6c757d;">‚úçÔ∏è</span>
                                    }
                                </div>
                                <div class="progress-label" style="font-weight: 600; margin-bottom: 5px;">Signature</div>
                                <div class="progress-status" style="color: @(string.IsNullOrEmpty(signatureBase64) ? "#6c757d" : "#28a745"); font-size: 14px;">
                                    @(string.IsNullOrEmpty(signatureBase64) ? "Not Signed" : "Signed")
                                </div>
                            </div>
                        </div>

                    <!-- Evidence and Documentation Controls -->
                    <div class="evidence-controls-section">
                        <div class="form-group" style="border: 2px solid #007bff; border-radius: 10px; padding: 20px; margin-bottom: 30px; background: #fff;">
                            <label style="font-weight: 600; font-size: 18px; color: #007bff; margin-bottom: 15px; display: block;">
                                üì∑ Student Photo (Optional)
                            </label>
                            <div class="photo-capture-container">
                                <div class="photo-controls" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                                    <button type="button" class="btn btn-outline" @onclick="StartCamera" disabled="@isLoading"
                                            style="flex: 1; min-width: 150px; padding: 12px; font-weight: 600;">
                                        üì∑ Start Camera
                                    </button>
                                    <button type="button" class="btn btn-outline" @onclick="CapturePhoto" disabled="@(!isCameraActive || isLoading)"
                                            style="flex: 1; min-width: 150px; padding: 12px; font-weight: 600;">
                                        üì∏ Capture Photo
                                    </button>
                                    <button type="button" class="btn btn-secondary" @onclick="StopCamera" disabled="@(!isCameraActive)"
                                            style="flex: 1; min-width: 150px; padding: 12px; font-weight: 600;">
                                        ‚èπÔ∏è Stop Camera
                                    </button>
                                    <button type="button" class="btn btn-danger" @onclick="ClearPhoto" disabled="@(string.IsNullOrEmpty(capturedPhotoBase64))"
                                            style="flex: 1; min-width: 150px; padding: 12px; font-weight: 600;">
                                        üóëÔ∏è Clear Photo
                                    </button>
                                </div>
                                
                                @if (isCameraActive)
                                {
                                    <div class="camera-container" style="text-align: center; margin: 20px 0;">
                                        <video id="cameraVideo" autoplay playsinline style="width: 100%; max-width: 500px; height: auto; border: 3px solid #007bff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></video>
                                    </div>
                                }
                                
                                @if (!string.IsNullOrEmpty(capturedPhotoBase64))
                                {
                                    <div class="captured-photo-container" style="text-align: center; margin: 20px 0;">
                                        <img src="data:image/jpeg;base64,@capturedPhotoBase64" alt="Captured Photo" style="max-width: 500px; height: auto; border: 3px solid #28a745; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" />
                                        <p class="text-success" style="margin-top: 10px; font-weight: 600; font-size: 16px;">‚úÖ Photo captured successfully!</p>
                                    </div>
                                }
                            </div>
                            <small class="text-muted" style="display: block; margin-top: 10px;">
                                üìå Use camera to capture photo of the reported student (optional but recommended)
                            </small>
                        </div>

                        <div class="form-group" style="border: 2px solid #6f42c1; border-radius: 10px; padding: 20px; background: #fff;">
                            <label style="font-weight: 600; font-size: 18px; color: #6f42c1; margin-bottom: 15px; display: block;">
                                ‚úçÔ∏è Student Signature (Optional)
                            </label>
                            <div class="signature-container">
                                <div class="signature-controls" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                                    <button type="button" class="btn btn-outline" @onclick="InitializeSignaturePad"
                                            style="flex: 1; min-width: 150px; padding: 12px; font-weight: 600;">
                                        üîß Initialize Pad
                                    </button>
                                    <button type="button" class="btn btn-outline" @onclick="SaveSignature"
                                            style="flex: 1; min-width: 150px; padding: 12px; font-weight: 600;">
                                        üíæ Save Signature
                                    </button>
                                    <button type="button" class="btn btn-outline" @onclick="ClearSignature"
                                            style="flex: 1; min-width: 150px; padding: 12px; font-weight: 600;">
                                        üóëÔ∏è Clear Signature
                                    </button>
                                </div>
                                
                                <div class="signature-pad" style="text-align: center;">
                                    <canvas id="signatureCanvas" 
                                            width="500" 
                                            height="200"
                                            style="border: 3px solid #6f42c1; border-radius: 12px; cursor: crosshair; width: 100%; max-width: 500px; height: 200px; background: white; touch-action: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    </canvas>
                                    <div class="signature-instructions" style="margin-top: 10px;">
                                        <small class="text-muted" style="font-weight: 500;">
                                            üí° <strong>Draw the student's signature using:</strong><br/>
                                            üñ±Ô∏è Mouse ‚Ä¢ üëÜ Touch screen ‚Ä¢ ‚úçÔ∏è Stylus/LCD Signature Pad
                                        </small>
                                        <small class="text-muted" style="display: block; margin-top: 8px; font-style: italic;">
                                            üìå Supports Wacom, Topaz, and other USB/Bluetooth signature pads
                                        </small>
                                    </div>
                                </div>
                                
                                @if (!string.IsNullOrEmpty(signatureBase64))
                                {
                                    <div class="signature-preview" style="text-align: center; margin-top: 20px;">
                                        <img src="data:image/png;base64,@signatureBase64" alt="Signature" style="max-width: 400px; height: auto; border: 3px solid #28a745; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" />
                                        <p class="text-success" style="margin-top: 10px; font-weight: 600; font-size: 16px;">‚úÖ Signature saved!</p>
                                    </div>
                                }
                            </div>
                            <small class="text-muted" style="display: block; margin-top: 10px;">
                                üìå The system automatically detects your input method (mouse, touch, or signature pad) and provides the best drawing experience
                            </small>
                        </div>
                    </div>
                    </div>

                    <!-- Info message about review -->
                    <div class="review-section" style="margin-top: 30px;">
                        <div class="review-info-box" style="padding: 20px; background: #d1ecf1; border: 2px solid #0c5460; border-radius: 10px;">
                            <p class="review-info-text" style="margin: 0; color: #0c5460; font-weight: 600; text-align: center;">
                                üìã Click "Submit Case Record" below to review all information before final submission
                            </p>
                        </div>
                    </div>

                    <div class="wizard-nav">
                        <button type="button" class="btn btn-outline-modern" @onclick="PreviousStep">
                            <span class="btn-icon">‚Üê</span> Back
                        </button>
                        
                        @if (selectedStudents.Any() && currentStudentIndex < selectedStudents.Count - 1)
                        {
                            <!-- More students to process - show Next button -->
                            <button type="button" class="btn btn-primary-modern" @onclick="NextStep">
                                Next Student (@(currentStudentIndex + 2) of @selectedStudents.Count) <span class="btn-icon">‚Üí</span>
                            </button>
                        }
                        else
                        {
                            <!-- Last student - show Submit button -->
                            <button type="submit" class="btn btn-primary-modern" disabled="@isLoading">
                                @(isLoading ? "Creating Records..." : selectedStudents.Count > 1 ? $"‚úì Submit All {selectedStudents.Count} Records" : "‚úì Submit Case Record")
                            </button>
                        }
                    </div>
                }
            </EditForm>
        </div>
    </div>

    <!-- Review Modal -->
    @if (showReviewModal)
    {
        <div class="modal-overlay" @onclick="CloseReviewModal">
            <div class="modal-content-large" @onclick:stopPropagation="true">
                <div class="modal-header-modern">
                    <h2>Review All Case Records</h2>
                    <button type="button" class="modal-close-btn" @onclick="CloseReviewModal">√ó</button>
                </div>
                
                <div class="modal-body-scrollable">
                    <div class="review-summary-header">
                        <p class="review-count">Total Students: <strong>@selectedStudents.Count</strong></p>
                        <p class="review-instruction">Please review all information carefully before submitting</p>
                    </div>

                    @{
                        var student = selectedStudents[currentReviewIndex];
                        var index = currentReviewIndex;
                        var record = studentCaseRecords.ContainsKey(index) ? studentCaseRecords[index] : null;
                    }
                        
                        <div class="student-review-card">
                            <div class="student-review-header">
                                <div class="student-badge">Student @(index + 1) of @selectedStudents.Count</div>
                                <h3 class="student-review-name">@student.StudentName</h3>
                                <p class="student-review-details">
                                    @{
                                        var gradeLevel = student.GradeLevel;
                                        var isGrade11or12 = gradeLevel == "Grade 11" || gradeLevel == "Grade 12";
                                        var trackStrand = student.TrackStrand;
                                        
                                        if (isGrade11or12 && !string.IsNullOrWhiteSpace(trackStrand))
                                        {
                                            <text>@gradeLevel @trackStrand - @student.Section</text>
                                        }
                                        else
                                        {
                                            <text>@gradeLevel - @student.Section</text>
                                        }
                                    }
                                </p>
                            </div>

                            @if (record != null)
                            {
                                <div class="review-details-grid">
                                    <div class="review-detail-item">
                                        <span class="detail-label">Adviser</span>
                                        <span class="detail-value">@record.AdviserName</span>
                                    </div>
                                    
                                    <div class="review-detail-item">
                                        <span class="detail-label">Parent/Guardian Contact</span>
                                        <span class="detail-value">@record.ParentGuardianContact</span>
                                    </div>

                                    @if (!string.IsNullOrEmpty(record.FathersName))
                                    {
                                        <div class="review-detail-item">
                                            <span class="detail-label">Father's Name</span>
                                            <span class="detail-value">@record.FathersName</span>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(record.MothersName))
                                    {
                                        <div class="review-detail-item">
                                            <span class="detail-label">Mother's Name</span>
                                            <span class="detail-value">@record.MothersName</span>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(record.GuardianName))
                                    {
                                        <div class="review-detail-item">
                                            <span class="detail-label">Guardian's Name</span>
                                            <span class="detail-value">@record.GuardianName</span>
                                        </div>
                                    }
                                    
                                    <div class="review-detail-item wide">
                                        <span class="detail-label">Violation Committed</span>
                                        <span class="detail-value">@record.ViolationCommitted</span>
                                    </div>
                                    
                                    <div class="review-detail-item">
                                        <span class="detail-label">Level of Offense</span>
                                        <span class="detail-value badge-level">@record.LevelOfOffense</span>
                                    </div>
                                    
                                    <div class="review-detail-item">
                                        <span class="detail-label">Offense Count</span>
                                        <span class="detail-value badge-count">@record.NumberOfOffense</span>
                                    </div>
                                    
                                    <div class="review-detail-item">
                                        <span class="detail-label">Date of Offense</span>
                                        <span class="detail-value">@record.DateOfOffense.ToString("MMMM dd, yyyy")</span>
                                    </div>
                                    
                                    <div class="review-detail-item">
                                        <span class="detail-label">Date Created</span>
                                        <span class="detail-value">@record.DateCreated.ToString("MMMM dd, yyyy")</span>
                                    </div>
                                    
                                    <div class="review-detail-item wide">
                                        <span class="detail-label">Agreement Details</span>
                                        <span class="detail-value description">@record.DetailsOfAgreement</span>
                                    </div>
                                    
                                    <div class="review-detail-item">
                                        <span class="detail-label">POD In-Charge</span>
                                        <span class="detail-value">@record.PODInCharge</span>
                                    </div>

                                    @if (studentPhotos.ContainsKey(index) && !string.IsNullOrEmpty(studentPhotos[index]) || 
                                         studentSignatures.ContainsKey(index) && !string.IsNullOrEmpty(studentSignatures[index]))
                                    {
                                        <div class="review-detail-item wide">
                                            <div class="photo-signature-container">
                                                @if (studentPhotos.ContainsKey(index) && !string.IsNullOrEmpty(studentPhotos[index]))
                                                {
                                                    <div class="photo-section">
                                                        <span class="detail-label">Student Photo</span>
                                                        <div class="student-photo-preview">
                                                            <img src="data:image/jpeg;base64,@studentPhotos[index]" alt="Student Photo" />
                                                        </div>
                                                    </div>
                                                }

                                                @if (studentSignatures.ContainsKey(index) && !string.IsNullOrEmpty(studentSignatures[index]))
                                                {
                                                    <div class="signature-section">
                                                        <span class="detail-label">Digital Signature</span>
                                                        <div class="signature-preview">
                                                            <img src="data:image/png;base64,@studentSignatures[index]" alt="Signature" />
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <p class="no-data">No case record data available for this student.</p>
                            }
                        </div>
                </div>

                <div class="modal-footer-modern" style="justify-content: space-between; align-items: center;">
                    <div class="review-navigation-left">
                        @if (currentReviewIndex > 0)
                        {
                            <button type="button" class="btn btn-outline-modern" @onclick="PreviousReviewStudent">
                                <span class="btn-icon">‚Üê</span> Previous
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-outline-modern" @onclick="CloseReviewModal">
                                Cancel
                            </button>
                        }
                    </div>

                    <div class="review-counter" style="font-weight: 600; color: #495057;">
                        Student @(currentReviewIndex + 1) of @selectedStudents.Count
                    </div>

                    <div class="review-navigation-right">
                        @if (currentReviewIndex < selectedStudents.Count - 1)
                        {
                            <button type="button" class="btn btn-primary-modern" @onclick="NextReviewStudent">
                                Next <span class="btn-icon">‚Üí</span>
                            </button>
                        }
                        else
                        {
                            <button type="button" class="btn btn-submit-modern" @onclick="ConfirmAndSubmit" disabled="@isLoading">
                                @(isLoading ? "Submitting..." : "‚úì Confirm & Submit All")
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
}
else
{
    <div class="login-required-container">
        <div class="login-required-card">
            <div class="login-required-header">
                <h2>üîí Login Required</h2>
                <p>You need to be logged in to access the student profile and case records form.</p>
                <p class="filipino-text">Kailangan mong mag-login upang ma-access ang student profile at case records form.</p>
            </div>
            
            <div class="login-required-actions">
                <a href="/login/teacher" class="btn btn-primary">Teacher Login</a>
                <a href="/login/student" class="btn btn-outline">Student Login</a>
                <a href="/" class="btn btn-secondary">Back to Home</a>
            </div>
        </div>
    </div>
}

@code {
    private StudentProfileCaseRecordModel caseRecord = new();
    private bool isLoading = false;
    private bool isSuccess = false;
    private string message = string.Empty;
    private string formKey = Guid.NewGuid().ToString();
    private bool isAuthenticated = false;
    private EditContext editContext = default!;
    private readonly string[] stepLabels = new[] { "Student Information", "Offense Details", "Resolution & Action", "Agreement", "Photo & Signature" };
    private int currentStep = 1;
    private int TotalSteps => stepLabels.Length;
    private int? incidentIdFromQuery = null;
    private int? escalationIdFromQuery = null;
    private readonly JsonSerializerOptions studentInfoJsonOptions = new() { PropertyNameCaseInsensitive = true };
    private List<StudentInfoSuggestion> studentInfoSuggestions = new();
    private StudentInfoSuggestion? selectedStudentSuggestion = null;
    
    // Multi-student support
    private List<StudentInfoSuggestion> selectedStudents = new();
    private int currentStudentIndex = 0;
    private Dictionary<int, StudentProfileCaseRecordModel> studentCaseRecords = new();
    
    // Per-student evidence storage
    private Dictionary<int, string> studentPhotos = new();
    private Dictionary<int, string> studentSignatures = new();
    
    // Incident report data (shared across all students)
    private string? incidentViolationType = null;
    private string? incidentOtherViolation = null;
    private DateTime? incidentDateOfOffense = null;
    
    // Teacher search functionality
    private List<TeacherSearchResult> teacherSuggestions = new();
    private bool showTeacherSuggestions = false;
    private string lastSearchTerm = string.Empty;
    
    // POD user location information for filtering teachers
    private string? podSchoolName = null;
    private string? podDivision = null;
    private string? podRegion = null;
    private string? podDistrict = null;
    private string currentUsername = string.Empty;
    
    // Violation types
    private List<string> violationTypes = new();
    
    // Contact person type selection
    private string contactPersonType = "";
    
    // Computed property for Track/Strand requirement
    private bool IsTrackStrandRequired => caseRecord.GradeLevel == "Grade 11" || caseRecord.GradeLevel == "Grade 12";
    
    // Review Modal
    private bool showReviewModal = false;
    
    // Agreement N/A checkbox
    private bool isAgreementNA = false;
    
    private int currentReviewIndex = 0;

    private void OpenReviewModal()
    {
        currentReviewIndex = 0;
        showReviewModal = true;
    }

    private void NextReviewStudent()
    {
        if (currentReviewIndex < selectedStudents.Count - 1)
        {
            currentReviewIndex++;
        }
    }

    private void PreviousReviewStudent()
    {
        if (currentReviewIndex > 0)
        {
            currentReviewIndex--;
        }
    }
    
    private void CloseReviewModal()
    {
        showReviewModal = false;
    }
    
    // New submit flow: show modal first, then submit
    private async Task HandleValidSubmit()
    {
        // Save current student's data before showing modal
        SaveCurrentStudentCaseRecord();
        SaveCurrentStudentEvidence();
        
        // Open the review modal instead of submitting directly
        OpenReviewModal();
    }
    
    private async Task ConfirmAndSubmit()
    {
        // Close modal and proceed with actual submission
        CloseReviewModal();
        
        // Call the original HandleSubmit method
        await HandleSubmit();
    }
    
    // Webcam functionality
    private bool isCameraActive = false;
    private string capturedPhotoBase64 = string.Empty;
    private string streamId = string.Empty;
    
    // Signature functionality
    private string signatureBase64 = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        InitializeEditContext();
        await CheckAuthentication();
        if (isAuthenticated)
        {
            await LoadCurrentUserInfo();
            await LoadPODUserLocation();
            await LoadViolationTypes();
            
            // Parse query parameters manually
            var uri = new Uri(NavigationManager.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            
            var sName = query["studentName"];
            var sGrade = query["gradeLevel"];
            var sSection = query["section"];
            var sSchool = query["schoolName"];
            var sDetails = query["caseDetails"];
            
            // If student info is present in query string, auto-populate
            if (!string.IsNullOrEmpty(sName))
            {
                bool studentFound = false;
                
                // Try to fetch full student information to get parent/guardian data
                try 
                {
                    var fetchUrl = $"api/StudentProfileCaseRecord/student-adviser/{Uri.EscapeDataString(sName)}";
                    if (!string.IsNullOrEmpty(sSchool)) fetchUrl += $"?schoolName={Uri.EscapeDataString(sSchool)}";
                    
                    var studentResponse = await Http.GetAsync(fetchUrl);
                    if (studentResponse.IsSuccessStatusCode)
                    {
                        var studentContent = await studentResponse.Content.ReadAsStringAsync();
                        var studentResult = JsonSerializer.Deserialize<JsonElement>(studentContent);
                        
                        if (TryGetPropertyCaseInsensitive(studentResult, "success", out var success) && success.GetBoolean() &&
                            TryGetPropertyCaseInsensitive(studentResult, "data", out var data) && data.ValueKind == JsonValueKind.Array && data.GetArrayLength() > 0)
                        {
                            // Find the best match - if we have multiple, try to match grade/section if provided
                            var studentData = data[0];
                            if (data.GetArrayLength() > 1 && !string.IsNullOrEmpty(sGrade))
                            {
                                foreach (var s in data.EnumerateArray())
                                {
                                    if (TryGetPropertyCaseInsensitive(s, "gradeLevel", out var matchGl) && matchGl.GetString() == sGrade)
                                    {
                                        studentData = s;
                                        break;
                                    }
                                }
                            }

                            var suggestion = new StudentInfoSuggestion
                            {
                                StudentId = TryGetPropertyCaseInsensitive(studentData, "studentId", out var studentIdProp) && studentIdProp.ValueKind != JsonValueKind.Null ? studentIdProp.GetInt32() : null,
                                StudentName = TryGetPropertyCaseInsensitive(studentData, "studentName", out var studentNameProp) ? studentNameProp.GetString() : sName,
                                GradeLevel = TryGetPropertyCaseInsensitive(studentData, "gradeLevel", out var gradeLevelProp) ? gradeLevelProp.GetString() : sGrade ?? "",
                                Section = TryGetPropertyCaseInsensitive(studentData, "section", out var sectionProp) ? sectionProp.GetString() : sSection ?? "",
                                TrackStrand = TryGetPropertyCaseInsensitive(studentData, "trackStrand", out var trackStrandProp) ? trackStrandProp.GetString() : "",
                                SchoolName = TryGetPropertyCaseInsensitive(studentData, "schoolName", out var schoolNameProp) ? schoolNameProp.GetString() : sSchool ?? podSchoolName ?? "",
                                AdviserName = TryGetPropertyCaseInsensitive(studentData, "adviserName", out var adviserNameProp) ? adviserNameProp.GetString() : "",
                                FathersName = TryGetPropertyCaseInsensitive(studentData, "fathersName", out var fathersNameProp) ? fathersNameProp.GetString() : null,
                                MothersName = TryGetPropertyCaseInsensitive(studentData, "mothersName", out var mothersNameProp) ? mothersNameProp.GetString() : null,
                                GuardianName = TryGetPropertyCaseInsensitive(studentData, "guardianName", out var guardianNameProp) ? guardianNameProp.GetString() : null,
                                GuardianContact = TryGetPropertyCaseInsensitive(studentData, "guardianContact", out var guardianContactProp) ? guardianContactProp.GetString() : null,
                                ContactPerson = TryGetPropertyCaseInsensitive(studentData, "contactPerson", out var contactPersonProp) ? contactPersonProp.GetString() : null,
                                Source = "Database (Escalated)"
                            };
                            
                            studentInfoSuggestions.Clear();
                            studentInfoSuggestions.Add(suggestion);
                            selectedStudents.Clear();
                            selectedStudents.Add(suggestion);
                            studentFound = true;
                            Console.WriteLine($"[AUTO-POPULATE] Successfully fetched database record for escalated student: {sName}");
                        }
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"[ERROR] Failed to fetch student info for escalated case: {ex.Message}");
                }

                if (!studentFound)
                {
                    // Fallback to manual info if not found in DB or fetch fails
                    var suggestion = new StudentInfoSuggestion
                    {
                        StudentName = sName,
                        GradeLevel = sGrade ?? "",
                        Section = sSection ?? "",
                        SchoolName = sSchool ?? podSchoolName ?? "",
                        Source = "Query Parameter"
                    };
                    
                    studentInfoSuggestions.Clear();
                    studentInfoSuggestions.Add(suggestion);
                    selectedStudents.Clear();
                    selectedStudents.Add(suggestion);
                    Console.WriteLine($"[AUTO-POPULATE] Falling back to query parameters for student: {sName}");
                }
                
                // Initialize the record for this student
                await InitializeCurrentStudentCaseRecord();
                
                // If details provided, use it as violation type for escalated cases
                if (!string.IsNullOrEmpty(sDetails))
                {
                    incidentViolationType = sDetails;
                    
                    // Add to violation types if not exists so it shows in dropdown
                    if (!violationTypes.Contains(sDetails))
                    {
                        violationTypes.Insert(0, sDetails);
                    }

                    // Update the active record explicitly
                    caseRecord.ViolationCommitted = sDetails;
                    await LoadViolationCategoryAndSetLevel(sDetails);
                    
                    // Also set as agreement detail context
                    caseRecord.DetailsOfAgreement = $"Escalated due to: {sDetails}";
                }
            }
            
            await LoadIncidentReportData();
        }
    }

    private async Task CheckAuthentication()
    {
        try
        {
            var authToken = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");
            var username = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "username");
            var userRole = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "userRole");
            
            if (!string.IsNullOrEmpty(authToken) && !string.IsNullOrEmpty(username))
            {
                isAuthenticated = true;
            }
            else
            {
                isAuthenticated = false;
            }
        }
        catch
        {
            isAuthenticated = false;
        }
    }

    private async Task LoadCurrentUserInfo()
    {
        try
        {
            var username = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "username");
            currentUsername = username ?? string.Empty;
            var teacherName = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "teacherName");
            
            if (!string.IsNullOrEmpty(teacherName))
            {
                caseRecord.PODInCharge = teacherName;
            }
        }
        catch (Exception ex)
        {
            message = $"Error loading user information: {ex.Message}";
            isSuccess = false;
        }
    }

    private async Task LoadPODUserLocation()
    {
        try
        {
            if (string.IsNullOrEmpty(currentUsername))
            {
                currentUsername = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "username") ?? string.Empty;
            }

            if (string.IsNullOrEmpty(currentUsername))
            {
                return;
            }

            var response = await Http.GetAsync($"api/IncidentReport/pod-location/{Uri.EscapeDataString(currentUsername)}");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (TryGetPropertyCaseInsensitive(result, "success", out var success) && success.GetBoolean() &&
                    TryGetPropertyCaseInsensitive(result, "data", out var data))
                {
                    podSchoolName = TryGetPropertyCaseInsensitive(data, "schoolName", out var sn) ? sn.GetString()?.Trim() : null;
                    podDivision = TryGetPropertyCaseInsensitive(data, "division", out var div) ? div.GetString()?.Trim() : null;
                    podRegion = TryGetPropertyCaseInsensitive(data, "region", out var reg) ? reg.GetString()?.Trim() : null;
                    podDistrict = TryGetPropertyCaseInsensitive(data, "district", out var dist) ? dist.GetString()?.Trim() : null;
                }
            }
        }
        catch (Exception ex)
        {
            // Continue without location filtering if this fails
        }
    }

    private async Task LoadViolationTypes()
    {
        try
        {
            var response = await Http.GetAsync("api/StudentProfileCaseRecord/violation-types");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                {
                    violationTypes = new List<string>();
                    foreach (var item in data.EnumerateArray())
                    {
                        violationTypes.Add(item.GetString() ?? "");
                    }
                }
            }
        }
        catch (Exception)
        {
            // Fallback to default violations
            violationTypes = new List<string>
            {
                "Late/Unauthorized Absence",
                "Dress Code Violation",
                "Disruptive Behavior",
                "Use of Profane Language",
                "Cheating/Plagiarism",
                "Bullying/Harassment",
                "Fighting/Physical Altercation",
                "Drug/Alcohol Possession",
                "Vandalism",
                "Theft",
                "Truancy",
                "Insubordination",
                "Other"
            };
        }
    }

    private async Task LoadIncidentReportData()
    {
        try
        {
            Console.WriteLine("[DEBUG] LoadIncidentReportData called");
            
            // Get query parameters from the URL
            var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
            
            // Pre-fill form with incident report data
            var offenderName = query["offenderName"];
            var complainantName = query["complainantName"];
            var violationType = query["violationType"];
            var otherViolation = query["otherViolation"];
            var incidentId = query["incidentId"];
            var dateReported = query["dateReported"];
            
            Console.WriteLine($"[DEBUG] Query parameters:");
            Console.WriteLine($"[DEBUG]   - offenderName: {offenderName}");
            Console.WriteLine($"[DEBUG]   - incidentId: {incidentId}");
            Console.WriteLine($"[DEBUG]   - violationType: {violationType}");
            
            // Store incident ID FIRST so fallback can use it
            if (!string.IsNullOrEmpty(incidentId))
            {
                if (int.TryParse(incidentId, out var parsedIncidentId))
                {
                    incidentIdFromQuery = parsedIncidentId;
                    Console.WriteLine($"[DEBUG] Set incidentIdFromQuery to: {incidentIdFromQuery}");
                }
            }

            // Also check for escalationId
            var escalationId = query["escalationId"];
            if (!string.IsNullOrEmpty(escalationId))
            {
                if (int.TryParse(escalationId, out var parsedEscalationId))
                {
                    escalationIdFromQuery = parsedEscalationId;
                    Console.WriteLine($"[DEBUG] Set escalationIdFromQuery to: {escalationIdFromQuery}");
                }
            }
            
            // Pre-fill student offender information
            if (!string.IsNullOrEmpty(offenderName))
            {
                Console.WriteLine($"[DEBUG] Setting StudentOffenderName to: {offenderName}");
                caseRecord.StudentOffenderName = offenderName;
                
                // Always load adviser and student info when offender name is provided from query
                Console.WriteLine($"[DEBUG] Calling LoadAdviserForStudentOffender for: {offenderName}");
                await LoadAdviserForStudentOffender(offenderName);
            }
            else
            {
                Console.WriteLine("[DEBUG] No offenderName in query parameters");
            }
            
            // Store incident report data for later use (will be applied to each student)
            if (!string.IsNullOrEmpty(violationType))
            {
                incidentViolationType = violationType;
                incidentOtherViolation = otherViolation;
                Console.WriteLine($"[DEBUG] Stored violation type: {incidentViolationType}");
            }
            
            // Store date of offense
            if (!string.IsNullOrEmpty(dateReported) && DateTime.TryParse(dateReported, out var date))
            {
                incidentDateOfOffense = date;
                Console.WriteLine($"[DEBUG] Stored date of offense: {incidentDateOfOffense}");
            }
            
            // Ensure UI is updated after loading data
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading incident report data: {ex.Message}");
            // Still update UI even if there's an error
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task OnAdviserNameChanged(ChangeEventArgs e)
    {
        var searchTerm = e.Value?.ToString() ?? "";
        caseRecord.AdviserName = searchTerm;
        
        if (searchTerm.Length >= 2 && searchTerm != lastSearchTerm)
        {
            lastSearchTerm = searchTerm;
            await SearchTeachers(searchTerm);
        }
        else if (searchTerm.Length < 2)
        {
            showTeacherSuggestions = false;
            teacherSuggestions.Clear();
        }
    }

    private async Task SearchTeachers(string searchTerm)
    {
        try
        {
            // Ensure POD location is loaded before searching
            if (string.IsNullOrEmpty(podSchoolName) && isAuthenticated)
            {
                await LoadPODUserLocation();
            }
            
            // Build API URL with search term and optional school filter
            var apiUrl = $"api/StudentProfileCaseRecord/search-teachers?searchTerm={Uri.EscapeDataString(searchTerm)}";
            
            // Add school filter if POD user's school is available - MANDATORY for filtering
            if (!string.IsNullOrEmpty(podSchoolName))
            {
                apiUrl += $"&schoolName={Uri.EscapeDataString(podSchoolName.Trim())}";
            }
            
            var response = await Http.GetAsync(apiUrl);
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                {
                    teacherSuggestions = new List<TeacherSearchResult>();
                    foreach (var teacherElement in data.EnumerateArray())
                    {
                        var teacher = new TeacherSearchResult();
                        
                        if (teacherElement.TryGetProperty("teacherID", out var teacherId))
                            teacher.TeacherID = teacherId.GetInt32();
                        if (teacherElement.TryGetProperty("teacherName", out var teacherName))
                            teacher.TeacherName = teacherName.GetString() ?? "";
                        if (teacherElement.TryGetProperty("position", out var position))
                            teacher.Position = position.GetString() ?? "";
                        if (teacherElement.TryGetProperty("gradeHandle", out var gradeHandle))
                            teacher.GradeHandle = gradeHandle.GetString() ?? "";
                        
                        teacherSuggestions.Add(teacher);
                    }
                    
                    showTeacherSuggestions = teacherSuggestions.Any();
                }
            }
        }
        catch (Exception ex)
        {
            // Error searching teachers - silently handle
        }
    }

    private void SelectTeacher(TeacherSearchResult teacher)
    {
        caseRecord.AdviserName = teacher.TeacherName;
        showTeacherSuggestions = false;
        teacherSuggestions.Clear();
    }

    private async Task OnViolationCommittedChanged(ChangeEventArgs e)
    {
        var violation = e.Value?.ToString() ?? "";
        caseRecord.ViolationCommitted = violation;
        
        // Clear other violation description if not "Other"
        if (violation != "Other")
        {
            caseRecord.OtherViolationDescription = null;
        }
        
        // Auto-fill Level of Offense based on violation category
        if (!string.IsNullOrEmpty(violation))
        {
            await LoadViolationCategoryAndSetLevel(violation);
        }
        else
        {
            caseRecord.LevelOfOffense = string.Empty;
        }
        
        StateHasChanged();
    }

    private async Task LoadViolationCategoryAndSetLevel(string violationName)
    {
        if (string.IsNullOrWhiteSpace(violationName))
        {
            caseRecord.LevelOfOffense = string.Empty;
            await InvokeAsync(StateHasChanged);
            return;
        }

        // Check for consolidated/multiple violations (comma separated)
        if (violationName.Contains(",")) 
        {
            // For escalated cases with multiple violations, we default to Major or specific handling
            caseRecord.LevelOfOffense = "Major"; 
            await InvokeAsync(StateHasChanged);
            return;
        }

        try
        {
            var trimmedViolationName = violationName.Trim();
            var apiUrl = $"api/StudentProfileCaseRecord/violation-category?violationName={Uri.EscapeDataString(trimmedViolationName)}";
            
            var response = await Http.GetAsync(apiUrl);
            var content = await response.Content.ReadAsStringAsync();
            
            if (response.IsSuccessStatusCode)
            {
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                // Check if success property exists and is true
                if (result.TryGetProperty("success", out var successProp) && successProp.GetBoolean())
                {
                    // Try to get the data property
                    if (result.TryGetProperty("data", out var dataProp))
                    {
                        // Handle different data types
                        string? category = null;
                        
                        if (dataProp.ValueKind == JsonValueKind.String)
                        {
                            category = dataProp.GetString()?.Trim();
                        }
                        else if (dataProp.ValueKind == JsonValueKind.Null)
                        {
                            // Data is null, category not found
                            category = null;
                        }
                        
                        if (!string.IsNullOrWhiteSpace(category))
                        {
                            caseRecord.LevelOfOffense = category;
                            await Task.Delay(100); // Small delay to ensure state update
                            await InvokeAsync(StateHasChanged);
                            return;
                        }
                    }
                }
                
                // Check if there's an error message
                if (result.TryGetProperty("message", out var messageProp))
                {
                    var errorMessage = messageProp.GetString();
                    // Category not found - leave empty
                    caseRecord.LevelOfOffense = string.Empty;
                }
                else
                {
                    // No category found
                    caseRecord.LevelOfOffense = string.Empty;
                }
            }
            else
            {
                // API call failed
                caseRecord.LevelOfOffense = string.Empty;
            }
            
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            // Reset level if error occurs
            caseRecord.LevelOfOffense = string.Empty;
            await InvokeAsync(StateHasChanged);
        }
    }

    private void OnGradeLevelChanged(ChangeEventArgs e)
    {
        var gradeLevel = e.Value?.ToString() ?? "";
        caseRecord.GradeLevel = gradeLevel;
        
        // Clear Track/Strand if not required for this grade level
        if (!IsTrackStrandRequired)
        {
            caseRecord.TrackStrand = string.Empty;
        }
        
        StateHasChanged();
    }

    private void FormatPhoneNumber(ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? "";
        
        // Remove any non-digit characters
        var digitsOnly = System.Text.RegularExpressions.Regex.Replace(value, @"[^\d]", "");
        
        // Limit to 11 digits
        if (digitsOnly.Length > 11)
        {
            digitsOnly = digitsOnly.Substring(0, 11);
        }
        
        // Ensure it starts with 09 if it has more than 1 digit
        if (digitsOnly.Length > 1 && !digitsOnly.StartsWith("09"))
        {
            if (digitsOnly.StartsWith("9"))
            {
                digitsOnly = "0" + digitsOnly;
            }
            else if (!digitsOnly.StartsWith("0"))
            {
                digitsOnly = "09" + digitsOnly.Substring(1);
            }
        }
        
        caseRecord.ParentGuardianContact = digitsOnly;
        StateHasChanged();
    }

    private async Task OnStudentOffenderNameBlur(FocusEventArgs _)
    {
        Console.WriteLine($"[DEBUG] OnStudentOffenderNameBlur triggered for: {caseRecord.StudentOffenderName}");
        
        // Always try to load adviser info when student name is entered/changed
        if (!string.IsNullOrWhiteSpace(caseRecord.StudentOffenderName))
        {
            Console.WriteLine($"[DEBUG] Calling LoadAdviserForStudentOffender...");
            await LoadAdviserForStudentOffender(caseRecord.StudentOffenderName);
            
            Console.WriteLine($"[DEBUG] Suggestions count after load: {studentInfoSuggestions.Count}");
            
            // Auto-select the best suggestion if available
            if (studentInfoSuggestions.Any() && selectedStudentSuggestion == null)
            {
                var bestSuggestion = studentInfoSuggestions.FirstOrDefault();
                if (bestSuggestion != null)
                {
                    Console.WriteLine($"[DEBUG] Auto-applying best suggestion...");
                    ApplyStudentSuggestion(bestSuggestion, clearSuggestions: false);
                }
            }
            else
            {
                Console.WriteLine($"[DEBUG] No suggestions to auto-apply. Suggestions={studentInfoSuggestions.Count}, Selected={selectedStudentSuggestion != null}");
            }
        }
    }

    private bool IsValidPhilippinePhoneNumber(string phoneNumber)
    {
        if (string.IsNullOrEmpty(phoneNumber))
            return false;

        // Check if it's exactly 11 digits and starts with 09
        return phoneNumber.Length == 11 && phoneNumber.StartsWith("09") && phoneNumber.All(char.IsDigit);
    }

    private void InitializeEditContext()
    {
        editContext = new EditContext(caseRecord);
    }

    private async Task NextStep()
    {
        message = string.Empty;
        var (isValid, errorMessage) = ValidateStep(currentStep);

        if (isValid)
        {
            // Step 1: Moving from student info to first student's parent/guardian form
            if (currentStep == 1)
            {
                // Auto-select all shown students
                selectedStudents = studentInfoSuggestions.ToList();
                currentStudentIndex = 0;
                currentStudentIndex = 0;
                await InitializeCurrentStudentCaseRecord();
                currentStep++;
                await InvokeAsync(StateHasChanged);
                return;
            }

            // Steps 2-5: Multi-page form sections per student
            var evidenceStep = TotalSteps; // Currently Photo & Signature
            if (currentStep >= 2 && currentStep < evidenceStep)
            {
                // Save current student's data
                SaveCurrentStudentCaseRecord();
                
                // Check if there are more students to process for this step
                if (currentStudentIndex < selectedStudents.Count - 1)
                {
                    // Move to next student, keep same step
                    currentStudentIndex++;
                    await InitializeCurrentStudentCaseRecord();
                    await InvokeAsync(StateHasChanged);
                    return;
                }
                else
                {
                    // All students done for this step, move to next step
                    currentStudentIndex = 0; // Reset for next step
                    await InitializeCurrentStudentCaseRecord();
                    
                     // If moving to evidence step, load saved photo/signature for first student
                    if (currentStep + 1 == evidenceStep)
                    {
                        await LoadCurrentStudentEvidence();
                    }
                    
                    currentStep++;
                    await InvokeAsync(StateHasChanged);
                    return;
                }
            }

            // Final step (Photo & Signature): Handle evidence capture per student
            if (currentStep == evidenceStep)
            {
                // Save current student's data and evidence
                SaveCurrentStudentCaseRecord();
                SaveCurrentStudentEvidence();
                
                // Check if there are more students to process
                if (currentStudentIndex < selectedStudents.Count - 1)
                {
                    // Move to next student for evidence capture
                    currentStudentIndex++;
                    await InitializeCurrentStudentCaseRecord();
                    await LoadCurrentStudentEvidence();
                    await InvokeAsync(StateHasChanged);
                    return;
                }
                else
                {
                    // All students done, proceed with submission
                    await InvokeAsync(StateHasChanged);
                }
            }
        }
        else
        {
            isSuccess = false;
            message = errorMessage;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task InitializeCurrentStudentCaseRecord()
    {
        var student = selectedStudents[currentStudentIndex];
        var key = GetStudentKey(currentStudentIndex);
        
        if (!studentCaseRecords.ContainsKey(key))
        {
            // Create new case record for this student
            var podInCharge = caseRecord?.PODInCharge ?? "";
            
            caseRecord = new StudentProfileCaseRecordModel
            {
                StudentOffenderName = student.StudentName ?? "",
                GradeLevel = student.GradeLevel ?? "",
                Section = student.Section ?? "",
                TrackStrand = student.TrackStrand ?? "",
                AdviserName = student.AdviserName ?? "",
                PODInCharge = podInCharge,
                DateCreated = DateTime.Now,
                Status = "Active",
                // Apply incident report data
                ViolationCommitted = incidentViolationType ?? "",
                OtherViolationDescription = incidentOtherViolation,
                DateOfOffense = incidentDateOfOffense ?? DateTime.Now,
                // Auto-populate parent/guardian information from student data
                FathersName = student.FathersName ?? "",
                MothersName = student.MothersName ?? "",
                GuardianName = student.GuardianName ?? "",
                ParentGuardianContact = student.GuardianContact ?? ""
            };
            
            // Auto-select contact person type based on available parent/guardian data
            if (!string.IsNullOrWhiteSpace(student.ContactPerson))
            {
                // Use the ContactPerson field from database if available
                var contactPerson = student.ContactPerson.Trim().ToLower();
                if (contactPerson == "father" || contactPerson == "mother" || contactPerson == "guardian" || contactPerson == "both")
                {
                    contactPersonType = contactPerson;
                    Console.WriteLine($"[AUTO-POPULATE] Set contactPersonType from database: {contactPersonType}");
                }
            }
            else
            {
                // Infer contact person type from available names
                if (!string.IsNullOrWhiteSpace(student.FathersName) && !string.IsNullOrWhiteSpace(student.MothersName))
                {
                    contactPersonType = "both";
                    Console.WriteLine($"[AUTO-POPULATE] Inferred contactPersonType: both (Father: {student.FathersName}, Mother: {student.MothersName})");
                }
                else if (!string.IsNullOrWhiteSpace(student.FathersName))
                {
                    contactPersonType = "father";
                    Console.WriteLine($"[AUTO-POPULATE] Inferred contactPersonType: father ({student.FathersName})");
                }
                else if (!string.IsNullOrWhiteSpace(student.MothersName))
                {
                    contactPersonType = "mother";
                    Console.WriteLine($"[AUTO-POPULATE] Inferred contactPersonType: mother ({student.MothersName})");
                }
                else if (!string.IsNullOrWhiteSpace(student.GuardianName))
                {
                    contactPersonType = "guardian";
                    Console.WriteLine($"[AUTO-POPULATE] Inferred contactPersonType: guardian ({student.GuardianName})");
                }
            }
            
            Console.WriteLine($"[AUTO-POPULATE] Parent/Guardian Info for {student.StudentName}:");
            Console.WriteLine($"  - FathersName: {caseRecord.FathersName}");
            Console.WriteLine($"  - MothersName: {caseRecord.MothersName}");
            Console.WriteLine($"  - GuardianName: {caseRecord.GuardianName}");
            Console.WriteLine($"  - ParentGuardianContact: {caseRecord.ParentGuardianContact}");
            Console.WriteLine($"  - contactPersonType: {contactPersonType}");
            
            // Auto-fill Level of Offense based on violation
            if (!string.IsNullOrEmpty(caseRecord.ViolationCommitted) && caseRecord.ViolationCommitted.ToLower() != "other")
            {
                await LoadViolationCategoryAndSetLevel(caseRecord.ViolationCommitted);
            }
            
            // Auto-calculate Number of Offense based on existing records
            await CalculateNumberOfOffense(student.StudentName ?? "");
            
            studentCaseRecords[key] = caseRecord;
        }
        else
        {
            // Load existing case record for this student
            caseRecord = studentCaseRecords[key];
            
            // Restore contactPersonType based on saved case record data
            if (!string.IsNullOrWhiteSpace(caseRecord.FathersName) && !string.IsNullOrWhiteSpace(caseRecord.MothersName))
            {
                contactPersonType = "both";
            }
            else if (!string.IsNullOrWhiteSpace(caseRecord.FathersName))
            {
                contactPersonType = "father";
            }
            else if (!string.IsNullOrWhiteSpace(caseRecord.MothersName))
            {
                contactPersonType = "mother";
            }
            else if (!string.IsNullOrWhiteSpace(caseRecord.GuardianName))
            {
                contactPersonType = "guardian";
            }
            
            Console.WriteLine($"[RESTORE] Restored contactPersonType for {caseRecord.StudentOffenderName}: {contactPersonType}");
        }
        
        InitializeEditContext();
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task CalculateNumberOfOffense(string studentName)
    {
        try
        {
            // Call API to check how many existing offense records this student has
            var apiUrl = $"api/StudentProfileCaseRecord/count-offenses?studentName={Uri.EscapeDataString(studentName)}";
            var response = await Http.GetAsync(apiUrl);
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("count", out var countProp))
                {
                    var existingCount = countProp.GetInt32();
                    var offenseNumber = existingCount + 1; // This will be the next offense
                    
                    caseRecord.NumberOfOffense = offenseNumber switch
                    {
                        1 => "First Offense",
                        2 => "Second Offense",
                        3 => "Third Offense",
                        _ => $"{offenseNumber}th Offense"
                    };
                    
                    Console.WriteLine($"[DEBUG] Student {studentName} has {existingCount} existing offenses. Setting to: {caseRecord.NumberOfOffense}");
                }
            }
            else
            {
                // Default to First Offense if API fails
                caseRecord.NumberOfOffense = "First Offense";
                Console.WriteLine($"[DEBUG] API failed, defaulting to First Offense for {studentName}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[DEBUG] Error calculating number of offense: {ex.Message}");
            caseRecord.NumberOfOffense = "First Offense";
        }
    }

    private void SaveCurrentStudentCaseRecord()
    {
        var key = GetStudentKey(currentStudentIndex);
        studentCaseRecords[key] = caseRecord;
    }
    
    private void SaveCurrentStudentEvidence()
    {
        var key = GetStudentKey(currentStudentIndex);
        studentPhotos[key] = capturedPhotoBase64 ?? string.Empty;
        studentSignatures[key] = signatureBase64 ?? string.Empty;
    }
    
    private async Task LoadCurrentStudentEvidence()
    {
        // First, explicitly clear current previews to ensure clean slate
        capturedPhotoBase64 = string.Empty;
        signatureBase64 = string.Empty;
        
        // Stop camera if it's active
        if (isCameraActive)
        {
            await StopCamera();
        }
        
        // Force UI update to show cleared state
        await InvokeAsync(StateHasChanged);
        
        // Now load the next student's saved evidence (if any)
        var key = GetStudentKey(currentStudentIndex);
        capturedPhotoBase64 = studentPhotos.ContainsKey(key) ? studentPhotos[key] : string.Empty;
        signatureBase64 = studentSignatures.ContainsKey(key) ? studentSignatures[key] : string.Empty;
    }

    private int GetStudentKey(int index)
    {
        return index;
    }

    private async Task PreviousStep()
    {
        message = string.Empty;
        if (currentStep > 1)
        {
            // Save current data before going back
            if (currentStep == 4)
            {
                SaveCurrentStudentCaseRecord();
                SaveCurrentStudentEvidence();
            }
            else if (currentStep >= 2 && currentStep <= 3)
            {
                SaveCurrentStudentCaseRecord();
            }
            
            // Handle navigation for step 4
            if (currentStep == 4 && currentStudentIndex > 0)
            {
                // Go back to previous student in same step
                currentStudentIndex--;
                await InitializeCurrentStudentCaseRecord();
                await LoadCurrentStudentEvidence();
                StateHasChanged();
                return;
            }
            
            // Handle navigation for steps 2-3
            if (currentStep >= 3 && currentStep <= 3 && currentStudentIndex > 0)
            {
                // Go back to previous student in same step
                currentStudentIndex--;
                await InitializeCurrentStudentCaseRecord();
                StateHasChanged();
                return;
            }
            
            // Move to previous step
            currentStep--;
            
            // When moving back to step 4, go to last student
            if (currentStep == 4)
            {
                currentStudentIndex = selectedStudents.Count - 1;
                await InitializeCurrentStudentCaseRecord();
                await LoadCurrentStudentEvidence();
            }
            // When moving back to steps 2-3, go to last student
            else if (currentStep >= 2 && currentStep <= 3)
            {
                currentStudentIndex = selectedStudents.Count - 1;
                await InitializeCurrentStudentCaseRecord();
            }
            
            StateHasChanged();
        }
    }

    private (bool isValid, string errorMessage) ValidateStep(int stepNumber)
    {
        switch (stepNumber)
        {
            case 1:
                if (!studentInfoSuggestions.Any())
                    return (false, "No student information found. Please ensure student data is loaded.");
                break;
            case 2:
                if (!HasParentOrGuardianInfo())
                    return (false, "Provide at least one parent or guardian name before continuing.");
                if (string.IsNullOrWhiteSpace(caseRecord.ParentGuardianContact))
                    return (false, "Parent/guardian contact number is required.");
                if (!IsValidPhilippinePhoneNumber(caseRecord.ParentGuardianContact))
                    return (false, "Please enter a valid Philippine mobile number (09XXXXXXXXX).");
                break;
            case 3:
                if (string.IsNullOrWhiteSpace(caseRecord.ViolationCommitted))
                    return (false, "Violation committed is required.");
                if (string.IsNullOrWhiteSpace(caseRecord.LevelOfOffense))
                    return (false, "Level of offense will auto-fill once a violation is selected.");
                if (caseRecord.ViolationCommitted == "Other" && string.IsNullOrWhiteSpace(caseRecord.OtherViolationDescription))
                    return (false, "Please describe the violation when 'Other' is selected.");
                if (string.IsNullOrWhiteSpace(caseRecord.NumberOfOffense))
                    return (false, "Please select the number of offenses committed.");
                break;
            case 4:
                // Skip validation if N/A is checked
                if (!isAgreementNA && string.IsNullOrWhiteSpace(caseRecord.DetailsOfAgreement))
                    return (false, "Details of the agreement must be filled out before submitting.");
                
                // If N/A is checked, automatically set agreement details to "N/A"
                if (isAgreementNA)
                {
                    caseRecord.DetailsOfAgreement = "N/A";
                }
                break;
        }

        return (true, string.Empty);
    }

    private bool HasParentOrGuardianInfo() =>
        !string.IsNullOrWhiteSpace(caseRecord.FathersName) ||
        !string.IsNullOrWhiteSpace(caseRecord.MothersName) ||
        !string.IsNullOrWhiteSpace(caseRecord.GuardianName);

    private async Task LoadAdviserForStudentOffender(string studentName)
    {
        Console.WriteLine($"[DEBUG] LoadAdviserForStudentOffender called with: '{studentName}'");
        
        if (string.IsNullOrWhiteSpace(studentName))
        {
            Console.WriteLine($"[DEBUG] Student name is empty, returning");
            return;
        }

        try
        {
            studentInfoSuggestions.Clear();

            // Check if studentName contains multiple names separated by semicolon (e.g., "STUDENT1; STUDENT2")
            var individualNames = studentName.Split(new[] { ';' }, StringSplitOptions.RemoveEmptyEntries)
                .Select(n => n.Trim())
                .Where(n => !string.IsNullOrWhiteSpace(n))
                .ToList();

            Console.WriteLine($"[DEBUG] Split into {individualNames.Count} individual name(s)");

            // Search for each student individually
            foreach (var name in individualNames)
            {
                Console.WriteLine($"[DEBUG] Searching for individual student: '{name}'");
                
                var apiUrl = $"api/StudentProfileCaseRecord/student-adviser/{Uri.EscapeDataString(name)}";
                if (!string.IsNullOrEmpty(podSchoolName))
                {
                    apiUrl += $"?schoolName={Uri.EscapeDataString(podSchoolName)}";
                }

                Console.WriteLine($"[DEBUG] API URL: {apiUrl}");

                var response = await Http.GetAsync(apiUrl);
                Console.WriteLine($"[DEBUG] Response status for '{name}': {response.StatusCode}");
                
                if (!response.IsSuccessStatusCode)
                {
                    Console.WriteLine($"API call failed for '{name}' with status: {response.StatusCode}");
                    await TryPopulateFromIncidentReportAsync(name);
                    continue;
                }

                var content = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"[DEBUG] API response for '{name}': {content}");
                var result = JsonSerializer.Deserialize<JsonElement>(content);

                if (TryGetPropertyCaseInsensitive(result, "success", out var successProp) && successProp.GetBoolean() &&
                    TryGetPropertyCaseInsensitive(result, "data", out var dataProp))
                {
                    Console.WriteLine($"[DEBUG] Processing student info result for '{name}', data type: {dataProp.ValueKind}");
                    HandleStudentInfoResult(dataProp, clearExisting: false); // Don't clear existing, we're adding multiple students
                    Console.WriteLine($"[DEBUG] Total suggestions so far: {studentInfoSuggestions.Count}");
                }
                else
                {
                    Console.WriteLine($"[DEBUG] API response missing success or data property for '{name}'");
                    await TryPopulateFromIncidentReportAsync(name);
                }
            }

            if (studentInfoSuggestions.Any())
            {
                Console.WriteLine($"[DEBUG] Final suggestions details:");
                foreach (var sug in studentInfoSuggestions)
                {
                    Console.WriteLine($"[DEBUG]   - Name: {sug.StudentName}, Grade: {sug.GradeLevel}, Section: {sug.Section}, Adviser: {sug.AdviserName}");
                }
            }
            else
            {
                Console.WriteLine("[DEBUG] No suggestions found for any student");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error auto-loading adviser for student '{studentName}': {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            await TryPopulateFromIncidentReportAsync(studentName);
        }
    }

    private async Task<bool> TryPopulateFromIncidentReportAsync(string studentName)
    {
        try
        {
            Console.WriteLine($"[DEBUG] TryPopulateFromIncidentReportAsync called for: {studentName}");
            Console.WriteLine($"[DEBUG] incidentIdFromQuery: {incidentIdFromQuery}");
            
            var queryParams = $"studentName={Uri.EscapeDataString(studentName)}";
            if (incidentIdFromQuery.HasValue)
            {
                queryParams += $"&incidentId={incidentIdFromQuery.Value}";
            }

            var apiUrl = $"api/StudentProfileCaseRecord/incident-student-info?{queryParams}";
            Console.WriteLine($"[DEBUG] Incident report API URL: {apiUrl}");

            var response = await Http.GetAsync(apiUrl);
            Console.WriteLine($"[DEBUG] Incident report API status: {response.StatusCode}");
            
            if (!response.IsSuccessStatusCode)
            {
                Console.WriteLine($"[DEBUG] Incident report API failed with status: {response.StatusCode}");
                return false;
            }

            var content = await response.Content.ReadAsStringAsync();
            Console.WriteLine($"[DEBUG] Incident report API response: {content}");
            var result = JsonSerializer.Deserialize<JsonElement>(content);

            if (TryGetPropertyCaseInsensitive(result, "success", out var successProp) && successProp.GetBoolean() &&
                TryGetPropertyCaseInsensitive(result, "data", out var dataProp))
            {
                Console.WriteLine($"[DEBUG] Incident report data type: {dataProp.ValueKind}");
                var handled = HandleStudentInfoResult(dataProp, clearExisting: !studentInfoSuggestions.Any());
                Console.WriteLine($"[DEBUG] Incident report handled: {handled}, Suggestions: {studentInfoSuggestions.Count}");
                return handled;
            }
            else
            {
                Console.WriteLine($"[DEBUG] Incident report response missing success or data");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[DEBUG] Fallback incident info lookup failed for '{studentName}': {ex.Message}");
            Console.WriteLine($"[DEBUG] Stack trace: {ex.StackTrace}");
        }

        return false;
    }

    private async Task ResetWizardStateAsync()
    {
        caseRecord = new StudentProfileCaseRecordModel();
        InitializeEditContext();
        formKey = Guid.NewGuid().ToString();
        currentStep = 1;
        currentStudentIndex = 0;
        capturedPhotoBase64 = string.Empty;
        signatureBase64 = string.Empty;
        studentInfoSuggestions.Clear();
        selectedStudentSuggestion = null;
        selectedStudents.Clear();
        studentCaseRecords.Clear();
        studentPhotos.Clear();
        studentSignatures.Clear();

        if (isCameraActive)
        {
            await StopCamera();
        }

        await LoadCurrentUserInfo();
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleSubmit()
    {
        isLoading = true;
        message = string.Empty;

        try
        {
            int successCount = 0;
            int failCount = 0;
            var errors = new List<string>();

            // Loop through all students and submit their records
            for (int i = 0; i < selectedStudents.Count; i++)
            {
                var key = GetStudentKey(i);
                
                // Get student's case record
                if (!studentCaseRecords.ContainsKey(key))
                {
                    errors.Add($"Missing data for student {selectedStudents[i].StudentName}");
                    failCount++;
                    continue;
                }

                var studentRecord = studentCaseRecords[key];
                
                // Manual validation for TrackStrand - only required for Grade 11 and 12
                var isTrackRequired = studentRecord.GradeLevel == "Grade 11" || studentRecord.GradeLevel == "Grade 12";
                if (isTrackRequired && string.IsNullOrWhiteSpace(studentRecord.TrackStrand))
                {
                    errors.Add($"Track/Strand is required for {studentRecord.StudentOffenderName} (Grade 11 or 12)");
                    failCount++;
                    continue;
                }

                // Get student's evidence
                var photo = studentPhotos.ContainsKey(key) ? studentPhotos[key] : string.Empty;
                var signature = studentSignatures.ContainsKey(key) ? studentSignatures[key] : string.Empty;

                // Convert to request object
                var request = new StudentProfileCaseRecordRequest
                {
                    IncidentID = incidentIdFromQuery,
                    StudentOffenderName = studentRecord.StudentOffenderName,
                    GradeLevel = studentRecord.GradeLevel,
                    TrackStrand = studentRecord.TrackStrand,
                    Section = studentRecord.Section,
                    AdviserName = studentRecord.AdviserName,
                    FathersName = studentRecord.FathersName,
                    MothersName = studentRecord.MothersName,
                    GuardianName = studentRecord.GuardianName,
                    ParentGuardianContact = studentRecord.ParentGuardianContact,
                    DateOfOffense = studentRecord.DateOfOffense,
                    LevelOfOffense = studentRecord.LevelOfOffense,
                    ViolationCommitted = studentRecord.ViolationCommitted,
                    OtherViolationDescription = studentRecord.OtherViolationDescription,
                    NumberOfOffense = studentRecord.NumberOfOffense,
                    DetailsOfAgreement = studentRecord.DetailsOfAgreement,
                    PODInCharge = studentRecord.PODInCharge,
                    DateCreated = studentRecord.DateCreated,
                    Status = studentRecord.Status,
                    // Add captured photo and signature for this student
                    EvidencePhotoBase64 = photo,
                    SignatureBase64 = signature
                };

                var json = JsonSerializer.Serialize(request);
                var content = new StringContent(json, System.Text.Encoding.UTF8, new MediaTypeHeaderValue("application/json"));

                // Call the API endpoint
                var response = await Http.PostAsync("api/StudentProfileCaseRecord", content);
                
                if (response.IsSuccessStatusCode)
                {
                    var responseContent = await response.Content.ReadAsStringAsync();
                    var result = JsonSerializer.Deserialize<JsonElement>(responseContent);
                    
                    if (result.TryGetProperty("success", out var success) && success.GetBoolean())
                    {
                        successCount++;
                    }
                    else
                    {
                        errors.Add($"Failed to create record for {studentRecord.StudentOffenderName}");
                        failCount++;
                    }
                }
                else
                {
                    var errorContent = await response.Content.ReadAsStringAsync();
                    errors.Add($"Server error for {studentRecord.StudentOffenderName}: {response.StatusCode}");
                    failCount++;
                }
            }

            // Show summary message
            if (successCount > 0 && failCount == 0)
            {
                message = $"‚úÖ All {successCount} student case record(s) created successfully!";
                isSuccess = true;
                
                // Update incident status to "Under Review" if linked to an incident
                if (incidentIdFromQuery.HasValue)
                {
                    try
                    {
                        var updateRequest = new { Status = "Under Review" };
                        var updateJson = JsonSerializer.Serialize(updateRequest);
                        var updateContent = new StringContent(updateJson, System.Text.Encoding.UTF8, "application/json");
                        var updateResponse = await Http.PutAsync($"api/IncidentReport/{incidentIdFromQuery.Value}/status", updateContent);
                        
                        if (updateResponse.IsSuccessStatusCode)
                        {
                            Console.WriteLine($"Successfully updated incident {incidentIdFromQuery.Value} status to Under Review");
                        }
                        else
                        {
                            Console.WriteLine($"Failed to update incident status: {updateResponse.StatusCode}");
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Error updating incident status: {ex.Message}");
                    }
                }

                // Update escalation status to "Under Review" if linked to an escalation
                if (escalationIdFromQuery.HasValue)
                {
                    try
                    {
                        var updateResponse = await Http.PutAsync($"api/Escalation/{escalationIdFromQuery.Value}/status?status=UnderReview", null);
                        
                        if (updateResponse.IsSuccessStatusCode)
                        {
                            Console.WriteLine($"Successfully updated escalation {escalationIdFromQuery.Value} status to Under Review");
                        }
                        else
                        {
                            Console.WriteLine($"Failed to update escalation status: {updateResponse.StatusCode}");
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"Error updating escalation status: {ex.Message}");
                    }
                }
                
                await ResetWizardStateAsync();
                
                // Redirect based on where the user came from
                await Task.Delay(2000);
                if (incidentIdFromQuery.HasValue)
                {
                    // If came from incident, go back to POD Dashboard
                    NavigationManager.NavigateTo("/pod-dashboard");
                }
                else
                {
                    // Otherwise go to case records dashboard
                    NavigationManager.NavigateTo("/case-records-dashboard");
                }
            }
            else if (successCount > 0 && failCount > 0)
            {
                message = $"‚ö†Ô∏è Partially completed: {successCount} successful, {failCount} failed. Errors: {string.Join("; ", errors)}";
                isSuccess = false;
            }
            else
            {
                message = $"‚ùå Failed to create case records. Errors: {string.Join("; ", errors)}";
                isSuccess = false;
            }
        }
        catch (Exception ex)
        {
            message = $"Error creating case records: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isLoading = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    // Webcam functionality
    private async Task StartCamera()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("startCamera");
            isCameraActive = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            message = $"Error starting camera: {ex.Message}";
            isSuccess = false;
        }
    }

    private async Task StopCamera()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("stopCamera");
            isCameraActive = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            message = $"Error stopping camera: {ex.Message}";
            isSuccess = false;
        }
    }

    private async Task CapturePhoto()
    {
        try
        {
            var photoData = await JSRuntime.InvokeAsync<string>("capturePhoto");
            if (!string.IsNullOrEmpty(photoData))
            {
                capturedPhotoBase64 = photoData;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            message = $"Error capturing photo: {ex.Message}";
            isSuccess = false;
        }
    }

    private void ClearPhoto()
    {
        capturedPhotoBase64 = string.Empty;
        StateHasChanged();
    }

    // Signature functionality - now handled by direct JavaScript event listeners
    
    private async Task InitializeSignaturePad()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("initializeSignatureCanvas");
        }
        catch (Exception ex)
        {
            // Error initializing signature pad - silently handle
        }
    }

    private async Task SaveSignature()
    {
        try
        {
            var signatureData = await JSRuntime.InvokeAsync<string>("getSignatureData");
            if (!string.IsNullOrEmpty(signatureData))
            {
                signatureBase64 = signatureData;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            message = $"Error saving signature: {ex.Message}";
            isSuccess = false;
        }
    }

    private async Task ClearSignature()
    {
        await JSRuntime.InvokeVoidAsync("clearSignature");
        signatureBase64 = string.Empty;
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Add a longer delay to ensure the canvas is fully rendered
            await Task.Delay(500);
            await JSRuntime.InvokeVoidAsync("initializeSignatureCanvas");
        }
    }

    public void Dispose()
    {
        if (isCameraActive)
        {
            _ = Task.Run(async () => await StopCamera());
        }
    }

    private bool HandleStudentInfoResult(JsonElement dataElement, bool clearExisting)
    {
        var suggestions = ParseStudentInfoSuggestions(dataElement);
        if (!suggestions.Any())
        {
            if (clearExisting)
            {
                studentInfoSuggestions.Clear();
                selectedStudentSuggestion = null;
                _ = InvokeAsync(StateHasChanged);
            }
            return false;
        }

        MergeStudentInfoSuggestions(suggestions, clearExisting);
        return true;
    }

    private List<StudentInfoSuggestion> ParseStudentInfoSuggestions(JsonElement dataElement)
    {
        try
        {
            if (dataElement.ValueKind == JsonValueKind.Array)
            {
                var list = JsonSerializer.Deserialize<List<StudentInfoSuggestion>>(dataElement.GetRawText(), studentInfoJsonOptions);
                return list?.Where(s => s is not null).ToList() ?? new List<StudentInfoSuggestion>();
            }

            if (dataElement.ValueKind == JsonValueKind.Object)
            {
                var single = JsonSerializer.Deserialize<StudentInfoSuggestion>(dataElement.GetRawText(), studentInfoJsonOptions);
                return single is null ? new List<StudentInfoSuggestion>() : new List<StudentInfoSuggestion> { single };
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error parsing student info suggestions: {ex.Message}");
        }

        return new List<StudentInfoSuggestion>();
    }

    private void MergeStudentInfoSuggestions(List<StudentInfoSuggestion> suggestions, bool clearExisting)
    {
        if (clearExisting)
        {
            studentInfoSuggestions.Clear();
        }

        foreach (var suggestion in suggestions)
        {
            if (suggestion is null)
            {
                continue;
            }

            if (studentInfoSuggestions.Any(existing => AreSuggestionsEquivalent(existing, suggestion)))
            {
                continue;
            }

            studentInfoSuggestions.Add(suggestion);
        }

        if (!studentInfoSuggestions.Any())
        {
            _ = InvokeAsync(StateHasChanged);
            return;
        }

        studentInfoSuggestions = studentInfoSuggestions
            .OrderByDescending(s => string.Equals(s.Source, "Student Records", StringComparison.OrdinalIgnoreCase))
            .ThenByDescending(s => ParseGradeLevel(s.GradeLevel))
            .ThenByDescending(s => s.Timestamp ?? DateTime.MinValue)
            .ThenByDescending(s => s.StudentId ?? 0)
            .ToList();

        var bestSuggestion = studentInfoSuggestions.FirstOrDefault();

        if (bestSuggestion is not null && selectedStudentSuggestion == null)
        {
            // Automatically apply the best suggestion on first load
            ApplyStudentSuggestion(bestSuggestion, clearSuggestions: false);
            Console.WriteLine($"[DEBUG] Auto-applied best suggestion for: {bestSuggestion.StudentName}");
        }

        _ = InvokeAsync(StateHasChanged);
    }

    private bool IsAutoGenerated(string fieldName)
    {
        if (selectedStudents == null || currentStudentIndex < 0 || currentStudentIndex >= selectedStudents.Count) return false;
        
        var student = selectedStudents[currentStudentIndex];
        var source = student.Source ?? "";
        
        // Check if the source indicates it's from the official database
        bool isOfficialSource = source.Contains("Database") || source.Contains("Student Records");
        if (!isOfficialSource) return false;

        return fieldName switch
        {
            "FathersName" => !string.IsNullOrWhiteSpace(student.FathersName),
            "MothersName" => !string.IsNullOrWhiteSpace(student.MothersName),
            "GuardianName" => !string.IsNullOrWhiteSpace(student.GuardianName),
            "ParentGuardianContact" => !string.IsNullOrWhiteSpace(student.GuardianContact),
            _ => false
        };
    }

    private static bool AreSuggestionsEquivalent(StudentInfoSuggestion a, StudentInfoSuggestion b)
    {
        // If we have Student IDs from the same source, that's the absolute best comparison
        if (a.StudentId.HasValue && b.StudentId.HasValue && string.Equals(a.Source, b.Source, StringComparison.OrdinalIgnoreCase))
        {
            return a.StudentId.Value == b.StudentId.Value;
        }

        return string.Equals(a.StudentName, b.StudentName, StringComparison.OrdinalIgnoreCase)
            && string.Equals(a.AdviserName, b.AdviserName, StringComparison.OrdinalIgnoreCase)
            && string.Equals(a.GradeLevel, b.GradeLevel, StringComparison.OrdinalIgnoreCase)
            && string.Equals(a.Section, b.Section, StringComparison.OrdinalIgnoreCase)
            && string.Equals(a.TrackStrand, b.TrackStrand, StringComparison.OrdinalIgnoreCase)
            && string.Equals(a.SchoolName, b.SchoolName, StringComparison.OrdinalIgnoreCase);
    }

    private static int ParseGradeLevel(string? gradeLevel)
    {
        if (string.IsNullOrWhiteSpace(gradeLevel))
        {
            return 0;
        }

        var digits = new string(gradeLevel.Where(char.IsDigit).ToArray());
        return int.TryParse(digits, out var parsed) ? parsed : 0;
    }

    private void ToggleStudentSelection(StudentInfoSuggestion suggestion)
    {
        if (suggestion is null) return;
        
        // Check if already selected
        var existing = selectedStudents.FirstOrDefault(s => 
            s.StudentName == suggestion.StudentName && s.Section == suggestion.Section);
        
        if (existing != null)
        {
            // Deselect
            selectedStudents.Remove(existing);
            Console.WriteLine($"[DEBUG] Deselected student: {suggestion.StudentName}");
        }
        else
        {
            // Select
            selectedStudents.Add(suggestion);
            Console.WriteLine($"[DEBUG] Selected student: {suggestion.StudentName} - Total selected: {selectedStudents.Count}");
        }
        
        StateHasChanged();
    }
    
    private void ApplyStudentSuggestion(StudentInfoSuggestion suggestion, bool clearSuggestions = true)
    {
        if (suggestion is null)
        {
            Console.WriteLine("[DEBUG] ApplyStudentSuggestion: suggestion is null");
            return;
        }

        Console.WriteLine($"[DEBUG] ApplyStudentSuggestion called:");
        Console.WriteLine($"[DEBUG]   - StudentName: {suggestion.StudentName}");
        Console.WriteLine($"[DEBUG]   - GradeLevel: {suggestion.GradeLevel}");
        Console.WriteLine($"[DEBUG]   - Section: {suggestion.Section}");
        Console.WriteLine($"[DEBUG]   - TrackStrand: {suggestion.TrackStrand}");
        Console.WriteLine($"[DEBUG]   - AdviserName: {suggestion.AdviserName}");
        Console.WriteLine($"[DEBUG]   - Source: {suggestion.Source}");
        Console.WriteLine($"[DEBUG]   - FathersName: {suggestion.FathersName}");
        Console.WriteLine($"[DEBUG]   - MothersName: {suggestion.MothersName}");
        Console.WriteLine($"[DEBUG]   - GuardianName: {suggestion.GuardianName}");
        Console.WriteLine($"[DEBUG]   - GuardianContact: {suggestion.GuardianContact}");
        Console.WriteLine($"[DEBUG]   - ContactPerson: {suggestion.ContactPerson}");

        selectedStudentSuggestion = suggestion;

        // Only update fields if the suggestion has values - preserve existing values otherwise
        if (!string.IsNullOrWhiteSpace(suggestion.AdviserName))
        {
            Console.WriteLine($"[DEBUG] Setting AdviserName to: {suggestion.AdviserName}");
            caseRecord.AdviserName = suggestion.AdviserName;
        }

        if (!string.IsNullOrWhiteSpace(suggestion.GradeLevel))
        {
            var gradeLevel = suggestion.GradeLevel;
            Console.WriteLine($"[DEBUG] Setting GradeLevel to: {gradeLevel}");
            caseRecord.GradeLevel = gradeLevel;
            OnGradeLevelChanged(new ChangeEventArgs { Value = gradeLevel });
        }

        if (!string.IsNullOrWhiteSpace(suggestion.Section))
        {
            Console.WriteLine($"[DEBUG] Setting Section to: {suggestion.Section}");
            caseRecord.Section = suggestion.Section;
        }

        if (!string.IsNullOrWhiteSpace(suggestion.TrackStrand))
        {
            Console.WriteLine($"[DEBUG] Setting TrackStrand to: {suggestion.TrackStrand}");
            caseRecord.TrackStrand = suggestion.TrackStrand;
        }

        // Always preserve/update student name if suggestion has it
        if (!string.IsNullOrWhiteSpace(suggestion.StudentName))
        {
            Console.WriteLine($"[DEBUG] Setting StudentOffenderName to: {suggestion.StudentName}");
            caseRecord.StudentOffenderName = suggestion.StudentName;
        }

        // Map Guardian Information
        if (!string.IsNullOrWhiteSpace(suggestion.FathersName)) caseRecord.FathersName = suggestion.FathersName;
        if (!string.IsNullOrWhiteSpace(suggestion.MothersName)) caseRecord.MothersName = suggestion.MothersName;
        if (!string.IsNullOrWhiteSpace(suggestion.GuardianName)) caseRecord.GuardianName = suggestion.GuardianName;
        
        bool contactTypeSet = false;
        if (!string.IsNullOrWhiteSpace(suggestion.ContactPerson)) 
        {
            // Map Contact Person Type (ensure it matches frontend logic/values)
            var contactPerson = suggestion.ContactPerson.Trim().ToLower();
            if (contactPerson == "father" || contactPerson == "mother" || contactPerson == "guardian" || contactPerson == "both")
            {
                contactPersonType = contactPerson;
                contactTypeSet = true;
            }
        }
        
        // Fallback: Infer contact person if not explicitly set or invalid
        if (!contactTypeSet)
        {
             if (!string.IsNullOrWhiteSpace(suggestion.FathersName) && !string.IsNullOrWhiteSpace(suggestion.MothersName))
             {
                 contactPersonType = "both";
             }
             else if (!string.IsNullOrWhiteSpace(suggestion.FathersName))
             {
                 contactPersonType = "father";
             }
             else if (!string.IsNullOrWhiteSpace(suggestion.MothersName))
             {
                 contactPersonType = "mother";
             }
             else if (!string.IsNullOrWhiteSpace(suggestion.GuardianName))
             {
                 contactPersonType = "guardian";
             }
        }

        if (!string.IsNullOrWhiteSpace(suggestion.GuardianContact)) caseRecord.ParentGuardianContact = suggestion.GuardianContact;

        Console.WriteLine($"[DEBUG] Final values after ApplyStudentSuggestion:");
        Console.WriteLine($"[DEBUG]   - StudentOffenderName: {caseRecord.StudentOffenderName}");
        Console.WriteLine($"[DEBUG]   - GradeLevel: {caseRecord.GradeLevel}");
        Console.WriteLine($"[DEBUG]   - Section: {caseRecord.Section}");
        Console.WriteLine($"[DEBUG]   - TrackStrand: {caseRecord.TrackStrand}");
        Console.WriteLine($"[DEBUG]   - AdviserName: {caseRecord.AdviserName}");
        Console.WriteLine($"[DEBUG]   - FathersName: {caseRecord.FathersName}");
        Console.WriteLine($"[DEBUG]   - MothersName: {caseRecord.MothersName}");
        Console.WriteLine($"[DEBUG]   - GuardianName: {caseRecord.GuardianName}");
        Console.WriteLine($"[DEBUG]   - ParentGuardianContact: {caseRecord.ParentGuardianContact}");
        Console.WriteLine($"[DEBUG]   - contactPersonType: {contactPersonType}");

        if (clearSuggestions)
        {
            studentInfoSuggestions.Clear();
            teacherSuggestions.Clear();
            showTeacherSuggestions = false;
        }

        _ = InvokeAsync(StateHasChanged);
    }

    private static bool TryGetPropertyCaseInsensitive(JsonElement element, string propertyName, out JsonElement value)
    {
        if (element.ValueKind == JsonValueKind.Object)
        {
            if (element.TryGetProperty(propertyName, out value))
            {
                return true;
            }

            foreach (var property in element.EnumerateObject())
            {
                if (string.Equals(property.Name, propertyName, StringComparison.OrdinalIgnoreCase))
                {
                    value = property.Value;
                    return true;
                }
            }
        }

        value = default;
        return false;
    }

    private class StudentInfoSuggestion
    {
        public int? StudentId { get; set; }
        public int? TeacherId { get; set; }
        public string? StudentName { get; set; }
        public string? AdviserName { get; set; }
        public string? GradeLevel { get; set; }
        public string? Section { get; set; }
        public string? TrackStrand { get; set; }
        public string? SchoolName { get; set; }
        public string? Source { get; set; }
        public DateTime? Timestamp { get; set; }
        public string? FathersName { get; set; }
        public string? MothersName { get; set; }
        public string? GuardianName { get; set; }
        public string? GuardianContact { get; set; }
        public string? ContactPerson { get; set; }
    }
}

@* CSS Styles *@
<style>
    .case-record-header {
        margin-top: 0;
        margin-bottom: 24px;
        padding-top: 20px;
    }

    .case-record-header h2 {
        font-size: 28px;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 12px 0;
    }

    .case-record-header p {
        font-size: 16px;
        color: #64748b;
        margin: 0 0 8px 0;
        line-height: 1.6;
    }

    .case-record-header .filipino-text {
        font-size: 15px;
        color: #6b7280;
        font-style: italic;
    }

    .section-description {
        font-size: 15px;
        color: #6b7280;
        margin-bottom: 20px;
        line-height: 1.5;
    }

    .evidence-section-header {
        margin-top: 30px;
        margin-bottom: 20px;
        padding: 15px 20px;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);
    }

    .evidence-section-header h4 {
        color: #ffffff;
        font-size: 20px;
        font-weight: 700;
        margin: 0 0 5px 0;
    }

    .evidence-section-header p {
        color: rgba(255, 255, 255, 0.9);
        font-size: 14px;
        margin: 0;
    }

    .wizard-stepper-container {
        margin-top: 2rem;
        margin-bottom: 2rem;
        padding-top: 1rem;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .wizard-stepper {
        display: flex;
        align-items: center;
        width: 80%;
        max-width: 700px;
        justify-content: space-between;
        margin: 0 auto 20px auto;
    }

    .step-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        min-width: 70px;
    }

    .step-circle {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #eee;
        color: #aaa;
        font-weight: 600;
        font-size: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.3s, color 0.3s, border 0.3s;
        border: 2px solid #ccc;
        z-index: 2;
    }

    .step-label {
        margin-top: 8px;
        font-size: 14px;
        color: #777;
        font-weight: 500;
        text-align: center;
    }

    .step-item.active .step-circle {
        background: #007bff;
        color: #fff;
        border-color: #007bff;
    }

    .step-item.done .step-circle {
        background: #22bb33;
        color: #fff;
        border-color: #22bb33;
    }

    .step-item.active .step-label {
        color: #007bff;
        font-weight: 700;
    }

    .step-item.done .step-label {
        color: #22bb33;
    }

    .step-line {
        height: 4px;
        flex: 1 1 50px;
        background: #ccc;
        border-radius: 2px;
        margin: 0 2px;
        min-width: 30px;
        max-width: 60px;
        transition: background 0.3s;
    }

    .step-line.done {
        background: #22bb33;
    }

    .wizard-nav {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 12px;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    .wizard-nav .btn {
        margin: 0;
    }

    .review-section {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
    }

    .review-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px;
        margin-top: 12px;
    }

    .review-item {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px 16px;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .review-item.wide {
        grid-column: span 2;
    }

    .review-label {
        font-size: 12px;
        font-weight: 600;
        color: #6b7280;
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }

    .review-value {
        font-size: 15px;
        font-weight: 600;
        color: #111827;
        word-break: break-word;
    }

    .search-container {
        position: relative;
    }

    .suggestions-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
    }

    .suggestion-item {
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s ease;
    }

    .suggestion-item:hover {
        background-color: #f8f9fa;
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .suggestion-item strong {
        display: block;
        color: #333;
        margin-bottom: 4px;
    }

    .suggestion-item small {
        color: #666;
        font-size: 0.85em;
    }

    .student-record-suggestions {
        margin-top: 16px;
        padding: 16px;
        border: 1px dashed #d1d5db;
        border-radius: 8px;
        background-color: #f9fafb;
    }

    .student-record-suggestions .suggestions-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 12px;
    }

    .suggestions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
    }

    .suggestion-card {
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        box-shadow: 0 1px 2px rgba(15, 23, 42, 0.05);
    }

    .suggestion-card.selected {
        border-color: #2563eb;
        box-shadow: 0 4px 10px rgba(37, 99, 235, 0.15);
        background: #eff6ff;
    }

    .suggestion-source {
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #2563eb;
    }

    .suggestion-selected-pill {
        display: inline-block;
        margin-left: 8px;
        padding: 2px 8px;
        border-radius: 999px;
        background: #2563eb;
        color: #fff;
        font-size: 11px;
        font-weight: 600;
    }

    .suggestions-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 16px;
    }

    .suggestions-icon {
        font-size: 20px;
    }

    .suggestion-details {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .suggestion-detail-item {
        display: flex;
        gap: 8px;
        font-size: 14px;
        color: #374151;
    }

    .suggestion-detail-item strong {
        min-width: 100px;
        color: #1f2937;
    }

    .suggestion-detail-item.timestamp {
        font-size: 12px;
        color: #6b7280;
        margin-top: 4px;
        padding-top: 8px;
        border-top: 1px solid #e5e7eb;
    }

    .source-badge {
        display: inline-block;
        padding: 4px 10px;
        background: #dbeafe;
        color: #1e40af;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }

    .suggestion-apply-btn {
        align-self: flex-start;
        margin-top: auto;
    }

    /* Student Records Cards - New Design */
    .student-records-container {
        margin-top: 24px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
        border: 2px solid #e2e8f0;
    }

    .records-header {
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 2px solid #e2e8f0;
    }

    .records-header-left {
        display: flex;
        align-items: flex-start;
        gap: 12px;
    }

    .records-icon {
        font-size: 32px;
        flex-shrink: 0;
    }

    .records-header-left h4 {
        margin: 0 0 4px 0;
        color: #1e293b;
        font-size: 20px;
        font-weight: 700;
    }

    .records-header-left p {
        margin: 0;
        color: #64748b;
        font-size: 14px;
    }

    .student-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 20px;
    }

    .student-info-card {
        background: white;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        display: flex;
        flex-direction: column;
    }

    .student-info-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
        border-color: #0ea5e9;
    }

    .student-info-card.card-selected {
        border-color: #0ea5e9;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        box-shadow: 0 4px 20px rgba(14, 165, 233, 0.25);
    }

    .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        border-bottom: 1px solid #e2e8f0;
    }

    .card-badge {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        background: #0ea5e9;
        color: white;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-icon {
        font-size: 14px;
    }

    .badge-text {
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .selected-badge {
        padding: 4px 10px;
        background: #10b981;
        color: white;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .card-body {
        padding: 16px;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .info-row {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
    }

    .info-row.primary {
        border-bottom: 2px solid #e2e8f0;
        padding-bottom: 12px;
        margin-bottom: 4px;
    }

    .info-row.highlight {
        background: #f8fafc;
        padding: 10px 12px;
        border-radius: 8px;
        border-left: 3px solid #0ea5e9;
    }

    .info-row.adviser-row {
        background: #fef3c7;
        padding: 10px 12px;
        border-radius: 8px;
        border-left: 3px solid #f59e0b;
    }

    .info-row.timestamp-row {
        padding-top: 12px;
        border-top: 1px solid #e2e8f0;
        margin-top: 4px;
    }  

    .info-label {
        font-weight: 600;
        color: #475569;
        font-size: 13px;
        min-width: 120px;
        flex-shrink: 0;
    }

    .info-value {
        color: #1e293b;
        font-size: 14px;
        flex: 1;
        word-break: break-word;
    }

    .info-value.highlight-value {
        color: #0ea5e9;
        font-weight: 700;
        font-size: 15px;
    }

    .info-value.adviser-value {
        color: #92400e;
        font-weight: 600;
    }

    .info-value.timestamp-value {
        color: #64748b;
        font-size: 12px;
    }

    .card-footer {
        padding: 12px 16px;
        background: #f8fafc;
        border-top: 1px solid #e2e8f0;
    }

    .btn-select-record {
        width: 100%;
        padding: 10px 16px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .btn-select-record.btn-primary {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        color: white;
    }

    .btn-select-record.btn-primary:hover {
        background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
    }

    .btn-select-record.btn-selected {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        cursor: default;
    }

    @@media (max-width: 768px) {
        .student-cards-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Auto-filled Section - Individual Cards */
    .auto-filled-section {
        margin-bottom: 24px;
    }

    .auto-filled-header-bar {
        background: linear-gradient(135deg, #4A73C6 0%, #5B8DD9 100%);
        padding: 12px 20px;
        border-radius: 12px 12px 0 0;
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .check-icon {
        width: 24px;
        height: 24px;
        background: white;
        color: #4A73C6;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
        flex-shrink: 0;
    }

    .header-title {
        color: white;
        font-size: 16px;
        font-weight: 600;
    }

    .student-name-header {
        margin-left: auto;
        font-size: 16px;
        font-weight: 700;
        background: rgba(255, 255, 255, 0.25);
        color: white;
        padding: 6px 16px;
        border-radius: 20px;
        letter-spacing: 0.5px;
        border: 2px solid rgba(255, 255, 255, 0.4);
    }

    .info-cards-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 16px;
    }

    .simple-card {
        background: white;
        border: 2px solid #d1d5db;
        border-radius: 10px;
        padding: 24px 26px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .simple-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .simple-card.card-selected {
        border-color: #3b82f6;
        border-width: 2px;
        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
        transform: translateY(-2px);
    }

    @@media (max-width: 768px) {
        .info-cards-container {
            grid-template-columns: 1fr;
        }
    }

    .card-content {
        flex: 1;
    }

    .student-name {
        margin: 0 0 10px 0;
        font-size: 20px;
        font-weight: 700;
        color: #111827;
        letter-spacing: -0.01em;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .selection-checkbox {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 20px;
        height: 20px;
        background: #3b82f6;
        color: white;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
        flex-shrink: 0;
    }

    .selected-count-badge {
        margin-top: 16px;
        padding: 12px 20px;
        background: #dbeafe;
        border: 2px solid #3b82f6;
        border-radius: 6px;
        text-align: center;
        font-weight: 600;
        color: #1e40af;
        font-size: 14px;
    }

    .current-student-indicator {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        margin-bottom: 24px;
        box-shadow: 0 4px 6px rgba(59, 130, 246, 0.2);
    }

    .section-header-with-student {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        gap: 20px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        width: 100%;
        padding-bottom: 10px;
        border-bottom: 2px solid #007bff;
    }

    .section-header-with-student h3 {
        margin: 0;
    }
    
    .offense-description {
        padding-bottom: 0;
        margin-bottom: 20px;
        border-bottom: none;
    }

    .current-student-indicator-inline {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
        padding: 20px 24px;
        margin: 0 0 28px 0;
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border-radius: 12px;
        border-left: 4px solid #0ea5e9;
        box-shadow: 0 2px 8px rgba(14, 165, 233, 0.1);
    }

    .student-counter {
        display: block;
        color: #6b7280;
        font-size: 12px;
        font-weight: 400;
        margin: 0 0 4px 0;
    }

    .current-student-name {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        color: #1f2937;
    }

    .current-student-info {
        margin: 0;
        font-size: 14px;
        color: #6b7280;
        font-weight: 400;
    }

    .student-details {
        margin: 0 0 6px 0;
        font-size: 16px;
        color: #4b5563;
        font-weight: 500;
        line-height: 1.6;
    }

    .teacher-name {
        margin: 0;
        font-size: 15px;
        color: #6b7280;
        font-weight: 500;
    }

    /* Modern Parent/Guardian Section Styles */
    .parent-guardian-section {
        background: #ffffff;
        padding: 32px;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .contact-type-selector {
        margin-bottom: 32px;
        padding: 24px;
        background: #f9fafb;
        border-radius: 12px;
        border: 2px solid #e5e7eb;
    }

    .selector-label {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 20px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 20px;
    }
    
    .selector-label .label-icon {
        font-size: 24px;
    }

    .contact-type-options {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
    }

    .contact-option {
        background: white;
        border: 3px solid #d1d5db;
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
        position: relative;
        min-height: 140px;
    }

    .contact-option:hover {
        border-color: #3b82f6;
        background: #eff6ff;
        transform: translateY(-4px);
        box-shadow: 0 8px 20px rgba(59, 130, 246, 0.2);
    }

    .contact-option.selected {
        border-color: #3b82f6;
        background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
        box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
        transform: translateY(-4px);
    }

    /* Selected Contact Type Display */
    .selected-contact-type-display {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
        border: 2px solid #3b82f6;
        border-radius: 12px;
        padding: 20px 24px;
        margin-top: 16px;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    }

    .selected-type-badge {
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e40af;
    }

    .selected-type-badge .badge-icon {
        font-size: 2rem;
    }

    .selected-type-badge .badge-text {
        font-size: 1.15rem;
    }

    .btn-change-selection {
        background: white;
        color: #3b82f6;
        border: 2px solid #3b82f6;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-change-selection:hover {
        background: #3b82f6;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .btn-change-selection .btn-icon {
        font-size: 1.1rem;
    }

    .option-icon {
        font-size: 56px;
        margin-bottom: 14px;
        line-height: 1;
    }

    .option-content {
        flex: 1;
    }

    .option-title {
        font-size: 18px;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 6px;
    }

    .option-desc {
        font-size: 15px;
        color: #6b7280;
        font-weight: 500;
    }

    .check-mark {
        position: absolute;
        top: 12px;
        right: 12px;
        background: #3b82f6;
        color: white;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: bold;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
        animation: checkPop 0.3s ease-out;
    }

    @@keyframes checkPop {
        0% {
            transform: scale(0);
        }
        50% {
            transform: scale(1.2);
        }
        100% {
            transform: scale(1);
        }
    }

    @@media (max-width: 768px) {
        .contact-type-options {
            grid-template-columns: 1fr 1fr;
        }
    }

    @@media (max-width: 480px) {
        .contact-type-options {
            grid-template-columns: 1fr;
        }
    }

    .section-header-modern {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        margin-bottom: 28px;
        padding-bottom: 0;
        border-bottom: none;
    }

    .section-icon-wrapper {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        padding: 16px;
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .section-icon-large {
        font-size: 48px;
        line-height: 1;
    }

    .section-title-modern {
        font-size: 26px;
        font-weight: 700;
        color: #1e293b;
        margin: 0 0 8px 0;
        letter-spacing: -0.02em;
    }

    .section-subtitle {
        font-size: 16px;
        color: #64748b;
        margin: 0;
        line-height: 1.5;
    }

    .info-note {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
        padding: 16px 20px;
        border-radius: 12px;
        border-left: 4px solid #3b82f6;
        margin-bottom: 28px;
        font-size: 15px;
        line-height: 1.6;
        color: #1e40af;
    }

    .info-icon {
        font-size: 24px;
        flex-shrink: 0;
    }

    .form-row-modern {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
        margin-bottom: 24px;
    }

    .form-group-modern {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .label-modern {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 18px;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 6px;
    }

    .label-icon {
        font-size: 24px;
    }

    .label-badge {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-left: auto;
    }

    .label-badge.optional {
        background: #e5e7eb;
        color: #6b7280;
    }

    .label-badge.required {
        background: #fecaca;
        color: #991b1b;
    }

    .form-control-modern {
        padding: 12px 14px;
        font-size: 14px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        background: #ffffff;
        color: #1f2937;
        font-family: inherit;
        width: 100%;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    
    .form-control-modern:hover {
        border-color: #d1d5db;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    }

    .text-uppercase {
        text-transform: uppercase;
    }

    .form-control-modern:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.12), 0 2px 8px rgba(0, 0, 0, 0.1);
        background: #fafbff;
    }

    .form-control-modern::placeholder {
        color: #9ca3af;
        font-weight: 400;
    }
    
    .form-control-modern:disabled {
        background: #f3f4f6;
        border-color: #e5e7eb;
        color: #9ca3af;
        cursor: not-allowed;
    }
    
    /* Form Labels with Icons */
    .form-label-with-icon {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 15px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 10px;
    }
    
    .label-icon-inline {
        font-size: 16px;
        line-height: 1;
    }
    
    .form-help-text {
        display: block;
        margin-top: 4px;
        font-size: 12px;
        color: #6b7280;
        line-height: 1.4;
    }

    .help-text {
        font-size: 15px;
        color: #6b7280;
        line-height: 1.5;
    }

    .format-example {
        font-weight: 600;
        color: #3b82f6;
        font-size: 15px;
    }

    .validation-error {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 15px;
        color: #dc2626;
        font-weight: 600;
    }

    .validation-success {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 15px;
        color: #16a34a;
        font-weight: 600;
    }

    .error-icon, .success-icon {
        font-size: 18px;
    }

    .contact-group {
        margin-top: 28px;
        padding: 24px;
        background: #f9fafb;
        border-radius: 12px;
        border: 2px dashed #d1d5db;
    }

    .input-with-prefix {
        display: flex;
        align-items: center;
        border: 2px solid #d1d5db;
        border-radius: 10px;
        background: white;
        transition: all 0.2s ease;
    }

    .input-with-prefix:focus-within {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .input-prefix {
        padding: 16px 18px;
        font-size: 17px;
        font-weight: 700;
        color: #3b82f6;
        background: #eff6ff;
        border-right: 2px solid #d1d5db;
        white-space: nowrap;
    }

    .form-control-modern.with-prefix {
        border: none;
        border-radius: 0 10px 10px 0;
        flex: 1;
    }

    .form-control-modern.with-prefix:focus {
        box-shadow: none;
    }

    .btn-outline-modern, .btn-primary-modern {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 28px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 10px;
        border: 2px solid;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .btn-outline-modern {
        background: white;
        color: #3b82f6;
        border-color: #3b82f6;
    }

    .btn-outline-modern:hover {
        background: #eff6ff;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    .btn-primary-modern {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-color: #3b82f6;
    }

    .btn-primary-modern:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.3);
    }

    .btn-icon {
        font-size: 18px;
        font-weight: bold;
    }

    @@media (max-width: 768px) {
        .form-row-modern {
            grid-template-columns: 1fr;
        }

        .section-header-modern {
            flex-direction: column;
            gap: 16px;
        }

        .parent-guardian-section {
            padding: 20px;
        }
    }

    .selected-check {
        font-size: 14px;
        font-weight: 600;
        color: #4A73C6;
        background: white;
        padding: 4px 12px;
        border-radius: 16px;
        border: 1px solid #4A73C6;
    }

    /* Unified Student Section */
    .unified-student-section {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 2px solid #0ea5e9;
    }

    .unified-student-section h3 {
        border-bottom-color: #0ea5e9;
        color: #0c4a6e;
    }

    .no-records-message {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 16px 20px;
        margin: 20px 0;
        text-align: center;
    }

    .no-records-message p {
        margin: 0;
        color: #856404;
        font-weight: 500;
        font-size: 15px;
    }

    /* Auto-filled Grid */
    .auto-filled-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 12px;
    }

    .auto-filled-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 8px 0;
    }
    
    .auto-filled-item .auto-filled-label {
        min-width: 120px;
    }
    
    .auto-filled-item .auto-filled-value {
        flex: 1;
    }

    /* Form Row Layout */
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    @@media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
        
        .auto-filled-grid {
            grid-template-columns: 1fr;
        }
    }

    .form-col {
        width: 100%;
    }

    .adviser-info-display {
        display: flex;
        align-items: center;
        gap: 12px;
        background: white;
        padding: 16px;
        border-radius: 8px;
        border: 2px solid #f59e0b;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);
    }

    .adviser-icon {
        font-size: 32px;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fef3c7;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .adviser-info-content {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
    }

    .adviser-info-content strong {
        color: #92400e;
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .adviser-name-display {
        color: #1e293b;
        font-size: 16px;
        font-weight: 600;
        padding: 4px 0;
    }

    .form-group {
        margin-bottom: 24px;
    }

    /* Inline Form Row - Three fields in one line */
    .form-row-inline {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 24px;
        margin-bottom: 28px;
        align-items: start;
    }

    .form-row-inline .form-group {
        margin-bottom: 0;
    }

    /* Two Column Layout for Level and Number of Offense */
    .form-row-two-cols {
        grid-template-columns: 1fr 1fr !important;
    }

    /* Single Line Layout - All fields in one row */
    .form-row-single-line {
        display: grid;
        grid-template-columns: 200px 2fr 1fr 200px;
        gap: 20px;
        margin-bottom: 28px;
        align-items: start;
    }

    .form-row-single-line .form-group {
        margin-bottom: 0;
    }

    /* Responsive: Stack on smaller screens */
    @@media (max-width: 992px) {
        .form-row-inline {
            grid-template-columns: 1fr;
            gap: 20px;
        }
        
        .form-row-inline .form-group {
            margin-bottom: 20px;
        }
        
        .form-row-inline .form-group:last-child {
            margin-bottom: 0;
        }

        .form-row-single-line {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .form-row-single-line .form-group {
            margin-bottom: 20px;
        }

        .form-row-single-line .form-group:last-child {
            margin-bottom: 0;
        }
    }

    .form-section {
        margin-bottom: 24px;
        padding: 24px 20px;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        background-color: #fafafa;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .form-section h3:not(.section-title-modern):not(.section-header-with-student h3) {
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #007bff;
    }
    
    .form-section h3.section-title-modern {
        border-bottom: none;
        padding-bottom: 0;
    }
    
    .section-header-with-student .section-title-wrapper h3 {
        border-bottom: none;
        padding-bottom: 0;
    }
    
    /* Validation Phase Header - Simple with Icon */
    .validation-phase-header {
        padding: 20px 24px;
        border-bottom: 3px solid #003d82;
        margin-bottom: 32px;
        background: linear-gradient(to right, rgba(0, 61, 130, 0.08), transparent);
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 61, 130, 0.1);
    }

    .validation-phase-header h3 {
        margin: 0;
        color: #003d82;
        font-size: 1.25rem;
        font-weight: 700;
        font-family: 'Poppins', sans-serif;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding-left: 0;
    }

    .phase-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #003d82 0%, #00a8e8 100%);
        color: white;
        border-radius: 50%;
        font-size: 1.1rem;
        font-weight: 700;
        margin-right: 10px;
        box-shadow: 0 2px 8px rgba(0, 61, 130, 0.3);
    }

    .form-actions {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #e0e0e0;
        text-align: center;
    }

    .btn {
        margin: 0 10px;
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background-color: #0056b3;
    }

    .btn-outline {
        background-color: transparent;
        color: #007bff;
        border: 2px solid #007bff;
    }

    .btn-outline:hover {
        background-color: #007bff;
        color: white;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #545b62;
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 6px;
        border: 1px solid transparent;
    }

    .alert-success {
        background-color: #d4edda;
        border-color: #c3e6cb;
        color: #155724;
    }

    .alert-error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
        color: #721c24;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.8);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .text-muted {
        color: #6c757d;
        font-size: 0.875em;
    }

    .text-danger {
        color: #dc3545;
    }

    .text-success {
        color: #28a745;
    }

    .filipino-text {
        font-style: italic;
        color: #666;
    }

    /* Webcam and Photo Styles */
    .photo-capture-container {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 20px;
        background-color: #fafafa;
        margin-bottom: 20px;
    }

    .photo-controls {
        margin-bottom: 15px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .camera-container {
        margin: 15px 0;
        text-align: center;
    }

    .captured-photo-container {
        margin: 15px 0;
        text-align: center;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 2px solid #e9ecef;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
        border: 2px solid #dc3545;
    }

    .btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }

    /* Signature Styles */
    .signature-container {
        border: 2px dashed #ddd;
        border-radius: 8px;
        padding: 20px;
        background-color: #fafafa;
        margin-bottom: 20px;
    }

    .signature-controls {
        margin-bottom: 15px;
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .signature-pad {
        margin: 15px 0;
        text-align: center;
    }

    .signature-instructions {
        margin-top: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }

    .signature-preview {
        margin: 15px 0;
        text-align: center;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 2px solid #e9ecef;
    }

    /* Responsive Design */
    @@media (max-width: 768px) {
        .photo-controls,
        .signature-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .photo-controls .btn,
        .signature-controls .btn {
            margin: 5px 0;
            width: 100%;
        }
        
        #signatureCanvas {
            width: 100% !important;
            max-width: 100% !important;
        }

        .wizard-stepper {
            width: 98%;
            max-width: none;
        }

        .step-label { 
            font-size: 11px; 
        }

        .step-circle { 
            width: 28px; 
            height: 28px; 
            font-size: 14px; 
        }

        .review-summary {
            grid-template-columns: 1fr;
        }

        .review-item.wide {
            grid-column: span 1;
        }

        .section-header-with-student {
            flex-direction: column;
            gap: 16px;
        }

        .current-student-indicator-inline {
            width: 100%;
            max-width: 100%;
            min-width: 100%;
        }
    }
    @@media (max-width: 768px) {
        .suggestions-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    let stream = null;
    let canvas = null;
    let ctx = null;
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;

    // Webcam functions
    window.startCamera = async () => {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'user'
                } 
            });
            
            const video = document.getElementById('cameraVideo');
            if (video) {
                video.srcObject = stream;
            }
        } catch (error) {
            console.error('Error accessing camera:', error);
            alert('Error accessing camera. Please check permissions.');
        }
    };

    window.stopCamera = () => {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
            
            const video = document.getElementById('cameraVideo');
            if (video) {
                video.srcObject = null;
            }
        }
    };

    window.capturePhoto = () => {
        return new Promise((resolve) => {
            const video = document.getElementById('cameraVideo');
            if (!video) {
                resolve('');
                return;
            }

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            ctx.drawImage(video, 0, 0);
            
            const dataURL = canvas.toDataURL('image/jpeg', 0.8);
            const base64 = dataURL.split(',')[1];
            
            resolve(base64);
        });
    };

    // Enhanced Signature functions with LCD Signature Pad support
    let strokeCount = 0;
    let points = [];
    
    window.initializeSignatureCanvas = () => {
        console.log('Initializing enhanced signature canvas with LCD pad support...');
        
        // Try to find the canvas element with retry
        let canvasElement = document.getElementById('signatureCanvas');
        console.log('Canvas element found:', canvasElement);
        
        // If not found, wait a bit and try again
        if (!canvasElement) {
            console.log('Canvas not found, retrying in 200ms...');
            setTimeout(() => {
                canvasElement = document.getElementById('signatureCanvas');
                console.log('Canvas element found on retry:', canvasElement);
                if (canvasElement) {
                    initializeCanvas(canvasElement);
                } else {
                    console.error('Canvas still not found after retry!');
                }
            }, 200);
            return;
        }
        
        initializeCanvas(canvasElement);
    };
    
    function initializeCanvas(canvasElement) {
        if (canvasElement) {
            canvas = canvasElement;
            ctx = canvas.getContext('2d');
            strokeCount = 0;
            points = [];
            
            // Set canvas size
            canvas.width = 500;
            canvas.height = 200;
            
            // Set drawing style
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2.5;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            console.log('Canvas initialized with size:', canvas.width, 'x', canvas.height);
            
            // Modern Pointer Events API - works with mouse, touch, stylus, and LCD signature pads
            canvas.addEventListener('pointerdown', (e) => {
                console.log('Pointer down - Type:', e.pointerType, 'Pressure:', e.pressure);
                isDrawing = true;
                strokeCount++;
                points = [];
                
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                lastX = (e.clientX - rect.left) * scaleX;
                lastY = (e.clientY - rect.top) * scaleY;
                
                points.push({ x: lastX, y: lastY, pressure: e.pressure || 0.5 });
                
                // Detect input type
                if (e.pointerType === 'pen') {
                    console.log('‚úçÔ∏è Stylus/LCD Signature Pad detected!');
                } else if (e.pointerType === 'touch') {
                    console.log('üëÜ Touch input detected');
                } else {
                    console.log('üñ±Ô∏è Mouse input detected');
                }
            });
            
            canvas.addEventListener('pointermove', (e) => {
                if (!isDrawing) return;
                
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                const currentX = (e.clientX - rect.left) * scaleX;
                const currentY = (e.clientY - rect.top) * scaleY;
                const pressure = e.pressure || 0.5;
                
                points.push({ x: currentX, y: currentY, pressure: pressure });
                
                // Draw with pressure sensitivity (if available from signature pad)
                const lineWidth = pressure > 0 ? 1.5 + (pressure * 3) : 2.5;
                
                ctx.lineWidth = lineWidth;
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
                
                lastX = currentX;
                lastY = currentY;
            });
            
            canvas.addEventListener('pointerup', (e) => {
                console.log('Pointer up - Stroke complete');
                if (isDrawing && points.length > 1) {
                    // Smooth the stroke for better quality
                    smoothStroke(points);
                }
                isDrawing = false;
                points = [];
            });
            
            canvas.addEventListener('pointerleave', () => {
                if (isDrawing) {
                    console.log('Pointer left canvas');
                }
                isDrawing = false;
                points = [];
            });
            
            // Prevent default touch behavior to avoid scrolling while signing
            canvas.addEventListener('touchstart', (e) => e.preventDefault());
            canvas.addEventListener('touchmove', (e) => e.preventDefault());
            canvas.addEventListener('touchend', (e) => e.preventDefault());
            
            console.log('‚úÖ Signature canvas initialization complete');
            console.log('üìù Supports: Mouse, Touch, Stylus, and LCD Signature Pads');
        } else {
            console.error('Signature canvas element not found!');
        }
    }
    
    // Smooth strokes for better quality (especially for hardware signature pads)
    function smoothStroke(points) {
        if (points.length < 3) return;
        
        // Simple smoothing algorithm
        for (let i = 1; i < points.length - 1; i++) {
            const prev = points[i - 1];
            const curr = points[i];
            const next = points[i + 1];
            
            // Calculate smoothed position
            const smoothX = (prev.x + curr.x + next.x) / 3;
            const smoothY = (prev.y + curr.y + next.y) / 3;
            
            // Optional: Redraw with smoothed coordinates for final quality
            // This is a lightweight smoothing - keeps performance good
        }
    }

    window.clearSignature = () => {
        if (canvas && ctx) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            strokeCount = 0;
            points = [];
            console.log('Signature cleared');
        }
    };

    window.getSignatureData = () => {
        if (!canvas) {
            console.error('Canvas not initialized');
            return '';
        }
        
        // Validate signature before returning
        if (!isSignatureValid()) {
            console.warn('‚ö†Ô∏è Signature appears to be empty or invalid');
            return '';
        }
        
        console.log('‚úÖ Signature captured successfully');
        return canvas.toDataURL('image/png').split(',')[1];
    };
    
    // Validate that signature is not blank
    function isSignatureValid() {
        if (!canvas || !ctx) return false;
        
        // Check if there were any strokes
        if (strokeCount === 0) {
            console.log('Validation: No strokes detected');
            return false;
        }
        
        // Check if canvas has any non-white pixels
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const pixels = imageData.data;
        
        let hasContent = false;
        for (let i = 0; i < pixels.length; i += 4) {
            const r = pixels[i];
            const g = pixels[i + 1];
            const b = pixels[i + 2];
            
            // Check if pixel is not white (255, 255, 255)
            if (r < 250 || g < 250 || b < 250) {
                hasContent = true;
                break;
            }
        }
        
        if (!hasContent) {
            console.log('Validation: Canvas appears empty');
        } else {
            console.log('Validation: Signature contains', strokeCount, 'stroke(s)');
        }
        
        return hasContent;
    }
</script>
