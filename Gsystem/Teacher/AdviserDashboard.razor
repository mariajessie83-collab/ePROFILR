@page "/adviser-dashboard"
@layout Gsystem.Layout.TeacherLayout
@using System.Text.Json
@using System.Net.Http
@using System.Net.Http.Headers
@using SharedProject
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

<PageTitle>Adviser Dashboard | Student Management</PageTitle>

<style>
    @@keyframes pulse {
        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        70% { transform: scale(1.05); box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    
    .needs-attention-pulse {
        background: #fef2f2;
        border: 1px solid #ef4444;
        box-shadow: 0 2px 5px rgba(239, 68, 68, 0.4);
        animation: pulse 2s infinite;
    }
</style>

<div class="dashboard-container">
    @if (showToast)
    {
        <div class="toast-notification @toastType">
            <div class="toast-content">
                <span class="toast-icon">@toastIcon</span>
                <div class="toast-message">
                    <h4>@toastTitle</h4>
                    <p>@toastMessage</p>
                </div>
            </div>
            <button class="toast-close" @onclick="CloseToast">&times;</button>
        </div>
    }
    <!-- Corporate Header -->
    <div class="dashboard-header-corporate">
        <div class="header-branding">
            <h1>@(string.IsNullOrEmpty(currentTeacherSchoolName) ? "SCHOOL MANAGEMENT SYSTEM" : currentTeacherSchoolName)</h1>
            <div class="school-details">
                @if (!string.IsNullOrEmpty(currentTeacherSchoolId) && currentTeacherSchoolId != "UNKNOWN")
                {
                    <span style="opacity:0.9;">School ID: @currentTeacherSchoolId</span>
                }
            </div>
        </div>
        <div class="header-actions-panel">
            <span class="adviser-badge">
                üë®‚Äçüè´ @(string.IsNullOrEmpty(currentTeacherGradeLevel) ? "Adviser" : currentTeacherGradeLevel) - @(string.IsNullOrEmpty(currentTeacherSection) ? "Section" : currentTeacherSection)
            </span>
        </div>
    </div>

    <!-- Corporate Data Cards -->
    <div class="stats-row-corporate" id="statsCarousel">
        <div class="stat-card-corporate">
            <span class="stat-icon-corner" style="color: #3b82f6; background: rgba(59, 130, 246, 0.1);">üë•</span>
            <span class="stat-value">@totalStudents</span>
            <span class="stat-label">Total Students</span>
        </div>
        <div class="stat-card-corporate">
            <span class="stat-icon-corner" style="color: #10b981; background: rgba(16, 185, 129, 0.1);">‚úÖ</span>
            <span class="stat-value">@activeStudents</span>
            <span class="stat-label">Active Students</span>
        </div>
        <div class="stat-card-corporate">
            <span class="stat-icon-corner" style="color: #f59e0b; background: rgba(245, 158, 11, 0.1);">üìÇ</span>
            <span class="stat-value">@studentCases.Count</span>
            <span class="stat-label">Total Cases</span>
        </div>
        <div class="stat-card-corporate warning-border">
            <span class="stat-icon-corner" style="color: #ef4444; background: rgba(239, 68, 68, 0.1);">‚ö†Ô∏è</span>
            <span class="stat-value">@studentCases.Count(c => c.MinorCases >= 3 && !c.IsEscalated)</span>
            <span class="stat-label">Needs Escalation</span>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="content-card-corporate">
        <!-- Corporate Tabs -->
        <div class="tabs-corporate">
            <button class="tab-item-corp active">
                Students with Cases
            </button>
        </div>

        @if (activeTab == "students") {
            <div class="tab-panel">
                 <!-- Filters -->
                 <div class="filters-bar" style="display:flex; margin-bottom:20px; gap: 10px; align-items: center;">
                     <div class="search-wrapper" style="position:relative; max-width:400px; width:100%;">
                         <span style="position:absolute; left:12px; top:50%; transform:translateY(-50%); opacity:0.5;">üîç</span>
                         <input type="text" placeholder="Search by name, LRN..." @bind="searchTerm" @oninput="OnSearchChanged" class="input-premium" style="padding-left:36px;" />
                     </div>
                     <button class="btn-corporate-primary btn-file-report" @onclick="NavigateToOfficialReport" style="background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); margin-left: auto;">
                         <span>üì¢ File Incident Report</span>
                     </button>
                 </div>

                 <!-- Students Table -->
                 <div class="table-container">
                     @if (isLoading) {
                         <div class="loading-state">
                             <div class="spinner-premium"></div>
                             <p>Loading students...</p>
                         </div>
                     } else if (filteredStudents?.Any() == true) {
                         <table class="table-corporate">
                              <thead>
                                  <tr>
                                      <th>STUDENT</th>
                                      <th>CASE SUMMARY</th>
                                      <th style="text-align: right;">ACTIONS</th>
                                  </tr>
                              </thead>
                              <tbody>
                                  @foreach (var student in filteredStudents) {
                                      @* Parse case counts from Gender field (format: M:1 Mj:0 P:0) *@
                                      var caseParts = student.Gender.Split(' ');
                                      int minorCount = 0, majorCount = 0, prohibitedCount = 0;
                                      foreach (var part in caseParts) {
                                          var split = part.Split(':');
                                          if (split.Length == 2 && int.TryParse(split[1], out int count)) {
                                              if (split[0] == "M") minorCount = count;
                                              else if (split[0] == "Mj") majorCount = count;
                                              else if (split[0] == "P") prohibitedCount = count;
                                          }
                                      }
                                      var totalCases = minorCount + majorCount + prohibitedCount;
                                      @* Badge color logic: 1 Minor = Gray, 2 Minor = Yellow, 3+ Minor = Red *@
                                      var badgeColor = minorCount == 1 ? "#9ca3af" : minorCount == 2 ? "#f59e0b" : minorCount >= 3 ? "#ef4444" : "#3b82f6";
                                      var canEscalate = minorCount >= 3;
                                      
                                      <tr>
                                          <td>
                                              <div class="student-cell" style="display:flex; gap:12px; align-items:center; cursor:pointer;" @onclick="() => EditStudent(student)">
                                                  <div class="avatar-circle" style="width:36px; height:36px; background:linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%); color:#0f4c81; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:1rem; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                                      @student.StudentName.FirstOrDefault()
                                                  </div>
                                                  <div>
                                                      <div style="font-weight:600; color:var(--text-main); text-decoration:underline; text-underline-offset:4px; text-decoration-color:rgba(0,0,0,0.1);">@student.StudentName</div>
                                                      <div style="font-size:0.75rem; color:var(--text-sec);">@student.GradeLevel</div>
                                                  </div>
                                              </div>
                                          </td>
                                          <td>
                                              @* Case Summary: show violation names (repeated) from pre-loaded data; click opens modal *@
                                              @{
                                                  var summaryMinor = preLoadedCaseRecords.TryGetValue(student.StudentName, out var sumRecords) ? sumRecords.Where(r => r.LevelOfOffense != null && r.LevelOfOffense.Contains("Minor", StringComparison.OrdinalIgnoreCase)).Select(r => r.ViolationCommitted ?? "‚Äî").ToList() : new List<string>();
                                                  var summaryMajor = sumRecords != null ? sumRecords.Where(r => r.LevelOfOffense != null && r.LevelOfOffense.Contains("Major", StringComparison.OrdinalIgnoreCase)).Select(r => r.ViolationCommitted ?? "‚Äî").ToList() : new List<string>();
                                                  var summaryProhibited = sumRecords != null ? sumRecords.Where(r => r.LevelOfOffense != null && (r.LevelOfOffense.Contains("Prohibited", StringComparison.OrdinalIgnoreCase) || r.LevelOfOffense.Contains("Grave", StringComparison.OrdinalIgnoreCase))).Select(r => r.ViolationCommitted ?? "‚Äî").ToList() : new List<string>();
                                              }
                                              <div class="case-summary-clickable" style="display:flex; flex-direction:row; gap:4px; flex-wrap:wrap; cursor:pointer; font-size:0.75rem;">
                                                  @if (summaryMinor.Any()) {
                                                      <span @onclick='() => ShowCaseRecordsModal(student.StudentName, "Minor")' @onclick:stopPropagation="true" style="background:#f3f4f6; color:#4b5563; padding:4px 8px; border-radius:8px; border:1px solid #d1d5db; font-weight:500; cursor:pointer;">@summaryMinor.Count Minor</span>
                                                  }
                                                  @if (summaryMajor.Any()) {
                                                      <span @onclick='() => ShowCaseRecordsModal(student.StudentName, "Major")' @onclick:stopPropagation="true" style="background:#fef2f2; color:#ef4444; padding:4px 8px; border-radius:8px; border:1px solid #fca5a5; font-weight:500; cursor:pointer;">@summaryMajor.Count Major</span>
                                                  }
                                                  @if (summaryProhibited.Any()) {
                                                      <span @onclick='() => ShowCaseRecordsModal(student.StudentName, "Prohibited")' @onclick:stopPropagation="true" style="background:#450a0a; color:#fecaca; padding:4px 8px; border-radius:8px; border:1px solid #7f1d1d; font-weight:500; cursor:pointer;">@summaryProhibited.Count Prohibited</span>
                                                  }
                                                  @if (totalCases == 0) {
                                                      <span style="color:#9ca3af; font-size:0.8rem;">No cases</span>
                                                  }
                                                  @if (totalCases > 0 && !summaryMinor.Any() && !summaryMajor.Any() && !summaryProhibited.Any()) {
                                                      <span @onclick='() => ShowCaseRecordsModal(student.StudentName, null)' @onclick:stopPropagation="true" style="background:#f3f4f6; color:#4b5563; padding:4px 8px; border-radius:8px;">@minorCount Minor @(majorCount > 0 ? $", {majorCount} Major" : "") @(prohibitedCount > 0 ? $", {prohibitedCount} Prohibited" : "")</span>
                                                  }
                                              </div>
                                          </td>
                                          <td style="text-align: right;">
                                              <div class="action-buttons-corp" style="display:flex; gap:6px; justify-content: flex-end; align-items:center;">
                                                  @* Escalate to POD notification (only show if 3+ minor cases) *@
                                                  @if (canEscalate) {
                                                      <button class="btn-icon-corp needs-attention-pulse" title="Needs Attention: 3+ Minor Cases" @onclick="() => EscalateToPOD(student)">
                                                          <span style="color:#ef4444; font-size:1.2rem; font-weight:800;">!</span>
                                                      </button>
                                                  }

                                                  @* Edit Button *@
                                                  <button class="btn-icon-corp edit" title="Edit Student" @onclick="() => EditStudent(student)">
                                                      <span style="color: #3b82f6;">‚úèÔ∏è</span>
                                                  </button>
                                                  
                                                  @* Remove Button *@
                                                  <button class="btn-icon-corp delete" title="Delete Student" @onclick="() => DeleteStudent(student)">
                                                      <span style="color: #ef4444;">üóëÔ∏è</span>
                                                  </button>
                                              </div>
                                          </td>
                                      </tr>
                                  }
                              </tbody>
                          </table>
                     } else {
                         <div class="empty-state">
                             <div style="font-size:2rem; opacity:0.5; margin-bottom:10px;">üì¶</div>
                             <h3>No Students Found</h3>
                             <p>You haven't added any students yet or they don't match your search.</p>
                             <button class="btn-corporate-primary" @onclick="ShowAddStudentModal" style="margin: 0 auto;">Add Student</button>
                         </div>
                     }
                 </div>

                 @* Case Records Modal *@

            </div>
        }
        else if (activeTab == "cases") {
            <div class="tab-panel">
                @if (isLoading) {
                    <div class="loading-state">
                        <div class="spinner-premium"></div>
                        <p>Loading cases...</p>
                    </div>
                } else {
                     <div style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                        <h3 style="margin:0; font-size:1.1rem;">Student Case Records</h3>
                        <div style="font-size:0.8rem; display:flex; gap:12px;">
                            <span style="display:flex; align-items:center; gap:4px;"><span style="width:8px; height:8px; border-radius:50%; background:#fcd34d;"></span> Minor</span>
                            <span style="display:flex; align-items:center; gap:4px;"><span style="width:8px; height:8px; border-radius:50%; background:#f97316;"></span> Major</span>
                            <span style="display:flex; align-items:center; gap:4px;"><span style="width:8px; height:8px; border-radius:50%; background:#ef4444;"></span> Prohibited</span>
                        </div>
                    </div>
                    
                    @if (studentCases?.Any() == true) {
                        <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:20px;">
                            @foreach (var studentCase in studentCases) {
                                <div class="stat-card-corporate" style="min-height:auto; display:block; padding:16px;">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
                                        <div style="font-weight:700; font-size:1.05rem;">@studentCase.StudentName</div>
                                        <div style="font-size:0.8rem; background:#eff6ff; color:#1e40af; padding:2px 8px; border-radius:12px;">@(studentCase.ActiveCases > 0 ? studentCase.LatestActiveStatus : "Cleared")</div>
                                    </div>
                                    
                                    <div style="display:flex; flex-wrap:wrap; gap:4px; margin-bottom:16px;">
                                         @if (studentCase.MinorCases > 0) { <span style="background:#fffbeb; color:#b45309; padding:2px 6px; border-radius:4px; font-size:0.75rem;">@studentCase.MinorCases Minor</span> }
                                         @if (studentCase.MajorCases > 0) { <span style="background:#fff7ed; color:#c2410c; padding:2px 6px; border-radius:4px; font-size:0.75rem;">@studentCase.MajorCases Major</span> }
                                         @if (studentCase.ProhibitedCases > 0) { <span style="background:#fef2f2; color:#b91c1c; padding:2px 6px; border-radius:4px; font-size:0.75rem;">@studentCase.ProhibitedCases Prohibited</span> }
                                    </div>
                                    
                                    <div style="display:flex; justify-content:flex-end; gap:8px;">
                                        @if (studentCase.IsEscalated) {
                                            <button class="btn-cancel" @onclick="@(() => WithdrawEscalation(studentCase))" style="font-size:0.8rem; padding:6px 12px;">Withdraw</button>
                                        } else if (studentCase.MinorCases >= 3) {
                                            <button class="btn-save" @onclick="@(() => EscalateStudentToPOD(studentCase))" style="font-size:0.8rem; padding:6px 12px; background:#dc2626;">Escalate</button>
                                        }
                                        <button class="btn-cancel" @onclick="@(() => NavigationManager.NavigateTo("/student-case-records"))" style="font-size:0.8rem; padding:6px 12px; border-color:var(--corp-blue); color:var(--corp-blue);">View Details</button>
                                    </div>
                                </div>
                            }
                        </div>
                    } else {
                        <div class="empty-state">
                             <div style="font-size:2rem; opacity:0.5; margin-bottom:10px;">‚úÖ</div>
                             <h3>No Active Cases</h3>
                             <p>Great job! Your students have no recorded cases.</p>
                        </div>
                    }
                }
            </div>
        }
    </div>

<!-- Add/Edit Student Modal -->
@if (showStudentModal)
{
    <div class="modal-backdrop-premium" @onclick="CloseStudentModal">
        <div class="modal-box-premium" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>@(isEditMode ? "Edit Student Profile" : "Register New Student")</h3>
                <button class="btn-close-modal" @onclick="CloseStudentModal">‚úñÔ∏è</button>
            </div>
            <div class="modal-body">
                <EditForm Model="studentForm" OnValidSubmit="HandleStudentSubmit">
                    <DataAnnotationsValidator />
                    
                    <div class="form-section-title">Personal Information</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Full Name <span class="req">*</span></label>
                            <InputText class="input-premium" placeholder="LAST NAME, FIRST NAME" @bind-Value="studentForm.StudentName" style="text-transform: uppercase;" />
                            <ValidationMessage For="@(() => studentForm.StudentName)" />
                        </div>
                        <div class="form-group">
                            <label>Gender <span class="req">*</span></label>
                            <InputSelect class="input-premium" @bind-Value="studentForm.Gender">
                                <option value="">Select...</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </InputSelect>
                            <ValidationMessage For="@(() => studentForm.Gender)" />
                        </div>
                    </div>

                    <div class="form-section-title">Academic Details</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Grade Level</label>
                            <InputText class="input-premium readonly" @bind-Value="studentForm.GradeLevel" readonly />
                        </div>
                        <div class="form-group">
                            <label>Section</label>
                            <InputText class="input-premium readonly" @bind-Value="studentForm.Section" readonly />
                        </div>
                        @if (ShowStrandField)
                        {
                            <div class="form-group full-width">
                                <label>Strand</label>
                                <InputSelect class="input-premium" @bind-Value="studentForm.Strand">
                                   <option value="">Select Strand</option>
                                   <optgroup label="Academic">
                                       <option value="GAS">GAS</option>
                                       <option value="HUMSS">HUMSS</option>
                                       <option value="STEM">STEM</option>
                                       <option value="ABM">ABM</option>
                                   </optgroup>
                                   <optgroup label="TVL">
                                       <option value="TVL-ICT">TVL-ICT</option>
                                       <option value="TVL-HE">TVL-HE</option>
                                       <option value="TVL-Agri-Fishery">TVL-Agri-Fishery</option>
                                       <option value="TVL-Industrial Arts">TVL-Industrial Arts</option>
                                   </optgroup>
                                   <option value="@studentForm.Strand" selected hidden>@studentForm.Strand</option>
                                </InputSelect>
                            </div>
                        }
                    </div>

                    <div class="form-section-title">Guardian Information</div>
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label>Contact Person <span class="req">*</span></label>
                            <InputSelect class="input-premium" @bind-Value="studentForm.ContactPerson">
                                <option value="">Select...</option>
                                <option value="Father">Father</option>
                                <option value="Mother">Mother</option>
                                <option value="Guardian">Guardian</option>
                                <option value="Both">Both (Father & Mother)</option>
                            </InputSelect>
                        </div>

                        @if (studentForm.ContactPerson == "Father" || studentForm.ContactPerson == "Both")
                        {
                            <div class="form-group">
                                <label>Father's Name <span class="req">*</span></label>
                                <InputText class="input-premium" placeholder="LAST NAME, FIRST NAME" @bind-Value="studentForm.FathersName" style="text-transform: uppercase;" />
                                <ValidationMessage For="@(() => studentForm.FathersName)" />
                            </div>
                        }

                        @if (studentForm.ContactPerson == "Mother" || studentForm.ContactPerson == "Both")
                        {
                            <div class="form-group">
                                <label>Mother's Name <span class="req">*</span></label>
                                <InputText class="input-premium" placeholder="LAST NAME, FIRST NAME" @bind-Value="studentForm.MothersName" style="text-transform: uppercase;" />
                                <ValidationMessage For="@(() => studentForm.MothersName)" />
                            </div>
                        }

                        @if (studentForm.ContactPerson == "Guardian")
                        {
                            <div class="form-group">
                                <label>Guardian's Name <span class="req">*</span></label>
                                <InputText class="input-premium" placeholder="LAST NAME, FIRST NAME" @bind-Value="studentForm.GuardianName" style="text-transform: uppercase;" />
                                <ValidationMessage For="@(() => studentForm.GuardianName)" />
                            </div>
                        }

                        <div class="form-group">
                             <label>Contact Number <span class="req">*</span></label>
                             <div class="input-group">
                                <InputText class="input-premium" placeholder="09xxxxxxxxx" @bind-Value="studentForm.GuardianContact" maxlength="11" />
                             </div>
                             <ValidationMessage For="@(() => studentForm.GuardianContact)" />
                        </div>
                    </div>

                    <div class="modal-actions-premium">
                        <button type="button" class="btn-cancel" @onclick="CloseStudentModal">Cancel</button>
                        <button type="submit" class="btn-save" disabled="@isSubmitting">
                            @if (isSubmitting) { <span class="spinner-sm"></span> }
                            @(isEditMode ? "Save Changes" : "Register Student")
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>
}

@if (showEscalationModal)
{
    <div class="modal-backdrop-premium" @onclick="CloseEscalationModal">
        <div class="modal-box-premium" @onclick:stopPropagation="true" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Escalate to POD?</h3>
                <button class="btn-close-modal" @onclick="CloseEscalationModal">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align:center; padding: 10px 0;">
                    <div style="background:#fef2f2; width:70px; height:70px; border-radius:50%; margin:0 auto 15px; display:flex; align-items:center; justify-content:center; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.1);">
                        <span style="font-size:35px;">‚ö†Ô∏è</span>
                    </div>
                    
                    <h4 style="color:#111827; margin-bottom:10px; font-weight:700;">Confirm Escalation</h4>
                    
                    <p style="color:#4b5563; margin-bottom:20px;">
                        Are you sure you want to escalate <strong>@(escalationCandidate?.StudentName)</strong> to the Prefect of Discipline?
                    </p>
                    
                    <div style="background:#f9fafb; border:1px solid #e5e7eb; border-radius:8px; padding:15px; text-align:left; max-height:200px; overflow-y:auto; margin-bottom:20px;">
                        <div style="font-size:0.8rem; font-weight:700; color:#6b7280; margin-bottom:8px; text-transform:uppercase; letter-spacing:0.5px;">Minor Offenses triggering this:</div>
                        
                        @if (escalationViolations.Any())
                        {
                            <ul style="margin:0; padding-left:20px; color:#374151;">
                                @foreach (var violation in escalationViolations)
                                {
                                    <li style="margin-bottom:4px; font-size:0.95rem;">@violation</li>
                                }
                            </ul>
                        }
                        else
                        {
                            <div style="color:#ef4444; font-style:italic; font-size:0.9rem;">
                                Warning: No specific 'Minor' violations found in system records.
                                <br/><span style="color:#6b7280; font-size:0.85em;">(System will log generic "Multiple Minor Offenses")</span>
                            </div>
                        }
                    </div>

                    <p style="font-size:0.85rem; color:#6b7280; font-style:italic;">
                        Note: This will notify the POD and update the student's case status.
                    </p>
                </div>
            </div>
            
            <div class="modal-actions-premium" style="background:#f9fafb; display:flex; justify-content:flex-end; gap:12px;">
                <button class="btn-cancel" @onclick="CloseEscalationModal">Cancel</button>
                <button class="btn-save" style="background:#ef4444; border-color:#ef4444; color:white;" @onclick="ConfirmEscalation" disabled="@isEscalating">
                    @if (isEscalating)
                    {
                        <span style="display:inline-block; animation:spin 1s linear infinite;">‚è≥</span> <span>Escalating...</span>
                    }
                    else
                    {
                        <span>Confirm Only</span>
                    }
                </button>
            </div>
        </div>
    </div>
}


@if (showCaseRecordsModal)
{
    <div class="modal-backdrop-premium" @onclick="CloseCaseRecordsModal">
        <div class="modal-box-premium" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Case Records: @selectedStudentName</h3>
                <button class="btn-close-modal" @onclick="CloseCaseRecordsModal">&times;</button>
            </div>
            <div class="modal-body">
                @if (isLoadingCaseRecords)
                {
                    <div style="text-align:center; padding:40px;">
                        <span class="spinner-sm" style="width:30px; height:30px; border-width:3px;"></span>
                        <p style="margin-top:10px; color:#6b7280;">Loading records...</p>
                    </div>
                }
                else if (studentCaseRecords.Any())
                {
                    var filteredRecords = GetFilteredCaseRecords(studentCaseRecords, selectedCaseLevelFilter).ToList();
                    if (filteredRecords.Any())
                    {
                        var minorList = filteredRecords.Where(r => r.LevelOfOffense != null && r.LevelOfOffense.Contains("Minor", StringComparison.OrdinalIgnoreCase)).Select(r => r.ViolationCommitted ?? "‚Äî").ToList();
                        var majorList = filteredRecords.Where(r => r.LevelOfOffense != null && r.LevelOfOffense.Contains("Major", StringComparison.OrdinalIgnoreCase)).Select(r => r.ViolationCommitted ?? "‚Äî").ToList();
                        var prohibitedList = filteredRecords.Where(r => r.LevelOfOffense != null && (r.LevelOfOffense.Contains("Prohibited", StringComparison.OrdinalIgnoreCase) || r.LevelOfOffense.Contains("Grave", StringComparison.OrdinalIgnoreCase))).Select(r => r.ViolationCommitted ?? "‚Äî").ToList();

                        <div class="case-records-summary" style="margin-bottom:16px; padding:12px; background:#f8fafc; border-radius:8px; border:1px solid #e2e8f0;">
                            @if (!string.IsNullOrEmpty(selectedCaseLevelFilter))
                            {
                                <div style="font-size:0.75rem; font-weight:700; color:#64748b; margin-bottom:8px;">Showing: <span style="color:#0f4c81;">@selectedCaseLevelFilter only</span></div>
                            }
                            <div style="font-size:0.75rem; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:8px;">Mga violation (value, kasama ulit)</div>
                            @if (minorList.Any())
                            {
                                <div style="margin-bottom:6px;">
                                    <span style="background:#fffbeb; color:#b45309; padding:2px 8px; border-radius:4px; font-size:0.8rem; font-weight:600;">Minor</span>
                                    <span style="margin-left:8px; color:#1e293b; font-size:0.9rem;">@string.Join(", ", minorList)</span>
                                </div>
                            }
                            @if (majorList.Any())
                            {
                                <div style="margin-bottom:6px;">
                                    <span style="background:#fff7ed; color:#c2410c; padding:2px 8px; border-radius:4px; font-size:0.8rem; font-weight:600;">Major</span>
                                    <span style="margin-left:8px; color:#1e293b; font-size:0.9rem;">@string.Join(", ", majorList)</span>
                                </div>
                            }
                            @if (prohibitedList.Any())
                            {
                                <div>
                                    <span style="background:#fef2f2; color:#b91c1c; padding:2px 8px; border-radius:4px; font-size:0.8rem; font-weight:600;">Prohibited</span>
                                    <span style="margin-left:8px; color:#1e293b; font-size:0.9rem;">@string.Join(", ", prohibitedList)</span>
                                </div>
                            }
                        </div>

                        <div style="font-size:0.75rem; font-weight:700; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; margin-bottom:6px;">Detalye bawat case (petsa, violation, level)</div>
                        <table class="table-corporate">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Violation / Uri</th>
                                    <th>Level</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var record in filteredRecords)
                                {
                                    <tr>
                                        <td>@record.DateOfOffense.ToString("MMM dd, yyyy")</td>
                                        <td style="font-weight:600; color:#1e293b;">@(string.IsNullOrEmpty(record.ViolationCommitted) ? "‚Äî" : record.ViolationCommitted)</td>
                                        <td>
                                            <span class="status-badge-corp" style="@(record.LevelOfOffense != null && record.LevelOfOffense.Contains("Minor") ? "background:#fffbeb; color:#b45309;" : 
                                                                                    record.LevelOfOffense != null && record.LevelOfOffense.Contains("Major") ? "background:#fff7ed; color:#c2410c;" : 
                                                                                    "background:#fef2f2; color:#b91c1c;")">
                                                @(string.IsNullOrEmpty(record.LevelOfOffense) ? "‚Äî" : record.LevelOfOffense)
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div style="text-align:center; padding:40px; color:#6b7280;">
                            <div style="font-size:2rem; opacity:0.3; margin-bottom:10px;">üìÇ</div>
                            <p>No @(string.IsNullOrEmpty(selectedCaseLevelFilter) ? "" : selectedCaseLevelFilter + " ")cases for this student.</p>
                        </div>
                    }
                }
                else
                {
                    <div style="text-align:center; padding:40px; color:#6b7280;">
                        <div style="font-size:2rem; opacity:0.3; margin-bottom:10px;">üìÇ</div>
                        <p>No case records found for this student.</p>
                    </div>
                }
            </div>
            <div class="modal-actions-premium">
                <button class="btn-cancel" @onclick="CloseCaseRecordsModal">Close</button>
            </div>
        </div>
    </div>
}
</div>

<style>
    /* Corporate Design Variables - Official Blue Theme */
    :root {
        /* Deep Corporate Blues */
        --corp-navy: #0f4c81;       /* Primary Brand Color */
        --corp-blue: #1e88e5;       /* Action/Highlight */
        --corp-light: #f1f5f9;      /* Backgrounds */
        --corp-white: #ffffff;
        
        --text-main: #1e293b;
        --text-sec: #64748b;
        
        /* Status Colors - Muted/Professional */
        --status-active: #10b981;
        --status-warning: #f59e0b;
        --status-danger: #ef4444;
        
        --shadow-card: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1);
        --border-light: #e2e8f0;
    }

    body {
        background-color: var(--corp-light);
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
        color: var(--text-main);
    }

    /* --- Hamburger Menu Styles Removed --- */

    .dashboard-container {
        max-width: 100%;
        padding: 0 0 40px 0;
        margin: 0;
    }

    /* --- Corporate Header --- */
    .dashboard-header-corporate {
        background-color: var(--corp-navy);
        color: white;
        padding: 20px 40px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .header-branding h1 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
        color: white;
        letter-spacing: -0.5px;
        text-transform: uppercase;
    }

    .header-branding .school-details {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-top: 4px;
        font-weight: 400;
    }

    .header-actions-panel {
        display: flex;
        gap: 16px;
        align-items: center;
    }

    .adviser-badge {
        background: rgba(255,255,255,0.1);
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.85rem;
        border: 1px solid rgba(255,255,255,0.2);
    }

    .btn-corporate-primary {
        background: linear-gradient(135deg, var(--corp-blue) 0%, var(--corp-navy) 100%);
        color: white;
        border: none;
        padding: 10px 22px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 4px 6px rgba(30, 136, 229, 0.2);
    }
    .btn-corporate-primary:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 6px 15px rgba(30, 136, 229, 0.35);
        filter: brightness(1.1);
    }
    .btn-corporate-primary:active {
        transform: translateY(0) scale(0.98);
    }
    .btn-icon-corp {
        background: white;
        border: 1px solid var(--border-light);
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 1rem;
    }
    .btn-icon-corp:hover {
        background: #f8fafc;
        border-color: var(--corp-blue);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    .btn-icon-corp.edit:hover { 
        border-color: #3b82f6; 
        background: rgba(59, 130, 246, 0.1); 
        transform: translateY(-2px) scale(1.1);
        color: #3b82f6;
    }
    .btn-icon-corp.delete:hover { 
        border-color: #ef4444; 
        background: rgba(239, 68, 68, 0.1); 
        transform: translateY(-2px) scale(1.1);
        color: #ef4444;
    }
    

    /* --- Stats Grid (Data Cards) --- */
    .stats-row-corporate {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        padding: 0 40px;
        margin-bottom: 30px;
    }

    .stat-card-corporate {
        background: white;
        border: 1px solid var(--border-light);
        border-left: 4px solid var(--corp-blue); /* Accent Border */
        border-radius: 6px;
        padding: 20px;
        position: relative;
        box-shadow: var(--shadow-card);
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-height: 100px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .stat-card-corporate:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(15, 76, 129, 0.1);
        border-color: var(--corp-blue);
        border-left-width: 6px;
    }
    
    .stat-card-corporate.warning-border {
        border-left-color: var(--status-warning);
    }

    .stat-card-corporate .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-main);
        line-height: 1.1;
        margin-bottom: 4px;
    }

    .stat-card-corporate .stat-label {
        font-size: 0.85rem;
        color: var(--text-sec);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-card-corporate .stat-icon-corner {
        position: absolute;
        top: 15px;
        right: 15px;
        font-size: 1.4rem;
        opacity: 1; /* Full opacity for colors */
        padding: 8px;
        border-radius: 8px;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .stat-card-corporate:hover .stat-icon-corner {
        transform: scale(1.2) rotate(10deg);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    /* --- Content Area --- */
    .content-card-corporate {
        background: white;
        border: 1px solid var(--border-light);
        border-top: 4px solid var(--corp-navy); /* Top Accent */
        border-radius: 6px;
        margin: 0 40px;
        box-shadow: var(--shadow-card);
        overflow: hidden;
    }

    .tabs-corporate {
        display: flex;
        border-bottom: 1px solid var(--border-light);
        background: #f8fafc;
        padding: 0 20px;
    }

    .tab-item-corp {
        padding: 16px 20px;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--text-sec);
        background: transparent;
        border: none;
        border-bottom: 2px solid transparent; /* Prepare for active state */
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .tab-item-corp:hover {
        color: var(--corp-blue);
        background: #f1f5f9;
    }

    .tab-item-corp.active {
        color: var(--corp-navy);
        border-bottom-color: var(--corp-navy);
        background: white;
    }

    .tab-panel {
        padding: 20px;
    }
    
    /* --- Student Table Hover Polish --- */
    .student-cell:hover .avatar-circle {
        transform: scale(1.1) rotate(-8deg);
        box-shadow: 0 4px 12px rgba(15, 76, 129, 0.2) !important;
        border-color: var(--corp-blue) !important;
    }
    .student-cell:hover .student-name-hover {
        color: var(--corp-blue) !important;
    }
    
    .notification-dot {
        width: 8px; height: 8px; background: var(--status-danger); border-radius: 50%;
    }

    /* --- Table Styles (Excel-like) --- */
    .table-corporate {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .table-corporate th {
        background-color: #f1f5f9;
        color: var(--text-main);
        font-weight: 600;
        text-align: left;
        padding: 12px 16px;
        border-bottom: 2px solid var(--border-light);
        text-transform: uppercase;
        font-size: 0.8rem;
    }

    .table-corporate td {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-light);
        color: var(--text-sec);
        vertical-align: middle;
    }

    .table-corporate tr:hover td {
        background-color: #f8fafc;
    }
    
    /* Scrollable Table Container */
    .table-container {
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid var(--border-light);
        border-radius: 8px;
        /* Custom Scrollbar */
        scrollbar-width: thin;
        scrollbar-color: #cbd5e1 #f1f5f9;
    }

    .table-container::-webkit-scrollbar {
        width: 8px;
    }
    
    .table-container::-webkit-scrollbar-track {
        background: #f1f5f9;
    }
    
    .table-container::-webkit-scrollbar-thumb {
        background-color: #cbd5e1;
        border-radius: 4px;
        border: 2px solid #f1f5f9;
    }

    .table-corporate thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #f1f5f9;
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
    }
    
    .status-badge-corp {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
    }
    .status-badge-corp.active { background: #dcfce7; color: #166534; }
    .status-badge-corp.inactive { background: #f1f5f9; color: #64748b; }

    /* --- Utilities & Legacy Support --- */

    /* Form Styles (remapped from premium classes) */
    .input-premium {
        width: 100%; padding: 10px 14px;
        border: 1px solid var(--border-light); border-radius: 6px;
        font-family: inherit; font-size: 0.95rem;
        background: white; color: var(--text-main);
    }
    .input-premium:focus {
        outline: none; border-color: var(--corp-blue);
        box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
    }
    .input-premium.readonly { background: #f8fafc; color: var(--text-sec); cursor: default; }
    
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: var(--text-main); }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
    .full-width { grid-column: span 2; }
    .req { color: var(--status-danger); }

    .modal-actions-premium {
        display: flex; justify-content: flex-end; gap: 12px;
        margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border-light);
    }
    .btn-cancel {
        background: white; border: 1px solid var(--border-light); color: var(--text-sec);
        padding: 10px 18px; border-radius: 6px; font-weight: 600; cursor: pointer;
    }
    .btn-save {
        background: var(--corp-blue); border: none; color: white;
        padding: 10px 18px; border-radius: 6px; font-weight: 600; cursor: pointer;
        display: flex; align-items: center; gap: 8px;
    }
    .btn-save:hover { background-color: #1565c0; }
    
    /* Modal Box - Premium to Corporate Map */
    .modal-backdrop-premium {
        position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;
        display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);
    }
    .modal-box-premium {
        background: white; width: 90%; max-width: 600px; border-radius: 8px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2); overflow: hidden;
    }
    .modal-header {
        background: var(--corp-light); padding: 16px 24px; border-bottom: 1px solid var(--border-light);
        display: flex; justify-content: space-between; align-items: center;
    }
    .modal-header h3 { margin: 0; font-size: 1.1rem; color: var(--text-main); font-weight: 700; }
    .btn-close-modal { background: transparent; border: none; font-size: 1.2rem; cursor: pointer; color: var(--text-sec); }
    
    /* Modal Body Scroll */
    .modal-body { padding: 24px; max-height: 70vh; overflow-y: auto; }

    /* Toast Notifications */
    .toast-notification {
        position: fixed; top: 24px; right: 24px; min-width: 320px;
        background: white; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        padding: 16px; z-index: 9999; border-left: 4px solid var(--corp-blue);
        animation: slideInRight 0.3s ease-out;
    }
    .toast-notification.success { border-left-color: var(--status-active); }
    .toast-notification.error { border-left-color: var(--status-danger); }
    .toast-content { display: flex; gap: 12px; }
    .toast-message h4 { margin: 0 0 4px; font-weight: 600; font-size: 0.95rem; }
    .toast-message p { margin: 0; font-size: 0.85rem; color: var(--text-sec); }
    .toast-close { position: absolute; top: 8px; right: 8px; border: none; background: none; cursor: pointer; color: #94a3b8; }

    @@keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* Loading & Empty */
    .loading-state { text-align: center; padding: 40px; color: var(--text-sec); }
    .spinner-premium {
        width: 32px; height: 32px; border: 3px solid #e2e8f0; border-top-color: var(--corp-blue);
        border-radius: 50%; margin: 0 auto 15px; animation: spin 0.8s linear infinite;
    }
    .empty-state { text-align: center; padding: 40px; }
    .empty-state h3 { font-size: 1.1rem; font-weight: 700; margin: 10px 0; }
    
    /* Misc */
    .action-buttons { display: flex; gap: 8px; justify-content: flex-end; }
    .btn-icon {
        width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
        border-radius: 4px; border: 1px solid var(--border-light); background: white; cursor: pointer;
    }
    .btn-icon:hover { background: #f1f5f9; }

    /* Button Corporate - Icon variant */
    .btn-icon-corp {
        width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
        border-radius: 8px; border: 1px solid var(--border-light); background: white; cursor: pointer;
        transition: all 0.2s;
    }
    .btn-icon-corp:hover { background: #f1f5f9; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .btn-icon-corp.edit:hover { border-color: #3b82f6; background: #eff6ff; }
    .btn-icon-corp.delete:hover { border-color: #ef4444; background: #fef2f2; }

    /* Responsive Adjustments */
    @@media (max-width: 1024px) {
        .stats-row-corporate { grid-template-columns: repeat(2, 1fr); }
    }

    @@media (max-width: 768px) {
        /* Mobile Button Optimization */
        .filters-bar {
            gap: 8px !important;
        }
        
        .btn-file-report {
            font-size: 0.75rem !important; 
            padding: 8px 10px !important;
            white-space: nowrap;
        }

        .search-wrapper {
            flex: 1;
            min-width: 0;
        }

        /* Header responsive */
        .dashboard-header-corporate {
            flex-direction: column;
            align-items: stretch;
            padding: 20px;
            gap: 16px;
            text-align: center;
        }
        
        .header-actions-panel {
            flex-direction: column;
            width: 100%;
            gap: 12px;
        }

        .header-actions-panel .btn-corporate-primary {
            width: 100%;
            justify-content: center;
            margin-right: 0 !important;
        }

        .adviser-badge {
            width: 100%;
        }

        /* Stats Carousel responsive */
        .stats-row-corporate {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            padding: 10px 20px;
            gap: 15px;
            margin-bottom: 20px;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Hide scrollbar for Firefox */
        }
        
        .stats-row-corporate::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome/Safari */
        }

        .stat-card-corporate {
            flex: 0 0 280px; /* Fixed width for carousel items */
            scroll-snap-align: start;
            min-height: 100px;
            padding: 20px;
            border-left-width: 4px;
        }

        .stat-card-corporate .stat-value {
            font-size: 1.8rem;
        }

        /* CONTENT AREA & TABLE - Card-based for no-scroll */
        .table-corporate thead {
            display: none; /* Hide headers on mobile */
        }

        .table-corporate, .table-corporate tbody, .table-corporate tr, .table-corporate td {
            display: block;
            width: 100%;
        }

        .table-corporate tr {
            background: white;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            margin-bottom: 16px;
            padding: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            position: relative;
            box-sizing: border-box;
        }

        .table-corporate td {
            padding: 8px 0 !important;
            border: none !important;
            position: static !important;
            background: transparent !important;
            box-shadow: none !important;
            width: 100% !important;
            min-width: 0 !important;
        }

        /* Re-styling the student cell as header */
        .table-corporate td:first-child {
            border-bottom: 1px solid #f1f5f9 !important;
            margin-bottom: 10px;
            padding-bottom: 12px !important;
        }

        /* Placing actions at the top right */
        .table-corporate td:last-child {
            position: absolute !important;
            top: 12px;
            right: 12px;
            width: auto !important;
            padding: 0 !important;
        }

        .action-buttons-corp {
            gap: 10px !important;
        }

        .table-container {
            padding: 0 10px;
            overflow-x: hidden; /* Prevent all scroll */
            margin: 0;
            max-height: none !important; /* Disable vertical scroll on mobile if card view is used */
            overflow-y: visible !important;
        }

        .content-card-corporate { 
            margin: 0;
            background: transparent;
            box-shadow: none;
        }


        /* HARD HIDE for any pulse leakage on mobile */
        .needs-attention-pulse {
            animation: none !important;
            box-shadow: none !important;
            transform: none !important;
        }
        
        .btn-icon-corp {
            transform: none !important;
        }

        /* Modal responsive */
        .modal-box-premium {
            width: 95%;
            max-width: none;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-body {
            padding: 15px;
        }

        .form-grid {
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .full-width {
            grid-column: span 1;
        }

        .modal-actions-premium {
            flex-direction: column;
            gap: 10px;
        }

        .modal-actions-premium button {
            width: 100%;
        }
    }
</style>
@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("initStatsCarousel", "statsCarousel");
        }
    }

    private List<Studentclass> students = new();
    private List<Studentclass> filteredStudents = new();
    private Studentclass studentForm = new();
    private bool showStudentModal = false;
    private bool isEditMode = false;
    private bool isLoading = true;
    private bool isSubmitting = false;
    private string message = string.Empty;
    private bool isSuccess = false;
    private string searchTerm = string.Empty;
    private string selectedGradeLevel = string.Empty;
    private string selectedSection = string.Empty;
    private List<string> gradeLevels = new();
    private List<string> sections = new();
    private Dictionary<int, bool> passwordVisibilityStates = new();
    private int totalStudents = 0;
    private int activeStudents = 0;
    private int currentTeacherId = 0;
    private string currentTeacherGradeLevel = string.Empty;
    private string currentTeacherSection = string.Empty;
    private string currentTeacherStrand = string.Empty;
    private string currentTeacherSchoolName = string.Empty;
    private string currentTeacherSchoolId = string.Empty;
    private int? currentTeacherSchoolID = null; // Changed to nullable int to allow null values
    private string currentTeacherName = string.Empty;
    private string username = string.Empty;
    
    // Students with cases summary
    private List<StudentCaseSummary> studentsWithCases = new();
    
    // Tab navigation
    private string activeTab = "students";
    
    // Student cases for Cases tab
    private List<StudentCaseDetail> studentCases = new();

    // Violation severity map (IncidentType -> Severity/Category)
    private Dictionary<string, string> violationSeverityMap = new();

    private bool ShowStrandField => !string.IsNullOrEmpty(studentForm.GradeLevel) && 
                                   (studentForm.GradeLevel == "Grade 11" || studentForm.GradeLevel == "Grade 12");

    private string GetStrandDisplay(Studentclass student)
    {
        // Show "N/A" if Strand is empty/null or if grade level is 7-10
        if (string.IsNullOrWhiteSpace(student.Strand))
        {
            return "N/A";
        }
        
        // Check if grade level is 7-10
        if (!string.IsNullOrEmpty(student.GradeLevel))
        {
            var gradeLevel = student.GradeLevel.ToLower();
            if (gradeLevel == "grade 7" || gradeLevel == "grade 8" || 
                gradeLevel == "grade 9" || gradeLevel == "grade 10")
            {
                return "N/A";
            }
        }
        
        return student.Strand;
    }

    private string GetGradeLevelStrandDisplay()
    {
        if (string.IsNullOrEmpty(currentTeacherGradeLevel))
        {
            return "N/A";
        }

        // Get the first student's strand if available
        var firstStudent = students?.FirstOrDefault() ?? filteredStudents?.FirstOrDefault();
        if (firstStudent != null)
        {
            var strand = GetStrandDisplay(firstStudent);
            if (strand != "N/A")
            {
                return $"{currentTeacherGradeLevel} - {strand}";
            }
        }

        return currentTeacherGradeLevel;
    }

    private string GenerateSchoolYear()
    {
        var currentYear = DateTime.Now.Year;
        var currentMonth = DateTime.Now.Month;
        
        // If it's before June, use previous year as start
        // If it's June or after, use current year as start
        var startYear = currentMonth < 6 ? currentYear - 1 : currentYear;
        var endYear = startYear + 1;
        
        return $"{startYear}-{endYear}";
    }


    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentTeacher();
        await LoadViolationSeverityMap();
        await LoadStudents();
        await LoadStudentsWithCases();
    }

    private async Task LoadViolationSeverityMap()
    {
        try
        {
            violationSeverityMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
            
            // 1. Add hardcoded defaults first (as fallback)
            violationSeverityMap["Littering"] = "Minor";
            violationSeverityMap["Glaring Hair/Nail Colors"] = "Minor";
            violationSeverityMap["Indecent Attire in Campus"] = "Minor";
            violationSeverityMap["Late/Unauthorized Absence"] = "Minor";
            violationSeverityMap["Dress Code Violation"] = "Minor";
            violationSeverityMap["Disruptive Behavior"] = "Minor";
            violationSeverityMap["Use of Profane Language"] = "Minor";
            violationSeverityMap["Charging Gadgets in Class"] = "Minor";
            violationSeverityMap["Earrings (Boys)"] = "Minor";
            
            violationSeverityMap["Cheating/Plagiarism"] = "Major";
            violationSeverityMap["Bullying/Harassment"] = "Major";
            violationSeverityMap["Cybercrime/Cyberbullying"] = "Major";
            violationSeverityMap["Forgery/Tampering Records"] = "Major";
            violationSeverityMap["Fraud/Identity Theft"] = "Major";
            violationSeverityMap["Disrespect to Authorities"] = "Major";
            violationSeverityMap["Acts Tarnishing School"] = "Major";
            
            violationSeverityMap["Deadly/Bladed Weapons"] = "Prohibited Acts";
            violationSeverityMap["Fights/Rumbles"] = "Prohibited Acts";
            violationSeverityMap["Entering Under Influence"] = "Prohibited Acts";
            violationSeverityMap["Gambling/Betting"] = "Prohibited Acts";
            violationSeverityMap["Extortion"] = "Prohibited Acts";

            // 2. Fetch from API to get dynamic updates
            string[] categories = { "Prohibited Acts", "Minor", "Major" };
            
            foreach (var category in categories)
            {
                var response = await Http.GetAsync($"api/StudentProfileCaseRecord/violation-types?category={Uri.EscapeDataString(category)}");
                
                if (response.IsSuccessStatusCode)
                {
                    var content = await response.Content.ReadAsStringAsync();
                    var result = JsonSerializer.Deserialize<JsonElement>(content);
                    
                    if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                        result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                    {
                        foreach (var item in data.EnumerateArray())
                        {
                            var violationName = item.GetString();
                            if (!string.IsNullOrEmpty(violationName))
                            {
                                violationSeverityMap[violationName] = category;
                            }
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading violation severity map: {ex.Message}");
        }
    }

    private async Task LoadCurrentTeacher()
    {
        try
        {
            // Get teacher ID from localStorage (set during login)
            var teacherIdStr = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "teacherId");
            username = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "username"); // Use class field
            
            Console.WriteLine($"AdviserDashboard - teacherId from localStorage: '{teacherIdStr}'");
            Console.WriteLine($"AdviserDashboard - username from localStorage: '{username}'");
            
            if (int.TryParse(teacherIdStr, out int teacherId))
            {
                currentTeacherId = teacherId;
                Console.WriteLine($"AdviserDashboard - Using TeacherID: {currentTeacherId}");
            }
            else
            {
                Console.WriteLine($"‚ö†Ô∏è AdviserDashboard - Could not parse teacherId '{teacherIdStr}', will try to load teacher info anyway");
                // Don't set fallback, let LoadTeacherInfo handle the error
            }
            
            // Load teacher information
            await LoadTeacherInfo();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading teacher ID: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
        }
    }

    private async Task LoadTeacherInfo()
    {
        try
        {
            if (currentTeacherId <= 0)
            {
                Console.WriteLine($"‚ö†Ô∏è AdviserDashboard - Invalid TeacherID ({currentTeacherId}), cannot load teacher info");
                // Set default values
                currentTeacherGradeLevel = "Grade 7";
                currentTeacherSection = "A";
                currentTeacherSchoolName = "Unknown School";
                currentTeacherSchoolId = "UNKNOWN";
                return;
            }
            
            Console.WriteLine($"Loading teacher info for TeacherID: {currentTeacherId}");
            var response = await Http.GetAsync($"api/Auth/teachers/{currentTeacherId}");
            Console.WriteLine($"Teacher API response status: {response.StatusCode}");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"Teacher API response content: {content}");
                
                var apiResponse = JsonSerializer.Deserialize<ApiResponse<Teacherclass>>(content, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });
                
                if (apiResponse?.Success == true && apiResponse.Data != null)
                {
                    var teacher = apiResponse.Data;
                    
                    // IMPORTANT: Update currentTeacherId with the actual TeacherID from the response
                    // This ensures we use the correct TeacherID, not UserID
                    if (teacher.TeacherID > 0)
                    {
                        currentTeacherId = teacher.TeacherID;
                        Console.WriteLine($"‚úÖ Updated currentTeacherId to actual TeacherID: {currentTeacherId}");
                    }
                    
                    currentTeacherGradeLevel = teacher.GradeLevel ?? string.Empty;
                    currentTeacherSection = teacher.Section ?? string.Empty;
                    currentTeacherStrand = teacher.Strand ?? string.Empty;
                    currentTeacherSchoolName = teacher.SchoolName ?? string.Empty;
                    currentTeacherSchoolId = teacher.School_ID ?? string.Empty;
                    currentTeacherSchoolID = teacher.SchoolID ?? null; // Keep as null if not available, don't set to 0
                    currentTeacherName = teacher.TeacherName ?? string.Empty;
                    
                    Console.WriteLine($"‚úÖ Teacher loaded successfully - Name: {currentTeacherName}, TeacherID: {currentTeacherId}, Grade: '{currentTeacherGradeLevel}', Section: '{currentTeacherSection}', School: '{currentTeacherSchoolName}', SchoolID: {currentTeacherSchoolID ?? 0}");
                    return; // Success, exit early
                }
                else
                {
                    Console.WriteLine($"‚ùå Failed to load teacher info by TeacherID: {apiResponse?.Message}");
                    Console.WriteLine($"Response Success: {apiResponse?.Success}, Data is null: {apiResponse?.Data == null}");
                    
                    // Try fallback: Load by UserID if TeacherID lookup failed
                    // This handles the case where localStorage has UserID instead of TeacherID
                    Console.WriteLine($"‚ö†Ô∏è Attempting fallback: Loading teacher by UserID ({currentTeacherId})");
                    var fallbackResponse = await Http.GetAsync($"api/Auth/teachers/by-user/{currentTeacherId}");
                    
                    if (fallbackResponse.IsSuccessStatusCode)
                    {
                        var fallbackContent = await fallbackResponse.Content.ReadAsStringAsync();
                        Console.WriteLine($"Fallback API response content: {fallbackContent}");
                        
                        var fallbackApiResponse = JsonSerializer.Deserialize<ApiResponse<Teacherclass>>(fallbackContent, new JsonSerializerOptions
                        {
                            PropertyNameCaseInsensitive = true
                        });
                        
                        if (fallbackApiResponse?.Success == true && fallbackApiResponse.Data != null)
                        {
                            var teacher = fallbackApiResponse.Data;
                            
                            // IMPORTANT: Update currentTeacherId with the actual TeacherID from the response
                            currentTeacherId = teacher.TeacherID;
                            Console.WriteLine($"‚úÖ Found teacher by UserID! Updated currentTeacherId to actual TeacherID: {currentTeacherId}");
                            
                            currentTeacherGradeLevel = teacher.GradeLevel ?? string.Empty;
                            currentTeacherSection = teacher.Section ?? string.Empty;
                            currentTeacherStrand = teacher.Strand ?? string.Empty;
                            currentTeacherSchoolName = teacher.SchoolName ?? string.Empty;
                            currentTeacherSchoolId = teacher.School_ID ?? string.Empty;
                            currentTeacherSchoolID = teacher.SchoolID ?? null;
                            
                            Console.WriteLine($"‚úÖ Teacher loaded successfully via fallback - TeacherID: {currentTeacherId}, Grade: '{currentTeacherGradeLevel}', Section: '{currentTeacherSection}', School: '{currentTeacherSchoolName}', SchoolID: {currentTeacherSchoolID ?? 0}");
                            return; // Success via fallback
                        }
                    }
                    
                    // Both attempts failed
                    Console.WriteLine($"‚ùå Both TeacherID and UserID lookups failed");
                    currentTeacherGradeLevel = "Grade 7";
                    currentTeacherSection = "A";
                    currentTeacherSchoolName = "Unknown School";
                    currentTeacherSchoolId = "UNKNOWN";
                    currentTeacherSchoolID = null;
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Console.WriteLine($"‚ùå Teacher API failed with status: {response.StatusCode}");
                Console.WriteLine($"Error content: {errorContent}");
                
                // Try fallback: Load by UserID
                Console.WriteLine($"‚ö†Ô∏è Attempting fallback: Loading teacher by UserID ({currentTeacherId})");
                var fallbackResponse = await Http.GetAsync($"api/Auth/teachers/by-user/{currentTeacherId}");
                
                if (fallbackResponse.IsSuccessStatusCode)
                {
                    var fallbackContent = await fallbackResponse.Content.ReadAsStringAsync();
                    var fallbackApiResponse = JsonSerializer.Deserialize<ApiResponse<Teacherclass>>(fallbackContent, new JsonSerializerOptions
                    {
                        PropertyNameCaseInsensitive = true
                    });
                    
                    if (fallbackApiResponse?.Success == true && fallbackApiResponse.Data != null)
                    {
                        var teacher = fallbackApiResponse.Data;
                        currentTeacherId = teacher.TeacherID;
                        Console.WriteLine($"‚úÖ Found teacher by UserID! Updated currentTeacherId to actual TeacherID: {currentTeacherId}");
                        
                        currentTeacherGradeLevel = teacher.GradeLevel ?? string.Empty;
                        currentTeacherSection = teacher.Section ?? string.Empty;
                        currentTeacherSchoolName = teacher.SchoolName ?? string.Empty;
                        currentTeacherSchoolId = teacher.School_ID ?? string.Empty;
                        currentTeacherSchoolID = teacher.SchoolID ?? null;
                        return; // Success via fallback
                    }
                }
                
                // Both attempts failed
                currentTeacherGradeLevel = "Grade 7";
                currentTeacherSection = "A";
                currentTeacherSchoolName = "Unknown School";
                currentTeacherSchoolId = "UNKNOWN";
                currentTeacherSchoolID = null;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"‚ùå Error loading teacher info: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            currentTeacherGradeLevel = "Grade 7";
            currentTeacherSection = "A";
            currentTeacherSchoolName = "Unknown School";
            currentTeacherSchoolId = "UNKNOWN";
            currentTeacherSchoolID = null;
        }
    }

    private async Task LoadStudents()
    {
        isLoading = true;
        try
        {
            // Load students with cases from simplifiedincidentreports table, filtered by adviser name
            if (string.IsNullOrEmpty(currentTeacherName))
            {
                Console.WriteLine("‚ö†Ô∏è Current teacher name is empty, cannot load students with cases");
                students = new List<Studentclass>();
                filteredStudents = new List<Studentclass>();
                return;
            }

            // Isang API lang: kukunin students + bawat violation (3 Minor, etc.) sa SimplifiedIncidentReports ‚Äî same source ng count at ng laman ng modal
            Console.WriteLine($"Loading students with cases + violation details for adviser: {currentTeacherName}");
            var response = await Http.GetAsync($"api/IncidentReport/students-with-cases-details/adviser/{Uri.EscapeDataString(currentTeacherName)}");
            
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var apiResponse = JsonSerializer.Deserialize<JsonElement>(content, new JsonSerializerOptions
                {
                    PropertyNameCaseInsensitive = true
                });
                
                if (apiResponse.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    apiResponse.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                {
                    students = new List<Studentclass>();
                    preLoadedCaseRecords.Clear();

                    foreach (var item in data.EnumerateArray())
                    {
                        var studentName = item.TryGetProperty("studentName", out var sn) ? sn.GetString() : "";
                        var totalCases = item.TryGetProperty("totalCases", out var tc) ? tc.GetInt32() : 0;
                        var minorCases = item.TryGetProperty("minorCases", out var mc) ? mc.GetInt32() : 0;
                        var majorCases = item.TryGetProperty("majorCases", out var mjc) ? mjc.GetInt32() : 0;
                        var prohibitedCases = item.TryGetProperty("prohibitedCases", out var pc) ? pc.GetInt32() : 0;
                        var activeCases = item.TryGetProperty("activeCases", out var ac) ? ac.GetInt32() : 0;
                        if (!string.IsNullOrEmpty(studentName))
                        {
                            var student = new Studentclass
                            {
                                StudentName = studentName,
                                IsActive = activeCases > 0,
                                GradeLevel = $"{totalCases} cases",
                                Gender = $"M:{minorCases} Mj:{majorCases} P:{prohibitedCases}",
                                Section = activeCases > 0 ? "Active" : "Resolved"
                            };
                            students.Add(student);

                            // Yung 3 Minor dito galing ‚Äî don din kunin yung laman: violations list for modal (same SimplifiedIncidentReports)
                            if (item.TryGetProperty("cases", out var casesEl) && casesEl.ValueKind == JsonValueKind.Array)
                            {
                                var list = ParseCaseRecordsFromApiData(casesEl);
                                preLoadedCaseRecords[studentName] = list;
                            }
                        }
                    }

                    filteredStudents = students.ToList();
                    UpdateStats();
                    Console.WriteLine($"‚úÖ Loaded {students.Count} students with cases + violation list (same source) for adviser {currentTeacherName}");
                }
            }
            else
            {
                Console.WriteLine($"‚ùå Failed to load students with cases: {response.StatusCode}");
                students = new List<Studentclass>();
                filteredStudents = new List<Studentclass>();
            }
        }
        catch (Exception ex)
        {
            ShowMessage($"Error loading students: {ex.Message}", false);
            Console.WriteLine($"‚ùå Error loading students with cases: {ex.Message}");
            students = new List<Studentclass>();
            filteredStudents = new List<Studentclass>();
        }
        finally
        {
            isLoading = false;
        }
    }

    private void UpdateStats()
    {
        totalStudents = students.Count;
        activeStudents = students.Count(s => s.IsActive);
    }

    private void UpdateFilters()
    {
        gradeLevels = students.Where(s => !string.IsNullOrEmpty(s.GradeLevel))
                             .Select(s => s.GradeLevel!)
                             .Distinct()
                             .OrderBy(g => g)
                             .ToList();
        
        sections = students.Where(s => !string.IsNullOrEmpty(s.Section))
                          .Select(s => s.Section!)
                          .Distinct()
                          .OrderBy(s => s)
                          .ToList();
    }

    private void OnSearchChanged(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? string.Empty;
        FilterStudents();
    }

    private void OnGradeFilterChanged()
    {
        FilterStudents();
    }

    private void OnSectionFilterChanged()
    {
        FilterStudents();
    }

    private void FilterStudents()
    {
        filteredStudents = students.Where(s =>
            (string.IsNullOrEmpty(searchTerm) || s.StudentName.ToLower().Contains(searchTerm.ToLower())) &&
            (string.IsNullOrEmpty(selectedGradeLevel) || s.GradeLevel == selectedGradeLevel) &&
            (string.IsNullOrEmpty(selectedSection) || s.Section == selectedSection)
        ).ToList();
    }

    private async Task LoadStudentsWithCases()
    {
        if (currentTeacherId <= 0)
        {
            return;
        }

        try
        {
            // Load case records
            var caseRecordsUrl = $"api/StudentProfileCaseRecord/teacher/{currentTeacherId}?page=1&pageSize=100";
            var caseRecordsResponse = await Http.GetAsync(caseRecordsUrl);
            
            var allRecords = new List<StudentProfileCaseRecordSummaryFixed>();
            
            if (caseRecordsResponse.IsSuccessStatusCode)
            {
                var content = await caseRecordsResponse.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                {
                    foreach (var recordElement in data.EnumerateArray())
                    {
                        var record = new StudentProfileCaseRecordSummaryFixed();
                        if (recordElement.TryGetProperty("recordID", out var recordId))
                            record.RecordID = recordId.GetInt32();
                        if (recordElement.TryGetProperty("studentOffenderName", out var studentName))
                            record.StudentOffenderName = studentName.GetString() ?? "";
                        if (recordElement.TryGetProperty("gradeLevel", out var gradeLevel))
                            record.GradeLevel = gradeLevel.GetString() ?? "";
                        if (recordElement.TryGetProperty("section", out var section))
                            record.Section = section.GetString() ?? "";
                        if (recordElement.TryGetProperty("status", out var status))
                            record.Status = status.GetString() ?? "";
                        if (recordElement.TryGetProperty("levelOfOffense", out var levelOfOffense))
                            record.LevelOfOffense = levelOfOffense.GetString() ?? "";
                        if (recordElement.TryGetProperty("violationCommitted", out var violationCommitted))
                            record.ViolationCommitted = violationCommitted.GetString() ?? "";
                        else if (recordElement.TryGetProperty("ViolationCommitted", out var violationCommittedCase))
                            record.ViolationCommitted = violationCommittedCase.GetString() ?? "";
                        allRecords.Add(record);
                    }
                }
            }
            
            // Load incident reports
            var incidentReportsUrl = $"api/IncidentReport/teacher/{currentTeacherId}?page=1&pageSize=100";
            var incidentReportsResponse = await Http.GetAsync(incidentReportsUrl);
            
            if (incidentReportsResponse.IsSuccessStatusCode)
            {
                var content = await incidentReportsResponse.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                {
                    foreach (var reportElement in data.EnumerateArray())
                    {
                        var record = new StudentProfileCaseRecordSummaryFixed();
                        if (reportElement.TryGetProperty("incidentID", out var incidentId))
                            record.RecordID = -incidentId.GetInt32();
                        
                        string studentName = "";
                        if (reportElement.TryGetProperty("respondentName", out var respondentName))
                            studentName = respondentName.GetString() ?? "";
                        else if (reportElement.TryGetProperty("victimName", out var victimName))
                            studentName = victimName.GetString() ?? "";
                        
                        record.StudentOffenderName = studentName;
                        if (reportElement.TryGetProperty("status", out var status))
                            record.Status = status.GetString() ?? "";

                        // Map IncidentType to LevelOfOffense
                        if (reportElement.TryGetProperty("incidentType", out var iType))
                        {
                            var typeStr = iType.GetString();
                            if (!string.IsNullOrEmpty(typeStr))
                            {
                                record.ViolationCommitted = typeStr; // Map IncidentType to ViolationCommitted
                                // Try exact match first
                                if (violationSeverityMap.TryGetValue(typeStr, out var severity))
                                {
                                    record.LevelOfOffense = severity;
                                }
                                else
                                {
                                    // Try case-insensitive keys
                                    var key = violationSeverityMap.Keys.FirstOrDefault(k => k.Equals(typeStr, StringComparison.OrdinalIgnoreCase));
                                    if (key != null)
                                    {
                                        record.LevelOfOffense = violationSeverityMap[key];
                                    }
                                    else
                                    {
                                        // Fallback: If map fails, just store the type itself so we can at least see it,
                                        // or if it contains keywords.
                                        if (typeStr.Contains("Minor", StringComparison.OrdinalIgnoreCase)) record.LevelOfOffense = "Minor";
                                        else if (typeStr.Contains("Major", StringComparison.OrdinalIgnoreCase)) record.LevelOfOffense = "Major";
                                        else if (typeStr.Contains("Prohibited", StringComparison.OrdinalIgnoreCase)) record.LevelOfOffense = "Prohibited Acts";
                                        else record.LevelOfOffense = typeStr; // Store raw type as fallback
                                    }
                                }
                            }
                        }
                        
                        allRecords.Add(record);
                    }
                }
            }
            
            // Group by student name
            studentsWithCases = allRecords
                .Where(r => !string.IsNullOrEmpty(r.StudentOffenderName))
                .GroupBy(r => r.StudentOffenderName)
                .Select(g => new StudentCaseSummary
                {
                    StudentName = g.Key,
                    GradeLevel = "",
                    Section = "",
                    CaseCount = g.Count(),
                    ActiveCases = g.Count(r => !r.Status.Equals("Resolved", StringComparison.OrdinalIgnoreCase) && !r.Status.Equals("Closed", StringComparison.OrdinalIgnoreCase)),
                    ResolvedCases = g.Count(r => r.Status.Equals("Resolved", StringComparison.OrdinalIgnoreCase)),
                    ClosedCases = g.Count(r => r.Status.Equals("Closed", StringComparison.OrdinalIgnoreCase))
                })
                .OrderByDescending(s => s.CaseCount)
                .ThenBy(s => s.StudentName)
                .ToList();
            
            // Populate studentCases for Cases tab with severity breakdown
            studentCases = allRecords
                .Where(r => !string.IsNullOrEmpty(r.StudentOffenderName))
                .GroupBy(r => r.StudentOffenderName)
                .Select(g => new StudentCaseDetail
                {
                    StudentName = g.Key,
                    GradeLevel = g.FirstOrDefault()?.GradeLevel ?? "",
                    Section = g.FirstOrDefault()?.Section ?? "",
                    TotalCases = g.Count(),
                    MinorCases = g.Count(r => r.LevelOfOffense != null && r.LevelOfOffense.Contains("Minor", StringComparison.OrdinalIgnoreCase)),
                    MajorCases = g.Count(r => r.LevelOfOffense != null && r.LevelOfOffense.Contains("Major", StringComparison.OrdinalIgnoreCase)),
                    ProhibitedCases = g.Count(r => r.LevelOfOffense != null && (r.LevelOfOffense.Contains("Prohibited", StringComparison.OrdinalIgnoreCase) || r.LevelOfOffense.Contains("Grave", StringComparison.OrdinalIgnoreCase))),
                    ActiveCases = g.Count(r => !r.Status.Equals("Resolved", StringComparison.OrdinalIgnoreCase) && !r.Status.Equals("Closed", StringComparison.OrdinalIgnoreCase)),
                    ResolvedCases = g.Count(r => r.Status.Equals("Resolved", StringComparison.OrdinalIgnoreCase)),
                    MinorViolations = g.Where(r => r.LevelOfOffense != null && r.LevelOfOffense.Contains("Minor", StringComparison.OrdinalIgnoreCase))
                                      .Select(r => r.ViolationCommitted ?? "Unknown")
                                      .ToList(),
                    MajorViolations = g.Where(r => r.LevelOfOffense != null && r.LevelOfOffense.Contains("Major", StringComparison.OrdinalIgnoreCase))
                                      .Select(r => r.ViolationCommitted ?? "Unknown")
                                      .ToList(),
                    ProhibitedViolations = g.Where(r => r.LevelOfOffense != null && (r.LevelOfOffense.Contains("Prohibited", StringComparison.OrdinalIgnoreCase) || r.LevelOfOffense.Contains("Grave", StringComparison.OrdinalIgnoreCase)))
                                           .Select(r => r.ViolationCommitted ?? "Unknown")
                                           .ToList(),
                    LatestActiveStatus = g.Where(r => !r.Status.Equals("Resolved", StringComparison.OrdinalIgnoreCase) && !r.Status.Equals("Closed", StringComparison.OrdinalIgnoreCase))
                                         .Select(r => r.Status)
                                         .FirstOrDefault() ?? "Active"
                })
                .OrderByDescending(s => s.TotalCases)
                .ThenBy(s => s.StudentName)
                .ToList();
            
            // Check escalation status for each student
            await CheckEscalationStatuses();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading students with cases: {ex.Message}");
        }
    }

    // Student case summary class
    private class StudentCaseSummary
    {
        public string StudentName { get; set; } = string.Empty;
        public string GradeLevel { get; set; } = string.Empty;
        public string Section { get; set; } = string.Empty;
        public int CaseCount { get; set; }
        public int ActiveCases { get; set; }
        public int ResolvedCases { get; set; }
        public int ClosedCases { get; set; }
    }

    // Student case detail class for Cases tab
    private class StudentCaseDetail
    {
        public string StudentName { get; set; } = string.Empty;
        public string GradeLevel { get; set; } = string.Empty;
        public string Section { get; set; } = string.Empty;
        public int TotalCases { get; set; }
        public int MinorCases { get; set; }
        public int MajorCases { get; set; }
        public int ProhibitedCases { get; set; }
        public int ActiveCases { get; set; }
        public int ResolvedCases { get; set; }
        public bool IsEscalated { get; set; }
        public int? EscalationID { get; set; }
        public List<string> MinorViolations { get; set; } = new List<string>();
        public List<string> MajorViolations { get; set; } = new List<string>();
        public List<string> ProhibitedViolations { get; set; } = new List<string>();
        public string LatestActiveStatus { get; set; } = "Active";
    }



    // Fixed summary class with ViolationCommitted
    private class StudentProfileCaseRecordSummaryFixed
    {
        public int RecordID { get; set; }
        public string StudentOffenderName { get; set; } = "";
        public string GradeLevel { get; set; } = "";
        public string Section { get; set; } = "";
        public string Status { get; set; } = "";
        public string LevelOfOffense { get; set; } = "";
        public string ViolationCommitted { get; set; } = "";
    }

    // Toast Notification logic
    private bool showToast = false;
    private string toastType = "success";
    private string toastTitle = "";
    private string toastMessage = "";
    private string toastIcon = "";

    private void ShowToast(string title, string message, string type)
    {
        toastTitle = title;
        toastMessage = message;
        toastType = type;
        showToast = true;

        switch (type)
        {
            case "success":
                toastIcon = "‚úÖ";
                break;
            case "error":
                toastIcon = "‚ùå";
                break;
            case "warning":
                toastIcon = "‚ö†Ô∏è";
                break;
            default:
                toastIcon = "‚ÑπÔ∏è";
                break;
        }

        StateHasChanged();

        // Auto-close after 5 seconds
        var timer = new System.Timers.Timer(5000);
        timer.Elapsed += (sender, e) =>
        {
            showToast = false;
            InvokeAsync(StateHasChanged);
            timer.Dispose();
        };
        timer.AutoReset = false;
        timer.Start();
    }

    private void CloseToast()
    {
        showToast = false;
    }

    private void NavigateToOfficialReport()
    {
        NavigationManager.NavigateTo("/official-incident-report");
    }

    private void SetActiveTab(string tab)
    {
        activeTab = tab;
        StateHasChanged();
    }

    // Check escalation status for all students
    private async Task CheckEscalationStatuses()
    {
        try
        {
            foreach (var student in studentCases)
            {
                // Try to get authoritative Grade/Section from masterlist first
                var masterStudent = students.FirstOrDefault(s => s.StudentName.Equals(student.StudentName, StringComparison.OrdinalIgnoreCase));
                var gradeToCheck = masterStudent?.GradeLevel ?? student.GradeLevel;
                var sectionToCheck = masterStudent?.Section ?? student.Section;

                // Ensure we don't send empty strings which cause HTTP 400
                var gradeArg = string.IsNullOrWhiteSpace(gradeToCheck) ? "N/A" : gradeToCheck;
                var sectionArg = string.IsNullOrWhiteSpace(sectionToCheck) ? "N/A" : sectionToCheck;

                var response = await Http.GetAsync($"api/Escalation/status?studentName={Uri.EscapeDataString(student.StudentName)}&gradeLevel={Uri.EscapeDataString(gradeArg)}&section={Uri.EscapeDataString(sectionArg)}");
                
                if (response.IsSuccessStatusCode)
                {
                    var content = await response.Content.ReadAsStringAsync();
                    var result = JsonSerializer.Deserialize<JsonElement>(content);        
                    if (result.TryGetProperty("isEscalated", out var isEscalated) && isEscalated.GetBoolean())
                    {
                        student.IsEscalated = true;
                        if (result.TryGetProperty("data", out var data) && data.TryGetProperty("escalationID", out var escalationId))
                        {
                            student.EscalationID = escalationId.GetInt32();
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking escalation statuses: {ex.Message}");
        }
    }

    // Escalate student to POD
    private async Task EscalateStudentToPOD(StudentCaseDetail student)
    {
        try
        {
            // 1. Get authoritative data from students master list
            var masterStudent = students.FirstOrDefault(s => s.StudentName.Equals(student.StudentName, StringComparison.OrdinalIgnoreCase));
            
            // Fallback to student case record data if not found (though it should be found)
            var actualGrade = masterStudent?.GradeLevel ?? student.GradeLevel;
            var actualSection = masterStudent?.Section ?? student.Section;
            var actualSchoolName = masterStudent?.SchoolName ?? currentTeacherSchoolName;

            // 2. Gather case details (list of offenses)
            // We need to look at studentsWithCases to find the details, or potentially reloading logic might be needed if details aren't stored.
            // But we can approximate it from the counts or better, fetch the records or filter from 'allRecords' if we kept it.
            // Since we don't have 'allRecords' valid here (it's local to LoadStudentsWithCases), we will reconstruct a simple summary.
            // A better approach would be to fetch the active cases for this student.
            // For now, we'll create a summary string.
            
            // Use the local data we already have - no need for extra API call
        string caseDetailsSummary;
        if (student.MinorViolations != null && student.MinorViolations.Any())
        {
            caseDetailsSummary = string.Join(", ", student.MinorViolations);
        }
        else
        {
            caseDetailsSummary = $"Minor: {student.MinorCases}, Major: {student.MajorCases}, Prohibited: {student.ProhibitedCases}";
        }

            var request = new
            {
                studentName = student.StudentName,
                gradeLevel = actualGrade,
                section = actualSection,
                schoolName = actualSchoolName,
                minorCaseCount = student.MinorCases,
                caseDetails = caseDetailsSummary, 
                notes = $"Escalated by {(string.IsNullOrEmpty(currentTeacherName) ? username : currentTeacherName)} - Student has {student.MinorCases} minor cases"
            };

            var json = JsonSerializer.Serialize(request);
            var httpContent = new StringContent(json, System.Text.Encoding.UTF8, "application/json");

            var displayEscalatedBy = !string.IsNullOrEmpty(currentTeacherName) ? currentTeacherName : username;
            var response = await Http.PostAsync($"api/Escalation/escalate?escalatedBy={Uri.EscapeDataString(displayEscalatedBy)}&teacherId={currentTeacherId}", httpContent);

            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                
                if (result.TryGetProperty("data", out var data) && data.TryGetProperty("escalationId", out var escalationId))
                {
                    student.IsEscalated = true;
                    student.EscalationID = escalationId.GetInt32();
                    // Update the master student reference too just in case
                    if(masterStudent != null) 
                    {
                        // Any local state on masterStudent related to escalation? Currently no property on Studentclass.
                    }
                    
                    StateHasChanged();
                    
                    ShowToast("Escalation Successful", $"Successfully sent {student.StudentName} to POD Dashboard!", "success");
                }
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                ShowToast("Escalation Failed", $"Error: {errorContent}", "error");
            }
        }
        catch (Exception ex)
        {
            ShowToast("System Error", $"Error escalating student: {ex.Message}", "error");
        }
    }

    // Withdraw escalation
    private async Task WithdrawEscalation(StudentCaseDetail student)
    {
        if (!student.EscalationID.HasValue)
            return;

        try
        {
            var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to withdraw {student.StudentName} from POD Dashboard?");
            if (!confirmed)
                return;

            var response = await Http.DeleteAsync($"api/Escalation/{student.EscalationID.Value}?teacherId={currentTeacherId}");

            if (response.IsSuccessStatusCode)
            {
                student.IsEscalated = false;
                student.EscalationID = null;
                StateHasChanged();
                
                ShowToast("Escalation Withdrawn", $"{student.StudentName} has been removed from POD Dashboard", "success");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                ShowToast("Withdrawal Failed", $"Error: {errorContent}", "error");
            }
        }
        catch (Exception ex)
        {
            ShowToast("System Error", $"Error withdrawing escalation: {ex.Message}", "error");
        }
    }

    private void OnGradeLevelChanged()
    {
        if (!ShowStrandField)
        {
            studentForm.Strand = string.Empty;
        }
    }

    // Password visibility toggle methods
    private void TogglePasswordVisibility(int studentId)
    {
        if (passwordVisibilityStates.ContainsKey(studentId))
        {
            passwordVisibilityStates[studentId] = !passwordVisibilityStates[studentId];
        }
        else
        {
            passwordVisibilityStates[studentId] = true;
        }
    }

    private bool IsPasswordVisible(int studentId)
    {
        return passwordVisibilityStates.ContainsKey(studentId) && passwordVisibilityStates[studentId];
    }

    private void ShowAddStudentModal()
    {
        // Check if teacher info is loaded
        if (currentTeacherId <= 0)
        {
            ShowMessage("Error: Teacher information not loaded. Please refresh the page or logout and login again.", false);
            Console.WriteLine($"‚ùå Cannot open add student modal - Invalid TeacherID: {currentTeacherId}");
            return;
        }
        
        Console.WriteLine($"Opening modal with - TeacherID: {currentTeacherId}, Grade: '{currentTeacherGradeLevel}', Section: '{currentTeacherSection}', School: '{currentTeacherSchoolName}'");
        
        studentForm = new Studentclass
        {
            TeacherID = currentTeacherId, // Ensure TeacherID is set correctly
            GradeLevel = currentTeacherGradeLevel, // Auto-populate from teacher's grade
            Section = currentTeacherSection, // Auto-populate from teacher's section
            Strand = ShowStrandField ? currentTeacherStrand : null, // Only set strand for Grade 11-12
            SchoolYear = GenerateSchoolYear(), // Auto-generate school year
            SchoolName = currentTeacherSchoolName, // Auto-populate from teacher's school
            School_ID = currentTeacherSchoolId, // Auto-populate from teacher's school
            SchoolID = currentTeacherSchoolID, // Auto-populate from teacher's school ID
            IsActive = true
        };
        
        Console.WriteLine($"Form populated - TeacherID: {studentForm.TeacherID}, Grade: '{studentForm.GradeLevel}', Section: '{studentForm.Section}', School Year: '{studentForm.SchoolYear}', School: '{studentForm.SchoolName}', SchoolID: {studentForm.SchoolID}");
        
        isEditMode = false;
        showStudentModal = true;
        StateHasChanged(); // Force UI update
    }

    private void EditStudent(Studentclass student)
    {
        studentForm = new Studentclass
        {
            StudentID = student.StudentID,
            UserID = student.UserID,
            StudentName = student.StudentName,
            Gender = student.Gender,
            GradeLevel = student.GradeLevel,
            Section = student.Section,
            Strand = student.Strand,
            SchoolYear = student.SchoolYear,
            ParentName = student.ParentName,
            ParentContact = student.ParentContact,
            Address = student.Address,
            BirthDate = student.BirthDate,
            TeacherID = currentTeacherId,
            SchoolID = student.SchoolID,
            SchoolName = student.SchoolName,
            School_ID = student.School_ID,
            IsActive = student.IsActive
        };
        isEditMode = true;
        showStudentModal = true;
    }

    private void CloseStudentModal()
    {
        showStudentModal = false;
        studentForm = new();
        isEditMode = false;
    }

    private void PreventNavigation()
    {
        // This method can be used to prevent navigation away from adviser dashboard
        // You can add logic here to show a confirmation dialog
    }

    private async Task HandleStudentSubmit()
    {
        if (isSubmitting) return;
        
        isSubmitting = true;
        try
        {
            if (isEditMode)
            {
                await UpdateStudent();
            }
            else
            {
                await AddStudent();
            }
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task AddStudent()
    {
        try
        {
            // Validate TeacherID first - must be valid and > 0
            if (currentTeacherId <= 0)
            {
                ShowMessage("Error: Invalid Teacher ID. Please logout and login again to refresh your session.", false);
                Console.WriteLine($"‚ùå Cannot add student - Invalid TeacherID: {currentTeacherId}");
                return;
            }
            
            // Validate SchoolID - if it's 0 or null, set it to null (don't send invalid SchoolID)
            int? validSchoolID = studentForm.SchoolID;
            if (validSchoolID <= 0)
            {
                Console.WriteLine($"‚ö†Ô∏è Invalid SchoolID ({studentForm.SchoolID}), setting to null");
                validSchoolID = null;
            }
            
            Console.WriteLine($"Adding student with TeacherID: {currentTeacherId}, SchoolID: {validSchoolID}, SchoolName: '{studentForm.SchoolName}', School_ID: '{studentForm.School_ID}'");
            
            // Ensure TeacherID is set correctly
            if (studentForm.TeacherID != currentTeacherId)
            {
                Console.WriteLine($"‚ö†Ô∏è TeacherID mismatch - Form: {studentForm.TeacherID}, Current: {currentTeacherId}. Using currentTeacherId.");
                studentForm.TeacherID = currentTeacherId;
            }
            
            // Create a registration request with auto-generated username and password
            var registrationRequest = new StudentRegistrationRequest
            {
                StudentName = studentForm.StudentName,
                Gender = studentForm.Gender,
                GradeLevel = studentForm.GradeLevel,
                Section = studentForm.Section,
                Strand = ShowStrandField ? studentForm.Strand : null, // Only include strand for Grade 11-12
                SchoolYear = studentForm.SchoolYear,
                ParentName = studentForm.ParentName,
                ParentContact = studentForm.ParentContact,
                Address = studentForm.Address,
                BirthDate = studentForm.BirthDate,
                SchoolID = validSchoolID, // Use validated SchoolID (null if invalid)
                SchoolName = studentForm.SchoolName,
                School_ID = studentForm.School_ID,

                TeacherID = currentTeacherId, // Use currentTeacherId directly to ensure it's correct
                // Map Guardian Info
                FathersName = studentForm.FathersName,
                MothersName = studentForm.MothersName,
                GuardianName = studentForm.GuardianName,
                GuardianContact = studentForm.GuardianContact,
                ContactPerson = studentForm.ContactPerson
            };

            var json = JsonSerializer.Serialize(registrationRequest);
            var content = new StringContent(json, System.Text.Encoding.UTF8, new MediaTypeHeaderValue("application/json"));

            Console.WriteLine($"Sending student registration request: {json}");

            var response = await Http.PostAsync("api/Auth/register/student", content);
            var responseContent = await response.Content.ReadAsStringAsync();

            Console.WriteLine($"Add Student Response: {response.StatusCode}");
            Console.WriteLine($"Add Student Content: {responseContent}");

            if (response.IsSuccessStatusCode)
            {
                var apiResponse = JsonSerializer.Deserialize<ApiResponse<int>>(responseContent);
                if (apiResponse?.Success == true)
                {
                    ShowMessage("Student added successfully with auto-generated account!", true);
                    CloseStudentModal();
                    await LoadStudents();
                }
                else
                {
                    ShowMessage(apiResponse?.Message ?? "Failed to add student", false);
                }
            }
            else
            {
                // Try to parse error message
                try
                {
                    var errorResponse = JsonSerializer.Deserialize<ApiResponse<object>>(responseContent);
                    var errorMessage = errorResponse?.Message ?? responseContent;
                    
                    // Check if it's a foreign key constraint error
                    if (errorMessage.Contains("foreign key constraint"))
                    {
                        if (errorMessage.Contains("TeacherID") || errorMessage.Contains("FK_Students_Teachers"))
                        {
                            ShowMessage("Error: Invalid Teacher ID. Your teacher account may not be properly set up. Please logout and login again, or contact administrator.", false);
                        }
                        else if (errorMessage.Contains("SchoolID") || errorMessage.Contains("FK_Students_School"))
                        {
                            ShowMessage("Error: Invalid School ID. Please ensure your teacher account has a valid school assigned. Contact administrator if this issue persists.", false);
                        }
                        else
                        {
                            ShowMessage($"Database error: {errorMessage}", false);
                        }
                    }
                    else
                    {
                        ShowMessage($"Failed to add student: {errorMessage}", false);
                    }
                }
                catch
                {
                    ShowMessage($"Failed to add student: {responseContent}", false);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error adding student: {ex.Message}");
            Console.WriteLine($"Stack trace: {ex.StackTrace}");
            ShowMessage($"Error adding student: {ex.Message}", false);
        }
    }

    private async Task UpdateStudent()
    {
        try
        {
            var json = JsonSerializer.Serialize(studentForm);
            var content = new StringContent(json, System.Text.Encoding.UTF8, new MediaTypeHeaderValue("application/json"));

            var response = await Http.PutAsync($"api/Auth/students/{studentForm.StudentID}", content);
            var responseContent = await response.Content.ReadAsStringAsync();

            if (response.IsSuccessStatusCode)
            {
                var apiResponse = JsonSerializer.Deserialize<ApiResponse<bool>>(responseContent);
                if (apiResponse?.Success == true)
                {
                    ShowMessage("Student updated successfully!", true);
                    CloseStudentModal();
                    await LoadStudents();
                }
                else
                {
                    ShowMessage(apiResponse?.Message ?? "Failed to update student", false);
                }
            }
            else
            {
                ShowMessage("Failed to update student", false);
            }
        }
        catch (Exception ex)
        {
            ShowMessage($"Error updating student: {ex.Message}", false);
        }
    }

    private async Task DeleteStudent(Studentclass student)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete {student.StudentName}?"))
        {
            try
            {
                var response = await Http.DeleteAsync($"api/Auth/students/{student.StudentID}");
                if (response.IsSuccessStatusCode)
                {
                    ShowMessage("Student deleted successfully!", true);
                    await LoadStudents();
                }
                else
                {
                    ShowMessage("Failed to delete student", false);
                }
            }
            catch (Exception ex)
            {
                ShowMessage($"Error deleting student: {ex.Message}", false);
            }
        }
    }

    private void ShowMessage(string msg, bool success)
    {
        ShowToast(success ? "Success" : "Error", msg, success ? "success" : "error");
    }

    private string GetStatusBadgeClass(string status)
    {
        if (string.IsNullOrEmpty(status)) return "";

        return status.ToLower() switch
        {
            "active" or "pending" => "status-pending",
            "under review" or "investigation" or "under investigation" => "status-review",
            "hearing" or "on-going hearing" => "status-hearing",
            "resolved" => "status-resolved",
            "closed" or "cleared" => "status-closed",
            _ => "status-pending" // Default to pending color for unknown statuses
        };
    }

    private void ShowCaseRecordsModal(string studentName, string? levelFilter = null)
    {
        selectedStudentName = studentName ?? "";
        selectedCaseLevelFilter = levelFilter ?? "";
        showCaseRecordsModal = true;
        studentCaseRecords.Clear();

        // Gamitin muna yung pre-loaded na galing SimplifiedIncidentReports (na-load nung buksan ang dashboard)
        if (!string.IsNullOrEmpty(studentName) && preLoadedCaseRecords.TryGetValue(studentName, out var preLoaded))
        {
            studentCaseRecords = new List<StudentCaseRecord>(preLoaded);
            isLoadingCaseRecords = false;
            StateHasChanged();
            return;
        }

        // Fallback: kung wala sa pre-loaded, fetch on demand (same API: SimplifiedIncidentReports)
        isLoadingCaseRecords = true;
        StateHasChanged();
        _ = LoadCaseRecordsIntoModalAsync(studentName);
    }

    private async Task LoadCaseRecordsIntoModalAsync(string? studentName)
    {
        if (string.IsNullOrEmpty(studentName)) { isLoadingCaseRecords = false; StateHasChanged(); return; }
        try
        {
            var response = await Http.GetAsync($"api/IncidentReport/student/{Uri.EscapeDataString(studentName)}");
            if (response.IsSuccessStatusCode)
            {
                var content = await response.Content.ReadAsStringAsync();
                var result = JsonSerializer.Deserialize<JsonElement>(content);
                if (result.TryGetProperty("success", out var success) && success.GetBoolean() &&
                    result.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                {
                    studentCaseRecords = ParseCaseRecordsFromApiData(data);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading case records: {ex.Message}");
        }
        finally
        {
            isLoadingCaseRecords = false;
            StateHasChanged();
        }
    }

    private static List<StudentCaseRecord> ParseCaseRecordsFromApiData(JsonElement data)
    {
        var list = new List<StudentCaseRecord>();
        foreach (var caseElement in data.EnumerateArray())
        {
            var caseRecord = new StudentCaseRecord();
            if (caseElement.TryGetProperty("dateOfOffense", out var date))
                caseRecord.DateOfOffense = ParseJsonDate(date);
            else if (caseElement.TryGetProperty("dateReported", out var dateRep))
                caseRecord.DateOfOffense = ParseJsonDate(dateRep);
            else if (caseElement.TryGetProperty("DateReported", out var dateRepCap))
                caseRecord.DateOfOffense = ParseJsonDate(dateRepCap);
            if (caseElement.TryGetProperty("violationCommitted", out var v)) caseRecord.ViolationCommitted = v.GetString() ?? "";
            else if (caseElement.TryGetProperty("incidentType", out var inc)) caseRecord.ViolationCommitted = inc.GetString() ?? "";
            else if (caseElement.TryGetProperty("IncidentType", out var ic)) caseRecord.ViolationCommitted = ic.GetString() ?? "";
            if (caseElement.TryGetProperty("levelOfOffense", out var l)) caseRecord.LevelOfOffense = l.GetString() ?? "";
            else if (caseElement.TryGetProperty("LevelOfOffense", out var lc)) caseRecord.LevelOfOffense = lc.GetString() ?? "";
            if (caseElement.TryGetProperty("status", out var st)) caseRecord.Status = st.GetString() ?? "";
            else if (caseElement.TryGetProperty("Status", out var sc)) caseRecord.Status = sc.GetString() ?? "";
            list.Add(caseRecord);
        }
        return list;
    }

    private static DateTime ParseJsonDate(JsonElement el)
    {
        try
        {
            if (el.ValueKind == JsonValueKind.String)
            {
                var s = el.GetString();
                return string.IsNullOrEmpty(s) ? DateTime.Now : DateTime.Parse(s);
            }
            if (el.ValueKind == JsonValueKind.Number && el.TryGetInt64(out var unix))
                return DateTimeOffset.FromUnixTimeMilliseconds(unix).DateTime;
            return DateTime.Now;
        }
        catch { return DateTime.Now; }
    }
    
    private void CloseCaseRecordsModal()
    {
        showCaseRecordsModal = false;
        selectedStudentName = "";
        selectedCaseLevelFilter = "";
        studentCaseRecords.Clear();
    }

    private static IEnumerable<StudentCaseRecord> GetFilteredCaseRecords(List<StudentCaseRecord> records, string levelFilter)
    {
        if (string.IsNullOrWhiteSpace(levelFilter)) return records;
        var filter = levelFilter.Trim();
        if (filter.Equals("Minor", StringComparison.OrdinalIgnoreCase))
            return records.Where(r => r.LevelOfOffense != null && r.LevelOfOffense.Contains("Minor", StringComparison.OrdinalIgnoreCase));
        if (filter.Equals("Major", StringComparison.OrdinalIgnoreCase))
            return records.Where(r => r.LevelOfOffense != null && r.LevelOfOffense.Contains("Major", StringComparison.OrdinalIgnoreCase));
        if (filter.Equals("Prohibited", StringComparison.OrdinalIgnoreCase))
            return records.Where(r => r.LevelOfOffense != null && (r.LevelOfOffense.Contains("Prohibited", StringComparison.OrdinalIgnoreCase) || r.LevelOfOffense.Contains("Grave", StringComparison.OrdinalIgnoreCase)));
        return records;
    }

    // Escalation Modal State
    private bool showEscalationModal = false;
    private Studentclass? escalationCandidate;
    private List<string> escalationViolations = new();
    private string escalationDetailsString = "";
    private bool isEscalating = false;

    private async Task EscalateToPOD(Studentclass student)
    {
        escalationCandidate = student;
        escalationViolations.Clear();
        escalationDetailsString = "";
        isEscalating = true;

        try
        {
            // Gamitin muna pre-loaded case records (same source: SimplifiedIncidentReports) para yung violations ma-save sa CaseDetails
            if (preLoadedCaseRecords.TryGetValue(student.StudentName, out var records))
            {
                var minorViolations = records
                    .Where(r => r.LevelOfOffense != null && r.LevelOfOffense.Contains("Minor", StringComparison.OrdinalIgnoreCase))
                    .Select(r => r.ViolationCommitted ?? "")
                    .Where(s => !string.IsNullOrWhiteSpace(s))
                    .ToList();
                foreach (var v in minorViolations) escalationViolations.Add(v);
            }

            if (!escalationViolations.Any())
            {
                var casesResponse = await Http.GetAsync($"api/IncidentReport/student/{Uri.EscapeDataString(student.StudentName)}");
                if (casesResponse.IsSuccessStatusCode)
                {
                    var content = await casesResponse.Content.ReadAsStringAsync();
                    using var doc = JsonDocument.Parse(content);
                    var root = doc.RootElement;
                    if (root.TryGetProperty("success", out var success) && success.GetBoolean() &&
                        root.TryGetProperty("data", out var data) && data.ValueKind == JsonValueKind.Array)
                    {
                        foreach (var caseElement in data.EnumerateArray())
                        {
                            string violation = "";
                            string level = "";
                            if (caseElement.TryGetProperty("violationCommitted", out var v)) violation = v.GetString() ?? "";
                            else if (caseElement.TryGetProperty("incidentType", out var i)) violation = i.GetString() ?? "";
                            else if (caseElement.TryGetProperty("IncidentType", out var ic)) violation = ic.GetString() ?? "";
                            if (caseElement.TryGetProperty("levelOfOffense", out var l)) level = l.GetString() ?? "";
                            else if (caseElement.TryGetProperty("LevelOfOffense", out var lc)) level = lc.GetString() ?? "";
                            if (!string.IsNullOrWhiteSpace(violation) && string.Equals(level.Trim(), "Minor", StringComparison.OrdinalIgnoreCase))
                                escalationViolations.Add(violation);
                        }
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching case details: {ex.Message}");
        }
        finally
        {
            isEscalating = false;
            showEscalationModal = true;
            StateHasChanged();
        }
    }

    private void CloseEscalationModal()
    {
        showEscalationModal = false;
        escalationCandidate = null;
        escalationViolations.Clear();
    }

    private async Task ConfirmEscalation()
    {
        if (escalationCandidate == null) return;

        try
        {
            isEscalating = true;
            
            // Format details string from list (kasama ulit ‚Äî No/Shared ID Card, No/Shared ID Card, No/Shared ID Card)
            string finalDetails = escalationViolations.Any() 
                ? string.Join(", ", escalationViolations) 
                : "Multiple Minor Offenses (Check Records)";

            // Parse minor count from Gender field
            var caseParts = escalationCandidate.Gender.Split(' ');
            int minorCount = 0;
            foreach (var part in caseParts) {
                var split = part.Split(':');
                if (split.Length == 2 && split[0] == "M" && int.TryParse(split[1], out int count)) {
                    minorCount = count;
                }
            }

            var request = new SharedProject.EscalateStudentRequest
            {
                StudentName = escalationCandidate.StudentName,
                GradeLevel = currentTeacherGradeLevel ?? "Unknown",
                Section = currentTeacherSection ?? "Unknown",
                TrackStrand = escalationCandidate.Strand,
                SchoolName = currentTeacherSchoolName,
                MinorCaseCount = minorCount,
                CaseDetails = finalDetails, 
                Notes = $"Escalated by Adviser {currentTeacherName}"
            };

            var teacherId = currentTeacherId;
            int? schoolIdInt = null;
            if (int.TryParse(currentTeacherSchoolId, out int sid)) schoolIdInt = sid;

            var url = $"api/Escalation/escalate?escalatedBy={Uri.EscapeDataString(currentTeacherName)}&teacherId={teacherId}&schoolId={schoolIdInt}";
            var response = await Http.PostAsJsonAsync(url, request);

            if (response.IsSuccessStatusCode)
            {
                ShowMessage($"{escalationCandidate.StudentName} has been successfully escalated to the POD!", true);
                CloseEscalationModal();
                await LoadStudentsWithCases(); 
            }
            else
            {
                var errorMsg = await response.Content.ReadAsStringAsync();
                ShowMessage($"Failed to escalate: {errorMsg}", false);
            }
        }
        catch (Exception ex)
        {
            ShowMessage($"Error escalating student: {ex.Message}", false);
        }
        finally
        {
            isEscalating = false;
        }
    }
    
    // Case Records Modal State ‚Äî pre-loaded from SimplifiedIncidentReports when dashboard loads
    private bool showCaseRecordsModal = false;
    private string selectedStudentName = "";
    private string selectedCaseLevelFilter = ""; // "Minor", "Major", "Prohibited", or "" = show all
    private bool isLoadingCaseRecords = false;
    private List<StudentCaseRecord> studentCaseRecords = new();
    private Dictionary<string, List<StudentCaseRecord>> preLoadedCaseRecords = new(StringComparer.OrdinalIgnoreCase);
    
    // Helper class for case records
    public class StudentCaseRecord
    {
        public DateTime DateOfOffense { get; set; }
        public string ViolationCommitted { get; set; } = "";
        public string LevelOfOffense { get; set; } = "";
        public string Status { get; set; } = "";
    }
}

